<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ContextLogger2 Logger Daemon Internals: lbaselib.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_0a42b8d7a42fdff37378486477d8f5e0.html">lua</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_3536dc5472cf8658af6f2f3c074e6fb2.html">src</a>
  </div>
</div>
<div class="contents">
<h1>lbaselib.c</h1><a href="lbaselib_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">** $Id: lbaselib.c,v 1.191.1.6 2008/02/14 16:46:22 roberto Exp $</span>
<a name="l00003"></a>00003 <span class="comment">** Basic library</span>
<a name="l00004"></a>00004 <span class="comment">** See Copyright Notice in lua.h</span>
<a name="l00005"></a>00005 <span class="comment">*/</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00013"></a>00013 
<a name="l00014"></a><a class="code" href="lbaselib_8c.html#a2f5604e97f34f28d76a1eb287e7784a2">00014</a> <span class="preprocessor">#define lbaselib_c</span>
<a name="l00015"></a><a class="code" href="lbaselib_8c.html#a884b19ad6094d6238c4072a8064aeb12">00015</a> <span class="preprocessor"></span><span class="preprocessor">#define LUA_LIB</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="lua_8h.html">lua.h</a>&quot;</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="lauxlib_8h.html">lauxlib.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="lualib_8h.html">lualib.h</a>&quot;</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#ifdef LUA_USE_ALUA_LOGGER</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span><span class="comment">// Use generic output routine instead</span>
<a name="l00024"></a>00024 <span class="comment">// of fputs</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;out.h&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#endif</span>
<a name="l00027"></a>00027 <span class="preprocessor"></span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="comment">/*</span>
<a name="l00030"></a>00030 <span class="comment">** If your system does not support `stdout&apos;, you can just remove this function.</span>
<a name="l00031"></a>00031 <span class="comment">** If you need, you can define your own `print&apos; function, following this</span>
<a name="l00032"></a>00032 <span class="comment">** model but changing `fputs&apos; to put the strings at a proper place</span>
<a name="l00033"></a>00033 <span class="comment">** (a console window or a log file, for instance).</span>
<a name="l00034"></a>00034 <span class="comment">*/</span>
<a name="l00035"></a>00035 <span class="preprocessor">#ifdef LUA_USE_ALUA_LOGGER</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a865eb761a305c588d6940da5272375b7">luaB_print</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00037"></a>00037   <span class="keywordtype">int</span> n = <a class="code" href="lapi_8c.html#afbb08ecb69421875494105d4de68e5bf">lua_gettop</a>(L);  <span class="comment">/* number of arguments */</span>
<a name="l00038"></a>00038   <span class="keywordtype">int</span> i;
<a name="l00039"></a>00039   <a class="code" href="lua_8h.html#abc2f6fef4682c1d4cdc33206aaf42bec">lua_getglobal</a>(L, <span class="stringliteral">&quot;tostring&quot;</span>);
<a name="l00040"></a>00040   <span class="keywordflow">for</span> (i=1; i&lt;=n; i++) {
<a name="l00041"></a>00041     <span class="keyword">const</span> <span class="keywordtype">char</span> *s;
<a name="l00042"></a>00042     <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, -1);  <span class="comment">/* function to be called */</span>
<a name="l00043"></a>00043     <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, i);   <span class="comment">/* value to print */</span>
<a name="l00044"></a>00044     <a class="code" href="lapi_8c.html#a2d80481ca28902752c2b12c61d9d4234">lua_call</a>(L, 1, 1);
<a name="l00045"></a>00045     s = <a class="code" href="lua_8h.html#ac813fc3bc1886ba17c363d5b4c6e7ef1">lua_tostring</a>(L, -1);  <span class="comment">/* get result */</span>
<a name="l00046"></a>00046     <span class="keywordflow">if</span> (s == NULL)
<a name="l00047"></a>00047       <span class="keywordflow">return</span> <a class="code" href="lauxlib_8c.html#a6c51d83d29244779392551388913e08a">luaL_error</a>(L, <a class="code" href="luaconf_8h.html#afa035bf534f18141e29c98e3a222074c">LUA_QL</a>(<span class="stringliteral">&quot;tostring&quot;</span>) <span class="stringliteral">&quot; must return a string to &quot;</span>
<a name="l00048"></a>00048                            <a class="code" href="luaconf_8h.html#afa035bf534f18141e29c98e3a222074c">LUA_QL</a>(<span class="stringliteral">&quot;print&quot;</span>));
<a name="l00049"></a>00049     <span class="keywordflow">if</span> (i&gt;1) ALua::ROut::Puts(<span class="stringliteral">&quot;\t&quot;</span>);
<a name="l00050"></a>00050     ALua::ROut::Puts(s);
<a name="l00051"></a>00051     <a class="code" href="lua_8h.html#abb8eae2164badeafdb037bc1e03cc822">lua_pop</a>(L, 1);  <span class="comment">/* pop result */</span>
<a name="l00052"></a>00052   }
<a name="l00053"></a>00053   ALua::ROut::Puts(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00054"></a>00054   <span class="keywordflow">return</span> 0;
<a name="l00055"></a>00055 }
<a name="l00056"></a>00056 <span class="preprocessor">#else</span>
<a name="l00057"></a><a class="code" href="lbaselib_8c.html#a865eb761a305c588d6940da5272375b7">00057</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a865eb761a305c588d6940da5272375b7">luaB_print</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00058"></a>00058   <span class="keywordtype">int</span> n = <a class="code" href="lapi_8c.html#afbb08ecb69421875494105d4de68e5bf">lua_gettop</a>(L);  <span class="comment">/* number of arguments */</span>
<a name="l00059"></a>00059   <span class="keywordtype">int</span> i;
<a name="l00060"></a>00060   <a class="code" href="lua_8h.html#abc2f6fef4682c1d4cdc33206aaf42bec">lua_getglobal</a>(L, <span class="stringliteral">&quot;tostring&quot;</span>);
<a name="l00061"></a>00061   <span class="keywordflow">for</span> (i=1; i&lt;=n; i++) {
<a name="l00062"></a>00062     <span class="keyword">const</span> <span class="keywordtype">char</span> *s;
<a name="l00063"></a>00063     <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, -1);  <span class="comment">/* function to be called */</span>
<a name="l00064"></a>00064     <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, i);   <span class="comment">/* value to print */</span>
<a name="l00065"></a>00065     <a class="code" href="lapi_8c.html#a2d80481ca28902752c2b12c61d9d4234">lua_call</a>(L, 1, 1);
<a name="l00066"></a>00066     s = <a class="code" href="lua_8h.html#ac813fc3bc1886ba17c363d5b4c6e7ef1">lua_tostring</a>(L, -1);  <span class="comment">/* get result */</span>
<a name="l00067"></a>00067     <span class="keywordflow">if</span> (s == NULL)
<a name="l00068"></a>00068       <span class="keywordflow">return</span> <a class="code" href="lauxlib_8c.html#a6c51d83d29244779392551388913e08a">luaL_error</a>(L, <a class="code" href="luaconf_8h.html#afa035bf534f18141e29c98e3a222074c">LUA_QL</a>(<span class="stringliteral">&quot;tostring&quot;</span>) <span class="stringliteral">&quot; must return a string to &quot;</span>
<a name="l00069"></a>00069                            <a class="code" href="luaconf_8h.html#afa035bf534f18141e29c98e3a222074c">LUA_QL</a>(<span class="stringliteral">&quot;print&quot;</span>));
<a name="l00070"></a>00070     <span class="keywordflow">if</span> (i&gt;1) fputs(<span class="stringliteral">&quot;\t&quot;</span>, stdout);
<a name="l00071"></a>00071     fputs(s, stdout);
<a name="l00072"></a>00072     <a class="code" href="lua_8h.html#abb8eae2164badeafdb037bc1e03cc822">lua_pop</a>(L, 1);  <span class="comment">/* pop result */</span>
<a name="l00073"></a>00073   }
<a name="l00074"></a>00074   fputs(<span class="stringliteral">&quot;\n&quot;</span>, stdout);
<a name="l00075"></a>00075   <span class="keywordflow">return</span> 0;
<a name="l00076"></a>00076 }
<a name="l00077"></a>00077 <span class="preprocessor">#endif</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span>
<a name="l00079"></a>00079 
<a name="l00080"></a><a class="code" href="lbaselib_8c.html#a6224f7b7c4485996e1c22eae32de990d">00080</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a6224f7b7c4485996e1c22eae32de990d">luaB_tonumber</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00081"></a>00081   <span class="keywordtype">int</span> base = <a class="code" href="lauxlib_8h.html#ab4d7f693e9405558c725783a756e0aca">luaL_optint</a>(L, 2, 10);
<a name="l00082"></a>00082   <span class="keywordflow">if</span> (base == 10) {  <span class="comment">/* standard conversion */</span>
<a name="l00083"></a>00083     <a class="code" href="lauxlib_8c.html#a801a6d587ffb8df1954f3275b64b0a5e">luaL_checkany</a>(L, 1);
<a name="l00084"></a>00084     <span class="keywordflow">if</span> (<a class="code" href="lapi_8c.html#a99451f234bf085c9c46c3d17a5aef905">lua_isnumber</a>(L, 1)) {
<a name="l00085"></a>00085       <a class="code" href="lapi_8c.html#a328625a03fbb5548f27b1af10f109f6a">lua_pushnumber</a>(L, <a class="code" href="lapi_8c.html#a42c1f68101dc98a6ae4695c8577b17f8">lua_tonumber</a>(L, 1));
<a name="l00086"></a>00086       <span class="keywordflow">return</span> 1;
<a name="l00087"></a>00087     }
<a name="l00088"></a>00088   }
<a name="l00089"></a>00089   <span class="keywordflow">else</span> {
<a name="l00090"></a>00090     <span class="keyword">const</span> <span class="keywordtype">char</span> *s1 = <a class="code" href="lauxlib_8h.html#ad9917d22c79651fdd73d42c146b5056f">luaL_checkstring</a>(L, 1);
<a name="l00091"></a>00091     <span class="keywordtype">char</span> *s2;
<a name="l00092"></a>00092     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> n;
<a name="l00093"></a>00093     <a class="code" href="lauxlib_8h.html#afe2e3018d561c14f2622fb32f425c111">luaL_argcheck</a>(L, 2 &lt;= base &amp;&amp; base &lt;= 36, 2, <span class="stringliteral">&quot;base out of range&quot;</span>);
<a name="l00094"></a>00094     n = strtoul(s1, &amp;s2, base);
<a name="l00095"></a>00095     <span class="keywordflow">if</span> (s1 != s2) {  <span class="comment">/* at least one valid digit? */</span>
<a name="l00096"></a>00096       <span class="keywordflow">while</span> (isspace((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)(*s2))) s2++;  <span class="comment">/* skip trailing spaces */</span>
<a name="l00097"></a>00097       <span class="keywordflow">if</span> (*s2 == <span class="charliteral">&apos;\0&apos;</span>) {  <span class="comment">/* no invalid trailing characters? */</span>
<a name="l00098"></a>00098         <a class="code" href="lapi_8c.html#a328625a03fbb5548f27b1af10f109f6a">lua_pushnumber</a>(L, (<a class="code" href="lua_8h.html#af0a6ed3b852d680769cfc410a0672172">lua_Number</a>)n);
<a name="l00099"></a>00099         <span class="keywordflow">return</span> 1;
<a name="l00100"></a>00100       }
<a name="l00101"></a>00101     }
<a name="l00102"></a>00102   }
<a name="l00103"></a>00103   <a class="code" href="lapi_8c.html#a1b4cd0d80f51e5545a97ca6c28c03c50">lua_pushnil</a>(L);  <span class="comment">/* else not a number */</span>
<a name="l00104"></a>00104   <span class="keywordflow">return</span> 1;
<a name="l00105"></a>00105 }
<a name="l00106"></a>00106 
<a name="l00107"></a>00107 
<a name="l00108"></a><a class="code" href="lbaselib_8c.html#a2ecfa987569d0b4c1063f3e204e42dd2">00108</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a2ecfa987569d0b4c1063f3e204e42dd2">luaB_error</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00109"></a>00109   <span class="keywordtype">int</span> level = <a class="code" href="lauxlib_8h.html#ab4d7f693e9405558c725783a756e0aca">luaL_optint</a>(L, 2, 1);
<a name="l00110"></a>00110   <a class="code" href="lapi_8c.html#adaa30f0d34786144c94644039d1d1b6e">lua_settop</a>(L, 1);
<a name="l00111"></a>00111   <span class="keywordflow">if</span> (<a class="code" href="lapi_8c.html#a9f20233199a414b04c1c4b43f5d040f3">lua_isstring</a>(L, 1) &amp;&amp; level &gt; 0) {  <span class="comment">/* add extra information? */</span>
<a name="l00112"></a>00112     <a class="code" href="lauxlib_8c.html#a0f4d3c30c07eae36aa25605df84279a0">luaL_where</a>(L, level);
<a name="l00113"></a>00113     <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, 1);
<a name="l00114"></a>00114     <a class="code" href="lapi_8c.html#a1de3afee1daece63d455f23818c883d9">lua_concat</a>(L, 2);
<a name="l00115"></a>00115   }
<a name="l00116"></a>00116   <span class="keywordflow">return</span> <a class="code" href="lapi_8c.html#a6ba7b91143fe8a03910420d800de8e97">lua_error</a>(L);
<a name="l00117"></a>00117 }
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 
<a name="l00120"></a><a class="code" href="lbaselib_8c.html#addfd66adcbe4c777cf5e10536d27d8b1">00120</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#addfd66adcbe4c777cf5e10536d27d8b1">luaB_getmetatable</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00121"></a>00121   <a class="code" href="lauxlib_8c.html#a801a6d587ffb8df1954f3275b64b0a5e">luaL_checkany</a>(L, 1);
<a name="l00122"></a>00122   <span class="keywordflow">if</span> (!<a class="code" href="lapi_8c.html#a4caa9ca5e47a30bd45e33d83bf2d6d6e">lua_getmetatable</a>(L, 1)) {
<a name="l00123"></a>00123     <a class="code" href="lapi_8c.html#a1b4cd0d80f51e5545a97ca6c28c03c50">lua_pushnil</a>(L);
<a name="l00124"></a>00124     <span class="keywordflow">return</span> 1;  <span class="comment">/* no metatable */</span>
<a name="l00125"></a>00125   }
<a name="l00126"></a>00126   <a class="code" href="lauxlib_8c.html#add7cea31816ff3f61014031248e0daa6">luaL_getmetafield</a>(L, 1, <span class="stringliteral">&quot;__metatable&quot;</span>);
<a name="l00127"></a>00127   <span class="keywordflow">return</span> 1;  <span class="comment">/* returns either __metatable field (if present) or metatable */</span>
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 
<a name="l00131"></a><a class="code" href="lbaselib_8c.html#af7799a987ba6d158a96a52e80fb5beaf">00131</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#af7799a987ba6d158a96a52e80fb5beaf">luaB_setmetatable</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00132"></a>00132   <span class="keywordtype">int</span> t = <a class="code" href="lapi_8c.html#a652b273947f0656686f998d8e90cd3ea">lua_type</a>(L, 2);
<a name="l00133"></a>00133   <a class="code" href="lauxlib_8c.html#a2289f14c4cd08df158f8894c87ed2c52">luaL_checktype</a>(L, 1, <a class="code" href="lua_8h.html#a31620fd8da5b655b7879e16a116ec31a">LUA_TTABLE</a>);
<a name="l00134"></a>00134   <a class="code" href="lauxlib_8h.html#afe2e3018d561c14f2622fb32f425c111">luaL_argcheck</a>(L, t == <a class="code" href="lua_8h.html#ae38a6fb8c687b8bfab211b7675a695ef">LUA_TNIL</a> || t == <a class="code" href="lua_8h.html#a31620fd8da5b655b7879e16a116ec31a">LUA_TTABLE</a>, 2,
<a name="l00135"></a>00135                     <span class="stringliteral">&quot;nil or table expected&quot;</span>);
<a name="l00136"></a>00136   <span class="keywordflow">if</span> (<a class="code" href="lauxlib_8c.html#add7cea31816ff3f61014031248e0daa6">luaL_getmetafield</a>(L, 1, <span class="stringliteral">&quot;__metatable&quot;</span>))
<a name="l00137"></a>00137     <a class="code" href="lauxlib_8c.html#a6c51d83d29244779392551388913e08a">luaL_error</a>(L, <span class="stringliteral">&quot;cannot change a protected metatable&quot;</span>);
<a name="l00138"></a>00138   <a class="code" href="lapi_8c.html#adaa30f0d34786144c94644039d1d1b6e">lua_settop</a>(L, 2);
<a name="l00139"></a>00139   <a class="code" href="lapi_8c.html#a15719ea4119bdf5b3f2a406534431a7e">lua_setmetatable</a>(L, 1);
<a name="l00140"></a>00140   <span class="keywordflow">return</span> 1;
<a name="l00141"></a>00141 }
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 
<a name="l00144"></a><a class="code" href="lbaselib_8c.html#a2b5ce950e53234d01d796cdaf3384b98">00144</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lbaselib_8c.html#a2b5ce950e53234d01d796cdaf3384b98">getfunc</a> (<a class="code" href="structlua__State.html">lua_State</a> *L, <span class="keywordtype">int</span> opt) {
<a name="l00145"></a>00145   <span class="keywordflow">if</span> (<a class="code" href="lua_8h.html#a7537af276c81906c144f29cd25b93315">lua_isfunction</a>(L, 1)) <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, 1);
<a name="l00146"></a>00146   <span class="keywordflow">else</span> {
<a name="l00147"></a>00147     <a class="code" href="structlua__Debug.html">lua_Debug</a> ar;
<a name="l00148"></a>00148     <span class="keywordtype">int</span> level = opt ? <a class="code" href="lauxlib_8h.html#ab4d7f693e9405558c725783a756e0aca">luaL_optint</a>(L, 1, 1) : <a class="code" href="lauxlib_8h.html#adb277a5f654228b51b66f95bcf883601">luaL_checkint</a>(L, 1);
<a name="l00149"></a>00149     <a class="code" href="lauxlib_8h.html#afe2e3018d561c14f2622fb32f425c111">luaL_argcheck</a>(L, level &gt;= 0, 1, <span class="stringliteral">&quot;level must be non-negative&quot;</span>);
<a name="l00150"></a>00150     <span class="keywordflow">if</span> (<a class="code" href="ldebug_8c.html#ac1fc03c27ee46caa4037df2d70f22110">lua_getstack</a>(L, level, &amp;ar) == 0)
<a name="l00151"></a>00151       <a class="code" href="lauxlib_8c.html#ad55b4b5fa169573bd0becaa38d7254c4">luaL_argerror</a>(L, 1, <span class="stringliteral">&quot;invalid level&quot;</span>);
<a name="l00152"></a>00152     <a class="code" href="ldebug_8c.html#acaafc35d8e385c4d167229486165df6d">lua_getinfo</a>(L, <span class="stringliteral">&quot;f&quot;</span>, &amp;ar);
<a name="l00153"></a>00153     <span class="keywordflow">if</span> (<a class="code" href="lua_8h.html#a86d737d7002e7e94023765397c6eef20">lua_isnil</a>(L, -1))
<a name="l00154"></a>00154       <a class="code" href="lauxlib_8c.html#a6c51d83d29244779392551388913e08a">luaL_error</a>(L, <span class="stringliteral">&quot;no function environment for tail call at level %d&quot;</span>,
<a name="l00155"></a>00155                     level);
<a name="l00156"></a>00156   }
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 
<a name="l00160"></a><a class="code" href="lbaselib_8c.html#ab43e01e3a4ccb3cc7cc9ace8f38d1ba6">00160</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#ab43e01e3a4ccb3cc7cc9ace8f38d1ba6">luaB_getfenv</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00161"></a>00161   <a class="code" href="lbaselib_8c.html#a2b5ce950e53234d01d796cdaf3384b98">getfunc</a>(L, 1);
<a name="l00162"></a>00162   <span class="keywordflow">if</span> (<a class="code" href="lapi_8c.html#a3b922032c9fe2930399186a3647cc3ad">lua_iscfunction</a>(L, -1))  <span class="comment">/* is a C function? */</span>
<a name="l00163"></a>00163     <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, <a class="code" href="lua_8h.html#adcd23d4ad1ec6e825daea03ee83c8c73">LUA_GLOBALSINDEX</a>);  <span class="comment">/* return the thread&apos;s global env. */</span>
<a name="l00164"></a>00164   <span class="keywordflow">else</span>
<a name="l00165"></a>00165     <a class="code" href="lapi_8c.html#aae62bb7fb4498cc5193abf66797b2246">lua_getfenv</a>(L, -1);
<a name="l00166"></a>00166   <span class="keywordflow">return</span> 1;
<a name="l00167"></a>00167 }
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 
<a name="l00170"></a><a class="code" href="lbaselib_8c.html#ad0768dadbffb2928eb6961c4aaa2c27b">00170</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#ad0768dadbffb2928eb6961c4aaa2c27b">luaB_setfenv</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00171"></a>00171   <a class="code" href="lauxlib_8c.html#a2289f14c4cd08df158f8894c87ed2c52">luaL_checktype</a>(L, 2, <a class="code" href="lua_8h.html#a31620fd8da5b655b7879e16a116ec31a">LUA_TTABLE</a>);
<a name="l00172"></a>00172   <a class="code" href="lbaselib_8c.html#a2b5ce950e53234d01d796cdaf3384b98">getfunc</a>(L, 0);
<a name="l00173"></a>00173   <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, 2);
<a name="l00174"></a>00174   <span class="keywordflow">if</span> (<a class="code" href="lapi_8c.html#a99451f234bf085c9c46c3d17a5aef905">lua_isnumber</a>(L, 1) &amp;&amp; <a class="code" href="lapi_8c.html#a42c1f68101dc98a6ae4695c8577b17f8">lua_tonumber</a>(L, 1) == 0) {
<a name="l00175"></a>00175     <span class="comment">/* change environment of current thread */</span>
<a name="l00176"></a>00176     <a class="code" href="lapi_8c.html#a4175aeea9aa6dbf096ecfca7b190fa4a">lua_pushthread</a>(L);
<a name="l00177"></a>00177     <a class="code" href="lapi_8c.html#aba6844115e26e0923488403436219e66">lua_insert</a>(L, -2);
<a name="l00178"></a>00178     <a class="code" href="lapi_8c.html#af3a6383019df780016182fb8924f3127">lua_setfenv</a>(L, -2);
<a name="l00179"></a>00179     <span class="keywordflow">return</span> 0;
<a name="l00180"></a>00180   }
<a name="l00181"></a>00181   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="lapi_8c.html#a3b922032c9fe2930399186a3647cc3ad">lua_iscfunction</a>(L, -2) || <a class="code" href="lapi_8c.html#af3a6383019df780016182fb8924f3127">lua_setfenv</a>(L, -2) == 0)
<a name="l00182"></a>00182     <a class="code" href="lauxlib_8c.html#a6c51d83d29244779392551388913e08a">luaL_error</a>(L,
<a name="l00183"></a>00183           <a class="code" href="luaconf_8h.html#afa035bf534f18141e29c98e3a222074c">LUA_QL</a>(<span class="stringliteral">&quot;setfenv&quot;</span>) <span class="stringliteral">&quot; cannot change environment of given object&quot;</span>);
<a name="l00184"></a>00184   <span class="keywordflow">return</span> 1;
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 
<a name="l00188"></a><a class="code" href="lbaselib_8c.html#a4dbd4fb89ec70a7b07cad52f7c13e637">00188</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a4dbd4fb89ec70a7b07cad52f7c13e637">luaB_rawequal</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00189"></a>00189   <a class="code" href="lauxlib_8c.html#a801a6d587ffb8df1954f3275b64b0a5e">luaL_checkany</a>(L, 1);
<a name="l00190"></a>00190   <a class="code" href="lauxlib_8c.html#a801a6d587ffb8df1954f3275b64b0a5e">luaL_checkany</a>(L, 2);
<a name="l00191"></a>00191   <a class="code" href="lapi_8c.html#a56bbb7479265e38da2e2596e6ec25faa">lua_pushboolean</a>(L, <a class="code" href="lapi_8c.html#ace66ea78ced7fda0b367f45d09d10d83">lua_rawequal</a>(L, 1, 2));
<a name="l00192"></a>00192   <span class="keywordflow">return</span> 1;
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 
<a name="l00196"></a><a class="code" href="lbaselib_8c.html#a248a6847a33f31c69a43a76b6b8bcb4b">00196</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a248a6847a33f31c69a43a76b6b8bcb4b">luaB_rawget</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00197"></a>00197   <a class="code" href="lauxlib_8c.html#a2289f14c4cd08df158f8894c87ed2c52">luaL_checktype</a>(L, 1, <a class="code" href="lua_8h.html#a31620fd8da5b655b7879e16a116ec31a">LUA_TTABLE</a>);
<a name="l00198"></a>00198   <a class="code" href="lauxlib_8c.html#a801a6d587ffb8df1954f3275b64b0a5e">luaL_checkany</a>(L, 2);
<a name="l00199"></a>00199   <a class="code" href="lapi_8c.html#adaa30f0d34786144c94644039d1d1b6e">lua_settop</a>(L, 2);
<a name="l00200"></a>00200   <a class="code" href="lapi_8c.html#a43379a0ba1fb68a4c81d205ad60b3cc1">lua_rawget</a>(L, 1);
<a name="l00201"></a>00201   <span class="keywordflow">return</span> 1;
<a name="l00202"></a>00202 }
<a name="l00203"></a>00203 
<a name="l00204"></a><a class="code" href="lbaselib_8c.html#a7b7225051c25127792f30eadd3498cc3">00204</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a7b7225051c25127792f30eadd3498cc3">luaB_rawset</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00205"></a>00205   <a class="code" href="lauxlib_8c.html#a2289f14c4cd08df158f8894c87ed2c52">luaL_checktype</a>(L, 1, <a class="code" href="lua_8h.html#a31620fd8da5b655b7879e16a116ec31a">LUA_TTABLE</a>);
<a name="l00206"></a>00206   <a class="code" href="lauxlib_8c.html#a801a6d587ffb8df1954f3275b64b0a5e">luaL_checkany</a>(L, 2);
<a name="l00207"></a>00207   <a class="code" href="lauxlib_8c.html#a801a6d587ffb8df1954f3275b64b0a5e">luaL_checkany</a>(L, 3);
<a name="l00208"></a>00208   <a class="code" href="lapi_8c.html#adaa30f0d34786144c94644039d1d1b6e">lua_settop</a>(L, 3);
<a name="l00209"></a>00209   <a class="code" href="lapi_8c.html#afb2d27f421677ef40425f9054ae216a7">lua_rawset</a>(L, 1);
<a name="l00210"></a>00210   <span class="keywordflow">return</span> 1;
<a name="l00211"></a>00211 }
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 
<a name="l00214"></a><a class="code" href="lbaselib_8c.html#aa30f77b7aaae8bda70dbb246edf7ea96">00214</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#aa30f77b7aaae8bda70dbb246edf7ea96">luaB_gcinfo</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00215"></a>00215   <a class="code" href="lapi_8c.html#adcec46ff05dfee9a3c4c05828b40c213">lua_pushinteger</a>(L, <a class="code" href="lua_8h.html#a1d036311a62bf9c9cc376de2f46433e2">lua_getgccount</a>(L));
<a name="l00216"></a>00216   <span class="keywordflow">return</span> 1;
<a name="l00217"></a>00217 }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 
<a name="l00220"></a><a class="code" href="lbaselib_8c.html#a07f71966c943cc9761ab129f64d4ac80">00220</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a07f71966c943cc9761ab129f64d4ac80">luaB_collectgarbage</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00221"></a>00221   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> opts[] = {<span class="stringliteral">&quot;stop&quot;</span>, <span class="stringliteral">&quot;restart&quot;</span>, <span class="stringliteral">&quot;collect&quot;</span>,
<a name="l00222"></a>00222     <span class="stringliteral">&quot;count&quot;</span>, <span class="stringliteral">&quot;step&quot;</span>, <span class="stringliteral">&quot;setpause&quot;</span>, <span class="stringliteral">&quot;setstepmul&quot;</span>, NULL};
<a name="l00223"></a>00223   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> optsnum[] = {<a class="code" href="lua_8h.html#a7080a7110a1b37afc6ea2f706e944bc3">LUA_GCSTOP</a>, <a class="code" href="lua_8h.html#a73701e5990022e938e90828a2c8291a4">LUA_GCRESTART</a>, <a class="code" href="lua_8h.html#a59b8b65be08a10442ea2ae41289f5073">LUA_GCCOLLECT</a>,
<a name="l00224"></a>00224     <a class="code" href="lua_8h.html#a3f8f1ebdffa4dbfe2dd89c2fd86bd7f4">LUA_GCCOUNT</a>, <a class="code" href="lua_8h.html#a9e7f3eaf2e269c3422aea3fd7c8973ef">LUA_GCSTEP</a>, <a class="code" href="lua_8h.html#a28342bd4f96a077c7447489073dfa376">LUA_GCSETPAUSE</a>, <a class="code" href="lua_8h.html#af07b3449c8e3ffdd62649443f32e1931">LUA_GCSETSTEPMUL</a>};
<a name="l00225"></a>00225   <span class="keywordtype">int</span> o = <a class="code" href="lauxlib_8c.html#aa7c6526b853e82e52fad474e8535f154">luaL_checkoption</a>(L, 1, <span class="stringliteral">&quot;collect&quot;</span>, opts);
<a name="l00226"></a>00226   <span class="keywordtype">int</span> ex = <a class="code" href="lauxlib_8h.html#ab4d7f693e9405558c725783a756e0aca">luaL_optint</a>(L, 2, 0);
<a name="l00227"></a>00227   <span class="keywordtype">int</span> res = <a class="code" href="lapi_8c.html#af8ed2209505943e2eb581cb4e4e02b62">lua_gc</a>(L, optsnum[o], ex);
<a name="l00228"></a>00228   <span class="keywordflow">switch</span> (optsnum[o]) {
<a name="l00229"></a>00229     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#a3f8f1ebdffa4dbfe2dd89c2fd86bd7f4">LUA_GCCOUNT</a>: {
<a name="l00230"></a>00230       <span class="keywordtype">int</span> b = <a class="code" href="lapi_8c.html#af8ed2209505943e2eb581cb4e4e02b62">lua_gc</a>(L, <a class="code" href="lua_8h.html#a99f1685cd6789e0b9bbd2a4c080fbaed">LUA_GCCOUNTB</a>, 0);
<a name="l00231"></a>00231       <a class="code" href="lapi_8c.html#a328625a03fbb5548f27b1af10f109f6a">lua_pushnumber</a>(L, res + ((<a class="code" href="lua_8h.html#af0a6ed3b852d680769cfc410a0672172">lua_Number</a>)b/1024));
<a name="l00232"></a>00232       <span class="keywordflow">return</span> 1;
<a name="l00233"></a>00233     }
<a name="l00234"></a>00234     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#a9e7f3eaf2e269c3422aea3fd7c8973ef">LUA_GCSTEP</a>: {
<a name="l00235"></a>00235       <a class="code" href="lapi_8c.html#a56bbb7479265e38da2e2596e6ec25faa">lua_pushboolean</a>(L, res);
<a name="l00236"></a>00236       <span class="keywordflow">return</span> 1;
<a name="l00237"></a>00237     }
<a name="l00238"></a>00238     <span class="keywordflow">default</span>: {
<a name="l00239"></a>00239       <a class="code" href="lapi_8c.html#a328625a03fbb5548f27b1af10f109f6a">lua_pushnumber</a>(L, res);
<a name="l00240"></a>00240       <span class="keywordflow">return</span> 1;
<a name="l00241"></a>00241     }
<a name="l00242"></a>00242   }
<a name="l00243"></a>00243 }
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 
<a name="l00246"></a><a class="code" href="lbaselib_8c.html#a7135b660cac1e25a2854acd9849cd4a4">00246</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a7135b660cac1e25a2854acd9849cd4a4">luaB_type</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00247"></a>00247   <a class="code" href="lauxlib_8c.html#a801a6d587ffb8df1954f3275b64b0a5e">luaL_checkany</a>(L, 1);
<a name="l00248"></a>00248   <a class="code" href="lapi_8c.html#a1281a7e2b52370cc416123bfd32b1b29">lua_pushstring</a>(L, <a class="code" href="lauxlib_8h.html#a2bee94954917c5bccb05d6578f3c675b">luaL_typename</a>(L, 1));
<a name="l00249"></a>00249   <span class="keywordflow">return</span> 1;
<a name="l00250"></a>00250 }
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 
<a name="l00253"></a><a class="code" href="lbaselib_8c.html#ac0b11ecf3ced275821aaf5a03ed33b02">00253</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#ac0b11ecf3ced275821aaf5a03ed33b02">luaB_next</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00254"></a>00254   <a class="code" href="lauxlib_8c.html#a2289f14c4cd08df158f8894c87ed2c52">luaL_checktype</a>(L, 1, <a class="code" href="lua_8h.html#a31620fd8da5b655b7879e16a116ec31a">LUA_TTABLE</a>);
<a name="l00255"></a>00255   <a class="code" href="lapi_8c.html#adaa30f0d34786144c94644039d1d1b6e">lua_settop</a>(L, 2);  <span class="comment">/* create a 2nd argument if there isn&apos;t one */</span>
<a name="l00256"></a>00256   <span class="keywordflow">if</span> (<a class="code" href="lapi_8c.html#aa8bf464b98335a075732200ad91ce1de">lua_next</a>(L, 1))
<a name="l00257"></a>00257     <span class="keywordflow">return</span> 2;
<a name="l00258"></a>00258   <span class="keywordflow">else</span> {
<a name="l00259"></a>00259     <a class="code" href="lapi_8c.html#a1b4cd0d80f51e5545a97ca6c28c03c50">lua_pushnil</a>(L);
<a name="l00260"></a>00260     <span class="keywordflow">return</span> 1;
<a name="l00261"></a>00261   }
<a name="l00262"></a>00262 }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 
<a name="l00265"></a><a class="code" href="lbaselib_8c.html#a36def102f87ba8c40734489231e90109">00265</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a36def102f87ba8c40734489231e90109">luaB_pairs</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00266"></a>00266   <a class="code" href="lauxlib_8c.html#a2289f14c4cd08df158f8894c87ed2c52">luaL_checktype</a>(L, 1, <a class="code" href="lua_8h.html#a31620fd8da5b655b7879e16a116ec31a">LUA_TTABLE</a>);
<a name="l00267"></a>00267   <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, <a class="code" href="lua_8h.html#ac3aa6665c25070f282c9827ec919fe6a">lua_upvalueindex</a>(1));  <span class="comment">/* return generator, */</span>
<a name="l00268"></a>00268   <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, 1);  <span class="comment">/* state, */</span>
<a name="l00269"></a>00269   <a class="code" href="lapi_8c.html#a1b4cd0d80f51e5545a97ca6c28c03c50">lua_pushnil</a>(L);  <span class="comment">/* and initial value */</span>
<a name="l00270"></a>00270   <span class="keywordflow">return</span> 3;
<a name="l00271"></a>00271 }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 
<a name="l00274"></a><a class="code" href="lbaselib_8c.html#a9e49fcec5e66e36e817b1951123efc03">00274</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a9e49fcec5e66e36e817b1951123efc03">ipairsaux</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00275"></a>00275   <span class="keywordtype">int</span> i = <a class="code" href="lauxlib_8h.html#adb277a5f654228b51b66f95bcf883601">luaL_checkint</a>(L, 2);
<a name="l00276"></a>00276   <a class="code" href="lauxlib_8c.html#a2289f14c4cd08df158f8894c87ed2c52">luaL_checktype</a>(L, 1, <a class="code" href="lua_8h.html#a31620fd8da5b655b7879e16a116ec31a">LUA_TTABLE</a>);
<a name="l00277"></a>00277   i++;  <span class="comment">/* next value */</span>
<a name="l00278"></a>00278   <a class="code" href="lapi_8c.html#adcec46ff05dfee9a3c4c05828b40c213">lua_pushinteger</a>(L, i);
<a name="l00279"></a>00279   <a class="code" href="lapi_8c.html#ae37bc3e2991700913a74d2b656442520">lua_rawgeti</a>(L, 1, i);
<a name="l00280"></a>00280   <span class="keywordflow">return</span> (<a class="code" href="lua_8h.html#a86d737d7002e7e94023765397c6eef20">lua_isnil</a>(L, -1)) ? 0 : 2;
<a name="l00281"></a>00281 }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283 
<a name="l00284"></a><a class="code" href="lbaselib_8c.html#a5cb8b3b13437afd94c3313f0a4b17d06">00284</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a5cb8b3b13437afd94c3313f0a4b17d06">luaB_ipairs</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00285"></a>00285   <a class="code" href="lauxlib_8c.html#a2289f14c4cd08df158f8894c87ed2c52">luaL_checktype</a>(L, 1, <a class="code" href="lua_8h.html#a31620fd8da5b655b7879e16a116ec31a">LUA_TTABLE</a>);
<a name="l00286"></a>00286   <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, <a class="code" href="lua_8h.html#ac3aa6665c25070f282c9827ec919fe6a">lua_upvalueindex</a>(1));  <span class="comment">/* return generator, */</span>
<a name="l00287"></a>00287   <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, 1);  <span class="comment">/* state, */</span>
<a name="l00288"></a>00288   <a class="code" href="lapi_8c.html#adcec46ff05dfee9a3c4c05828b40c213">lua_pushinteger</a>(L, 0);  <span class="comment">/* and initial value */</span>
<a name="l00289"></a>00289   <span class="keywordflow">return</span> 3;
<a name="l00290"></a>00290 }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292 
<a name="l00293"></a><a class="code" href="lbaselib_8c.html#a554228c65f0a0e43fdc2bbe75831a732">00293</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a554228c65f0a0e43fdc2bbe75831a732">load_aux</a> (<a class="code" href="structlua__State.html">lua_State</a> *L, <span class="keywordtype">int</span> status) {
<a name="l00294"></a>00294   <span class="keywordflow">if</span> (status == 0)  <span class="comment">/* OK? */</span>
<a name="l00295"></a>00295     <span class="keywordflow">return</span> 1;
<a name="l00296"></a>00296   <span class="keywordflow">else</span> {
<a name="l00297"></a>00297     <a class="code" href="lapi_8c.html#a1b4cd0d80f51e5545a97ca6c28c03c50">lua_pushnil</a>(L);
<a name="l00298"></a>00298     <a class="code" href="lapi_8c.html#aba6844115e26e0923488403436219e66">lua_insert</a>(L, -2);  <span class="comment">/* put before error message */</span>
<a name="l00299"></a>00299     <span class="keywordflow">return</span> 2;  <span class="comment">/* return nil plus error message */</span>
<a name="l00300"></a>00300   }
<a name="l00301"></a>00301 }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303 
<a name="l00304"></a><a class="code" href="lbaselib_8c.html#aedd88ec0159e7891314aa32c540b35a0">00304</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#aedd88ec0159e7891314aa32c540b35a0">luaB_loadstring</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00305"></a>00305   <span class="keywordtype">size_t</span> l;
<a name="l00306"></a>00306   <span class="keyword">const</span> <span class="keywordtype">char</span> *s = <a class="code" href="lauxlib_8c.html#aad24a665e607b9901c3483dbe769fa52">luaL_checklstring</a>(L, 1, &amp;l);
<a name="l00307"></a>00307   <span class="keyword">const</span> <span class="keywordtype">char</span> *chunkname = <a class="code" href="lauxlib_8h.html#a732bc5882c4a5da46b236649ab6db47b">luaL_optstring</a>(L, 2, s);
<a name="l00308"></a>00308   <span class="keywordflow">return</span> <a class="code" href="lbaselib_8c.html#a554228c65f0a0e43fdc2bbe75831a732">load_aux</a>(L, <a class="code" href="lauxlib_8c.html#a05e933ed88ffcd34a8cd3b907ccbdb2b">luaL_loadbuffer</a>(L, s, l, chunkname));
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 
<a name="l00312"></a><a class="code" href="lbaselib_8c.html#aeb4cb83db820979bbdd7710109b52957">00312</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#aeb4cb83db820979bbdd7710109b52957">luaB_loadfile</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00313"></a>00313   <span class="keyword">const</span> <span class="keywordtype">char</span> *fname = <a class="code" href="lauxlib_8h.html#a732bc5882c4a5da46b236649ab6db47b">luaL_optstring</a>(L, 1, NULL);
<a name="l00314"></a>00314   <span class="keywordflow">return</span> <a class="code" href="lbaselib_8c.html#a554228c65f0a0e43fdc2bbe75831a732">load_aux</a>(L, <a class="code" href="lauxlib_8c.html#a081c9ce214fcda6c19d13b7bf829360d">luaL_loadfile</a>(L, fname));
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 
<a name="l00317"></a>00317 
<a name="l00318"></a>00318 <span class="comment">/*</span>
<a name="l00319"></a>00319 <span class="comment">** Reader for generic `load&apos; function: `lua_load&apos; uses the</span>
<a name="l00320"></a>00320 <span class="comment">** stack for internal stuff, so the reader cannot change the</span>
<a name="l00321"></a>00321 <span class="comment">** stack top. Instead, it keeps its resulting string in a</span>
<a name="l00322"></a>00322 <span class="comment">** reserved slot inside the stack.</span>
<a name="l00323"></a>00323 <span class="comment">*/</span>
<a name="l00324"></a><a class="code" href="lbaselib_8c.html#ad467c787e381e8d18e4c7b46b4f1b05d">00324</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="lbaselib_8c.html#ad467c787e381e8d18e4c7b46b4f1b05d">generic_reader</a> (<a class="code" href="structlua__State.html">lua_State</a> *L, <span class="keywordtype">void</span> *ud, <span class="keywordtype">size_t</span> *size) {
<a name="l00325"></a>00325   (void)ud;  <span class="comment">/* to avoid warnings */</span>
<a name="l00326"></a>00326   <a class="code" href="lauxlib_8c.html#a18ce0d287377298929d5213dd15353ea">luaL_checkstack</a>(L, 2, <span class="stringliteral">&quot;too many nested functions&quot;</span>);
<a name="l00327"></a>00327   <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, 1);  <span class="comment">/* get function */</span>
<a name="l00328"></a>00328   <a class="code" href="lapi_8c.html#a2d80481ca28902752c2b12c61d9d4234">lua_call</a>(L, 0, 1);  <span class="comment">/* call it */</span>
<a name="l00329"></a>00329   <span class="keywordflow">if</span> (<a class="code" href="lua_8h.html#a86d737d7002e7e94023765397c6eef20">lua_isnil</a>(L, -1)) {
<a name="l00330"></a>00330     *size = 0;
<a name="l00331"></a>00331     <span class="keywordflow">return</span> NULL;
<a name="l00332"></a>00332   }
<a name="l00333"></a>00333   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="lapi_8c.html#a9f20233199a414b04c1c4b43f5d040f3">lua_isstring</a>(L, -1)) {
<a name="l00334"></a>00334     <a class="code" href="lapi_8c.html#a66d3827120ac828f870502bff0d4ff75">lua_replace</a>(L, 3);  <span class="comment">/* save string in a reserved stack slot */</span>
<a name="l00335"></a>00335     <span class="keywordflow">return</span> <a class="code" href="lapi_8c.html#a3fc7dbcac3f2610f3d687ec15343bd3f">lua_tolstring</a>(L, 3, size);
<a name="l00336"></a>00336   }
<a name="l00337"></a>00337   <span class="keywordflow">else</span> <a class="code" href="lauxlib_8c.html#a6c51d83d29244779392551388913e08a">luaL_error</a>(L, <span class="stringliteral">&quot;reader function must return a string&quot;</span>);
<a name="l00338"></a>00338   <span class="keywordflow">return</span> NULL;  <span class="comment">/* to avoid warnings */</span>
<a name="l00339"></a>00339 }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 
<a name="l00342"></a><a class="code" href="lbaselib_8c.html#a4a9a3613fcf80fe033e044f7e19bed69">00342</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a4a9a3613fcf80fe033e044f7e19bed69">luaB_load</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00343"></a>00343   <span class="keywordtype">int</span> status;
<a name="l00344"></a>00344   <span class="keyword">const</span> <span class="keywordtype">char</span> *cname = <a class="code" href="lauxlib_8h.html#a732bc5882c4a5da46b236649ab6db47b">luaL_optstring</a>(L, 2, <span class="stringliteral">&quot;=(load)&quot;</span>);
<a name="l00345"></a>00345   <a class="code" href="lauxlib_8c.html#a2289f14c4cd08df158f8894c87ed2c52">luaL_checktype</a>(L, 1, <a class="code" href="lua_8h.html#adaa7fa6e2561c1bc428ba8d265171494">LUA_TFUNCTION</a>);
<a name="l00346"></a>00346   <a class="code" href="lapi_8c.html#adaa30f0d34786144c94644039d1d1b6e">lua_settop</a>(L, 3);  <span class="comment">/* function, eventual name, plus one reserved slot */</span>
<a name="l00347"></a>00347   status = <a class="code" href="lapi_8c.html#a7318e2aab856e8f690ef62571d8afa8b">lua_load</a>(L, <a class="code" href="lbaselib_8c.html#ad467c787e381e8d18e4c7b46b4f1b05d">generic_reader</a>, NULL, cname);
<a name="l00348"></a>00348   <span class="keywordflow">return</span> <a class="code" href="lbaselib_8c.html#a554228c65f0a0e43fdc2bbe75831a732">load_aux</a>(L, status);
<a name="l00349"></a>00349 }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351 
<a name="l00352"></a><a class="code" href="lbaselib_8c.html#a86a4e35d9c9ad4661a0dbbac3758c049">00352</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a86a4e35d9c9ad4661a0dbbac3758c049">luaB_dofile</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00353"></a>00353   <span class="keyword">const</span> <span class="keywordtype">char</span> *fname = <a class="code" href="lauxlib_8h.html#a732bc5882c4a5da46b236649ab6db47b">luaL_optstring</a>(L, 1, NULL);
<a name="l00354"></a>00354   <span class="keywordtype">int</span> n = <a class="code" href="lapi_8c.html#afbb08ecb69421875494105d4de68e5bf">lua_gettop</a>(L);
<a name="l00355"></a>00355   <span class="keywordflow">if</span> (<a class="code" href="lauxlib_8c.html#a081c9ce214fcda6c19d13b7bf829360d">luaL_loadfile</a>(L, fname) != 0) <a class="code" href="lapi_8c.html#a6ba7b91143fe8a03910420d800de8e97">lua_error</a>(L);
<a name="l00356"></a>00356   <a class="code" href="lapi_8c.html#a2d80481ca28902752c2b12c61d9d4234">lua_call</a>(L, 0, <a class="code" href="lua_8h.html#ace3545adc11664c2f2b152fbe8b6283c">LUA_MULTRET</a>);
<a name="l00357"></a>00357   <span class="keywordflow">return</span> <a class="code" href="lapi_8c.html#afbb08ecb69421875494105d4de68e5bf">lua_gettop</a>(L) - n;
<a name="l00358"></a>00358 }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360 
<a name="l00361"></a><a class="code" href="lbaselib_8c.html#a8ba9378d5d46ef34a7429d52c3f3e4c7">00361</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a8ba9378d5d46ef34a7429d52c3f3e4c7">luaB_assert</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00362"></a>00362   <a class="code" href="lauxlib_8c.html#a801a6d587ffb8df1954f3275b64b0a5e">luaL_checkany</a>(L, 1);
<a name="l00363"></a>00363   <span class="keywordflow">if</span> (!<a class="code" href="lapi_8c.html#a444aee9aa56b0b06175ee3c7bcf7927c">lua_toboolean</a>(L, 1))
<a name="l00364"></a>00364     <span class="keywordflow">return</span> <a class="code" href="lauxlib_8c.html#a6c51d83d29244779392551388913e08a">luaL_error</a>(L, <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="lauxlib_8h.html#a732bc5882c4a5da46b236649ab6db47b">luaL_optstring</a>(L, 2, <span class="stringliteral">&quot;assertion failed!&quot;</span>));
<a name="l00365"></a>00365   <span class="keywordflow">return</span> <a class="code" href="lapi_8c.html#afbb08ecb69421875494105d4de68e5bf">lua_gettop</a>(L);
<a name="l00366"></a>00366 }
<a name="l00367"></a>00367 
<a name="l00368"></a>00368 
<a name="l00369"></a><a class="code" href="lbaselib_8c.html#ad85b57477f47b73d672a09578426212d">00369</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#ad85b57477f47b73d672a09578426212d">luaB_unpack</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00370"></a>00370   <span class="keywordtype">int</span> i, e, n;
<a name="l00371"></a>00371   <a class="code" href="lauxlib_8c.html#a2289f14c4cd08df158f8894c87ed2c52">luaL_checktype</a>(L, 1, <a class="code" href="lua_8h.html#a31620fd8da5b655b7879e16a116ec31a">LUA_TTABLE</a>);
<a name="l00372"></a>00372   i = <a class="code" href="lauxlib_8h.html#ab4d7f693e9405558c725783a756e0aca">luaL_optint</a>(L, 2, 1);
<a name="l00373"></a>00373   e = <a class="code" href="lauxlib_8h.html#aca033280b0176012ef290131876f706e">luaL_opt</a>(L, <a class="code" href="lauxlib_8h.html#adb277a5f654228b51b66f95bcf883601">luaL_checkint</a>, 3, <a class="code" href="lauxlib_8h.html#a0ef5c05520dabbaa65ecbade53e719fa">luaL_getn</a>(L, 1));
<a name="l00374"></a>00374   <span class="keywordflow">if</span> (i &gt; e) <span class="keywordflow">return</span> 0;  <span class="comment">/* empty range */</span>
<a name="l00375"></a>00375   n = e - i + 1;  <span class="comment">/* number of elements */</span>
<a name="l00376"></a>00376   <span class="keywordflow">if</span> (n &lt;= 0 || !<a class="code" href="lapi_8c.html#acea2383413b1e10bee681b109bad5b59">lua_checkstack</a>(L, n))  <span class="comment">/* n &lt;= 0 means arith. overflow */</span>
<a name="l00377"></a>00377     <span class="keywordflow">return</span> <a class="code" href="lauxlib_8c.html#a6c51d83d29244779392551388913e08a">luaL_error</a>(L, <span class="stringliteral">&quot;too many results to unpack&quot;</span>);
<a name="l00378"></a>00378   <a class="code" href="lapi_8c.html#ae37bc3e2991700913a74d2b656442520">lua_rawgeti</a>(L, 1, i);  <span class="comment">/* push arg[i] (avoiding overflow problems) */</span>
<a name="l00379"></a>00379   <span class="keywordflow">while</span> (i++ &lt; e)  <span class="comment">/* push arg[i + 1...e] */</span>
<a name="l00380"></a>00380     <a class="code" href="lapi_8c.html#ae37bc3e2991700913a74d2b656442520">lua_rawgeti</a>(L, 1, i);
<a name="l00381"></a>00381   <span class="keywordflow">return</span> n;
<a name="l00382"></a>00382 }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384 
<a name="l00385"></a><a class="code" href="lbaselib_8c.html#ac2909062d4ac2b0396c640407e5b19d8">00385</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#ac2909062d4ac2b0396c640407e5b19d8">luaB_select</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00386"></a>00386   <span class="keywordtype">int</span> n = <a class="code" href="lapi_8c.html#afbb08ecb69421875494105d4de68e5bf">lua_gettop</a>(L);
<a name="l00387"></a>00387   <span class="keywordflow">if</span> (<a class="code" href="lapi_8c.html#a652b273947f0656686f998d8e90cd3ea">lua_type</a>(L, 1) == <a class="code" href="lua_8h.html#a57de20d87bb5131a3159f2bd52e3fab6">LUA_TSTRING</a> &amp;&amp; *<a class="code" href="lua_8h.html#ac813fc3bc1886ba17c363d5b4c6e7ef1">lua_tostring</a>(L, 1) == <span class="charliteral">&apos;#&apos;</span>) {
<a name="l00388"></a>00388     <a class="code" href="lapi_8c.html#adcec46ff05dfee9a3c4c05828b40c213">lua_pushinteger</a>(L, n-1);
<a name="l00389"></a>00389     <span class="keywordflow">return</span> 1;
<a name="l00390"></a>00390   }
<a name="l00391"></a>00391   <span class="keywordflow">else</span> {
<a name="l00392"></a>00392     <span class="keywordtype">int</span> i = <a class="code" href="lauxlib_8h.html#adb277a5f654228b51b66f95bcf883601">luaL_checkint</a>(L, 1);
<a name="l00393"></a>00393     <span class="keywordflow">if</span> (i &lt; 0) i = n + i;
<a name="l00394"></a>00394     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i &gt; n) i = n;
<a name="l00395"></a>00395     <a class="code" href="lauxlib_8h.html#afe2e3018d561c14f2622fb32f425c111">luaL_argcheck</a>(L, 1 &lt;= i, 1, <span class="stringliteral">&quot;index out of range&quot;</span>);
<a name="l00396"></a>00396     <span class="keywordflow">return</span> n - i;
<a name="l00397"></a>00397   }
<a name="l00398"></a>00398 }
<a name="l00399"></a>00399 
<a name="l00400"></a>00400 
<a name="l00401"></a><a class="code" href="lbaselib_8c.html#a1fb2725eed679431d070b2e9e7abc223">00401</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a1fb2725eed679431d070b2e9e7abc223">luaB_pcall</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00402"></a>00402   <span class="keywordtype">int</span> status;
<a name="l00403"></a>00403   <a class="code" href="lauxlib_8c.html#a801a6d587ffb8df1954f3275b64b0a5e">luaL_checkany</a>(L, 1);
<a name="l00404"></a>00404   status = <a class="code" href="lapi_8c.html#a2a6cbad7f1c567378d17ded68b47f8f3">lua_pcall</a>(L, <a class="code" href="lapi_8c.html#afbb08ecb69421875494105d4de68e5bf">lua_gettop</a>(L) - 1, <a class="code" href="lua_8h.html#ace3545adc11664c2f2b152fbe8b6283c">LUA_MULTRET</a>, 0);
<a name="l00405"></a>00405   <a class="code" href="lapi_8c.html#a56bbb7479265e38da2e2596e6ec25faa">lua_pushboolean</a>(L, (status == 0));
<a name="l00406"></a>00406   <a class="code" href="lapi_8c.html#aba6844115e26e0923488403436219e66">lua_insert</a>(L, 1);
<a name="l00407"></a>00407   <span class="keywordflow">return</span> <a class="code" href="lapi_8c.html#afbb08ecb69421875494105d4de68e5bf">lua_gettop</a>(L);  <span class="comment">/* return status + all results */</span>
<a name="l00408"></a>00408 }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410 
<a name="l00411"></a><a class="code" href="lbaselib_8c.html#a5fbb0094fa1a56f0a4c2547f1ec4c5ab">00411</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a5fbb0094fa1a56f0a4c2547f1ec4c5ab">luaB_xpcall</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00412"></a>00412   <span class="keywordtype">int</span> status;
<a name="l00413"></a>00413   <a class="code" href="lauxlib_8c.html#a801a6d587ffb8df1954f3275b64b0a5e">luaL_checkany</a>(L, 2);
<a name="l00414"></a>00414   <a class="code" href="lapi_8c.html#adaa30f0d34786144c94644039d1d1b6e">lua_settop</a>(L, 2);
<a name="l00415"></a>00415   <a class="code" href="lapi_8c.html#aba6844115e26e0923488403436219e66">lua_insert</a>(L, 1);  <span class="comment">/* put error function under function to be called */</span>
<a name="l00416"></a>00416   status = <a class="code" href="lapi_8c.html#a2a6cbad7f1c567378d17ded68b47f8f3">lua_pcall</a>(L, 0, <a class="code" href="lua_8h.html#ace3545adc11664c2f2b152fbe8b6283c">LUA_MULTRET</a>, 1);
<a name="l00417"></a>00417   <a class="code" href="lapi_8c.html#a56bbb7479265e38da2e2596e6ec25faa">lua_pushboolean</a>(L, (status == 0));
<a name="l00418"></a>00418   <a class="code" href="lapi_8c.html#a66d3827120ac828f870502bff0d4ff75">lua_replace</a>(L, 1);
<a name="l00419"></a>00419   <span class="keywordflow">return</span> <a class="code" href="lapi_8c.html#afbb08ecb69421875494105d4de68e5bf">lua_gettop</a>(L);  <span class="comment">/* return status + all results */</span>
<a name="l00420"></a>00420 }
<a name="l00421"></a>00421 
<a name="l00422"></a>00422 
<a name="l00423"></a><a class="code" href="lbaselib_8c.html#a15bd8ce3f719c87883bcb578c60677e7">00423</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a15bd8ce3f719c87883bcb578c60677e7">luaB_tostring</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00424"></a>00424   <a class="code" href="lauxlib_8c.html#a801a6d587ffb8df1954f3275b64b0a5e">luaL_checkany</a>(L, 1);
<a name="l00425"></a>00425   <span class="keywordflow">if</span> (<a class="code" href="lauxlib_8c.html#abfb23747df76e74d28ac48dabda0c3e1">luaL_callmeta</a>(L, 1, <span class="stringliteral">&quot;__tostring&quot;</span>))  <span class="comment">/* is there a metafield? */</span>
<a name="l00426"></a>00426     <span class="keywordflow">return</span> 1;  <span class="comment">/* use its value */</span>
<a name="l00427"></a>00427   <span class="keywordflow">switch</span> (<a class="code" href="lapi_8c.html#a652b273947f0656686f998d8e90cd3ea">lua_type</a>(L, 1)) {
<a name="l00428"></a>00428     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#a7f62ecb240cb38da9c8a53b41fe21ed9">LUA_TNUMBER</a>:
<a name="l00429"></a>00429       <a class="code" href="lapi_8c.html#a1281a7e2b52370cc416123bfd32b1b29">lua_pushstring</a>(L, <a class="code" href="lua_8h.html#ac813fc3bc1886ba17c363d5b4c6e7ef1">lua_tostring</a>(L, 1));
<a name="l00430"></a>00430       <span class="keywordflow">break</span>;
<a name="l00431"></a>00431     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#a57de20d87bb5131a3159f2bd52e3fab6">LUA_TSTRING</a>:
<a name="l00432"></a>00432       <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, 1);
<a name="l00433"></a>00433       <span class="keywordflow">break</span>;
<a name="l00434"></a>00434     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#a611808ed12d4c2aee2a9e298a9d9a9bf">LUA_TBOOLEAN</a>:
<a name="l00435"></a>00435       <a class="code" href="lapi_8c.html#a1281a7e2b52370cc416123bfd32b1b29">lua_pushstring</a>(L, (<a class="code" href="lapi_8c.html#a444aee9aa56b0b06175ee3c7bcf7927c">lua_toboolean</a>(L, 1) ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>));
<a name="l00436"></a>00436       <span class="keywordflow">break</span>;
<a name="l00437"></a>00437     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#ae38a6fb8c687b8bfab211b7675a695ef">LUA_TNIL</a>:
<a name="l00438"></a>00438       <a class="code" href="lua_8h.html#a47854189a679002ed743ebbcb30b1b26">lua_pushliteral</a>(L, <span class="stringliteral">&quot;nil&quot;</span>);
<a name="l00439"></a>00439       <span class="keywordflow">break</span>;
<a name="l00440"></a>00440     <span class="keywordflow">default</span>:
<a name="l00441"></a>00441       <a class="code" href="lapi_8c.html#ab190c226d38b289e6ca57683a9d4e0f0">lua_pushfstring</a>(L, <span class="stringliteral">&quot;%s: %p&quot;</span>, <a class="code" href="lauxlib_8h.html#a2bee94954917c5bccb05d6578f3c675b">luaL_typename</a>(L, 1), <a class="code" href="lapi_8c.html#a5b533fe96cb52b5415896d41daad374a">lua_topointer</a>(L, 1));
<a name="l00442"></a>00442       <span class="keywordflow">break</span>;
<a name="l00443"></a>00443   }
<a name="l00444"></a>00444   <span class="keywordflow">return</span> 1;
<a name="l00445"></a>00445 }
<a name="l00446"></a>00446 
<a name="l00447"></a>00447 
<a name="l00448"></a><a class="code" href="lbaselib_8c.html#a7f593a7d28596bdce0d8c8525e180dd5">00448</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a7f593a7d28596bdce0d8c8525e180dd5">luaB_newproxy</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00449"></a>00449   <a class="code" href="lapi_8c.html#adaa30f0d34786144c94644039d1d1b6e">lua_settop</a>(L, 1);
<a name="l00450"></a>00450   <a class="code" href="lapi_8c.html#a467bb6f4780b27d6e7de6ee10a80dac5">lua_newuserdata</a>(L, 0);  <span class="comment">/* create proxy */</span>
<a name="l00451"></a>00451   <span class="keywordflow">if</span> (<a class="code" href="lapi_8c.html#a444aee9aa56b0b06175ee3c7bcf7927c">lua_toboolean</a>(L, 1) == 0)
<a name="l00452"></a>00452     <span class="keywordflow">return</span> 1;  <span class="comment">/* no metatable */</span>
<a name="l00453"></a>00453   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="lua_8h.html#af4f579ead7d5ea837d8d708186033502">lua_isboolean</a>(L, 1)) {
<a name="l00454"></a>00454     <a class="code" href="lua_8h.html#aa59db6b784aa1ec954599a44168c7761">lua_newtable</a>(L);  <span class="comment">/* create a new metatable `m&apos; ... */</span>
<a name="l00455"></a>00455     <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, -1);  <span class="comment">/* ... and mark `m&apos; as a valid metatable */</span>
<a name="l00456"></a>00456     <a class="code" href="lapi_8c.html#a56bbb7479265e38da2e2596e6ec25faa">lua_pushboolean</a>(L, 1);
<a name="l00457"></a>00457     <a class="code" href="lapi_8c.html#afb2d27f421677ef40425f9054ae216a7">lua_rawset</a>(L, <a class="code" href="lua_8h.html#ac3aa6665c25070f282c9827ec919fe6a">lua_upvalueindex</a>(1));  <span class="comment">/* weaktable[m] = true */</span>
<a name="l00458"></a>00458   }
<a name="l00459"></a>00459   <span class="keywordflow">else</span> {
<a name="l00460"></a>00460     <span class="keywordtype">int</span> validproxy = 0;  <span class="comment">/* to check if weaktable[metatable(u)] == true */</span>
<a name="l00461"></a>00461     <span class="keywordflow">if</span> (<a class="code" href="lapi_8c.html#a4caa9ca5e47a30bd45e33d83bf2d6d6e">lua_getmetatable</a>(L, 1)) {
<a name="l00462"></a>00462       <a class="code" href="lapi_8c.html#a43379a0ba1fb68a4c81d205ad60b3cc1">lua_rawget</a>(L, <a class="code" href="lua_8h.html#ac3aa6665c25070f282c9827ec919fe6a">lua_upvalueindex</a>(1));
<a name="l00463"></a>00463       validproxy = <a class="code" href="lapi_8c.html#a444aee9aa56b0b06175ee3c7bcf7927c">lua_toboolean</a>(L, -1);
<a name="l00464"></a>00464       <a class="code" href="lua_8h.html#abb8eae2164badeafdb037bc1e03cc822">lua_pop</a>(L, 1);  <span class="comment">/* remove value */</span>
<a name="l00465"></a>00465     }
<a name="l00466"></a>00466     <a class="code" href="lauxlib_8h.html#afe2e3018d561c14f2622fb32f425c111">luaL_argcheck</a>(L, validproxy, 1, <span class="stringliteral">&quot;boolean or proxy expected&quot;</span>);
<a name="l00467"></a>00467     <a class="code" href="lapi_8c.html#a4caa9ca5e47a30bd45e33d83bf2d6d6e">lua_getmetatable</a>(L, 1);  <span class="comment">/* metatable is valid; get it */</span>
<a name="l00468"></a>00468   }
<a name="l00469"></a>00469   <a class="code" href="lapi_8c.html#a15719ea4119bdf5b3f2a406534431a7e">lua_setmetatable</a>(L, 2);
<a name="l00470"></a>00470   <span class="keywordflow">return</span> 1;
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 
<a name="l00474"></a><a class="code" href="lbaselib_8c.html#a0d05e830245692a51489fe27e499c17b">00474</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structluaL__Reg.html">luaL_Reg</a> <a class="code" href="lbaselib_8c.html#a0d05e830245692a51489fe27e499c17b">base_funcs</a>[] = {
<a name="l00475"></a>00475   {<span class="stringliteral">&quot;assert&quot;</span>, <a class="code" href="lbaselib_8c.html#a8ba9378d5d46ef34a7429d52c3f3e4c7">luaB_assert</a>},
<a name="l00476"></a>00476   {<span class="stringliteral">&quot;collectgarbage&quot;</span>, <a class="code" href="lbaselib_8c.html#a07f71966c943cc9761ab129f64d4ac80">luaB_collectgarbage</a>},
<a name="l00477"></a>00477   {<span class="stringliteral">&quot;dofile&quot;</span>, <a class="code" href="lbaselib_8c.html#a86a4e35d9c9ad4661a0dbbac3758c049">luaB_dofile</a>},
<a name="l00478"></a>00478   {<span class="stringliteral">&quot;error&quot;</span>, <a class="code" href="lbaselib_8c.html#a2ecfa987569d0b4c1063f3e204e42dd2">luaB_error</a>},
<a name="l00479"></a>00479   {<span class="stringliteral">&quot;gcinfo&quot;</span>, <a class="code" href="lbaselib_8c.html#aa30f77b7aaae8bda70dbb246edf7ea96">luaB_gcinfo</a>},
<a name="l00480"></a>00480   {<span class="stringliteral">&quot;getfenv&quot;</span>, <a class="code" href="lbaselib_8c.html#ab43e01e3a4ccb3cc7cc9ace8f38d1ba6">luaB_getfenv</a>},
<a name="l00481"></a>00481   {<span class="stringliteral">&quot;getmetatable&quot;</span>, <a class="code" href="lbaselib_8c.html#addfd66adcbe4c777cf5e10536d27d8b1">luaB_getmetatable</a>},
<a name="l00482"></a>00482   {<span class="stringliteral">&quot;loadfile&quot;</span>, <a class="code" href="lbaselib_8c.html#aeb4cb83db820979bbdd7710109b52957">luaB_loadfile</a>},
<a name="l00483"></a>00483   {<span class="stringliteral">&quot;load&quot;</span>, <a class="code" href="lbaselib_8c.html#a4a9a3613fcf80fe033e044f7e19bed69">luaB_load</a>},
<a name="l00484"></a>00484   {<span class="stringliteral">&quot;loadstring&quot;</span>, <a class="code" href="lbaselib_8c.html#aedd88ec0159e7891314aa32c540b35a0">luaB_loadstring</a>},
<a name="l00485"></a>00485   {<span class="stringliteral">&quot;next&quot;</span>, <a class="code" href="lbaselib_8c.html#ac0b11ecf3ced275821aaf5a03ed33b02">luaB_next</a>},
<a name="l00486"></a>00486   {<span class="stringliteral">&quot;pcall&quot;</span>, <a class="code" href="lbaselib_8c.html#a1fb2725eed679431d070b2e9e7abc223">luaB_pcall</a>},
<a name="l00487"></a>00487   {<span class="stringliteral">&quot;print&quot;</span>, <a class="code" href="lbaselib_8c.html#a865eb761a305c588d6940da5272375b7">luaB_print</a>},
<a name="l00488"></a>00488   {<span class="stringliteral">&quot;rawequal&quot;</span>, <a class="code" href="lbaselib_8c.html#a4dbd4fb89ec70a7b07cad52f7c13e637">luaB_rawequal</a>},
<a name="l00489"></a>00489   {<span class="stringliteral">&quot;rawget&quot;</span>, <a class="code" href="lbaselib_8c.html#a248a6847a33f31c69a43a76b6b8bcb4b">luaB_rawget</a>},
<a name="l00490"></a>00490   {<span class="stringliteral">&quot;rawset&quot;</span>, <a class="code" href="lbaselib_8c.html#a7b7225051c25127792f30eadd3498cc3">luaB_rawset</a>},
<a name="l00491"></a>00491   {<span class="stringliteral">&quot;select&quot;</span>, <a class="code" href="lbaselib_8c.html#ac2909062d4ac2b0396c640407e5b19d8">luaB_select</a>},
<a name="l00492"></a>00492   {<span class="stringliteral">&quot;setfenv&quot;</span>, <a class="code" href="lbaselib_8c.html#ad0768dadbffb2928eb6961c4aaa2c27b">luaB_setfenv</a>},
<a name="l00493"></a>00493   {<span class="stringliteral">&quot;setmetatable&quot;</span>, <a class="code" href="lbaselib_8c.html#af7799a987ba6d158a96a52e80fb5beaf">luaB_setmetatable</a>},
<a name="l00494"></a>00494   {<span class="stringliteral">&quot;tonumber&quot;</span>, <a class="code" href="lbaselib_8c.html#a6224f7b7c4485996e1c22eae32de990d">luaB_tonumber</a>},
<a name="l00495"></a>00495   {<span class="stringliteral">&quot;tostring&quot;</span>, <a class="code" href="lbaselib_8c.html#a15bd8ce3f719c87883bcb578c60677e7">luaB_tostring</a>},
<a name="l00496"></a>00496   {<span class="stringliteral">&quot;type&quot;</span>, <a class="code" href="lbaselib_8c.html#a7135b660cac1e25a2854acd9849cd4a4">luaB_type</a>},
<a name="l00497"></a>00497   {<span class="stringliteral">&quot;unpack&quot;</span>, <a class="code" href="lbaselib_8c.html#ad85b57477f47b73d672a09578426212d">luaB_unpack</a>},
<a name="l00498"></a>00498   {<span class="stringliteral">&quot;xpcall&quot;</span>, <a class="code" href="lbaselib_8c.html#a5fbb0094fa1a56f0a4c2547f1ec4c5ab">luaB_xpcall</a>},
<a name="l00499"></a>00499   {NULL, NULL}
<a name="l00500"></a>00500 };
<a name="l00501"></a>00501 
<a name="l00502"></a>00502 
<a name="l00503"></a>00503 <span class="comment">/*</span>
<a name="l00504"></a>00504 <span class="comment">** {======================================================</span>
<a name="l00505"></a>00505 <span class="comment">** Coroutine library</span>
<a name="l00506"></a>00506 <span class="comment">** =======================================================</span>
<a name="l00507"></a>00507 <span class="comment">*/</span>
<a name="l00508"></a>00508 
<a name="l00509"></a><a class="code" href="lbaselib_8c.html#a095308213b4a84b48cacee1550a97b2c">00509</a> <span class="preprocessor">#define CO_RUN  0 </span><span class="comment">/* running */</span>
<a name="l00510"></a><a class="code" href="lbaselib_8c.html#ac6e11dbd4e153a636e7579b1d683477e">00510</a> <span class="preprocessor">#define CO_SUS  1 </span><span class="comment">/* suspended */</span>
<a name="l00511"></a><a class="code" href="lbaselib_8c.html#a2bd87dc8dce4c6fcdf2a7707d1db12ac">00511</a> <span class="preprocessor">#define CO_NOR  2 </span><span class="comment">/* &apos;normal&apos; (it resumed another coroutine) */</span>
<a name="l00512"></a><a class="code" href="lbaselib_8c.html#a2b20818a9aa286f7b0944c4eef472ce6">00512</a> <span class="preprocessor">#define CO_DEAD 3</span>
<a name="l00513"></a>00513 <span class="preprocessor"></span>
<a name="l00514"></a><a class="code" href="lbaselib_8c.html#a478d1bb5cc50ba2fdf4c7470cac13c77">00514</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> <a class="code" href="lbaselib_8c.html#a478d1bb5cc50ba2fdf4c7470cac13c77">statnames</a>[] =
<a name="l00515"></a>00515     {<span class="stringliteral">&quot;running&quot;</span>, <span class="stringliteral">&quot;suspended&quot;</span>, <span class="stringliteral">&quot;normal&quot;</span>, <span class="stringliteral">&quot;dead&quot;</span>};
<a name="l00516"></a>00516 
<a name="l00517"></a><a class="code" href="lbaselib_8c.html#ae36236fdd65e5ba60e521fd3b5cf4f94">00517</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#ae36236fdd65e5ba60e521fd3b5cf4f94">costatus</a> (<a class="code" href="structlua__State.html">lua_State</a> *L, <a class="code" href="structlua__State.html">lua_State</a> *co) {
<a name="l00518"></a>00518   <span class="keywordflow">if</span> (L == co) <span class="keywordflow">return</span> <a class="code" href="lbaselib_8c.html#a095308213b4a84b48cacee1550a97b2c">CO_RUN</a>;
<a name="l00519"></a>00519   <span class="keywordflow">switch</span> (<a class="code" href="lapi_8c.html#aadea4b6f60174a1334ebde560968a615">lua_status</a>(co)) {
<a name="l00520"></a>00520     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#ab69f4bd0c0693d4c8fcfc0ebaeb2806b">LUA_YIELD</a>:
<a name="l00521"></a>00521       <span class="keywordflow">return</span> <a class="code" href="lbaselib_8c.html#ac6e11dbd4e153a636e7579b1d683477e">CO_SUS</a>;
<a name="l00522"></a>00522     <span class="keywordflow">case</span> 0: {
<a name="l00523"></a>00523       <a class="code" href="structlua__Debug.html">lua_Debug</a> ar;
<a name="l00524"></a>00524       <span class="keywordflow">if</span> (<a class="code" href="ldebug_8c.html#ac1fc03c27ee46caa4037df2d70f22110">lua_getstack</a>(co, 0, &amp;ar) &gt; 0)  <span class="comment">/* does it have frames? */</span>
<a name="l00525"></a>00525         <span class="keywordflow">return</span> <a class="code" href="lbaselib_8c.html#a2bd87dc8dce4c6fcdf2a7707d1db12ac">CO_NOR</a>;  <span class="comment">/* it is running */</span>
<a name="l00526"></a>00526       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="lapi_8c.html#afbb08ecb69421875494105d4de68e5bf">lua_gettop</a>(co) == 0)
<a name="l00527"></a>00527           <span class="keywordflow">return</span> <a class="code" href="lbaselib_8c.html#a2b20818a9aa286f7b0944c4eef472ce6">CO_DEAD</a>;
<a name="l00528"></a>00528       <span class="keywordflow">else</span>
<a name="l00529"></a>00529         <span class="keywordflow">return</span> <a class="code" href="lbaselib_8c.html#ac6e11dbd4e153a636e7579b1d683477e">CO_SUS</a>;  <span class="comment">/* initial state */</span>
<a name="l00530"></a>00530     }
<a name="l00531"></a>00531     <span class="keywordflow">default</span>:  <span class="comment">/* some error occured */</span>
<a name="l00532"></a>00532       <span class="keywordflow">return</span> <a class="code" href="lbaselib_8c.html#a2b20818a9aa286f7b0944c4eef472ce6">CO_DEAD</a>;
<a name="l00533"></a>00533   }
<a name="l00534"></a>00534 }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536 
<a name="l00537"></a><a class="code" href="lbaselib_8c.html#a174dfb2852a7d04964e4a1426fff93f8">00537</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a174dfb2852a7d04964e4a1426fff93f8">luaB_costatus</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00538"></a>00538   <a class="code" href="structlua__State.html">lua_State</a> *co = <a class="code" href="lapi_8c.html#ad1dcea410edb5c5595fc070f8bf2e9a0">lua_tothread</a>(L, 1);
<a name="l00539"></a>00539   <a class="code" href="lauxlib_8h.html#afe2e3018d561c14f2622fb32f425c111">luaL_argcheck</a>(L, co, 1, <span class="stringliteral">&quot;coroutine expected&quot;</span>);
<a name="l00540"></a>00540   <a class="code" href="lapi_8c.html#a1281a7e2b52370cc416123bfd32b1b29">lua_pushstring</a>(L, <a class="code" href="lbaselib_8c.html#a478d1bb5cc50ba2fdf4c7470cac13c77">statnames</a>[<a class="code" href="lbaselib_8c.html#ae36236fdd65e5ba60e521fd3b5cf4f94">costatus</a>(L, co)]);
<a name="l00541"></a>00541   <span class="keywordflow">return</span> 1;
<a name="l00542"></a>00542 }
<a name="l00543"></a>00543 
<a name="l00544"></a>00544 
<a name="l00545"></a><a class="code" href="lbaselib_8c.html#aaa37b3a30ab0c6daef7fae8951fef3e7">00545</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#aaa37b3a30ab0c6daef7fae8951fef3e7">auxresume</a> (<a class="code" href="structlua__State.html">lua_State</a> *L, <a class="code" href="structlua__State.html">lua_State</a> *co, <span class="keywordtype">int</span> narg) {
<a name="l00546"></a>00546   <span class="keywordtype">int</span> status = <a class="code" href="lbaselib_8c.html#ae36236fdd65e5ba60e521fd3b5cf4f94">costatus</a>(L, co);
<a name="l00547"></a>00547   <span class="keywordflow">if</span> (!<a class="code" href="lapi_8c.html#acea2383413b1e10bee681b109bad5b59">lua_checkstack</a>(co, narg))
<a name="l00548"></a>00548     <a class="code" href="lauxlib_8c.html#a6c51d83d29244779392551388913e08a">luaL_error</a>(L, <span class="stringliteral">&quot;too many arguments to resume&quot;</span>);
<a name="l00549"></a>00549   <span class="keywordflow">if</span> (status != <a class="code" href="lbaselib_8c.html#ac6e11dbd4e153a636e7579b1d683477e">CO_SUS</a>) {
<a name="l00550"></a>00550     <a class="code" href="lapi_8c.html#ab190c226d38b289e6ca57683a9d4e0f0">lua_pushfstring</a>(L, <span class="stringliteral">&quot;cannot resume %s coroutine&quot;</span>, <a class="code" href="lbaselib_8c.html#a478d1bb5cc50ba2fdf4c7470cac13c77">statnames</a>[status]);
<a name="l00551"></a>00551     <span class="keywordflow">return</span> -1;  <span class="comment">/* error flag */</span>
<a name="l00552"></a>00552   }
<a name="l00553"></a>00553   <a class="code" href="lapi_8c.html#ae27bb8d0218710bbbfefc1f573839d6d">lua_xmove</a>(L, co, narg);
<a name="l00554"></a>00554   <a class="code" href="lapi_8c.html#a23ba67a2597f1bce7e408f44ff5bc4f4">lua_setlevel</a>(L, co);
<a name="l00555"></a>00555   status = <a class="code" href="ldo_8c.html#a98c5a7666ee815cadd261cd1b8c09a13">lua_resume</a>(co, narg);
<a name="l00556"></a>00556   <span class="keywordflow">if</span> (status == 0 || status == <a class="code" href="lua_8h.html#ab69f4bd0c0693d4c8fcfc0ebaeb2806b">LUA_YIELD</a>) {
<a name="l00557"></a>00557     <span class="keywordtype">int</span> nres = <a class="code" href="lapi_8c.html#afbb08ecb69421875494105d4de68e5bf">lua_gettop</a>(co);
<a name="l00558"></a>00558     <span class="keywordflow">if</span> (!<a class="code" href="lapi_8c.html#acea2383413b1e10bee681b109bad5b59">lua_checkstack</a>(L, nres + 1))
<a name="l00559"></a>00559       <a class="code" href="lauxlib_8c.html#a6c51d83d29244779392551388913e08a">luaL_error</a>(L, <span class="stringliteral">&quot;too many results to resume&quot;</span>);
<a name="l00560"></a>00560     <a class="code" href="lapi_8c.html#ae27bb8d0218710bbbfefc1f573839d6d">lua_xmove</a>(co, L, nres);  <span class="comment">/* move yielded values */</span>
<a name="l00561"></a>00561     <span class="keywordflow">return</span> nres;
<a name="l00562"></a>00562   }
<a name="l00563"></a>00563   <span class="keywordflow">else</span> {
<a name="l00564"></a>00564     <a class="code" href="lapi_8c.html#ae27bb8d0218710bbbfefc1f573839d6d">lua_xmove</a>(co, L, 1);  <span class="comment">/* move error message */</span>
<a name="l00565"></a>00565     <span class="keywordflow">return</span> -1;  <span class="comment">/* error flag */</span>
<a name="l00566"></a>00566   }
<a name="l00567"></a>00567 }
<a name="l00568"></a>00568 
<a name="l00569"></a>00569 
<a name="l00570"></a><a class="code" href="lbaselib_8c.html#a76f5d80387eeb1c7d31eb5f9cb6c9392">00570</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a76f5d80387eeb1c7d31eb5f9cb6c9392">luaB_coresume</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00571"></a>00571   <a class="code" href="structlua__State.html">lua_State</a> *co = <a class="code" href="lapi_8c.html#ad1dcea410edb5c5595fc070f8bf2e9a0">lua_tothread</a>(L, 1);
<a name="l00572"></a>00572   <span class="keywordtype">int</span> r;
<a name="l00573"></a>00573   <a class="code" href="lauxlib_8h.html#afe2e3018d561c14f2622fb32f425c111">luaL_argcheck</a>(L, co, 1, <span class="stringliteral">&quot;coroutine expected&quot;</span>);
<a name="l00574"></a>00574   r = <a class="code" href="lbaselib_8c.html#aaa37b3a30ab0c6daef7fae8951fef3e7">auxresume</a>(L, co, <a class="code" href="lapi_8c.html#afbb08ecb69421875494105d4de68e5bf">lua_gettop</a>(L) - 1);
<a name="l00575"></a>00575   <span class="keywordflow">if</span> (r &lt; 0) {
<a name="l00576"></a>00576     <a class="code" href="lapi_8c.html#a56bbb7479265e38da2e2596e6ec25faa">lua_pushboolean</a>(L, 0);
<a name="l00577"></a>00577     <a class="code" href="lapi_8c.html#aba6844115e26e0923488403436219e66">lua_insert</a>(L, -2);
<a name="l00578"></a>00578     <span class="keywordflow">return</span> 2;  <span class="comment">/* return false + error message */</span>
<a name="l00579"></a>00579   }
<a name="l00580"></a>00580   <span class="keywordflow">else</span> {
<a name="l00581"></a>00581     <a class="code" href="lapi_8c.html#a56bbb7479265e38da2e2596e6ec25faa">lua_pushboolean</a>(L, 1);
<a name="l00582"></a>00582     <a class="code" href="lapi_8c.html#aba6844115e26e0923488403436219e66">lua_insert</a>(L, -(r + 1));
<a name="l00583"></a>00583     <span class="keywordflow">return</span> r + 1;  <span class="comment">/* return true + `resume&apos; returns */</span>
<a name="l00584"></a>00584   }
<a name="l00585"></a>00585 }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587 
<a name="l00588"></a><a class="code" href="lbaselib_8c.html#a777abb20385a69ce4787f72bd90375a7">00588</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a777abb20385a69ce4787f72bd90375a7">luaB_auxwrap</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00589"></a>00589   <a class="code" href="structlua__State.html">lua_State</a> *co = <a class="code" href="lapi_8c.html#ad1dcea410edb5c5595fc070f8bf2e9a0">lua_tothread</a>(L, <a class="code" href="lua_8h.html#ac3aa6665c25070f282c9827ec919fe6a">lua_upvalueindex</a>(1));
<a name="l00590"></a>00590   <span class="keywordtype">int</span> r = <a class="code" href="lbaselib_8c.html#aaa37b3a30ab0c6daef7fae8951fef3e7">auxresume</a>(L, co, <a class="code" href="lapi_8c.html#afbb08ecb69421875494105d4de68e5bf">lua_gettop</a>(L));
<a name="l00591"></a>00591   <span class="keywordflow">if</span> (r &lt; 0) {
<a name="l00592"></a>00592     <span class="keywordflow">if</span> (<a class="code" href="lapi_8c.html#a9f20233199a414b04c1c4b43f5d040f3">lua_isstring</a>(L, -1)) {  <span class="comment">/* error object is a string? */</span>
<a name="l00593"></a>00593       <a class="code" href="lauxlib_8c.html#a0f4d3c30c07eae36aa25605df84279a0">luaL_where</a>(L, 1);  <span class="comment">/* add extra info */</span>
<a name="l00594"></a>00594       <a class="code" href="lapi_8c.html#aba6844115e26e0923488403436219e66">lua_insert</a>(L, -2);
<a name="l00595"></a>00595       <a class="code" href="lapi_8c.html#a1de3afee1daece63d455f23818c883d9">lua_concat</a>(L, 2);
<a name="l00596"></a>00596     }
<a name="l00597"></a>00597     <a class="code" href="lapi_8c.html#a6ba7b91143fe8a03910420d800de8e97">lua_error</a>(L);  <span class="comment">/* propagate error */</span>
<a name="l00598"></a>00598   }
<a name="l00599"></a>00599   <span class="keywordflow">return</span> r;
<a name="l00600"></a>00600 }
<a name="l00601"></a>00601 
<a name="l00602"></a>00602 
<a name="l00603"></a><a class="code" href="lbaselib_8c.html#ad49772e236781ef7ad88ff8bc980b40b">00603</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#ad49772e236781ef7ad88ff8bc980b40b">luaB_cocreate</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00604"></a>00604   <a class="code" href="structlua__State.html">lua_State</a> *NL = <a class="code" href="lapi_8c.html#a86b660d6f2b69734c35ec9fc718e4ca9">lua_newthread</a>(L);
<a name="l00605"></a>00605   <a class="code" href="lauxlib_8h.html#afe2e3018d561c14f2622fb32f425c111">luaL_argcheck</a>(L, <a class="code" href="lua_8h.html#a7537af276c81906c144f29cd25b93315">lua_isfunction</a>(L, 1) &amp;&amp; !<a class="code" href="lapi_8c.html#a3b922032c9fe2930399186a3647cc3ad">lua_iscfunction</a>(L, 1), 1,
<a name="l00606"></a>00606     <span class="stringliteral">&quot;Lua function expected&quot;</span>);
<a name="l00607"></a>00607   <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, 1);  <span class="comment">/* move function to top */</span>
<a name="l00608"></a>00608   <a class="code" href="lapi_8c.html#ae27bb8d0218710bbbfefc1f573839d6d">lua_xmove</a>(L, NL, 1);  <span class="comment">/* move function from L to NL */</span>
<a name="l00609"></a>00609   <span class="keywordflow">return</span> 1;
<a name="l00610"></a>00610 }
<a name="l00611"></a>00611 
<a name="l00612"></a>00612 
<a name="l00613"></a><a class="code" href="lbaselib_8c.html#a1c0429e27f504b08e25f437f733edad1">00613</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a1c0429e27f504b08e25f437f733edad1">luaB_cowrap</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00614"></a>00614   <a class="code" href="lbaselib_8c.html#ad49772e236781ef7ad88ff8bc980b40b">luaB_cocreate</a>(L);
<a name="l00615"></a>00615   <a class="code" href="lapi_8c.html#a142802b91cdd22516b54599f51e101e4">lua_pushcclosure</a>(L, <a class="code" href="lbaselib_8c.html#a777abb20385a69ce4787f72bd90375a7">luaB_auxwrap</a>, 1);
<a name="l00616"></a>00616   <span class="keywordflow">return</span> 1;
<a name="l00617"></a>00617 }
<a name="l00618"></a>00618 
<a name="l00619"></a>00619 
<a name="l00620"></a><a class="code" href="lbaselib_8c.html#ad9fe432026d8990d13be09536a683c2a">00620</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#ad9fe432026d8990d13be09536a683c2a">luaB_yield</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00621"></a>00621   <span class="keywordflow">return</span> <a class="code" href="ldo_8c.html#af341c25bf642f9244778e130c86d6260">lua_yield</a>(L, <a class="code" href="lapi_8c.html#afbb08ecb69421875494105d4de68e5bf">lua_gettop</a>(L));
<a name="l00622"></a>00622 }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624 
<a name="l00625"></a><a class="code" href="lbaselib_8c.html#ad5fa6e6f20235e61b3ba56ea3dc973d2">00625</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#ad5fa6e6f20235e61b3ba56ea3dc973d2">luaB_corunning</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00626"></a>00626   <span class="keywordflow">if</span> (<a class="code" href="lapi_8c.html#a4175aeea9aa6dbf096ecfca7b190fa4a">lua_pushthread</a>(L))
<a name="l00627"></a>00627     <a class="code" href="lapi_8c.html#a1b4cd0d80f51e5545a97ca6c28c03c50">lua_pushnil</a>(L);  <span class="comment">/* main thread is not a coroutine */</span>
<a name="l00628"></a>00628   <span class="keywordflow">return</span> 1;
<a name="l00629"></a>00629 }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631 
<a name="l00632"></a><a class="code" href="lbaselib_8c.html#a3857a1be3b5aaf23b28b4e6809c7dc97">00632</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structluaL__Reg.html">luaL_Reg</a> <a class="code" href="lbaselib_8c.html#a3857a1be3b5aaf23b28b4e6809c7dc97">co_funcs</a>[] = {
<a name="l00633"></a>00633   {<span class="stringliteral">&quot;create&quot;</span>, <a class="code" href="lbaselib_8c.html#ad49772e236781ef7ad88ff8bc980b40b">luaB_cocreate</a>},
<a name="l00634"></a>00634   {<span class="stringliteral">&quot;resume&quot;</span>, <a class="code" href="lbaselib_8c.html#a76f5d80387eeb1c7d31eb5f9cb6c9392">luaB_coresume</a>},
<a name="l00635"></a>00635   {<span class="stringliteral">&quot;running&quot;</span>, <a class="code" href="lbaselib_8c.html#ad5fa6e6f20235e61b3ba56ea3dc973d2">luaB_corunning</a>},
<a name="l00636"></a>00636   {<span class="stringliteral">&quot;status&quot;</span>, <a class="code" href="lbaselib_8c.html#a174dfb2852a7d04964e4a1426fff93f8">luaB_costatus</a>},
<a name="l00637"></a>00637   {<span class="stringliteral">&quot;wrap&quot;</span>, <a class="code" href="lbaselib_8c.html#a1c0429e27f504b08e25f437f733edad1">luaB_cowrap</a>},
<a name="l00638"></a>00638   {<span class="stringliteral">&quot;yield&quot;</span>, <a class="code" href="lbaselib_8c.html#ad9fe432026d8990d13be09536a683c2a">luaB_yield</a>},
<a name="l00639"></a>00639   {NULL, NULL}
<a name="l00640"></a>00640 };
<a name="l00641"></a>00641 
<a name="l00642"></a>00642 <span class="comment">/* }====================================================== */</span>
<a name="l00643"></a>00643 
<a name="l00644"></a>00644 
<a name="l00645"></a><a class="code" href="lbaselib_8c.html#aeb48ea97ead6ad6bbf3a9cc80900d918">00645</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lbaselib_8c.html#aeb48ea97ead6ad6bbf3a9cc80900d918">auxopen</a> (<a class="code" href="structlua__State.html">lua_State</a> *L, <span class="keyword">const</span> <span class="keywordtype">char</span> *name,
<a name="l00646"></a>00646                      <a class="code" href="lua_8h.html#a5f5bedea265eccf43c6e404e020988ce">lua_CFunction</a> <a class="code" href="libluasqlite3_8c.html#ae16fcc70ad2cbf55b1906507bcb6fa33">f</a>, <a class="code" href="lua_8h.html#a5f5bedea265eccf43c6e404e020988ce">lua_CFunction</a> u) {
<a name="l00647"></a>00647   <a class="code" href="lua_8h.html#a2e4fbbe97182bf90004379202202f2b9">lua_pushcfunction</a>(L, u);
<a name="l00648"></a>00648   <a class="code" href="lapi_8c.html#a142802b91cdd22516b54599f51e101e4">lua_pushcclosure</a>(L, f, 1);
<a name="l00649"></a>00649   <a class="code" href="lapi_8c.html#a3f2f542ee6728d82e51b1c302f9606df">lua_setfield</a>(L, -2, name);
<a name="l00650"></a>00650 }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652 
<a name="l00653"></a><a class="code" href="lbaselib_8c.html#ae64945be858f5b857683b8240336a366">00653</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lbaselib_8c.html#ae64945be858f5b857683b8240336a366">base_open</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00654"></a>00654   <span class="comment">/* set global _G */</span>
<a name="l00655"></a>00655   <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, <a class="code" href="lua_8h.html#adcd23d4ad1ec6e825daea03ee83c8c73">LUA_GLOBALSINDEX</a>);
<a name="l00656"></a>00656   <a class="code" href="lua_8h.html#ab9c7b1411a77d9dff74f2930fc51f796">lua_setglobal</a>(L, <span class="stringliteral">&quot;_G&quot;</span>);
<a name="l00657"></a>00657   <span class="comment">/* open lib into global table */</span>
<a name="l00658"></a>00658   <a class="code" href="lauxlib_8c.html#a258c0fd40d57aec9cf62ebd74be7666e">luaL_register</a>(L, <span class="stringliteral">&quot;_G&quot;</span>, base_funcs);
<a name="l00659"></a>00659   <a class="code" href="lua_8h.html#a47854189a679002ed743ebbcb30b1b26">lua_pushliteral</a>(L, <a class="code" href="lua_8h.html#a3818e6f6538c9f42e9522c74334df03d">LUA_VERSION</a>);
<a name="l00660"></a>00660   <a class="code" href="lua_8h.html#ab9c7b1411a77d9dff74f2930fc51f796">lua_setglobal</a>(L, <span class="stringliteral">&quot;_VERSION&quot;</span>);  <span class="comment">/* set global _VERSION */</span>
<a name="l00661"></a>00661   <span class="comment">/* `ipairs&apos; and `pairs&apos; need auxliliary functions as upvalues */</span>
<a name="l00662"></a>00662   <a class="code" href="lbaselib_8c.html#aeb48ea97ead6ad6bbf3a9cc80900d918">auxopen</a>(L, <span class="stringliteral">&quot;ipairs&quot;</span>, <a class="code" href="lbaselib_8c.html#a5cb8b3b13437afd94c3313f0a4b17d06">luaB_ipairs</a>, <a class="code" href="lbaselib_8c.html#a9e49fcec5e66e36e817b1951123efc03">ipairsaux</a>);
<a name="l00663"></a>00663   <a class="code" href="lbaselib_8c.html#aeb48ea97ead6ad6bbf3a9cc80900d918">auxopen</a>(L, <span class="stringliteral">&quot;pairs&quot;</span>, <a class="code" href="lbaselib_8c.html#a36def102f87ba8c40734489231e90109">luaB_pairs</a>, <a class="code" href="lbaselib_8c.html#ac0b11ecf3ced275821aaf5a03ed33b02">luaB_next</a>);
<a name="l00664"></a>00664   <span class="comment">/* `newproxy&apos; needs a weaktable as upvalue */</span>
<a name="l00665"></a>00665   <a class="code" href="lapi_8c.html#a7f93e3baf3101cad59ec61b7744a55d8">lua_createtable</a>(L, 0, 1);  <span class="comment">/* new table `w&apos; */</span>
<a name="l00666"></a>00666   <a class="code" href="lapi_8c.html#a602f61a9b583d69dc1c72c8970bd65e8">lua_pushvalue</a>(L, -1);  <span class="comment">/* `w&apos; will be its own metatable */</span>
<a name="l00667"></a>00667   <a class="code" href="lapi_8c.html#a15719ea4119bdf5b3f2a406534431a7e">lua_setmetatable</a>(L, -2);
<a name="l00668"></a>00668   <a class="code" href="lua_8h.html#a47854189a679002ed743ebbcb30b1b26">lua_pushliteral</a>(L, <span class="stringliteral">&quot;kv&quot;</span>);
<a name="l00669"></a>00669   <a class="code" href="lapi_8c.html#a3f2f542ee6728d82e51b1c302f9606df">lua_setfield</a>(L, -2, <span class="stringliteral">&quot;__mode&quot;</span>);  <span class="comment">/* metatable(w).__mode = &quot;kv&quot; */</span>
<a name="l00670"></a>00670   <a class="code" href="lapi_8c.html#a142802b91cdd22516b54599f51e101e4">lua_pushcclosure</a>(L, <a class="code" href="lbaselib_8c.html#a7f593a7d28596bdce0d8c8525e180dd5">luaB_newproxy</a>, 1);
<a name="l00671"></a>00671   <a class="code" href="lua_8h.html#ab9c7b1411a77d9dff74f2930fc51f796">lua_setglobal</a>(L, <span class="stringliteral">&quot;newproxy&quot;</span>);  <span class="comment">/* set global `newproxy&apos; */</span>
<a name="l00672"></a>00672 }
<a name="l00673"></a>00673 
<a name="l00674"></a>00674 
<a name="l00675"></a><a class="code" href="lualib_8h.html#a6dcb766ec6891fef5d138112c7360c7c">00675</a> <a class="code" href="luaconf_8h.html#a373d5a572c4c65a5f35a6e4ee9293c95">LUALIB_API</a> <span class="keywordtype">int</span> <a class="code" href="lbaselib_8c.html#a894e3abf706bdd62202ca5a6640078f1">luaopen_base</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00676"></a>00676   <a class="code" href="lbaselib_8c.html#ae64945be858f5b857683b8240336a366">base_open</a>(L);
<a name="l00677"></a>00677   <a class="code" href="lauxlib_8c.html#a258c0fd40d57aec9cf62ebd74be7666e">luaL_register</a>(L, <a class="code" href="lualib_8h.html#a8548d3b29e4dffa749a4ca4288bec7e3">LUA_COLIBNAME</a>, co_funcs);
<a name="l00678"></a>00678   <span class="keywordflow">return</span> 2;
<a name="l00679"></a>00679 }
<a name="l00680"></a>00680 
</pre></div></div>
<hr size="1">

<p style="text-align: right;">
  <a href="http://www.contextlogger.org/">ContextLogger2</a>&#8212;ContextLogger2 Logger Daemon Internals&#8212;<small>Generated on Mon May 2 13:49:54 2011 by&nbsp;<a href="http://www.doxygen.org/">Doxygen</a> 1.6.1</small>
</p>

</body>
</html>
