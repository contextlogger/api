<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ContextLogger2 Logger Daemon Internals: tclsqlite.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_53e7feede50ae4cb655a635f658a2b4e.html">sqlite3h</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_a0c08fff43b69094a2511677d8587129.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_05c6b5177aad09a72e8ee1adc608dac0.html">sqlite3</a>
  </div>
</div>
<div class="contents">
<h1>tclsqlite.c</h1><a href="tclsqlite_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">** 2001 September 15</span>
<a name="l00003"></a>00003 <span class="comment">**</span>
<a name="l00004"></a>00004 <span class="comment">** The author disclaims copyright to this source code.  In place of</span>
<a name="l00005"></a>00005 <span class="comment">** a legal notice, here is a blessing:</span>
<a name="l00006"></a>00006 <span class="comment">**</span>
<a name="l00007"></a>00007 <span class="comment">**    May you do good and not evil.</span>
<a name="l00008"></a>00008 <span class="comment">**    May you find forgiveness for yourself and forgive others.</span>
<a name="l00009"></a>00009 <span class="comment">**    May you share freely, never taking more than you give.</span>
<a name="l00010"></a>00010 <span class="comment">**</span>
<a name="l00011"></a>00011 <span class="comment">*************************************************************************</span>
<a name="l00012"></a>00012 <span class="comment">** A TCL Interface to SQLite.  Append this file to sqlite3.c and</span>
<a name="l00013"></a>00013 <span class="comment">** compile the whole thing to build a TCL-enabled version of SQLite.</span>
<a name="l00014"></a>00014 <span class="comment">**</span>
<a name="l00015"></a>00015 <span class="comment">** $Id: tclsqlite.c,v 1.228 2008/10/09 14:45:26 drh Exp $</span>
<a name="l00016"></a>00016 <span class="comment">*/</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;tcl.h&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="comment">/*</span>
<a name="l00021"></a>00021 <span class="comment">** Some additional include files are needed if this file is not</span>
<a name="l00022"></a>00022 <span class="comment">** appended to the amalgamation.</span>
<a name="l00023"></a>00023 <span class="comment">*/</span>
<a name="l00024"></a>00024 <span class="preprocessor">#ifndef SQLITE_AMALGAMATION</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span><span class="preprocessor"># include &quot;<a class="code" href="sqliteInt_8h.html">sqliteInt.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor"># include &lt;stdlib.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor"># include &lt;string.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor"># include &lt;assert.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor"># include &lt;ctype.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#endif</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span>
<a name="l00032"></a>00032 <span class="comment">/*</span>
<a name="l00033"></a>00033 <span class="comment"> * Windows needs to know which symbols to export.  Unix does not.</span>
<a name="l00034"></a>00034 <span class="comment"> * BUILD_sqlite should be undefined for Unix.</span>
<a name="l00035"></a>00035 <span class="comment"> */</span>
<a name="l00036"></a>00036 <span class="preprocessor">#ifdef BUILD_sqlite</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#undef TCL_STORAGE_CLASS</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#define TCL_STORAGE_CLASS DLLEXPORT</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* BUILD_sqlite */</span>
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="tclsqlite_8c.html#a2871e2af97e334d5dac2253b786e129e">00041</a> <span class="preprocessor">#define NUM_PREPARED_STMTS 10</span>
<a name="l00042"></a><a class="code" href="tclsqlite_8c.html#a93755ba605854fcbb9615f3c8def160c">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_PREPARED_STMTS 100</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span>
<a name="l00044"></a>00044 <span class="comment">/*</span>
<a name="l00045"></a>00045 <span class="comment">** If TCL uses UTF-8 and SQLite is configured to use iso8859, then we</span>
<a name="l00046"></a>00046 <span class="comment">** have to do a translation when going between the two.  Set the </span>
<a name="l00047"></a>00047 <span class="comment">** UTF_TRANSLATION_NEEDED macro to indicate that we need to do</span>
<a name="l00048"></a>00048 <span class="comment">** this translation.  </span>
<a name="l00049"></a>00049 <span class="comment">*/</span>
<a name="l00050"></a>00050 <span class="preprocessor">#if defined(TCL_UTF_MAX) &amp;&amp; !defined(SQLITE_UTF8)</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span><span class="preprocessor"># define UTF_TRANSLATION_NEEDED 1</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span>
<a name="l00054"></a>00054 <span class="comment">/*</span>
<a name="l00055"></a>00055 <span class="comment">** New SQL functions can be created as TCL scripts.  Each such function</span>
<a name="l00056"></a>00056 <span class="comment">** is described by an instance of the following structure.</span>
<a name="l00057"></a>00057 <span class="comment">*/</span>
<a name="l00058"></a><a class="code" href="tclsqlite_8c.html#ab82fbeb355ee478b3da093c5e167b7c2">00058</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structSqlFunc.html">SqlFunc</a> <a class="code" href="structSqlFunc.html">SqlFunc</a>;
<a name="l00059"></a><a class="code" href="structSqlFunc.html">00059</a> <span class="keyword">struct </span><a class="code" href="structSqlFunc.html">SqlFunc</a> {
<a name="l00060"></a><a class="code" href="structSqlFunc.html#a3e9ba0d1b0804c61c9df668283c10db8">00060</a>   Tcl_Interp *<a class="code" href="structSqlFunc.html#a3e9ba0d1b0804c61c9df668283c10db8">interp</a>;   <span class="comment">/* The TCL interpret to execute the function */</span>
<a name="l00061"></a><a class="code" href="structSqlFunc.html#a0e421ba3739e20e3985a1152666efd15">00061</a>   Tcl_Obj *<a class="code" href="structSqlFunc.html#a0e421ba3739e20e3985a1152666efd15">pScript</a>;     <span class="comment">/* The Tcl_Obj representation of the script */</span>
<a name="l00062"></a><a class="code" href="structSqlFunc.html#a536b8b8164a7be75f4b092dd3a4146bc">00062</a>   <span class="keywordtype">int</span> <a class="code" href="structSqlFunc.html#a536b8b8164a7be75f4b092dd3a4146bc">useEvalObjv</a>;      <span class="comment">/* True if it is safe to use Tcl_EvalObjv */</span>
<a name="l00063"></a><a class="code" href="structSqlFunc.html#a1f551c0a26de74c0b436674483996fd1">00063</a>   <span class="keywordtype">char</span> *<a class="code" href="structSqlFunc.html#a1f551c0a26de74c0b436674483996fd1">zName</a>;          <span class="comment">/* Name of this function */</span>
<a name="l00064"></a><a class="code" href="structSqlFunc.html#a253a6db10a7e22a8ec2b5ed4fa3fdb9a">00064</a>   <a class="code" href="structSqlFunc.html">SqlFunc</a> *<a class="code" href="structSqlFunc.html#a253a6db10a7e22a8ec2b5ed4fa3fdb9a">pNext</a>;       <span class="comment">/* Next function on the list of them all */</span>
<a name="l00065"></a>00065 };
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="comment">/*</span>
<a name="l00068"></a>00068 <span class="comment">** New collation sequences function can be created as TCL scripts.  Each such</span>
<a name="l00069"></a>00069 <span class="comment">** function is described by an instance of the following structure.</span>
<a name="l00070"></a>00070 <span class="comment">*/</span>
<a name="l00071"></a><a class="code" href="tclsqlite_8c.html#a353feb6a247092f43135026de09b70fe">00071</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structSqlCollate.html">SqlCollate</a> <a class="code" href="structSqlCollate.html">SqlCollate</a>;
<a name="l00072"></a><a class="code" href="structSqlCollate.html">00072</a> <span class="keyword">struct </span><a class="code" href="structSqlCollate.html">SqlCollate</a> {
<a name="l00073"></a><a class="code" href="structSqlCollate.html#a635f16f99114a708d2c7e2211be056d5">00073</a>   Tcl_Interp *<a class="code" href="structSqlCollate.html#a635f16f99114a708d2c7e2211be056d5">interp</a>;   <span class="comment">/* The TCL interpret to execute the function */</span>
<a name="l00074"></a><a class="code" href="structSqlCollate.html#af6d57ee2d119ce791fbf0898774fb31a">00074</a>   <span class="keywordtype">char</span> *<a class="code" href="structSqlCollate.html#af6d57ee2d119ce791fbf0898774fb31a">zScript</a>;        <span class="comment">/* The script to be run */</span>
<a name="l00075"></a><a class="code" href="structSqlCollate.html#a45b5c1e7332d72fa455af40de09c2417">00075</a>   <a class="code" href="structSqlCollate.html">SqlCollate</a> *<a class="code" href="structSqlCollate.html#a45b5c1e7332d72fa455af40de09c2417">pNext</a>;    <span class="comment">/* Next function on the list of them all */</span>
<a name="l00076"></a>00076 };
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="comment">/*</span>
<a name="l00079"></a>00079 <span class="comment">** Prepared statements are cached for faster execution.  Each prepared</span>
<a name="l00080"></a>00080 <span class="comment">** statement is described by an instance of the following structure.</span>
<a name="l00081"></a>00081 <span class="comment">*/</span>
<a name="l00082"></a><a class="code" href="tclsqlite_8c.html#a04d10f17615240d95ba91ad5548ba799">00082</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structSqlPreparedStmt.html">SqlPreparedStmt</a> <a class="code" href="structSqlPreparedStmt.html">SqlPreparedStmt</a>;
<a name="l00083"></a><a class="code" href="structSqlPreparedStmt.html">00083</a> <span class="keyword">struct </span><a class="code" href="structSqlPreparedStmt.html">SqlPreparedStmt</a> {
<a name="l00084"></a><a class="code" href="structSqlPreparedStmt.html#ab507bc5e962f1c1f1f27dc7468c3bee1">00084</a>   <a class="code" href="structSqlPreparedStmt.html">SqlPreparedStmt</a> *<a class="code" href="structSqlPreparedStmt.html#ab507bc5e962f1c1f1f27dc7468c3bee1">pNext</a>;  <span class="comment">/* Next in linked list */</span>
<a name="l00085"></a><a class="code" href="structSqlPreparedStmt.html#a11f690895aa6c427b38cf62c572a44c5">00085</a>   <a class="code" href="structSqlPreparedStmt.html">SqlPreparedStmt</a> *<a class="code" href="structSqlPreparedStmt.html#a11f690895aa6c427b38cf62c572a44c5">pPrev</a>;  <span class="comment">/* Previous on the list */</span>
<a name="l00086"></a><a class="code" href="structSqlPreparedStmt.html#a1281d141acc5a7e88d0c006814b437cf">00086</a>   <a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> *<a class="code" href="structSqlPreparedStmt.html#a1281d141acc5a7e88d0c006814b437cf">pStmt</a>;     <span class="comment">/* The prepared statement */</span>
<a name="l00087"></a><a class="code" href="structSqlPreparedStmt.html#a3bdc15903b54995e489270392aaef9f9">00087</a>   <span class="keywordtype">int</span> <a class="code" href="structSqlPreparedStmt.html#a3bdc15903b54995e489270392aaef9f9">nSql</a>;                <span class="comment">/* chars in zSql[] */</span>
<a name="l00088"></a><a class="code" href="structSqlPreparedStmt.html#adf0ae473efb12e525ffae189e7965295">00088</a>   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structSqlPreparedStmt.html#adf0ae473efb12e525ffae189e7965295">zSql</a>;        <span class="comment">/* Text of the SQL statement */</span>
<a name="l00089"></a>00089 };
<a name="l00090"></a>00090 
<a name="l00091"></a><a class="code" href="tclsqlite_8c.html#afa78e3bf683d1d199be5ce04d84a58de">00091</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> <a class="code" href="structIncrblobChannel.html">IncrblobChannel</a>;
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="comment">/*</span>
<a name="l00094"></a>00094 <span class="comment">** There is one instance of this structure for each SQLite database</span>
<a name="l00095"></a>00095 <span class="comment">** that has been opened by the SQLite TCL interface.</span>
<a name="l00096"></a>00096 <span class="comment">*/</span>
<a name="l00097"></a><a class="code" href="tclsqlite_8c.html#a4a7d7bb67ae2661879587dc12ae1e198">00097</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structSqliteDb.html">SqliteDb</a> <a class="code" href="structSqliteDb.html">SqliteDb</a>;
<a name="l00098"></a><a class="code" href="structSqliteDb.html">00098</a> <span class="keyword">struct </span><a class="code" href="structSqliteDb.html">SqliteDb</a> {
<a name="l00099"></a><a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">00099</a>   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>;               <span class="comment">/* The &quot;real&quot; database structure. MUST BE FIRST */</span>
<a name="l00100"></a><a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">00100</a>   Tcl_Interp *<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>;        <span class="comment">/* The interpreter used for this database */</span>
<a name="l00101"></a><a class="code" href="structSqliteDb.html#a7cb84aabdfbedd95240e06775fb180ef">00101</a>   <span class="keywordtype">char</span> *<a class="code" href="structSqliteDb.html#a7cb84aabdfbedd95240e06775fb180ef">zBusy</a>;               <span class="comment">/* The busy callback routine */</span>
<a name="l00102"></a><a class="code" href="structSqliteDb.html#a4a926744dbe738f8c4103899ead38e7e">00102</a>   <span class="keywordtype">char</span> *<a class="code" href="structSqliteDb.html#a4a926744dbe738f8c4103899ead38e7e">zCommit</a>;             <span class="comment">/* The commit hook callback routine */</span>
<a name="l00103"></a><a class="code" href="structSqliteDb.html#a74b96df446ab216017644fdab5c95ac3">00103</a>   <span class="keywordtype">char</span> *<a class="code" href="structSqliteDb.html#a74b96df446ab216017644fdab5c95ac3">zTrace</a>;              <span class="comment">/* The trace callback routine */</span>
<a name="l00104"></a><a class="code" href="structSqliteDb.html#aef8682a8fa0aa5f8a07233130354fd8f">00104</a>   <span class="keywordtype">char</span> *<a class="code" href="structSqliteDb.html#aef8682a8fa0aa5f8a07233130354fd8f">zProfile</a>;            <span class="comment">/* The profile callback routine */</span>
<a name="l00105"></a><a class="code" href="structSqliteDb.html#ab113606884e65607ecbc4c6471f9e09c">00105</a>   <span class="keywordtype">char</span> *<a class="code" href="structSqliteDb.html#ab113606884e65607ecbc4c6471f9e09c">zProgress</a>;           <span class="comment">/* The progress callback routine */</span>
<a name="l00106"></a><a class="code" href="structSqliteDb.html#a0c45582460ca74c9c89d0e362ffe2358">00106</a>   <span class="keywordtype">char</span> *<a class="code" href="structSqliteDb.html#a0c45582460ca74c9c89d0e362ffe2358">zAuth</a>;               <span class="comment">/* The authorization callback routine */</span>
<a name="l00107"></a><a class="code" href="structSqliteDb.html#af48d5c43dfbd5b0f4b4fab2214996989">00107</a>   <span class="keywordtype">int</span> <a class="code" href="structSqliteDb.html#af48d5c43dfbd5b0f4b4fab2214996989">disableAuth</a>;           <span class="comment">/* Disable the authorizer if it exists */</span>
<a name="l00108"></a><a class="code" href="structSqliteDb.html#a64ee061174a00304836817ce20507035">00108</a>   <span class="keywordtype">char</span> *<a class="code" href="structSqliteDb.html#a64ee061174a00304836817ce20507035">zNull</a>;               <span class="comment">/* Text to substitute for an SQL NULL value */</span>
<a name="l00109"></a><a class="code" href="structSqliteDb.html#adb54cf9558c00b844904f394df3f6ba6">00109</a>   <a class="code" href="structSqlFunc.html">SqlFunc</a> *<a class="code" href="structSqliteDb.html#adb54cf9558c00b844904f394df3f6ba6">pFunc</a>;            <span class="comment">/* List of SQL functions */</span>
<a name="l00110"></a><a class="code" href="structSqliteDb.html#a54f8f8788f9e9a5a061076b7377d23d3">00110</a>   Tcl_Obj *<a class="code" href="structSqliteDb.html#a54f8f8788f9e9a5a061076b7377d23d3">pUpdateHook</a>;      <span class="comment">/* Update hook script (if any) */</span>
<a name="l00111"></a><a class="code" href="structSqliteDb.html#a5dbd38263d99aff24eaadd2ef522e823">00111</a>   Tcl_Obj *<a class="code" href="structSqliteDb.html#a5dbd38263d99aff24eaadd2ef522e823">pRollbackHook</a>;    <span class="comment">/* Rollback hook script (if any) */</span>
<a name="l00112"></a><a class="code" href="structSqliteDb.html#a17b422014e06eceb32cf75eb6e0ef9ac">00112</a>   <a class="code" href="structSqlCollate.html">SqlCollate</a> *<a class="code" href="structSqliteDb.html#a17b422014e06eceb32cf75eb6e0ef9ac">pCollate</a>;      <span class="comment">/* List of SQL collation functions */</span>
<a name="l00113"></a><a class="code" href="structSqliteDb.html#a57ea0c2d7c9947ebd6fb7654dc98906e">00113</a>   <span class="keywordtype">int</span> <a class="code" href="structSqliteDb.html#a57ea0c2d7c9947ebd6fb7654dc98906e">rc</a>;                    <span class="comment">/* Return code of most recent sqlite3_exec() */</span>
<a name="l00114"></a><a class="code" href="structSqliteDb.html#a1d39f77f9f33e5e9434652544530b177">00114</a>   Tcl_Obj *<a class="code" href="structSqliteDb.html#a1d39f77f9f33e5e9434652544530b177">pCollateNeeded</a>;   <span class="comment">/* Collation needed script */</span>
<a name="l00115"></a><a class="code" href="structSqliteDb.html#a622c25c8c19cd96236513cb643bb34b3">00115</a>   <a class="code" href="structSqlPreparedStmt.html">SqlPreparedStmt</a> *<a class="code" href="structSqliteDb.html#a622c25c8c19cd96236513cb643bb34b3">stmtList</a>; <span class="comment">/* List of prepared statements*/</span>
<a name="l00116"></a><a class="code" href="structSqliteDb.html#a6d38e9086103c95838cf9e5110a7831c">00116</a>   <a class="code" href="structSqlPreparedStmt.html">SqlPreparedStmt</a> *<a class="code" href="structSqliteDb.html#a6d38e9086103c95838cf9e5110a7831c">stmtLast</a>; <span class="comment">/* Last statement in the list */</span>
<a name="l00117"></a><a class="code" href="structSqliteDb.html#a552e45c18680c2bfb6962b361b40204f">00117</a>   <span class="keywordtype">int</span> <a class="code" href="structSqliteDb.html#a552e45c18680c2bfb6962b361b40204f">maxStmt</a>;               <span class="comment">/* The next maximum number of stmtList */</span>
<a name="l00118"></a><a class="code" href="structSqliteDb.html#aea14c71b9b28d06f7c3094e6069560a2">00118</a>   <span class="keywordtype">int</span> <a class="code" href="structSqliteDb.html#aea14c71b9b28d06f7c3094e6069560a2">nStmt</a>;                 <span class="comment">/* Number of statements in stmtList */</span>
<a name="l00119"></a><a class="code" href="structSqliteDb.html#a698f42bb08abc4cb28febe240dcad8a3">00119</a>   <a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> *<a class="code" href="structSqliteDb.html#a698f42bb08abc4cb28febe240dcad8a3">pIncrblob</a>;<span class="comment">/* Linked list of open incrblob channels */</span>
<a name="l00120"></a><a class="code" href="structSqliteDb.html#aae182504912cf9d112003530cf1b6fe5">00120</a>   <span class="keywordtype">int</span> <a class="code" href="structSqliteDb.html#aae182504912cf9d112003530cf1b6fe5">nStep</a>, <a class="code" href="structSqliteDb.html#ac3fcd48fdcfc407666f0fdf443cb3ffd">nSort</a>;          <span class="comment">/* Statistics for most recent operation */</span>
<a name="l00121"></a>00121 };
<a name="l00122"></a>00122 
<a name="l00123"></a><a class="code" href="structIncrblobChannel.html">00123</a> <span class="keyword">struct </span><a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> {
<a name="l00124"></a><a class="code" href="structIncrblobChannel.html#a8e22e20b13e95ad1035e2b94cb7e10d7">00124</a>   <a class="code" href="sqlite3_8h.html#a3eb4857c157c542bb3fb7d8cbf38a662">sqlite3_blob</a> *<a class="code" href="structIncrblobChannel.html#a8e22e20b13e95ad1035e2b94cb7e10d7">pBlob</a>;      <span class="comment">/* sqlite3 blob handle */</span>
<a name="l00125"></a><a class="code" href="structIncrblobChannel.html#a00095f62e3202768793dd55c32bbada7">00125</a>   <a class="code" href="structSqliteDb.html">SqliteDb</a> *<a class="code" href="structIncrblobChannel.html#a00095f62e3202768793dd55c32bbada7">pDb</a>;            <span class="comment">/* Associated database connection */</span>
<a name="l00126"></a><a class="code" href="structIncrblobChannel.html#a582f1998eb3cbd748a0f3d58ecbf8f80">00126</a>   <span class="keywordtype">int</span> <a class="code" href="structIncrblobChannel.html#a582f1998eb3cbd748a0f3d58ecbf8f80">iSeek</a>;                <span class="comment">/* Current seek offset */</span>
<a name="l00127"></a><a class="code" href="structIncrblobChannel.html#ac03368c3c0463d27e77438ab5a383c80">00127</a>   Tcl_Channel <a class="code" href="structIncrblobChannel.html#ac03368c3c0463d27e77438ab5a383c80">channel</a>;      <span class="comment">/* Channel identifier */</span>
<a name="l00128"></a><a class="code" href="structIncrblobChannel.html#a998f90ce66fd0fb93019e69591548ce0">00128</a>   <a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> *<a class="code" href="structIncrblobChannel.html#a998f90ce66fd0fb93019e69591548ce0">pNext</a>;   <span class="comment">/* Linked list of all open incrblob channels */</span>
<a name="l00129"></a><a class="code" href="structIncrblobChannel.html#af5bcdd119751b83e08e45ae5f923d582">00129</a>   <a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> *<a class="code" href="structIncrblobChannel.html#af5bcdd119751b83e08e45ae5f923d582">pPrev</a>;   <span class="comment">/* Linked list of all open incrblob channels */</span>
<a name="l00130"></a>00130 };
<a name="l00131"></a>00131 
<a name="l00132"></a>00132 <span class="preprocessor">#ifndef SQLITE_OMIT_INCRBLOB</span>
<a name="l00133"></a>00133 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l00134"></a>00134 <span class="comment">** Close all incrblob channels opened using database connection pDb.</span>
<a name="l00135"></a>00135 <span class="comment">** This is called when shutting down the database connection.</span>
<a name="l00136"></a>00136 <span class="comment">*/</span>
<a name="l00137"></a><a class="code" href="tclsqlite_8c.html#ab35c1503530a338bcb8a137bbd067890">00137</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="tclsqlite_8c.html#ab35c1503530a338bcb8a137bbd067890">closeIncrblobChannels</a>(<a class="code" href="structSqliteDb.html">SqliteDb</a> *pDb){
<a name="l00138"></a>00138   <a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> *p;
<a name="l00139"></a>00139   <a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> *pNext;
<a name="l00140"></a>00140 
<a name="l00141"></a>00141   <span class="keywordflow">for</span>(p=pDb-&gt;<a class="code" href="structSqliteDb.html#a698f42bb08abc4cb28febe240dcad8a3">pIncrblob</a>; p; p=pNext){
<a name="l00142"></a>00142     pNext = p-&gt;<a class="code" href="structIncrblobChannel.html#a998f90ce66fd0fb93019e69591548ce0">pNext</a>;
<a name="l00143"></a>00143 
<a name="l00144"></a>00144     <span class="comment">/* Note: Calling unregister here call Tcl_Close on the incrblob channel, </span>
<a name="l00145"></a>00145 <span class="comment">    ** which deletes the IncrblobChannel structure at *p. So do not</span>
<a name="l00146"></a>00146 <span class="comment">    ** call Tcl_Free() here.</span>
<a name="l00147"></a>00147 <span class="comment">    */</span>
<a name="l00148"></a>00148     Tcl_UnregisterChannel(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>, p-&gt;<a class="code" href="structIncrblobChannel.html#ac03368c3c0463d27e77438ab5a383c80">channel</a>);
<a name="l00149"></a>00149   }
<a name="l00150"></a>00150 }
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 <span class="comment">/*</span>
<a name="l00153"></a>00153 <span class="comment">** Close an incremental blob channel.</span>
<a name="l00154"></a>00154 <span class="comment">*/</span>
<a name="l00155"></a><a class="code" href="tclsqlite_8c.html#a1cf19c4c0506525156d209595fe5cd94">00155</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#a1cf19c4c0506525156d209595fe5cd94">incrblobClose</a>(ClientData instanceData, Tcl_Interp *interp){
<a name="l00156"></a>00156   <a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> *p = (<a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> *)instanceData;
<a name="l00157"></a>00157   <span class="keywordtype">int</span> rc = <a class="code" href="sqlite3_8h.html#a4fa30f77f307bf27544138a6a88b45cf">sqlite3_blob_close</a>(p-&gt;<a class="code" href="structIncrblobChannel.html#a8e22e20b13e95ad1035e2b94cb7e10d7">pBlob</a>);
<a name="l00158"></a>00158   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a> = p-&gt;<a class="code" href="structIncrblobChannel.html#a00095f62e3202768793dd55c32bbada7">pDb</a>-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160   <span class="comment">/* Remove the channel from the SqliteDb.pIncrblob list. */</span>
<a name="l00161"></a>00161   <span class="keywordflow">if</span>( p-&gt;<a class="code" href="structIncrblobChannel.html#a998f90ce66fd0fb93019e69591548ce0">pNext</a> ){
<a name="l00162"></a>00162     p-&gt;<a class="code" href="structIncrblobChannel.html#a998f90ce66fd0fb93019e69591548ce0">pNext</a>-&gt;<a class="code" href="structIncrblobChannel.html#af5bcdd119751b83e08e45ae5f923d582">pPrev</a> = p-&gt;<a class="code" href="structIncrblobChannel.html#af5bcdd119751b83e08e45ae5f923d582">pPrev</a>;
<a name="l00163"></a>00163   }
<a name="l00164"></a>00164   <span class="keywordflow">if</span>( p-&gt;<a class="code" href="structIncrblobChannel.html#af5bcdd119751b83e08e45ae5f923d582">pPrev</a> ){
<a name="l00165"></a>00165     p-&gt;<a class="code" href="structIncrblobChannel.html#af5bcdd119751b83e08e45ae5f923d582">pPrev</a>-&gt;<a class="code" href="structIncrblobChannel.html#a998f90ce66fd0fb93019e69591548ce0">pNext</a> = p-&gt;<a class="code" href="structIncrblobChannel.html#a998f90ce66fd0fb93019e69591548ce0">pNext</a>;
<a name="l00166"></a>00166   }
<a name="l00167"></a>00167   <span class="keywordflow">if</span>( p-&gt;<a class="code" href="structIncrblobChannel.html#a00095f62e3202768793dd55c32bbada7">pDb</a>-&gt;<a class="code" href="structSqliteDb.html#a698f42bb08abc4cb28febe240dcad8a3">pIncrblob</a>==p ){
<a name="l00168"></a>00168     p-&gt;<a class="code" href="structIncrblobChannel.html#a00095f62e3202768793dd55c32bbada7">pDb</a>-&gt;<a class="code" href="structSqliteDb.html#a698f42bb08abc4cb28febe240dcad8a3">pIncrblob</a> = p-&gt;<a class="code" href="structIncrblobChannel.html#a998f90ce66fd0fb93019e69591548ce0">pNext</a>;
<a name="l00169"></a>00169   }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171   <span class="comment">/* Free the IncrblobChannel structure */</span>
<a name="l00172"></a>00172   Tcl_Free((<span class="keywordtype">char</span> *)p);
<a name="l00173"></a>00173 
<a name="l00174"></a>00174   <span class="keywordflow">if</span>( rc!=<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> ){
<a name="l00175"></a>00175     Tcl_SetResult(interp, (<span class="keywordtype">char</span> *)<a class="code" href="main_8c.html#ad2a9feca40ee5a7c629c2af6d0ae1d27">sqlite3_errmsg</a>(db), TCL_VOLATILE);
<a name="l00176"></a>00176     <span class="keywordflow">return</span> TCL_ERROR;
<a name="l00177"></a>00177   }
<a name="l00178"></a>00178   <span class="keywordflow">return</span> TCL_OK;
<a name="l00179"></a>00179 }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 <span class="comment">/*</span>
<a name="l00182"></a>00182 <span class="comment">** Read data from an incremental blob channel.</span>
<a name="l00183"></a>00183 <span class="comment">*/</span>
<a name="l00184"></a><a class="code" href="tclsqlite_8c.html#a2ca8db0d0c4b6c1c697727da1d0240b6">00184</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#a2ca8db0d0c4b6c1c697727da1d0240b6">incrblobInput</a>(
<a name="l00185"></a>00185   ClientData instanceData, 
<a name="l00186"></a>00186   <span class="keywordtype">char</span> *buf, 
<a name="l00187"></a>00187   <span class="keywordtype">int</span> bufSize,
<a name="l00188"></a>00188   <span class="keywordtype">int</span> *errorCodePtr
<a name="l00189"></a>00189 ){
<a name="l00190"></a>00190   <a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> *p = (<a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> *)instanceData;
<a name="l00191"></a>00191   <span class="keywordtype">int</span> nRead = bufSize;         <span class="comment">/* Number of bytes to read */</span>
<a name="l00192"></a>00192   <span class="keywordtype">int</span> nBlob;                   <span class="comment">/* Total size of the blob */</span>
<a name="l00193"></a>00193   <span class="keywordtype">int</span> rc;                      <span class="comment">/* sqlite error code */</span>
<a name="l00194"></a>00194 
<a name="l00195"></a>00195   nBlob = <a class="code" href="sqlite3_8h.html#a3c5a730e8f7bb89384994f42341e2081">sqlite3_blob_bytes</a>(p-&gt;<a class="code" href="structIncrblobChannel.html#a8e22e20b13e95ad1035e2b94cb7e10d7">pBlob</a>);
<a name="l00196"></a>00196   <span class="keywordflow">if</span>( (p-&gt;<a class="code" href="structIncrblobChannel.html#a582f1998eb3cbd748a0f3d58ecbf8f80">iSeek</a>+nRead)&gt;nBlob ){
<a name="l00197"></a>00197     nRead = nBlob-p-&gt;<a class="code" href="structIncrblobChannel.html#a582f1998eb3cbd748a0f3d58ecbf8f80">iSeek</a>;
<a name="l00198"></a>00198   }
<a name="l00199"></a>00199   <span class="keywordflow">if</span>( nRead&lt;=0 ){
<a name="l00200"></a>00200     <span class="keywordflow">return</span> 0;
<a name="l00201"></a>00201   }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203   rc = <a class="code" href="sqlite3_8h.html#aca280a1aad5b2e4597f2f15b00e91465">sqlite3_blob_read</a>(p-&gt;<a class="code" href="structIncrblobChannel.html#a8e22e20b13e95ad1035e2b94cb7e10d7">pBlob</a>, (<span class="keywordtype">void</span> *)buf, nRead, p-&gt;<a class="code" href="structIncrblobChannel.html#a582f1998eb3cbd748a0f3d58ecbf8f80">iSeek</a>);
<a name="l00204"></a>00204   <span class="keywordflow">if</span>( rc!=<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> ){
<a name="l00205"></a>00205     *errorCodePtr = rc;
<a name="l00206"></a>00206     <span class="keywordflow">return</span> -1;
<a name="l00207"></a>00207   }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209   p-&gt;<a class="code" href="structIncrblobChannel.html#a582f1998eb3cbd748a0f3d58ecbf8f80">iSeek</a> += nRead;
<a name="l00210"></a>00210   <span class="keywordflow">return</span> nRead;
<a name="l00211"></a>00211 }
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="comment">/*</span>
<a name="l00214"></a>00214 <span class="comment">** Write data to an incremental blob channel.</span>
<a name="l00215"></a>00215 <span class="comment">*/</span>
<a name="l00216"></a><a class="code" href="tclsqlite_8c.html#adb26edc9d83cfffb464d29156edd32bf">00216</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#adb26edc9d83cfffb464d29156edd32bf">incrblobOutput</a>(
<a name="l00217"></a>00217   ClientData instanceData, 
<a name="l00218"></a>00218   CONST <span class="keywordtype">char</span> *buf, 
<a name="l00219"></a>00219   <span class="keywordtype">int</span> toWrite,
<a name="l00220"></a>00220   <span class="keywordtype">int</span> *errorCodePtr
<a name="l00221"></a>00221 ){
<a name="l00222"></a>00222   <a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> *p = (<a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> *)instanceData;
<a name="l00223"></a>00223   <span class="keywordtype">int</span> nWrite = toWrite;        <span class="comment">/* Number of bytes to write */</span>
<a name="l00224"></a>00224   <span class="keywordtype">int</span> nBlob;                   <span class="comment">/* Total size of the blob */</span>
<a name="l00225"></a>00225   <span class="keywordtype">int</span> rc;                      <span class="comment">/* sqlite error code */</span>
<a name="l00226"></a>00226 
<a name="l00227"></a>00227   nBlob = <a class="code" href="sqlite3_8h.html#a3c5a730e8f7bb89384994f42341e2081">sqlite3_blob_bytes</a>(p-&gt;<a class="code" href="structIncrblobChannel.html#a8e22e20b13e95ad1035e2b94cb7e10d7">pBlob</a>);
<a name="l00228"></a>00228   <span class="keywordflow">if</span>( (p-&gt;<a class="code" href="structIncrblobChannel.html#a582f1998eb3cbd748a0f3d58ecbf8f80">iSeek</a>+nWrite)&gt;nBlob ){
<a name="l00229"></a>00229     *errorCodePtr = EINVAL;
<a name="l00230"></a>00230     <span class="keywordflow">return</span> -1;
<a name="l00231"></a>00231   }
<a name="l00232"></a>00232   <span class="keywordflow">if</span>( nWrite&lt;=0 ){
<a name="l00233"></a>00233     <span class="keywordflow">return</span> 0;
<a name="l00234"></a>00234   }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236   rc = <a class="code" href="sqlite3_8h.html#ac994103512f70b80b4978824ef008071">sqlite3_blob_write</a>(p-&gt;<a class="code" href="structIncrblobChannel.html#a8e22e20b13e95ad1035e2b94cb7e10d7">pBlob</a>, (<span class="keywordtype">void</span> *)buf, nWrite, p-&gt;<a class="code" href="structIncrblobChannel.html#a582f1998eb3cbd748a0f3d58ecbf8f80">iSeek</a>);
<a name="l00237"></a>00237   <span class="keywordflow">if</span>( rc!=<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> ){
<a name="l00238"></a>00238     *errorCodePtr = EIO;
<a name="l00239"></a>00239     <span class="keywordflow">return</span> -1;
<a name="l00240"></a>00240   }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242   p-&gt;<a class="code" href="structIncrblobChannel.html#a582f1998eb3cbd748a0f3d58ecbf8f80">iSeek</a> += nWrite;
<a name="l00243"></a>00243   <span class="keywordflow">return</span> nWrite;
<a name="l00244"></a>00244 }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 <span class="comment">/*</span>
<a name="l00247"></a>00247 <span class="comment">** Seek an incremental blob channel.</span>
<a name="l00248"></a>00248 <span class="comment">*/</span>
<a name="l00249"></a><a class="code" href="tclsqlite_8c.html#a17b5805d12b5c6d02103c19f0d1077c8">00249</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#a17b5805d12b5c6d02103c19f0d1077c8">incrblobSeek</a>(
<a name="l00250"></a>00250   ClientData instanceData, 
<a name="l00251"></a>00251   <span class="keywordtype">long</span> offset,
<a name="l00252"></a>00252   <span class="keywordtype">int</span> seekMode,
<a name="l00253"></a>00253   <span class="keywordtype">int</span> *errorCodePtr
<a name="l00254"></a>00254 ){
<a name="l00255"></a>00255   <a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> *p = (<a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> *)instanceData;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257   <span class="keywordflow">switch</span>( seekMode ){
<a name="l00258"></a>00258     <span class="keywordflow">case</span> SEEK_SET:
<a name="l00259"></a>00259       p-&gt;<a class="code" href="structIncrblobChannel.html#a582f1998eb3cbd748a0f3d58ecbf8f80">iSeek</a> = offset;
<a name="l00260"></a>00260       <span class="keywordflow">break</span>;
<a name="l00261"></a>00261     <span class="keywordflow">case</span> SEEK_CUR:
<a name="l00262"></a>00262       p-&gt;<a class="code" href="structIncrblobChannel.html#a582f1998eb3cbd748a0f3d58ecbf8f80">iSeek</a> += offset;
<a name="l00263"></a>00263       <span class="keywordflow">break</span>;
<a name="l00264"></a>00264     <span class="keywordflow">case</span> SEEK_END:
<a name="l00265"></a>00265       p-&gt;<a class="code" href="structIncrblobChannel.html#a582f1998eb3cbd748a0f3d58ecbf8f80">iSeek</a> = <a class="code" href="sqlite3_8h.html#a3c5a730e8f7bb89384994f42341e2081">sqlite3_blob_bytes</a>(p-&gt;<a class="code" href="structIncrblobChannel.html#a8e22e20b13e95ad1035e2b94cb7e10d7">pBlob</a>) + offset;
<a name="l00266"></a>00266       <span class="keywordflow">break</span>;
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     <span class="keywordflow">default</span>: assert(!<span class="stringliteral">&quot;Bad seekMode&quot;</span>);
<a name="l00269"></a>00269   }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271   <span class="keywordflow">return</span> p-&gt;<a class="code" href="structIncrblobChannel.html#a582f1998eb3cbd748a0f3d58ecbf8f80">iSeek</a>;
<a name="l00272"></a>00272 }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274 
<a name="l00275"></a><a class="code" href="tclsqlite_8c.html#ad5e8c6a775390a3d644fe7492529fa82">00275</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="tclsqlite_8c.html#ad5e8c6a775390a3d644fe7492529fa82">incrblobWatch</a>(ClientData instanceData, <span class="keywordtype">int</span> mode){ 
<a name="l00276"></a>00276   <span class="comment">/* NO-OP */</span> 
<a name="l00277"></a>00277 }
<a name="l00278"></a><a class="code" href="tclsqlite_8c.html#aff58d04bc1abd655854da0b93e9f6a84">00278</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#aff58d04bc1abd655854da0b93e9f6a84">incrblobHandle</a>(ClientData instanceData, <span class="keywordtype">int</span> dir, ClientData *hPtr){
<a name="l00279"></a>00279   <span class="keywordflow">return</span> TCL_ERROR;
<a name="l00280"></a>00280 }
<a name="l00281"></a>00281 
<a name="l00282"></a><a class="code" href="tclsqlite_8c.html#a3d1274d5307b3818d4169805799f1b2a">00282</a> <span class="keyword">static</span> Tcl_ChannelType <a class="code" href="tclsqlite_8c.html#a3d1274d5307b3818d4169805799f1b2a">IncrblobChannelType</a> = {
<a name="l00283"></a>00283   <span class="stringliteral">&quot;incrblob&quot;</span>,                        <span class="comment">/* typeName                             */</span>
<a name="l00284"></a>00284   TCL_CHANNEL_VERSION_2,             <span class="comment">/* version                              */</span>
<a name="l00285"></a>00285   <a class="code" href="tclsqlite_8c.html#a1cf19c4c0506525156d209595fe5cd94">incrblobClose</a>,                     <span class="comment">/* closeProc                            */</span>
<a name="l00286"></a>00286   <a class="code" href="tclsqlite_8c.html#a2ca8db0d0c4b6c1c697727da1d0240b6">incrblobInput</a>,                     <span class="comment">/* inputProc                            */</span>
<a name="l00287"></a>00287   <a class="code" href="tclsqlite_8c.html#adb26edc9d83cfffb464d29156edd32bf">incrblobOutput</a>,                    <span class="comment">/* outputProc                           */</span>
<a name="l00288"></a>00288   <a class="code" href="tclsqlite_8c.html#a17b5805d12b5c6d02103c19f0d1077c8">incrblobSeek</a>,                      <span class="comment">/* seekProc                             */</span>
<a name="l00289"></a>00289   0,                                 <span class="comment">/* setOptionProc                        */</span>
<a name="l00290"></a>00290   0,                                 <span class="comment">/* getOptionProc                        */</span>
<a name="l00291"></a>00291   <a class="code" href="tclsqlite_8c.html#ad5e8c6a775390a3d644fe7492529fa82">incrblobWatch</a>,                     <span class="comment">/* watchProc (this is a no-op)          */</span>
<a name="l00292"></a>00292   <a class="code" href="tclsqlite_8c.html#aff58d04bc1abd655854da0b93e9f6a84">incrblobHandle</a>,                    <span class="comment">/* getHandleProc (always returns error) */</span>
<a name="l00293"></a>00293   0,                                 <span class="comment">/* close2Proc                           */</span>
<a name="l00294"></a>00294   0,                                 <span class="comment">/* blockModeProc                        */</span>
<a name="l00295"></a>00295   0,                                 <span class="comment">/* flushProc                            */</span>
<a name="l00296"></a>00296   0,                                 <span class="comment">/* handlerProc                          */</span>
<a name="l00297"></a>00297   0,                                 <span class="comment">/* wideSeekProc                         */</span>
<a name="l00298"></a>00298 };
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 <span class="comment">/*</span>
<a name="l00301"></a>00301 <span class="comment">** Create a new incrblob channel.</span>
<a name="l00302"></a>00302 <span class="comment">*/</span>
<a name="l00303"></a><a class="code" href="tclsqlite_8c.html#a31dc80b70a971817e5105c0b2a1ab14e">00303</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#a31dc80b70a971817e5105c0b2a1ab14e">createIncrblobChannel</a>(
<a name="l00304"></a>00304   Tcl_Interp *interp, 
<a name="l00305"></a>00305   <a class="code" href="structSqliteDb.html">SqliteDb</a> *pDb, 
<a name="l00306"></a>00306   <span class="keyword">const</span> <span class="keywordtype">char</span> *zDb,
<a name="l00307"></a>00307   <span class="keyword">const</span> <span class="keywordtype">char</span> *zTable, 
<a name="l00308"></a>00308   <span class="keyword">const</span> <span class="keywordtype">char</span> *zColumn, 
<a name="l00309"></a>00309   <a class="code" href="sqlite3_8h.html#a520a95f9080c018b2fade39885bd2e2a">sqlite_int64</a> iRow,
<a name="l00310"></a>00310   <span class="keywordtype">int</span> isReadonly
<a name="l00311"></a>00311 ){
<a name="l00312"></a>00312   <a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> *p;
<a name="l00313"></a>00313   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a> = pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>;
<a name="l00314"></a>00314   <a class="code" href="sqlite3_8h.html#a3eb4857c157c542bb3fb7d8cbf38a662">sqlite3_blob</a> *pBlob;
<a name="l00315"></a>00315   <span class="keywordtype">int</span> rc;
<a name="l00316"></a>00316   <span class="keywordtype">int</span> flags = TCL_READABLE|(isReadonly ? 0 : TCL_WRITABLE);
<a name="l00317"></a>00317 
<a name="l00318"></a>00318   <span class="comment">/* This variable is used to name the channels: &quot;incrblob_[incr count]&quot; */</span>
<a name="l00319"></a>00319   <span class="keyword">static</span> <span class="keywordtype">int</span> count = 0;
<a name="l00320"></a>00320   <span class="keywordtype">char</span> zChannel[64];
<a name="l00321"></a>00321 
<a name="l00322"></a>00322   rc = <a class="code" href="sqlite3_8h.html#ae1f10d350ddc4b4ec97bb9c7efc51102">sqlite3_blob_open</a>(db, zDb, zTable, zColumn, iRow, !isReadonly, &amp;pBlob);
<a name="l00323"></a>00323   <span class="keywordflow">if</span>( rc!=<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> ){
<a name="l00324"></a>00324     Tcl_SetResult(interp, (<span class="keywordtype">char</span> *)<a class="code" href="main_8c.html#ad2a9feca40ee5a7c629c2af6d0ae1d27">sqlite3_errmsg</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>), TCL_VOLATILE);
<a name="l00325"></a>00325     <span class="keywordflow">return</span> TCL_ERROR;
<a name="l00326"></a>00326   }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328   p = (<a class="code" href="structIncrblobChannel.html">IncrblobChannel</a> *)Tcl_Alloc(<span class="keyword">sizeof</span>(<a class="code" href="structIncrblobChannel.html">IncrblobChannel</a>));
<a name="l00329"></a>00329   p-&gt;<a class="code" href="structIncrblobChannel.html#a582f1998eb3cbd748a0f3d58ecbf8f80">iSeek</a> = 0;
<a name="l00330"></a>00330   p-&gt;<a class="code" href="structIncrblobChannel.html#a8e22e20b13e95ad1035e2b94cb7e10d7">pBlob</a> = pBlob;
<a name="l00331"></a>00331 
<a name="l00332"></a>00332   <a class="code" href="printf_8c.html#aa62e83e27ab0a63e15f9f844c17c595f">sqlite3_snprintf</a>(<span class="keyword">sizeof</span>(zChannel), zChannel, <span class="stringliteral">&quot;incrblob_%d&quot;</span>, ++count);
<a name="l00333"></a>00333   p-&gt;<a class="code" href="structIncrblobChannel.html#ac03368c3c0463d27e77438ab5a383c80">channel</a> = Tcl_CreateChannel(&amp;<a class="code" href="tclsqlite_8c.html#a3d1274d5307b3818d4169805799f1b2a">IncrblobChannelType</a>, zChannel, p, flags);
<a name="l00334"></a>00334   Tcl_RegisterChannel(interp, p-&gt;<a class="code" href="structIncrblobChannel.html#ac03368c3c0463d27e77438ab5a383c80">channel</a>);
<a name="l00335"></a>00335 
<a name="l00336"></a>00336   <span class="comment">/* Link the new channel into the SqliteDb.pIncrblob list. */</span>
<a name="l00337"></a>00337   p-&gt;<a class="code" href="structIncrblobChannel.html#a998f90ce66fd0fb93019e69591548ce0">pNext</a> = pDb-&gt;<a class="code" href="structSqliteDb.html#a698f42bb08abc4cb28febe240dcad8a3">pIncrblob</a>;
<a name="l00338"></a>00338   p-&gt;<a class="code" href="structIncrblobChannel.html#af5bcdd119751b83e08e45ae5f923d582">pPrev</a> = 0;
<a name="l00339"></a>00339   <span class="keywordflow">if</span>( p-&gt;<a class="code" href="structIncrblobChannel.html#a998f90ce66fd0fb93019e69591548ce0">pNext</a> ){
<a name="l00340"></a>00340     p-&gt;<a class="code" href="structIncrblobChannel.html#a998f90ce66fd0fb93019e69591548ce0">pNext</a>-&gt;<a class="code" href="structIncrblobChannel.html#af5bcdd119751b83e08e45ae5f923d582">pPrev</a> = p;
<a name="l00341"></a>00341   }
<a name="l00342"></a>00342   pDb-&gt;<a class="code" href="structSqliteDb.html#a698f42bb08abc4cb28febe240dcad8a3">pIncrblob</a> = p;
<a name="l00343"></a>00343   p-&gt;<a class="code" href="structIncrblobChannel.html#a00095f62e3202768793dd55c32bbada7">pDb</a> = pDb;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345   Tcl_SetResult(interp, (<span class="keywordtype">char</span> *)Tcl_GetChannelName(p-&gt;<a class="code" href="structIncrblobChannel.html#ac03368c3c0463d27e77438ab5a383c80">channel</a>), TCL_VOLATILE);
<a name="l00346"></a>00346   <span class="keywordflow">return</span> TCL_OK;
<a name="l00347"></a>00347 }
<a name="l00348"></a>00348 <span class="preprocessor">#else  </span><span class="comment">/* else clause for &quot;#ifndef SQLITE_OMIT_INCRBLOB&quot; */</span>
<a name="l00349"></a>00349 <span class="preprocessor">  #define closeIncrblobChannels(pDb)</span>
<a name="l00350"></a>00350 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00351"></a>00351 <span class="preprocessor"></span>
<a name="l00352"></a>00352 <span class="comment">/*</span>
<a name="l00353"></a>00353 <span class="comment">** Look at the script prefix in pCmd.  We will be executing this script</span>
<a name="l00354"></a>00354 <span class="comment">** after first appending one or more arguments.  This routine analyzes</span>
<a name="l00355"></a>00355 <span class="comment">** the script to see if it is safe to use Tcl_EvalObjv() on the script</span>
<a name="l00356"></a>00356 <span class="comment">** rather than the more general Tcl_EvalEx().  Tcl_EvalObjv() is much</span>
<a name="l00357"></a>00357 <span class="comment">** faster.</span>
<a name="l00358"></a>00358 <span class="comment">**</span>
<a name="l00359"></a>00359 <span class="comment">** Scripts that are safe to use with Tcl_EvalObjv() consists of a</span>
<a name="l00360"></a>00360 <span class="comment">** command name followed by zero or more arguments with no [...] or $</span>
<a name="l00361"></a>00361 <span class="comment">** or {...} or ; to be seen anywhere.  Most callback scripts consist</span>
<a name="l00362"></a>00362 <span class="comment">** of just a single procedure name and they meet this requirement.</span>
<a name="l00363"></a>00363 <span class="comment">*/</span>
<a name="l00364"></a><a class="code" href="tclsqlite_8c.html#aec8737fc43abc8a5ed8b6b9044fec1d5">00364</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#aec8737fc43abc8a5ed8b6b9044fec1d5">safeToUseEvalObjv</a>(Tcl_Interp *interp, Tcl_Obj *pCmd){
<a name="l00365"></a>00365   <span class="comment">/* We could try to do something with Tcl_Parse().  But we will instead</span>
<a name="l00366"></a>00366 <span class="comment">  ** just do a search for forbidden characters.  If any of the forbidden</span>
<a name="l00367"></a>00367 <span class="comment">  ** characters appear in pCmd, we will report the string as unsafe.</span>
<a name="l00368"></a>00368 <span class="comment">  */</span>
<a name="l00369"></a>00369   <span class="keyword">const</span> <span class="keywordtype">char</span> *z;
<a name="l00370"></a>00370   <span class="keywordtype">int</span> n;
<a name="l00371"></a>00371   z = Tcl_GetStringFromObj(pCmd, &amp;n);
<a name="l00372"></a>00372   <span class="keywordflow">while</span>( n-- &gt; 0 ){
<a name="l00373"></a>00373     <span class="keywordtype">int</span> c = *(z++);
<a name="l00374"></a>00374     <span class="keywordflow">if</span>( c==<span class="charliteral">&apos;$&apos;</span> || c==<span class="charliteral">&apos;[&apos;</span> || c==<span class="charliteral">&apos;;&apos;</span> ) <span class="keywordflow">return</span> 0;
<a name="l00375"></a>00375   }
<a name="l00376"></a>00376   <span class="keywordflow">return</span> 1;
<a name="l00377"></a>00377 }
<a name="l00378"></a>00378 
<a name="l00379"></a>00379 <span class="comment">/*</span>
<a name="l00380"></a>00380 <span class="comment">** Find an SqlFunc structure with the given name.  Or create a new</span>
<a name="l00381"></a>00381 <span class="comment">** one if an existing one cannot be found.  Return a pointer to the</span>
<a name="l00382"></a>00382 <span class="comment">** structure.</span>
<a name="l00383"></a>00383 <span class="comment">*/</span>
<a name="l00384"></a><a class="code" href="tclsqlite_8c.html#a378ebd8ae922e39802c72ed5b31c9534">00384</a> <span class="keyword">static</span> <a class="code" href="structSqlFunc.html">SqlFunc</a> *<a class="code" href="tclsqlite_8c.html#a378ebd8ae922e39802c72ed5b31c9534">findSqlFunc</a>(<a class="code" href="structSqliteDb.html">SqliteDb</a> *pDb, <span class="keyword">const</span> <span class="keywordtype">char</span> *zName){
<a name="l00385"></a>00385   <a class="code" href="structSqlFunc.html">SqlFunc</a> *p, *pNew;
<a name="l00386"></a>00386   <span class="keywordtype">int</span> i;
<a name="l00387"></a>00387   pNew = (<a class="code" href="structSqlFunc.html">SqlFunc</a>*)Tcl_Alloc( <span class="keyword">sizeof</span>(*pNew) + strlen(zName) + 1 );
<a name="l00388"></a>00388   pNew-&gt;<a class="code" href="structSqlFunc.html#a1f551c0a26de74c0b436674483996fd1">zName</a> = (<span class="keywordtype">char</span>*)&amp;pNew[1];
<a name="l00389"></a>00389   <span class="keywordflow">for</span>(i=0; zName[i]; i++){ pNew-&gt;<a class="code" href="structSqlFunc.html#a1f551c0a26de74c0b436674483996fd1">zName</a>[i] = tolower(zName[i]); }
<a name="l00390"></a>00390   pNew-&gt;<a class="code" href="structSqlFunc.html#a1f551c0a26de74c0b436674483996fd1">zName</a>[i] = 0;
<a name="l00391"></a>00391   <span class="keywordflow">for</span>(p=pDb-&gt;<a class="code" href="structSqliteDb.html#adb54cf9558c00b844904f394df3f6ba6">pFunc</a>; p; p=p-&gt;<a class="code" href="structSqlFunc.html#a253a6db10a7e22a8ec2b5ed4fa3fdb9a">pNext</a>){ 
<a name="l00392"></a>00392     <span class="keywordflow">if</span>( strcmp(p-&gt;<a class="code" href="structSqlFunc.html#a1f551c0a26de74c0b436674483996fd1">zName</a>, pNew-&gt;<a class="code" href="structSqlFunc.html#a1f551c0a26de74c0b436674483996fd1">zName</a>)==0 ){
<a name="l00393"></a>00393       Tcl_Free((<span class="keywordtype">char</span>*)pNew);
<a name="l00394"></a>00394       <span class="keywordflow">return</span> p;
<a name="l00395"></a>00395     }
<a name="l00396"></a>00396   }
<a name="l00397"></a>00397   pNew-&gt;<a class="code" href="structSqlFunc.html#a3e9ba0d1b0804c61c9df668283c10db8">interp</a> = pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>;
<a name="l00398"></a>00398   pNew-&gt;<a class="code" href="structSqlFunc.html#a0e421ba3739e20e3985a1152666efd15">pScript</a> = 0;
<a name="l00399"></a>00399   pNew-&gt;<a class="code" href="structSqlFunc.html#a253a6db10a7e22a8ec2b5ed4fa3fdb9a">pNext</a> = pDb-&gt;<a class="code" href="structSqliteDb.html#adb54cf9558c00b844904f394df3f6ba6">pFunc</a>;
<a name="l00400"></a>00400   pDb-&gt;<a class="code" href="structSqliteDb.html#adb54cf9558c00b844904f394df3f6ba6">pFunc</a> = pNew;
<a name="l00401"></a>00401   <span class="keywordflow">return</span> pNew;
<a name="l00402"></a>00402 }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404 <span class="comment">/*</span>
<a name="l00405"></a>00405 <span class="comment">** Finalize and free a list of prepared statements</span>
<a name="l00406"></a>00406 <span class="comment">*/</span>
<a name="l00407"></a><a class="code" href="tclsqlite_8c.html#a48c8393e76d28d7d1b252df3297074b2">00407</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="tclsqlite_8c.html#a48c8393e76d28d7d1b252df3297074b2">flushStmtCache</a>( <a class="code" href="structSqliteDb.html">SqliteDb</a> *pDb ){
<a name="l00408"></a>00408   <a class="code" href="structSqlPreparedStmt.html">SqlPreparedStmt</a> *pPreStmt;
<a name="l00409"></a>00409 
<a name="l00410"></a>00410   <span class="keywordflow">while</span>(  pDb-&gt;<a class="code" href="structSqliteDb.html#a622c25c8c19cd96236513cb643bb34b3">stmtList</a> ){
<a name="l00411"></a>00411     <a class="code" href="sqlite3_8h.html#aaf6c3dbc23f33c0752588425c7e9d498">sqlite3_finalize</a>( pDb-&gt;<a class="code" href="structSqliteDb.html#a622c25c8c19cd96236513cb643bb34b3">stmtList</a>-&gt;<a class="code" href="structSqlPreparedStmt.html#a1281d141acc5a7e88d0c006814b437cf">pStmt</a> );
<a name="l00412"></a>00412     pPreStmt = pDb-&gt;<a class="code" href="structSqliteDb.html#a622c25c8c19cd96236513cb643bb34b3">stmtList</a>;
<a name="l00413"></a>00413     pDb-&gt;<a class="code" href="structSqliteDb.html#a622c25c8c19cd96236513cb643bb34b3">stmtList</a> = pDb-&gt;<a class="code" href="structSqliteDb.html#a622c25c8c19cd96236513cb643bb34b3">stmtList</a>-&gt;<a class="code" href="structSqlPreparedStmt.html#ab507bc5e962f1c1f1f27dc7468c3bee1">pNext</a>;
<a name="l00414"></a>00414     Tcl_Free( (<span class="keywordtype">char</span>*)pPreStmt );
<a name="l00415"></a>00415   }
<a name="l00416"></a>00416   pDb-&gt;<a class="code" href="structSqliteDb.html#aea14c71b9b28d06f7c3094e6069560a2">nStmt</a> = 0;
<a name="l00417"></a>00417   pDb-&gt;<a class="code" href="structSqliteDb.html#a6d38e9086103c95838cf9e5110a7831c">stmtLast</a> = 0;
<a name="l00418"></a>00418 }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420 <span class="comment">/*</span>
<a name="l00421"></a>00421 <span class="comment">** TCL calls this procedure when an sqlite3 database command is</span>
<a name="l00422"></a>00422 <span class="comment">** deleted.</span>
<a name="l00423"></a>00423 <span class="comment">*/</span>
<a name="l00424"></a><a class="code" href="tclsqlite_8c.html#a2dc21f3170c84e31f611875e0629bf84">00424</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="tclsqlite_8c.html#a2dc21f3170c84e31f611875e0629bf84">DbDeleteCmd</a>(<span class="keywordtype">void</span> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a>){
<a name="l00425"></a>00425   <a class="code" href="structSqliteDb.html">SqliteDb</a> *pDb = (<a class="code" href="structSqliteDb.html">SqliteDb</a>*)db;
<a name="l00426"></a>00426   <a class="code" href="tclsqlite_8c.html#a48c8393e76d28d7d1b252df3297074b2">flushStmtCache</a>(pDb);
<a name="l00427"></a>00427   <a class="code" href="tclsqlite_8c.html#ab35c1503530a338bcb8a137bbd067890">closeIncrblobChannels</a>(pDb);
<a name="l00428"></a>00428   <a class="code" href="main_8c.html#ad8b9c470f85398febda75993b66a8827">sqlite3_close</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>);
<a name="l00429"></a>00429   <span class="keywordflow">while</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#adb54cf9558c00b844904f394df3f6ba6">pFunc</a> ){
<a name="l00430"></a>00430     <a class="code" href="structSqlFunc.html">SqlFunc</a> *pFunc = pDb-&gt;<a class="code" href="structSqliteDb.html#adb54cf9558c00b844904f394df3f6ba6">pFunc</a>;
<a name="l00431"></a>00431     pDb-&gt;<a class="code" href="structSqliteDb.html#adb54cf9558c00b844904f394df3f6ba6">pFunc</a> = pFunc-&gt;<a class="code" href="structSqlFunc.html#a253a6db10a7e22a8ec2b5ed4fa3fdb9a">pNext</a>;
<a name="l00432"></a>00432     Tcl_DecrRefCount(pFunc-&gt;<a class="code" href="structSqlFunc.html#a0e421ba3739e20e3985a1152666efd15">pScript</a>);
<a name="l00433"></a>00433     Tcl_Free((<span class="keywordtype">char</span>*)pFunc);
<a name="l00434"></a>00434   }
<a name="l00435"></a>00435   <span class="keywordflow">while</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a17b422014e06eceb32cf75eb6e0ef9ac">pCollate</a> ){
<a name="l00436"></a>00436     <a class="code" href="structSqlCollate.html">SqlCollate</a> *pCollate = pDb-&gt;<a class="code" href="structSqliteDb.html#a17b422014e06eceb32cf75eb6e0ef9ac">pCollate</a>;
<a name="l00437"></a>00437     pDb-&gt;<a class="code" href="structSqliteDb.html#a17b422014e06eceb32cf75eb6e0ef9ac">pCollate</a> = pCollate-&gt;<a class="code" href="structSqlCollate.html#a45b5c1e7332d72fa455af40de09c2417">pNext</a>;
<a name="l00438"></a>00438     Tcl_Free((<span class="keywordtype">char</span>*)pCollate);
<a name="l00439"></a>00439   }
<a name="l00440"></a>00440   <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a7cb84aabdfbedd95240e06775fb180ef">zBusy</a> ){
<a name="l00441"></a>00441     Tcl_Free(pDb-&gt;<a class="code" href="structSqliteDb.html#a7cb84aabdfbedd95240e06775fb180ef">zBusy</a>);
<a name="l00442"></a>00442   }
<a name="l00443"></a>00443   <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a74b96df446ab216017644fdab5c95ac3">zTrace</a> ){
<a name="l00444"></a>00444     Tcl_Free(pDb-&gt;<a class="code" href="structSqliteDb.html#a74b96df446ab216017644fdab5c95ac3">zTrace</a>);
<a name="l00445"></a>00445   }
<a name="l00446"></a>00446   <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#aef8682a8fa0aa5f8a07233130354fd8f">zProfile</a> ){
<a name="l00447"></a>00447     Tcl_Free(pDb-&gt;<a class="code" href="structSqliteDb.html#aef8682a8fa0aa5f8a07233130354fd8f">zProfile</a>);
<a name="l00448"></a>00448   }
<a name="l00449"></a>00449   <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a0c45582460ca74c9c89d0e362ffe2358">zAuth</a> ){
<a name="l00450"></a>00450     Tcl_Free(pDb-&gt;<a class="code" href="structSqliteDb.html#a0c45582460ca74c9c89d0e362ffe2358">zAuth</a>);
<a name="l00451"></a>00451   }
<a name="l00452"></a>00452   <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a64ee061174a00304836817ce20507035">zNull</a> ){
<a name="l00453"></a>00453     Tcl_Free(pDb-&gt;<a class="code" href="structSqliteDb.html#a64ee061174a00304836817ce20507035">zNull</a>);
<a name="l00454"></a>00454   }
<a name="l00455"></a>00455   <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a54f8f8788f9e9a5a061076b7377d23d3">pUpdateHook</a> ){
<a name="l00456"></a>00456     Tcl_DecrRefCount(pDb-&gt;<a class="code" href="structSqliteDb.html#a54f8f8788f9e9a5a061076b7377d23d3">pUpdateHook</a>);
<a name="l00457"></a>00457   }
<a name="l00458"></a>00458   <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a5dbd38263d99aff24eaadd2ef522e823">pRollbackHook</a> ){
<a name="l00459"></a>00459     Tcl_DecrRefCount(pDb-&gt;<a class="code" href="structSqliteDb.html#a5dbd38263d99aff24eaadd2ef522e823">pRollbackHook</a>);
<a name="l00460"></a>00460   }
<a name="l00461"></a>00461   <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a1d39f77f9f33e5e9434652544530b177">pCollateNeeded</a> ){
<a name="l00462"></a>00462     Tcl_DecrRefCount(pDb-&gt;<a class="code" href="structSqliteDb.html#a1d39f77f9f33e5e9434652544530b177">pCollateNeeded</a>);
<a name="l00463"></a>00463   }
<a name="l00464"></a>00464   Tcl_Free((<span class="keywordtype">char</span>*)pDb);
<a name="l00465"></a>00465 }
<a name="l00466"></a>00466 
<a name="l00467"></a>00467 <span class="comment">/*</span>
<a name="l00468"></a>00468 <span class="comment">** This routine is called when a database file is locked while trying</span>
<a name="l00469"></a>00469 <span class="comment">** to execute SQL.</span>
<a name="l00470"></a>00470 <span class="comment">*/</span>
<a name="l00471"></a><a class="code" href="tclsqlite_8c.html#a56dc0aae05dbc7067c1e5133198a033b">00471</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#a56dc0aae05dbc7067c1e5133198a033b">DbBusyHandler</a>(<span class="keywordtype">void</span> *cd, <span class="keywordtype">int</span> nTries){
<a name="l00472"></a>00472   <a class="code" href="structSqliteDb.html">SqliteDb</a> *pDb = (<a class="code" href="structSqliteDb.html">SqliteDb</a>*)cd;
<a name="l00473"></a>00473   <span class="keywordtype">int</span> rc;
<a name="l00474"></a>00474   <span class="keywordtype">char</span> zVal[30];
<a name="l00475"></a>00475 
<a name="l00476"></a>00476   <a class="code" href="printf_8c.html#aa62e83e27ab0a63e15f9f844c17c595f">sqlite3_snprintf</a>(<span class="keyword">sizeof</span>(zVal), zVal, <span class="stringliteral">&quot;%d&quot;</span>, nTries);
<a name="l00477"></a>00477   rc = Tcl_VarEval(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>, pDb-&gt;<a class="code" href="structSqliteDb.html#a7cb84aabdfbedd95240e06775fb180ef">zBusy</a>, <span class="stringliteral">&quot; &quot;</span>, zVal, (<span class="keywordtype">char</span>*)0);
<a name="l00478"></a>00478   <span class="keywordflow">if</span>( rc!=TCL_OK || atoi(Tcl_GetStringResult(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>)) ){
<a name="l00479"></a>00479     <span class="keywordflow">return</span> 0;
<a name="l00480"></a>00480   }
<a name="l00481"></a>00481   <span class="keywordflow">return</span> 1;
<a name="l00482"></a>00482 }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484 <span class="preprocessor">#ifndef SQLITE_OMIT_PROGRESS_CALLBACK</span>
<a name="l00485"></a>00485 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l00486"></a>00486 <span class="comment">** This routine is invoked as the &apos;progress callback&apos; for the database.</span>
<a name="l00487"></a>00487 <span class="comment">*/</span>
<a name="l00488"></a><a class="code" href="tclsqlite_8c.html#acf066efc07635c9ea4c7da980ae0d104">00488</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#acf066efc07635c9ea4c7da980ae0d104">DbProgressHandler</a>(<span class="keywordtype">void</span> *cd){
<a name="l00489"></a>00489   <a class="code" href="structSqliteDb.html">SqliteDb</a> *pDb = (<a class="code" href="structSqliteDb.html">SqliteDb</a>*)cd;
<a name="l00490"></a>00490   <span class="keywordtype">int</span> rc;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492   assert( pDb-&gt;<a class="code" href="structSqliteDb.html#ab113606884e65607ecbc4c6471f9e09c">zProgress</a> );
<a name="l00493"></a>00493   rc = Tcl_Eval(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>, pDb-&gt;<a class="code" href="structSqliteDb.html#ab113606884e65607ecbc4c6471f9e09c">zProgress</a>);
<a name="l00494"></a>00494   <span class="keywordflow">if</span>( rc!=TCL_OK || atoi(Tcl_GetStringResult(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>)) ){
<a name="l00495"></a>00495     <span class="keywordflow">return</span> 1;
<a name="l00496"></a>00496   }
<a name="l00497"></a>00497   <span class="keywordflow">return</span> 0;
<a name="l00498"></a>00498 }
<a name="l00499"></a>00499 <span class="preprocessor">#endif</span>
<a name="l00500"></a>00500 <span class="preprocessor"></span>
<a name="l00501"></a>00501 <span class="preprocessor">#ifndef SQLITE_OMIT_TRACE</span>
<a name="l00502"></a>00502 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l00503"></a>00503 <span class="comment">** This routine is called by the SQLite trace handler whenever a new</span>
<a name="l00504"></a>00504 <span class="comment">** block of SQL is executed.  The TCL script in pDb-&gt;zTrace is executed.</span>
<a name="l00505"></a>00505 <span class="comment">*/</span>
<a name="l00506"></a><a class="code" href="tclsqlite_8c.html#a6085723754eea01de4e1731063631def">00506</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="tclsqlite_8c.html#a6085723754eea01de4e1731063631def">DbTraceHandler</a>(<span class="keywordtype">void</span> *cd, <span class="keyword">const</span> <span class="keywordtype">char</span> *zSql){
<a name="l00507"></a>00507   <a class="code" href="structSqliteDb.html">SqliteDb</a> *pDb = (<a class="code" href="structSqliteDb.html">SqliteDb</a>*)cd;
<a name="l00508"></a>00508   Tcl_DString str;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510   Tcl_DStringInit(&amp;str);
<a name="l00511"></a>00511   Tcl_DStringAppend(&amp;str, pDb-&gt;<a class="code" href="structSqliteDb.html#a74b96df446ab216017644fdab5c95ac3">zTrace</a>, -1);
<a name="l00512"></a>00512   Tcl_DStringAppendElement(&amp;str, zSql);
<a name="l00513"></a>00513   Tcl_Eval(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>, Tcl_DStringValue(&amp;str));
<a name="l00514"></a>00514   Tcl_DStringFree(&amp;str);
<a name="l00515"></a>00515   Tcl_ResetResult(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>);
<a name="l00516"></a>00516 }
<a name="l00517"></a>00517 <span class="preprocessor">#endif</span>
<a name="l00518"></a>00518 <span class="preprocessor"></span>
<a name="l00519"></a>00519 <span class="preprocessor">#ifndef SQLITE_OMIT_TRACE</span>
<a name="l00520"></a>00520 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l00521"></a>00521 <span class="comment">** This routine is called by the SQLite profile handler after a statement</span>
<a name="l00522"></a>00522 <span class="comment">** SQL has executed.  The TCL script in pDb-&gt;zProfile is evaluated.</span>
<a name="l00523"></a>00523 <span class="comment">*/</span>
<a name="l00524"></a><a class="code" href="tclsqlite_8c.html#a2373a1e082dbf49565c10bcd0ce91a61">00524</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="tclsqlite_8c.html#a2373a1e082dbf49565c10bcd0ce91a61">DbProfileHandler</a>(<span class="keywordtype">void</span> *cd, <span class="keyword">const</span> <span class="keywordtype">char</span> *zSql, <a class="code" href="sqlite3_8h.html#a127a9c18f6d067a05b994f5d0111ee25">sqlite_uint64</a> tm){
<a name="l00525"></a>00525   <a class="code" href="structSqliteDb.html">SqliteDb</a> *pDb = (<a class="code" href="structSqliteDb.html">SqliteDb</a>*)cd;
<a name="l00526"></a>00526   Tcl_DString str;
<a name="l00527"></a>00527   <span class="keywordtype">char</span> zTm[100];
<a name="l00528"></a>00528 
<a name="l00529"></a>00529   <a class="code" href="printf_8c.html#aa62e83e27ab0a63e15f9f844c17c595f">sqlite3_snprintf</a>(<span class="keyword">sizeof</span>(zTm)-1, zTm, <span class="stringliteral">&quot;%lld&quot;</span>, tm);
<a name="l00530"></a>00530   Tcl_DStringInit(&amp;str);
<a name="l00531"></a>00531   Tcl_DStringAppend(&amp;str, pDb-&gt;<a class="code" href="structSqliteDb.html#aef8682a8fa0aa5f8a07233130354fd8f">zProfile</a>, -1);
<a name="l00532"></a>00532   Tcl_DStringAppendElement(&amp;str, zSql);
<a name="l00533"></a>00533   Tcl_DStringAppendElement(&amp;str, zTm);
<a name="l00534"></a>00534   Tcl_Eval(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>, Tcl_DStringValue(&amp;str));
<a name="l00535"></a>00535   Tcl_DStringFree(&amp;str);
<a name="l00536"></a>00536   Tcl_ResetResult(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>);
<a name="l00537"></a>00537 }
<a name="l00538"></a>00538 <span class="preprocessor">#endif</span>
<a name="l00539"></a>00539 <span class="preprocessor"></span>
<a name="l00540"></a>00540 <span class="comment">/*</span>
<a name="l00541"></a>00541 <span class="comment">** This routine is called when a transaction is committed.  The</span>
<a name="l00542"></a>00542 <span class="comment">** TCL script in pDb-&gt;zCommit is executed.  If it returns non-zero or</span>
<a name="l00543"></a>00543 <span class="comment">** if it throws an exception, the transaction is rolled back instead</span>
<a name="l00544"></a>00544 <span class="comment">** of being committed.</span>
<a name="l00545"></a>00545 <span class="comment">*/</span>
<a name="l00546"></a><a class="code" href="tclsqlite_8c.html#a629fc836419a9008a39bc371f445a690">00546</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#a629fc836419a9008a39bc371f445a690">DbCommitHandler</a>(<span class="keywordtype">void</span> *cd){
<a name="l00547"></a>00547   <a class="code" href="structSqliteDb.html">SqliteDb</a> *pDb = (<a class="code" href="structSqliteDb.html">SqliteDb</a>*)cd;
<a name="l00548"></a>00548   <span class="keywordtype">int</span> rc;
<a name="l00549"></a>00549 
<a name="l00550"></a>00550   rc = Tcl_Eval(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>, pDb-&gt;<a class="code" href="structSqliteDb.html#a4a926744dbe738f8c4103899ead38e7e">zCommit</a>);
<a name="l00551"></a>00551   <span class="keywordflow">if</span>( rc!=TCL_OK || atoi(Tcl_GetStringResult(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>)) ){
<a name="l00552"></a>00552     <span class="keywordflow">return</span> 1;
<a name="l00553"></a>00553   }
<a name="l00554"></a>00554   <span class="keywordflow">return</span> 0;
<a name="l00555"></a>00555 }
<a name="l00556"></a>00556 
<a name="l00557"></a><a class="code" href="tclsqlite_8c.html#a0371dcddfbb6458bdca2808ecd7d85aa">00557</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="tclsqlite_8c.html#a0371dcddfbb6458bdca2808ecd7d85aa">DbRollbackHandler</a>(<span class="keywordtype">void</span> *clientData){
<a name="l00558"></a>00558   <a class="code" href="structSqliteDb.html">SqliteDb</a> *pDb = (<a class="code" href="structSqliteDb.html">SqliteDb</a>*)clientData;
<a name="l00559"></a>00559   assert(pDb-&gt;<a class="code" href="structSqliteDb.html#a5dbd38263d99aff24eaadd2ef522e823">pRollbackHook</a>);
<a name="l00560"></a>00560   <span class="keywordflow">if</span>( TCL_OK!=Tcl_EvalObjEx(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>, pDb-&gt;<a class="code" href="structSqliteDb.html#a5dbd38263d99aff24eaadd2ef522e823">pRollbackHook</a>, 0) ){
<a name="l00561"></a>00561     Tcl_BackgroundError(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>);
<a name="l00562"></a>00562   }
<a name="l00563"></a>00563 }
<a name="l00564"></a>00564 
<a name="l00565"></a><a class="code" href="tclsqlite_8c.html#a4bff178401a9ed6126bdeb1e8fc240c4">00565</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="tclsqlite_8c.html#a4bff178401a9ed6126bdeb1e8fc240c4">DbUpdateHandler</a>(
<a name="l00566"></a>00566   <span class="keywordtype">void</span> *p, 
<a name="l00567"></a>00567   <span class="keywordtype">int</span> op,
<a name="l00568"></a>00568   <span class="keyword">const</span> <span class="keywordtype">char</span> *zDb, 
<a name="l00569"></a>00569   <span class="keyword">const</span> <span class="keywordtype">char</span> *zTbl, 
<a name="l00570"></a>00570   <a class="code" href="sqlite3_8h.html#a520a95f9080c018b2fade39885bd2e2a">sqlite_int64</a> rowid
<a name="l00571"></a>00571 ){
<a name="l00572"></a>00572   <a class="code" href="structSqliteDb.html">SqliteDb</a> *pDb = (<a class="code" href="structSqliteDb.html">SqliteDb</a> *)p;
<a name="l00573"></a>00573   Tcl_Obj *pCmd;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575   assert( pDb-&gt;<a class="code" href="structSqliteDb.html#a54f8f8788f9e9a5a061076b7377d23d3">pUpdateHook</a> );
<a name="l00576"></a>00576   assert( op==<a class="code" href="sqlite3_8h.html#a0d32c3f24fcfd33411eecb1e4da64a40">SQLITE_INSERT</a> || op==<a class="code" href="sqlite3_8h.html#abe5e121cf6a85525dae8c65cea7edd48">SQLITE_UPDATE</a> || op==<a class="code" href="sqlite3_8h.html#ad68e72e7bbe70d79e4ca2016455cdf8d">SQLITE_DELETE</a> );
<a name="l00577"></a>00577 
<a name="l00578"></a>00578   pCmd = Tcl_DuplicateObj(pDb-&gt;<a class="code" href="structSqliteDb.html#a54f8f8788f9e9a5a061076b7377d23d3">pUpdateHook</a>);
<a name="l00579"></a>00579   Tcl_IncrRefCount(pCmd);
<a name="l00580"></a>00580   Tcl_ListObjAppendElement(0, pCmd, Tcl_NewStringObj(
<a name="l00581"></a>00581     ( (op==<a class="code" href="sqlite3_8h.html#a0d32c3f24fcfd33411eecb1e4da64a40">SQLITE_INSERT</a>)?<span class="stringliteral">&quot;INSERT&quot;</span>:(op==<a class="code" href="sqlite3_8h.html#abe5e121cf6a85525dae8c65cea7edd48">SQLITE_UPDATE</a>)?<span class="stringliteral">&quot;UPDATE&quot;</span>:<span class="stringliteral">&quot;DELETE&quot;</span>), -1));
<a name="l00582"></a>00582   Tcl_ListObjAppendElement(0, pCmd, Tcl_NewStringObj(zDb, -1));
<a name="l00583"></a>00583   Tcl_ListObjAppendElement(0, pCmd, Tcl_NewStringObj(zTbl, -1));
<a name="l00584"></a>00584   Tcl_ListObjAppendElement(0, pCmd, Tcl_NewWideIntObj(rowid));
<a name="l00585"></a>00585   Tcl_EvalObjEx(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>, pCmd, TCL_EVAL_DIRECT);
<a name="l00586"></a>00586 }
<a name="l00587"></a>00587 
<a name="l00588"></a><a class="code" href="tclsqlite_8c.html#a24621091d2c6b4947d0fceac8ee6e0a5">00588</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="tclsqlite_8c.html#a24621091d2c6b4947d0fceac8ee6e0a5">tclCollateNeeded</a>(
<a name="l00589"></a>00589   <span class="keywordtype">void</span> *pCtx,
<a name="l00590"></a>00590   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a>,
<a name="l00591"></a>00591   <span class="keywordtype">int</span> enc,
<a name="l00592"></a>00592   <span class="keyword">const</span> <span class="keywordtype">char</span> *zName
<a name="l00593"></a>00593 ){
<a name="l00594"></a>00594   <a class="code" href="structSqliteDb.html">SqliteDb</a> *pDb = (<a class="code" href="structSqliteDb.html">SqliteDb</a> *)pCtx;
<a name="l00595"></a>00595   Tcl_Obj *pScript = Tcl_DuplicateObj(pDb-&gt;<a class="code" href="structSqliteDb.html#a1d39f77f9f33e5e9434652544530b177">pCollateNeeded</a>);
<a name="l00596"></a>00596   Tcl_IncrRefCount(pScript);
<a name="l00597"></a>00597   Tcl_ListObjAppendElement(0, pScript, Tcl_NewStringObj(zName, -1));
<a name="l00598"></a>00598   Tcl_EvalObjEx(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>, pScript, 0);
<a name="l00599"></a>00599   Tcl_DecrRefCount(pScript);
<a name="l00600"></a>00600 }
<a name="l00601"></a>00601 
<a name="l00602"></a>00602 <span class="comment">/*</span>
<a name="l00603"></a>00603 <span class="comment">** This routine is called to evaluate an SQL collation function implemented</span>
<a name="l00604"></a>00604 <span class="comment">** using TCL script.</span>
<a name="l00605"></a>00605 <span class="comment">*/</span>
<a name="l00606"></a><a class="code" href="tclsqlite_8c.html#a8de38d7d066bf5766ec88b4cf015c3af">00606</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#a8de38d7d066bf5766ec88b4cf015c3af">tclSqlCollate</a>(
<a name="l00607"></a>00607   <span class="keywordtype">void</span> *pCtx,
<a name="l00608"></a>00608   <span class="keywordtype">int</span> nA,
<a name="l00609"></a>00609   <span class="keyword">const</span> <span class="keywordtype">void</span> *zA,
<a name="l00610"></a>00610   <span class="keywordtype">int</span> nB,
<a name="l00611"></a>00611   <span class="keyword">const</span> <span class="keywordtype">void</span> *zB
<a name="l00612"></a>00612 ){
<a name="l00613"></a>00613   <a class="code" href="structSqlCollate.html">SqlCollate</a> *p = (<a class="code" href="structSqlCollate.html">SqlCollate</a> *)pCtx;
<a name="l00614"></a>00614   Tcl_Obj *pCmd;
<a name="l00615"></a>00615 
<a name="l00616"></a>00616   pCmd = Tcl_NewStringObj(p-&gt;<a class="code" href="structSqlCollate.html#af6d57ee2d119ce791fbf0898774fb31a">zScript</a>, -1);
<a name="l00617"></a>00617   Tcl_IncrRefCount(pCmd);
<a name="l00618"></a>00618   Tcl_ListObjAppendElement(p-&gt;<a class="code" href="structSqlCollate.html#a635f16f99114a708d2c7e2211be056d5">interp</a>, pCmd, Tcl_NewStringObj(zA, nA));
<a name="l00619"></a>00619   Tcl_ListObjAppendElement(p-&gt;<a class="code" href="structSqlCollate.html#a635f16f99114a708d2c7e2211be056d5">interp</a>, pCmd, Tcl_NewStringObj(zB, nB));
<a name="l00620"></a>00620   Tcl_EvalObjEx(p-&gt;<a class="code" href="structSqlCollate.html#a635f16f99114a708d2c7e2211be056d5">interp</a>, pCmd, TCL_EVAL_DIRECT);
<a name="l00621"></a>00621   Tcl_DecrRefCount(pCmd);
<a name="l00622"></a>00622   <span class="keywordflow">return</span> (atoi(Tcl_GetStringResult(p-&gt;<a class="code" href="structSqlCollate.html#a635f16f99114a708d2c7e2211be056d5">interp</a>)));
<a name="l00623"></a>00623 }
<a name="l00624"></a>00624 
<a name="l00625"></a>00625 <span class="comment">/*</span>
<a name="l00626"></a>00626 <span class="comment">** This routine is called to evaluate an SQL function implemented</span>
<a name="l00627"></a>00627 <span class="comment">** using TCL script.</span>
<a name="l00628"></a>00628 <span class="comment">*/</span>
<a name="l00629"></a><a class="code" href="tclsqlite_8c.html#ae43d451c5e8846f9e3b4c21dca31dc20">00629</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="tclsqlite_8c.html#ae43d451c5e8846f9e3b4c21dca31dc20">tclSqlFunc</a>(<a class="code" href="structsqlite3__context.html">sqlite3_context</a> *context, <span class="keywordtype">int</span> argc, <a class="code" href="structMem.html">sqlite3_value</a>**argv){
<a name="l00630"></a>00630   <a class="code" href="structSqlFunc.html">SqlFunc</a> *p = <a class="code" href="sqlite3_8h.html#ae36489c2fd5b8e831c359b32b04d38f3">sqlite3_user_data</a>(context);
<a name="l00631"></a>00631   Tcl_Obj *pCmd;
<a name="l00632"></a>00632   <span class="keywordtype">int</span> i;
<a name="l00633"></a>00633   <span class="keywordtype">int</span> rc;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635   <span class="keywordflow">if</span>( argc==0 ){
<a name="l00636"></a>00636     <span class="comment">/* If there are no arguments to the function, call Tcl_EvalObjEx on the</span>
<a name="l00637"></a>00637 <span class="comment">    ** script object directly.  This allows the TCL compiler to generate</span>
<a name="l00638"></a>00638 <span class="comment">    ** bytecode for the command on the first invocation and thus make</span>
<a name="l00639"></a>00639 <span class="comment">    ** subsequent invocations much faster. */</span>
<a name="l00640"></a>00640     pCmd = p-&gt;<a class="code" href="structSqlFunc.html#a0e421ba3739e20e3985a1152666efd15">pScript</a>;
<a name="l00641"></a>00641     Tcl_IncrRefCount(pCmd);
<a name="l00642"></a>00642     rc = Tcl_EvalObjEx(p-&gt;<a class="code" href="structSqlFunc.html#a3e9ba0d1b0804c61c9df668283c10db8">interp</a>, pCmd, 0);
<a name="l00643"></a>00643     Tcl_DecrRefCount(pCmd);
<a name="l00644"></a>00644   }<span class="keywordflow">else</span>{
<a name="l00645"></a>00645     <span class="comment">/* If there are arguments to the function, make a shallow copy of the</span>
<a name="l00646"></a>00646 <span class="comment">    ** script object, lappend the arguments, then evaluate the copy.</span>
<a name="l00647"></a>00647 <span class="comment">    **</span>
<a name="l00648"></a>00648 <span class="comment">    ** By &quot;shallow&quot; copy, we mean a only the outer list Tcl_Obj is duplicated.</span>
<a name="l00649"></a>00649 <span class="comment">    ** The new Tcl_Obj contains pointers to the original list elements. </span>
<a name="l00650"></a>00650 <span class="comment">    ** That way, when Tcl_EvalObjv() is run and shimmers the first element</span>
<a name="l00651"></a>00651 <span class="comment">    ** of the list to tclCmdNameType, that alternate representation will</span>
<a name="l00652"></a>00652 <span class="comment">    ** be preserved and reused on the next invocation.</span>
<a name="l00653"></a>00653 <span class="comment">    */</span>
<a name="l00654"></a>00654     Tcl_Obj **aArg;
<a name="l00655"></a>00655     <span class="keywordtype">int</span> nArg;
<a name="l00656"></a>00656     <span class="keywordflow">if</span>( Tcl_ListObjGetElements(p-&gt;<a class="code" href="structSqlFunc.html#a3e9ba0d1b0804c61c9df668283c10db8">interp</a>, p-&gt;<a class="code" href="structSqlFunc.html#a0e421ba3739e20e3985a1152666efd15">pScript</a>, &amp;nArg, &amp;aArg) ){
<a name="l00657"></a>00657       <a class="code" href="sqlite3_8h.html#a02826d87e45fd4f04445a3c99a14b54e">sqlite3_result_error</a>(context, Tcl_GetStringResult(p-&gt;<a class="code" href="structSqlFunc.html#a3e9ba0d1b0804c61c9df668283c10db8">interp</a>), -1); 
<a name="l00658"></a>00658       <span class="keywordflow">return</span>;
<a name="l00659"></a>00659     }     
<a name="l00660"></a>00660     pCmd = Tcl_NewListObj(nArg, aArg);
<a name="l00661"></a>00661     Tcl_IncrRefCount(pCmd);
<a name="l00662"></a>00662     <span class="keywordflow">for</span>(i=0; i&lt;argc; i++){
<a name="l00663"></a>00663       <a class="code" href="structMem.html">sqlite3_value</a> *pIn = argv[i];
<a name="l00664"></a>00664       Tcl_Obj *pVal;
<a name="l00665"></a>00665             
<a name="l00666"></a>00666       <span class="comment">/* Set pVal to contain the i&apos;th column of this row. */</span>
<a name="l00667"></a>00667       <span class="keywordflow">switch</span>( <a class="code" href="sqlite3_8h.html#aed137fb0d21554419bc7de5675057503">sqlite3_value_type</a>(pIn) ){
<a name="l00668"></a>00668         <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a26c29a137b2a35bbde7048e5e48b794a">SQLITE_BLOB</a>: {
<a name="l00669"></a>00669           <span class="keywordtype">int</span> bytes = <a class="code" href="sqlite3_8h.html#a2aff2bf1311b5bd05d8e30738445b186">sqlite3_value_bytes</a>(pIn);
<a name="l00670"></a>00670           pVal = Tcl_NewByteArrayObj(<a class="code" href="sqlite3_8h.html#a81138be97f3e5124e33fb50925b710b6">sqlite3_value_blob</a>(pIn), bytes);
<a name="l00671"></a>00671           <span class="keywordflow">break</span>;
<a name="l00672"></a>00672         }
<a name="l00673"></a>00673         <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a7453d71905f10fa330940428f8abe21c">SQLITE_INTEGER</a>: {
<a name="l00674"></a>00674           <a class="code" href="sqlite3_8h.html#a520a95f9080c018b2fade39885bd2e2a">sqlite_int64</a> v = <a class="code" href="sqlite3_8h.html#a8e6a9f5cda11dec1ca742f58695feded">sqlite3_value_int64</a>(pIn);
<a name="l00675"></a>00675           <span class="keywordflow">if</span>( v&gt;=-2147483647 &amp;&amp; v&lt;=2147483647 ){
<a name="l00676"></a>00676             pVal = Tcl_NewIntObj(v);
<a name="l00677"></a>00677           }<span class="keywordflow">else</span>{
<a name="l00678"></a>00678             pVal = Tcl_NewWideIntObj(v);
<a name="l00679"></a>00679           }
<a name="l00680"></a>00680           <span class="keywordflow">break</span>;
<a name="l00681"></a>00681         }
<a name="l00682"></a>00682         <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a0f415018bddf6542e69792aee0357984">SQLITE_FLOAT</a>: {
<a name="l00683"></a>00683           <span class="keywordtype">double</span> r = <a class="code" href="sqlite3_8h.html#a0e5216b4627c5609b627c474617489bc">sqlite3_value_double</a>(pIn);
<a name="l00684"></a>00684           pVal = Tcl_NewDoubleObj(r);
<a name="l00685"></a>00685           <span class="keywordflow">break</span>;
<a name="l00686"></a>00686         }
<a name="l00687"></a>00687         <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#afd180931f2d06d6c245791d187da5802">SQLITE_NULL</a>: {
<a name="l00688"></a>00688           pVal = Tcl_NewStringObj(<span class="stringliteral">&quot;&quot;</span>, 0);
<a name="l00689"></a>00689           <span class="keywordflow">break</span>;
<a name="l00690"></a>00690         }
<a name="l00691"></a>00691         <span class="keywordflow">default</span>: {
<a name="l00692"></a>00692           <span class="keywordtype">int</span> bytes = <a class="code" href="sqlite3_8h.html#a2aff2bf1311b5bd05d8e30738445b186">sqlite3_value_bytes</a>(pIn);
<a name="l00693"></a>00693           pVal = Tcl_NewStringObj((<span class="keywordtype">char</span> *)<a class="code" href="sqlite3_8h.html#a766575996a443f3405e197e0d74e3a9e">sqlite3_value_text</a>(pIn), bytes);
<a name="l00694"></a>00694           <span class="keywordflow">break</span>;
<a name="l00695"></a>00695         }
<a name="l00696"></a>00696       }
<a name="l00697"></a>00697       rc = Tcl_ListObjAppendElement(p-&gt;<a class="code" href="structSqlFunc.html#a3e9ba0d1b0804c61c9df668283c10db8">interp</a>, pCmd, pVal);
<a name="l00698"></a>00698       <span class="keywordflow">if</span>( rc ){
<a name="l00699"></a>00699         Tcl_DecrRefCount(pCmd);
<a name="l00700"></a>00700         <a class="code" href="sqlite3_8h.html#a02826d87e45fd4f04445a3c99a14b54e">sqlite3_result_error</a>(context, Tcl_GetStringResult(p-&gt;<a class="code" href="structSqlFunc.html#a3e9ba0d1b0804c61c9df668283c10db8">interp</a>), -1); 
<a name="l00701"></a>00701         <span class="keywordflow">return</span>;
<a name="l00702"></a>00702       }
<a name="l00703"></a>00703     }
<a name="l00704"></a>00704     <span class="keywordflow">if</span>( !p-&gt;<a class="code" href="structSqlFunc.html#a536b8b8164a7be75f4b092dd3a4146bc">useEvalObjv</a> ){
<a name="l00705"></a>00705       <span class="comment">/* Tcl_EvalObjEx() will automatically call Tcl_EvalObjv() if pCmd</span>
<a name="l00706"></a>00706 <span class="comment">      ** is a list without a string representation.  To prevent this from</span>
<a name="l00707"></a>00707 <span class="comment">      ** happening, make sure pCmd has a valid string representation */</span>
<a name="l00708"></a>00708       Tcl_GetString(pCmd);
<a name="l00709"></a>00709     }
<a name="l00710"></a>00710     rc = Tcl_EvalObjEx(p-&gt;<a class="code" href="structSqlFunc.html#a3e9ba0d1b0804c61c9df668283c10db8">interp</a>, pCmd, TCL_EVAL_DIRECT);
<a name="l00711"></a>00711     Tcl_DecrRefCount(pCmd);
<a name="l00712"></a>00712   }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714   <span class="keywordflow">if</span>( rc &amp;&amp; rc!=TCL_RETURN ){
<a name="l00715"></a>00715     <a class="code" href="sqlite3_8h.html#a02826d87e45fd4f04445a3c99a14b54e">sqlite3_result_error</a>(context, Tcl_GetStringResult(p-&gt;<a class="code" href="structSqlFunc.html#a3e9ba0d1b0804c61c9df668283c10db8">interp</a>), -1); 
<a name="l00716"></a>00716   }<span class="keywordflow">else</span>{
<a name="l00717"></a>00717     Tcl_Obj *pVar = Tcl_GetObjResult(p-&gt;<a class="code" href="structSqlFunc.html#a3e9ba0d1b0804c61c9df668283c10db8">interp</a>);
<a name="l00718"></a>00718     <span class="keywordtype">int</span> n;
<a name="l00719"></a>00719     <a class="code" href="sqliteInt_8h.html#a74a0f6424ae628af25f23f0a35f6ead3">u8</a> *data;
<a name="l00720"></a>00720     <span class="keywordtype">char</span> *zType = pVar-&gt;typePtr ? pVar-&gt;typePtr-&gt;name : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00721"></a>00721     <span class="keywordtype">char</span> c = zType[0];
<a name="l00722"></a>00722     <span class="keywordflow">if</span>( c==<span class="charliteral">&apos;b&apos;</span> &amp;&amp; strcmp(zType,<span class="stringliteral">&quot;bytearray&quot;</span>)==0 &amp;&amp; pVar-&gt;bytes==0 ){
<a name="l00723"></a>00723       <span class="comment">/* Only return a BLOB type if the Tcl variable is a bytearray and</span>
<a name="l00724"></a>00724 <span class="comment">      ** has no string representation. */</span>
<a name="l00725"></a>00725       data = Tcl_GetByteArrayFromObj(pVar, &amp;n);
<a name="l00726"></a>00726       <a class="code" href="sqlite3_8h.html#a7dabc96652dbaf414a4dc55176a11158">sqlite3_result_blob</a>(context, data, n, <a class="code" href="sqlite3_8h.html#adec3d88e3dff21d4c566daccbede9b3b">SQLITE_TRANSIENT</a>);
<a name="l00727"></a>00727     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( c==<span class="charliteral">&apos;b&apos;</span> &amp;&amp; strcmp(zType,<span class="stringliteral">&quot;boolean&quot;</span>)==0 ){
<a name="l00728"></a>00728       Tcl_GetIntFromObj(0, pVar, &amp;n);
<a name="l00729"></a>00729       <a class="code" href="sqlite3_8h.html#a127222e07afca28c77e0b8bab06c155d">sqlite3_result_int</a>(context, n);
<a name="l00730"></a>00730     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( c==<span class="charliteral">&apos;d&apos;</span> &amp;&amp; strcmp(zType,<span class="stringliteral">&quot;double&quot;</span>)==0 ){
<a name="l00731"></a>00731       <span class="keywordtype">double</span> r;
<a name="l00732"></a>00732       Tcl_GetDoubleFromObj(0, pVar, &amp;r);
<a name="l00733"></a>00733       <a class="code" href="sqlite3_8h.html#a75eacc6277e6988383e58509d4e59a16">sqlite3_result_double</a>(context, r);
<a name="l00734"></a>00734     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( (c==<span class="charliteral">&apos;w&apos;</span> &amp;&amp; strcmp(zType,<span class="stringliteral">&quot;wideInt&quot;</span>)==0) ||
<a name="l00735"></a>00735           (c==<span class="charliteral">&apos;i&apos;</span> &amp;&amp; strcmp(zType,<span class="stringliteral">&quot;int&quot;</span>)==0) ){
<a name="l00736"></a>00736       Tcl_WideInt v;
<a name="l00737"></a>00737       Tcl_GetWideIntFromObj(0, pVar, &amp;v);
<a name="l00738"></a>00738       <a class="code" href="sqlite3_8h.html#ada836eb968e488521e96c035b50181de">sqlite3_result_int64</a>(context, v);
<a name="l00739"></a>00739     }<span class="keywordflow">else</span>{
<a name="l00740"></a>00740       data = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)Tcl_GetStringFromObj(pVar, &amp;n);
<a name="l00741"></a>00741       <a class="code" href="sqlite3_8h.html#a2dfd2d971e743b8d5a24725606a733ac">sqlite3_result_text</a>(context, (<span class="keywordtype">char</span> *)data, n, <a class="code" href="sqlite3_8h.html#adec3d88e3dff21d4c566daccbede9b3b">SQLITE_TRANSIENT</a>);
<a name="l00742"></a>00742     }
<a name="l00743"></a>00743   }
<a name="l00744"></a>00744 }
<a name="l00745"></a>00745 
<a name="l00746"></a>00746 <span class="preprocessor">#ifndef SQLITE_OMIT_AUTHORIZATION</span>
<a name="l00747"></a>00747 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l00748"></a>00748 <span class="comment">** This is the authentication function.  It appends the authentication</span>
<a name="l00749"></a>00749 <span class="comment">** type code and the two arguments to zCmd[] then invokes the result</span>
<a name="l00750"></a>00750 <span class="comment">** on the interpreter.  The reply is examined to determine if the</span>
<a name="l00751"></a>00751 <span class="comment">** authentication fails or succeeds.</span>
<a name="l00752"></a>00752 <span class="comment">*/</span>
<a name="l00753"></a><a class="code" href="tclsqlite_8c.html#af20c0dab419c4de8b1fa7095d2c2169d">00753</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#af20c0dab419c4de8b1fa7095d2c2169d">auth_callback</a>(
<a name="l00754"></a>00754   <span class="keywordtype">void</span> *pArg,
<a name="l00755"></a>00755   <span class="keywordtype">int</span> code,
<a name="l00756"></a>00756   <span class="keyword">const</span> <span class="keywordtype">char</span> *zArg1,
<a name="l00757"></a>00757   <span class="keyword">const</span> <span class="keywordtype">char</span> *zArg2,
<a name="l00758"></a>00758   <span class="keyword">const</span> <span class="keywordtype">char</span> *zArg3,
<a name="l00759"></a>00759   <span class="keyword">const</span> <span class="keywordtype">char</span> *zArg4
<a name="l00760"></a>00760 ){
<a name="l00761"></a>00761   <span class="keywordtype">char</span> *zCode;
<a name="l00762"></a>00762   Tcl_DString str;
<a name="l00763"></a>00763   <span class="keywordtype">int</span> rc;
<a name="l00764"></a>00764   <span class="keyword">const</span> <span class="keywordtype">char</span> *zReply;
<a name="l00765"></a>00765   <a class="code" href="structSqliteDb.html">SqliteDb</a> *pDb = (<a class="code" href="structSqliteDb.html">SqliteDb</a>*)pArg;
<a name="l00766"></a>00766   <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#af48d5c43dfbd5b0f4b4fab2214996989">disableAuth</a> ) <span class="keywordflow">return</span> <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00767"></a>00767 
<a name="l00768"></a>00768   <span class="keywordflow">switch</span>( code ){
<a name="l00769"></a>00769     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a2ac492b1fee01144b8f4f3f6924c9d38">SQLITE_COPY</a>              : zCode=<span class="stringliteral">&quot;SQLITE_COPY&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00770"></a>00770     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#afbcb4b5ee1d5772cef588361efba0b68">SQLITE_CREATE_INDEX</a>      : zCode=<span class="stringliteral">&quot;SQLITE_CREATE_INDEX&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00771"></a>00771     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a5c0aa6f25437e25456453c213b7a7626">SQLITE_CREATE_TABLE</a>      : zCode=<span class="stringliteral">&quot;SQLITE_CREATE_TABLE&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00772"></a>00772     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a9ec6a2ffcc0cfa3c36c8007141a38fa1">SQLITE_CREATE_TEMP_INDEX</a> : zCode=<span class="stringliteral">&quot;SQLITE_CREATE_TEMP_INDEX&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00773"></a>00773     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#af45530e07634dde0993da64df8fac41a">SQLITE_CREATE_TEMP_TABLE</a> : zCode=<span class="stringliteral">&quot;SQLITE_CREATE_TEMP_TABLE&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00774"></a>00774     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a811f55a358da6ed4d1f9d95484bbdd5c">SQLITE_CREATE_TEMP_TRIGGER</a>: zCode=<span class="stringliteral">&quot;SQLITE_CREATE_TEMP_TRIGGER&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00775"></a>00775     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a1d4f64f2b5baf8c638780511b27753a6">SQLITE_CREATE_TEMP_VIEW</a>  : zCode=<span class="stringliteral">&quot;SQLITE_CREATE_TEMP_VIEW&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00776"></a>00776     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a7dcc55ab50b69228d4a208293b43bd7d">SQLITE_CREATE_TRIGGER</a>    : zCode=<span class="stringliteral">&quot;SQLITE_CREATE_TRIGGER&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00777"></a>00777     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#ad7b8eb5c5c6545dd174090218ba2b894">SQLITE_CREATE_VIEW</a>       : zCode=<span class="stringliteral">&quot;SQLITE_CREATE_VIEW&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00778"></a>00778     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#ad68e72e7bbe70d79e4ca2016455cdf8d">SQLITE_DELETE</a>            : zCode=<span class="stringliteral">&quot;SQLITE_DELETE&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00779"></a>00779     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#ac285cb102ca0ced83ce8eaf34de49f2c">SQLITE_DROP_INDEX</a>        : zCode=<span class="stringliteral">&quot;SQLITE_DROP_INDEX&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00780"></a>00780     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a2438239bdc66129189a9f3cdcc41096e">SQLITE_DROP_TABLE</a>        : zCode=<span class="stringliteral">&quot;SQLITE_DROP_TABLE&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00781"></a>00781     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a33f05725c280233f7a2bce538d862d63">SQLITE_DROP_TEMP_INDEX</a>   : zCode=<span class="stringliteral">&quot;SQLITE_DROP_TEMP_INDEX&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00782"></a>00782     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a6fcdb2dc93b4c7937e58de176da508e3">SQLITE_DROP_TEMP_TABLE</a>   : zCode=<span class="stringliteral">&quot;SQLITE_DROP_TEMP_TABLE&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00783"></a>00783     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a06e26767a0b03197b42d0cba590285e8">SQLITE_DROP_TEMP_TRIGGER</a> : zCode=<span class="stringliteral">&quot;SQLITE_DROP_TEMP_TRIGGER&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00784"></a>00784     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a0e8b3a8774a3f9e5ffa03220d4daa236">SQLITE_DROP_TEMP_VIEW</a>    : zCode=<span class="stringliteral">&quot;SQLITE_DROP_TEMP_VIEW&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00785"></a>00785     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#ae3bf0ee40c4041190c5fed55e5504ed7">SQLITE_DROP_TRIGGER</a>      : zCode=<span class="stringliteral">&quot;SQLITE_DROP_TRIGGER&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00786"></a>00786     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#accc2ecaaf088bb98eaef53fefab83361">SQLITE_DROP_VIEW</a>         : zCode=<span class="stringliteral">&quot;SQLITE_DROP_VIEW&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00787"></a>00787     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a0d32c3f24fcfd33411eecb1e4da64a40">SQLITE_INSERT</a>            : zCode=<span class="stringliteral">&quot;SQLITE_INSERT&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00788"></a>00788     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a3a4caf2970195e9221d677852b79e5b6">SQLITE_PRAGMA</a>            : zCode=<span class="stringliteral">&quot;SQLITE_PRAGMA&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00789"></a>00789     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a3f1a55857de47148723f789496f8731b">SQLITE_READ</a>              : zCode=<span class="stringliteral">&quot;SQLITE_READ&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00790"></a>00790     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#aaf0f44e586b55ebc82bad16c31d86ba7">SQLITE_SELECT</a>            : zCode=<span class="stringliteral">&quot;SQLITE_SELECT&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00791"></a>00791     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a881c5f0d2da58a62833f97d55688df8e">SQLITE_TRANSACTION</a>       : zCode=<span class="stringliteral">&quot;SQLITE_TRANSACTION&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00792"></a>00792     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#abe5e121cf6a85525dae8c65cea7edd48">SQLITE_UPDATE</a>            : zCode=<span class="stringliteral">&quot;SQLITE_UPDATE&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00793"></a>00793     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#af6e738da0cab18033bfc290613d54d37">SQLITE_ATTACH</a>            : zCode=<span class="stringliteral">&quot;SQLITE_ATTACH&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00794"></a>00794     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a6e7e0bd673e34f1be10412263d2f0608">SQLITE_DETACH</a>            : zCode=<span class="stringliteral">&quot;SQLITE_DETACH&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00795"></a>00795     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a7352574863b7586fe9c9e64d26d1913b">SQLITE_ALTER_TABLE</a>       : zCode=<span class="stringliteral">&quot;SQLITE_ALTER_TABLE&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00796"></a>00796     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#acb9fe0eddb3cff890b0ae7ebdbb47bb7">SQLITE_REINDEX</a>           : zCode=<span class="stringliteral">&quot;SQLITE_REINDEX&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00797"></a>00797     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a6abbcfbefb1f384cb5de05e7c70b451b">SQLITE_ANALYZE</a>           : zCode=<span class="stringliteral">&quot;SQLITE_ANALYZE&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00798"></a>00798     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a561f96d54c59cc5df8f7d13489fd5820">SQLITE_CREATE_VTABLE</a>     : zCode=<span class="stringliteral">&quot;SQLITE_CREATE_VTABLE&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00799"></a>00799     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#ab8c7595b8a9c0e96e67c49a77e28b810">SQLITE_DROP_VTABLE</a>       : zCode=<span class="stringliteral">&quot;SQLITE_DROP_VTABLE&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00800"></a>00800     <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a17deed69f2e7023742c487b95c66381e">SQLITE_FUNCTION</a>          : zCode=<span class="stringliteral">&quot;SQLITE_FUNCTION&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00801"></a>00801     <span class="keywordflow">default</span>                       : zCode=<span class="stringliteral">&quot;????&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00802"></a>00802   }
<a name="l00803"></a>00803   Tcl_DStringInit(&amp;str);
<a name="l00804"></a>00804   Tcl_DStringAppend(&amp;str, pDb-&gt;<a class="code" href="structSqliteDb.html#a0c45582460ca74c9c89d0e362ffe2358">zAuth</a>, -1);
<a name="l00805"></a>00805   Tcl_DStringAppendElement(&amp;str, zCode);
<a name="l00806"></a>00806   Tcl_DStringAppendElement(&amp;str, zArg1 ? zArg1 : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00807"></a>00807   Tcl_DStringAppendElement(&amp;str, zArg2 ? zArg2 : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00808"></a>00808   Tcl_DStringAppendElement(&amp;str, zArg3 ? zArg3 : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00809"></a>00809   Tcl_DStringAppendElement(&amp;str, zArg4 ? zArg4 : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00810"></a>00810   rc = Tcl_GlobalEval(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>, Tcl_DStringValue(&amp;str));
<a name="l00811"></a>00811   Tcl_DStringFree(&amp;str);
<a name="l00812"></a>00812   zReply = Tcl_GetStringResult(pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a>);
<a name="l00813"></a>00813   <span class="keywordflow">if</span>( strcmp(zReply,<span class="stringliteral">&quot;SQLITE_OK&quot;</span>)==0 ){
<a name="l00814"></a>00814     rc = <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00815"></a>00815   }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(zReply,<span class="stringliteral">&quot;SQLITE_DENY&quot;</span>)==0 ){
<a name="l00816"></a>00816     rc = <a class="code" href="sqlite3_8h.html#aac54c702b6175785e3300e9172b5f9bb">SQLITE_DENY</a>;
<a name="l00817"></a>00817   }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(zReply,<span class="stringliteral">&quot;SQLITE_IGNORE&quot;</span>)==0 ){
<a name="l00818"></a>00818     rc = <a class="code" href="sqlite3_8h.html#a5148e80e8b93241486549be6842ecb7b">SQLITE_IGNORE</a>;
<a name="l00819"></a>00819   }<span class="keywordflow">else</span>{
<a name="l00820"></a>00820     rc = 999;
<a name="l00821"></a>00821   }
<a name="l00822"></a>00822   <span class="keywordflow">return</span> rc;
<a name="l00823"></a>00823 }
<a name="l00824"></a>00824 <span class="preprocessor">#endif </span><span class="comment">/* SQLITE_OMIT_AUTHORIZATION */</span>
<a name="l00825"></a>00825 
<a name="l00826"></a>00826 <span class="comment">/*</span>
<a name="l00827"></a>00827 <span class="comment">** zText is a pointer to text obtained via an sqlite3_result_text()</span>
<a name="l00828"></a>00828 <span class="comment">** or similar interface. This routine returns a Tcl string object, </span>
<a name="l00829"></a>00829 <span class="comment">** reference count set to 0, containing the text. If a translation</span>
<a name="l00830"></a>00830 <span class="comment">** between iso8859 and UTF-8 is required, it is preformed.</span>
<a name="l00831"></a>00831 <span class="comment">*/</span>
<a name="l00832"></a><a class="code" href="tclsqlite_8c.html#a6f3d1a8f249e127f14772767875ac9b2">00832</a> <span class="keyword">static</span> Tcl_Obj *<a class="code" href="tclsqlite_8c.html#a6f3d1a8f249e127f14772767875ac9b2">dbTextToObj</a>(<span class="keywordtype">char</span> <span class="keyword">const</span> *zText){
<a name="l00833"></a>00833   Tcl_Obj *pVal;
<a name="l00834"></a>00834 <span class="preprocessor">#ifdef UTF_TRANSLATION_NEEDED</span>
<a name="l00835"></a>00835 <span class="preprocessor"></span>  Tcl_DString dCol;
<a name="l00836"></a>00836   Tcl_DStringInit(&amp;dCol);
<a name="l00837"></a>00837   Tcl_ExternalToUtfDString(NULL, zText, -1, &amp;dCol);
<a name="l00838"></a>00838   pVal = Tcl_NewStringObj(Tcl_DStringValue(&amp;dCol), -1);
<a name="l00839"></a>00839   Tcl_DStringFree(&amp;dCol);
<a name="l00840"></a>00840 <span class="preprocessor">#else</span>
<a name="l00841"></a>00841 <span class="preprocessor"></span>  pVal = Tcl_NewStringObj(zText, -1);
<a name="l00842"></a>00842 <span class="preprocessor">#endif</span>
<a name="l00843"></a>00843 <span class="preprocessor"></span>  <span class="keywordflow">return</span> pVal;
<a name="l00844"></a>00844 }
<a name="l00845"></a>00845 
<a name="l00846"></a>00846 <span class="comment">/*</span>
<a name="l00847"></a>00847 <span class="comment">** This routine reads a line of text from FILE in, stores</span>
<a name="l00848"></a>00848 <span class="comment">** the text in memory obtained from malloc() and returns a pointer</span>
<a name="l00849"></a>00849 <span class="comment">** to the text.  NULL is returned at end of file, or if malloc()</span>
<a name="l00850"></a>00850 <span class="comment">** fails.</span>
<a name="l00851"></a>00851 <span class="comment">**</span>
<a name="l00852"></a>00852 <span class="comment">** The interface is like &quot;readline&quot; but no command-line editing</span>
<a name="l00853"></a>00853 <span class="comment">** is done.</span>
<a name="l00854"></a>00854 <span class="comment">**</span>
<a name="l00855"></a>00855 <span class="comment">** copied from shell.c from &apos;.import&apos; command</span>
<a name="l00856"></a>00856 <span class="comment">*/</span>
<a name="l00857"></a><a class="code" href="tclsqlite_8c.html#a54ce176c00bd08f2bfeb77b1ef1a6f94">00857</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="tclsqlite_8c.html#a54ce176c00bd08f2bfeb77b1ef1a6f94">local_getline</a>(<span class="keywordtype">char</span> *zPrompt, FILE *in){
<a name="l00858"></a>00858   <span class="keywordtype">char</span> *zLine;
<a name="l00859"></a>00859   <span class="keywordtype">int</span> nLine;
<a name="l00860"></a>00860   <span class="keywordtype">int</span> n;
<a name="l00861"></a>00861   <span class="keywordtype">int</span> eol;
<a name="l00862"></a>00862 
<a name="l00863"></a>00863   nLine = 100;
<a name="l00864"></a>00864   zLine = malloc( nLine );
<a name="l00865"></a>00865   <span class="keywordflow">if</span>( zLine==0 ) <span class="keywordflow">return</span> 0;
<a name="l00866"></a>00866   n = 0;
<a name="l00867"></a>00867   eol = 0;
<a name="l00868"></a>00868   <span class="keywordflow">while</span>( !eol ){
<a name="l00869"></a>00869     <span class="keywordflow">if</span>( n+100&gt;nLine ){
<a name="l00870"></a>00870       nLine = nLine*2 + 100;
<a name="l00871"></a>00871       zLine = realloc(zLine, nLine);
<a name="l00872"></a>00872       <span class="keywordflow">if</span>( zLine==0 ) <span class="keywordflow">return</span> 0;
<a name="l00873"></a>00873     }
<a name="l00874"></a>00874     <span class="keywordflow">if</span>( fgets(&amp;zLine[n], nLine - n, in)==0 ){
<a name="l00875"></a>00875       <span class="keywordflow">if</span>( n==0 ){
<a name="l00876"></a>00876         free(zLine);
<a name="l00877"></a>00877         <span class="keywordflow">return</span> 0;
<a name="l00878"></a>00878       }
<a name="l00879"></a>00879       zLine[n] = 0;
<a name="l00880"></a>00880       eol = 1;
<a name="l00881"></a>00881       <span class="keywordflow">break</span>;
<a name="l00882"></a>00882     }
<a name="l00883"></a>00883     <span class="keywordflow">while</span>( zLine[n] ){ n++; }
<a name="l00884"></a>00884     <span class="keywordflow">if</span>( n&gt;0 &amp;&amp; zLine[n-1]==<span class="charliteral">&apos;\n&apos;</span> ){
<a name="l00885"></a>00885       n--;
<a name="l00886"></a>00886       zLine[n] = 0;
<a name="l00887"></a>00887       eol = 1;
<a name="l00888"></a>00888     }
<a name="l00889"></a>00889   }
<a name="l00890"></a>00890   zLine = realloc( zLine, n+1 );
<a name="l00891"></a>00891   <span class="keywordflow">return</span> zLine;
<a name="l00892"></a>00892 }
<a name="l00893"></a>00893 
<a name="l00894"></a>00894 
<a name="l00895"></a>00895 <span class="comment">/*</span>
<a name="l00896"></a>00896 <span class="comment">** Figure out the column names for the data returned by the statement</span>
<a name="l00897"></a>00897 <span class="comment">** passed as the second argument.</span>
<a name="l00898"></a>00898 <span class="comment">**</span>
<a name="l00899"></a>00899 <span class="comment">** If parameter papColName is not NULL, then *papColName is set to point</span>
<a name="l00900"></a>00900 <span class="comment">** at an array allocated using Tcl_Alloc(). It is the callers responsibility</span>
<a name="l00901"></a>00901 <span class="comment">** to free this array using Tcl_Free(), and to decrement the reference</span>
<a name="l00902"></a>00902 <span class="comment">** count of each Tcl_Obj* member of the array.</span>
<a name="l00903"></a>00903 <span class="comment">**</span>
<a name="l00904"></a>00904 <span class="comment">** The return value of this function is the number of columns of data</span>
<a name="l00905"></a>00905 <span class="comment">** returned by pStmt (and hence the size of the *papColName array).</span>
<a name="l00906"></a>00906 <span class="comment">**</span>
<a name="l00907"></a>00907 <span class="comment">** If pArray is not NULL, then it contains the name of a Tcl array</span>
<a name="l00908"></a>00908 <span class="comment">** variable. The &quot;*&quot; member of this array is set to a list containing</span>
<a name="l00909"></a>00909 <span class="comment">** the names of the columns returned by the statement, in order from</span>
<a name="l00910"></a>00910 <span class="comment">** left to right. e.g. if the names of the returned columns are a, b and</span>
<a name="l00911"></a>00911 <span class="comment">** c, it does the equivalent of the tcl command:</span>
<a name="l00912"></a>00912 <span class="comment">**</span>
<a name="l00913"></a>00913 <span class="comment">**     set ${pArray}(*) {a b c}</span>
<a name="l00914"></a>00914 <span class="comment">*/</span>
<a name="l00915"></a>00915 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00916"></a><a class="code" href="tclsqlite_8c.html#ac55ef9d4d1678546df62817c5e37d70d">00916</a> <a class="code" href="tclsqlite_8c.html#ac55ef9d4d1678546df62817c5e37d70d">computeColumnNames</a>(
<a name="l00917"></a>00917   Tcl_Interp *interp, 
<a name="l00918"></a>00918   <a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> *pStmt,              <span class="comment">/* SQL statement */</span>
<a name="l00919"></a>00919   Tcl_Obj ***papColName,            <span class="comment">/* OUT: Array of column names */</span>
<a name="l00920"></a>00920   Tcl_Obj *pArray                   <span class="comment">/* Name of array variable (may be null) */</span>
<a name="l00921"></a>00921 ){
<a name="l00922"></a>00922   <span class="keywordtype">int</span> nCol;
<a name="l00923"></a>00923 
<a name="l00924"></a>00924   <span class="comment">/* Compute column names */</span>
<a name="l00925"></a>00925   nCol = <a class="code" href="sqlite3_8h.html#a7a4eefc77c19b661a6ba063ddf12326a">sqlite3_column_count</a>(pStmt);
<a name="l00926"></a>00926   <span class="keywordflow">if</span>( papColName ){
<a name="l00927"></a>00927     <span class="keywordtype">int</span> i;
<a name="l00928"></a>00928     Tcl_Obj **apColName = (Tcl_Obj**)Tcl_Alloc( <span class="keyword">sizeof</span>(Tcl_Obj*)*nCol );
<a name="l00929"></a>00929     <span class="keywordflow">for</span>(i=0; i&lt;nCol; i++){
<a name="l00930"></a>00930       apColName[i] = <a class="code" href="tclsqlite_8c.html#a6f3d1a8f249e127f14772767875ac9b2">dbTextToObj</a>(<a class="code" href="sqlite3_8h.html#a91645a73cd77747f5ae81b35e43e7d3d">sqlite3_column_name</a>(pStmt,i));
<a name="l00931"></a>00931       Tcl_IncrRefCount(apColName[i]);
<a name="l00932"></a>00932     }
<a name="l00933"></a>00933 
<a name="l00934"></a>00934     <span class="comment">/* If results are being stored in an array variable, then create</span>
<a name="l00935"></a>00935 <span class="comment">    ** the array(*) entry for that array</span>
<a name="l00936"></a>00936 <span class="comment">    */</span>
<a name="l00937"></a>00937     <span class="keywordflow">if</span>( pArray ){
<a name="l00938"></a>00938       Tcl_Obj *pColList = Tcl_NewObj();
<a name="l00939"></a>00939       Tcl_Obj *pStar = Tcl_NewStringObj(<span class="stringliteral">&quot;*&quot;</span>, -1);
<a name="l00940"></a>00940       Tcl_IncrRefCount(pColList);
<a name="l00941"></a>00941       <span class="keywordflow">for</span>(i=0; i&lt;nCol; i++){
<a name="l00942"></a>00942         Tcl_ListObjAppendElement(interp, pColList, apColName[i]);
<a name="l00943"></a>00943       }
<a name="l00944"></a>00944       Tcl_IncrRefCount(pStar);
<a name="l00945"></a>00945       Tcl_ObjSetVar2(interp, pArray, pStar, pColList,0);
<a name="l00946"></a>00946       Tcl_DecrRefCount(pColList);
<a name="l00947"></a>00947       Tcl_DecrRefCount(pStar);
<a name="l00948"></a>00948     }
<a name="l00949"></a>00949     *papColName = apColName;
<a name="l00950"></a>00950   }
<a name="l00951"></a>00951 
<a name="l00952"></a>00952   <span class="keywordflow">return</span> nCol;
<a name="l00953"></a>00953 }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955 <span class="comment">/*</span>
<a name="l00956"></a>00956 <span class="comment">** The &quot;sqlite&quot; command below creates a new Tcl command for each</span>
<a name="l00957"></a>00957 <span class="comment">** connection it opens to an SQLite database.  This routine is invoked</span>
<a name="l00958"></a>00958 <span class="comment">** whenever one of those connection-specific commands is executed</span>
<a name="l00959"></a>00959 <span class="comment">** in Tcl.  For example, if you run Tcl code like this:</span>
<a name="l00960"></a>00960 <span class="comment">**</span>
<a name="l00961"></a>00961 <span class="comment">**       sqlite3 db1  &quot;my_database&quot;</span>
<a name="l00962"></a>00962 <span class="comment">**       db1 close</span>
<a name="l00963"></a>00963 <span class="comment">**</span>
<a name="l00964"></a>00964 <span class="comment">** The first command opens a connection to the &quot;my_database&quot; database</span>
<a name="l00965"></a>00965 <span class="comment">** and calls that connection &quot;db1&quot;.  The second command causes this</span>
<a name="l00966"></a>00966 <span class="comment">** subroutine to be invoked.</span>
<a name="l00967"></a>00967 <span class="comment">*/</span>
<a name="l00968"></a><a class="code" href="tclsqlite_8c.html#aa0fb8e0d5de83fd3540f057c460087d1">00968</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#aa0fb8e0d5de83fd3540f057c460087d1">DbObjCmd</a>(<span class="keywordtype">void</span> *cd, Tcl_Interp *interp, <span class="keywordtype">int</span> objc,Tcl_Obj *<span class="keyword">const</span>*objv){
<a name="l00969"></a>00969   <a class="code" href="structSqliteDb.html">SqliteDb</a> *pDb = (<a class="code" href="structSqliteDb.html">SqliteDb</a>*)cd;
<a name="l00970"></a>00970   <span class="keywordtype">int</span> choice;
<a name="l00971"></a>00971   <span class="keywordtype">int</span> rc = TCL_OK;
<a name="l00972"></a>00972   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *DB_strs[] = {
<a name="l00973"></a>00973     <span class="stringliteral">&quot;authorizer&quot;</span>,         <span class="stringliteral">&quot;busy&quot;</span>,              <span class="stringliteral">&quot;cache&quot;</span>,
<a name="l00974"></a>00974     <span class="stringliteral">&quot;changes&quot;</span>,            <span class="stringliteral">&quot;close&quot;</span>,             <span class="stringliteral">&quot;collate&quot;</span>,
<a name="l00975"></a>00975     <span class="stringliteral">&quot;collation_needed&quot;</span>,   <span class="stringliteral">&quot;commit_hook&quot;</span>,       <span class="stringliteral">&quot;complete&quot;</span>,
<a name="l00976"></a>00976     <span class="stringliteral">&quot;copy&quot;</span>,               <span class="stringliteral">&quot;enable_load_extension&quot;</span>,<span class="stringliteral">&quot;errorcode&quot;</span>,
<a name="l00977"></a>00977     <span class="stringliteral">&quot;eval&quot;</span>,               <span class="stringliteral">&quot;exists&quot;</span>,            <span class="stringliteral">&quot;function&quot;</span>,
<a name="l00978"></a>00978     <span class="stringliteral">&quot;incrblob&quot;</span>,           <span class="stringliteral">&quot;interrupt&quot;</span>,         <span class="stringliteral">&quot;last_insert_rowid&quot;</span>,
<a name="l00979"></a>00979     <span class="stringliteral">&quot;nullvalue&quot;</span>,          <span class="stringliteral">&quot;onecolumn&quot;</span>,         <span class="stringliteral">&quot;profile&quot;</span>,
<a name="l00980"></a>00980     <span class="stringliteral">&quot;progress&quot;</span>,           <span class="stringliteral">&quot;rekey&quot;</span>,             <span class="stringliteral">&quot;rollback_hook&quot;</span>,
<a name="l00981"></a>00981     <span class="stringliteral">&quot;status&quot;</span>,             <span class="stringliteral">&quot;timeout&quot;</span>,           <span class="stringliteral">&quot;total_changes&quot;</span>,
<a name="l00982"></a>00982     <span class="stringliteral">&quot;trace&quot;</span>,              <span class="stringliteral">&quot;transaction&quot;</span>,       <span class="stringliteral">&quot;update_hook&quot;</span>,
<a name="l00983"></a>00983     <span class="stringliteral">&quot;version&quot;</span>,            0                    
<a name="l00984"></a>00984   };
<a name="l00985"></a>00985   <span class="keyword">enum</span> DB_enum {
<a name="l00986"></a>00986     DB_AUTHORIZER,        DB_BUSY,             DB_CACHE,
<a name="l00987"></a>00987     DB_CHANGES,           DB_CLOSE,            DB_COLLATE,
<a name="l00988"></a>00988     DB_COLLATION_NEEDED,  DB_COMMIT_HOOK,      DB_COMPLETE,
<a name="l00989"></a>00989     DB_COPY,              DB_ENABLE_LOAD_EXTENSION,DB_ERRORCODE,
<a name="l00990"></a>00990     DB_EVAL,              DB_EXISTS,           DB_FUNCTION,
<a name="l00991"></a>00991     DB_INCRBLOB,          DB_INTERRUPT,        DB_LAST_INSERT_ROWID,
<a name="l00992"></a>00992     DB_NULLVALUE,         DB_ONECOLUMN,        DB_PROFILE,
<a name="l00993"></a>00993     DB_PROGRESS,          DB_REKEY,            DB_ROLLBACK_HOOK,
<a name="l00994"></a>00994     DB_STATUS,            DB_TIMEOUT,          DB_TOTAL_CHANGES,
<a name="l00995"></a>00995     DB_TRACE,             DB_TRANSACTION,      DB_UPDATE_HOOK, 
<a name="l00996"></a>00996     DB_VERSION
<a name="l00997"></a>00997   };
<a name="l00998"></a>00998   <span class="comment">/* don&apos;t leave trailing commas on DB_enum, it confuses the AIX xlc compiler */</span>
<a name="l00999"></a>00999 
<a name="l01000"></a>01000   <span class="keywordflow">if</span>( objc&lt;2 ){
<a name="l01001"></a>01001     Tcl_WrongNumArgs(interp, 1, objv, <span class="stringliteral">&quot;SUBCOMMAND ...&quot;</span>);
<a name="l01002"></a>01002     <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01003"></a>01003   }
<a name="l01004"></a>01004   <span class="keywordflow">if</span>( Tcl_GetIndexFromObj(interp, objv[1], DB_strs, <span class="stringliteral">&quot;option&quot;</span>, 0, &amp;choice) ){
<a name="l01005"></a>01005     <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01006"></a>01006   }
<a name="l01007"></a>01007 
<a name="l01008"></a>01008   <span class="keywordflow">switch</span>( (<span class="keyword">enum</span> DB_enum)choice ){
<a name="l01009"></a>01009 
<a name="l01010"></a>01010   <span class="comment">/*    $db authorizer ?CALLBACK?</span>
<a name="l01011"></a>01011 <span class="comment">  **</span>
<a name="l01012"></a>01012 <span class="comment">  ** Invoke the given callback to authorize each SQL operation as it is</span>
<a name="l01013"></a>01013 <span class="comment">  ** compiled.  5 arguments are appended to the callback before it is</span>
<a name="l01014"></a>01014 <span class="comment">  ** invoked:</span>
<a name="l01015"></a>01015 <span class="comment">  **</span>
<a name="l01016"></a>01016 <span class="comment">  **   (1) The authorization type (ex: SQLITE_CREATE_TABLE, SQLITE_INSERT, ...)</span>
<a name="l01017"></a>01017 <span class="comment">  **   (2) First descriptive name (depends on authorization type)</span>
<a name="l01018"></a>01018 <span class="comment">  **   (3) Second descriptive name</span>
<a name="l01019"></a>01019 <span class="comment">  **   (4) Name of the database (ex: &quot;main&quot;, &quot;temp&quot;)</span>
<a name="l01020"></a>01020 <span class="comment">  **   (5) Name of trigger that is doing the access</span>
<a name="l01021"></a>01021 <span class="comment">  **</span>
<a name="l01022"></a>01022 <span class="comment">  ** The callback should return on of the following strings: SQLITE_OK,</span>
<a name="l01023"></a>01023 <span class="comment">  ** SQLITE_IGNORE, or SQLITE_DENY.  Any other return value is an error.</span>
<a name="l01024"></a>01024 <span class="comment">  **</span>
<a name="l01025"></a>01025 <span class="comment">  ** If this method is invoked with no arguments, the current authorization</span>
<a name="l01026"></a>01026 <span class="comment">  ** callback string is returned.</span>
<a name="l01027"></a>01027 <span class="comment">  */</span>
<a name="l01028"></a>01028   <span class="keywordflow">case</span> DB_AUTHORIZER: {
<a name="l01029"></a>01029 <span class="preprocessor">#ifdef SQLITE_OMIT_AUTHORIZATION</span>
<a name="l01030"></a>01030 <span class="preprocessor"></span>    Tcl_AppendResult(interp, <span class="stringliteral">&quot;authorization not available in this build&quot;</span>, 0);
<a name="l01031"></a>01031     <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01032"></a>01032 <span class="preprocessor">#else</span>
<a name="l01033"></a>01033 <span class="preprocessor"></span>    <span class="keywordflow">if</span>( objc&gt;3 ){
<a name="l01034"></a>01034       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;?CALLBACK?&quot;</span>);
<a name="l01035"></a>01035       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01036"></a>01036     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( objc==2 ){
<a name="l01037"></a>01037       <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a0c45582460ca74c9c89d0e362ffe2358">zAuth</a> ){
<a name="l01038"></a>01038         Tcl_AppendResult(interp, pDb-&gt;<a class="code" href="structSqliteDb.html#a0c45582460ca74c9c89d0e362ffe2358">zAuth</a>, 0);
<a name="l01039"></a>01039       }
<a name="l01040"></a>01040     }<span class="keywordflow">else</span>{
<a name="l01041"></a>01041       <span class="keywordtype">char</span> *zAuth;
<a name="l01042"></a>01042       <span class="keywordtype">int</span> len;
<a name="l01043"></a>01043       <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a0c45582460ca74c9c89d0e362ffe2358">zAuth</a> ){
<a name="l01044"></a>01044         Tcl_Free(pDb-&gt;<a class="code" href="structSqliteDb.html#a0c45582460ca74c9c89d0e362ffe2358">zAuth</a>);
<a name="l01045"></a>01045       }
<a name="l01046"></a>01046       zAuth = Tcl_GetStringFromObj(objv[2], &amp;len);
<a name="l01047"></a>01047       <span class="keywordflow">if</span>( zAuth &amp;&amp; len&gt;0 ){
<a name="l01048"></a>01048         pDb-&gt;<a class="code" href="structSqliteDb.html#a0c45582460ca74c9c89d0e362ffe2358">zAuth</a> = Tcl_Alloc( len + 1 );
<a name="l01049"></a>01049         memcpy(pDb-&gt;<a class="code" href="structSqliteDb.html#a0c45582460ca74c9c89d0e362ffe2358">zAuth</a>, zAuth, len+1);
<a name="l01050"></a>01050       }<span class="keywordflow">else</span>{
<a name="l01051"></a>01051         pDb-&gt;<a class="code" href="structSqliteDb.html#a0c45582460ca74c9c89d0e362ffe2358">zAuth</a> = 0;
<a name="l01052"></a>01052       }
<a name="l01053"></a>01053       <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a0c45582460ca74c9c89d0e362ffe2358">zAuth</a> ){
<a name="l01054"></a>01054         pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a> = interp;
<a name="l01055"></a>01055         <a class="code" href="auth_8c.html#a4777b652e17be2d2c2ad64a2ea8eb735">sqlite3_set_authorizer</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, <a class="code" href="tclsqlite_8c.html#af20c0dab419c4de8b1fa7095d2c2169d">auth_callback</a>, pDb);
<a name="l01056"></a>01056       }<span class="keywordflow">else</span>{
<a name="l01057"></a>01057         <a class="code" href="auth_8c.html#a4777b652e17be2d2c2ad64a2ea8eb735">sqlite3_set_authorizer</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, 0, 0);
<a name="l01058"></a>01058       }
<a name="l01059"></a>01059     }
<a name="l01060"></a>01060 <span class="preprocessor">#endif</span>
<a name="l01061"></a>01061 <span class="preprocessor"></span>    <span class="keywordflow">break</span>;
<a name="l01062"></a>01062   }
<a name="l01063"></a>01063 
<a name="l01064"></a>01064   <span class="comment">/*    $db busy ?CALLBACK?</span>
<a name="l01065"></a>01065 <span class="comment">  **</span>
<a name="l01066"></a>01066 <span class="comment">  ** Invoke the given callback if an SQL statement attempts to open</span>
<a name="l01067"></a>01067 <span class="comment">  ** a locked database file.</span>
<a name="l01068"></a>01068 <span class="comment">  */</span>
<a name="l01069"></a>01069   <span class="keywordflow">case</span> DB_BUSY: {
<a name="l01070"></a>01070     <span class="keywordflow">if</span>( objc&gt;3 ){
<a name="l01071"></a>01071       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;CALLBACK&quot;</span>);
<a name="l01072"></a>01072       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01073"></a>01073     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( objc==2 ){
<a name="l01074"></a>01074       <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a7cb84aabdfbedd95240e06775fb180ef">zBusy</a> ){
<a name="l01075"></a>01075         Tcl_AppendResult(interp, pDb-&gt;<a class="code" href="structSqliteDb.html#a7cb84aabdfbedd95240e06775fb180ef">zBusy</a>, 0);
<a name="l01076"></a>01076       }
<a name="l01077"></a>01077     }<span class="keywordflow">else</span>{
<a name="l01078"></a>01078       <span class="keywordtype">char</span> *zBusy;
<a name="l01079"></a>01079       <span class="keywordtype">int</span> len;
<a name="l01080"></a>01080       <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a7cb84aabdfbedd95240e06775fb180ef">zBusy</a> ){
<a name="l01081"></a>01081         Tcl_Free(pDb-&gt;<a class="code" href="structSqliteDb.html#a7cb84aabdfbedd95240e06775fb180ef">zBusy</a>);
<a name="l01082"></a>01082       }
<a name="l01083"></a>01083       zBusy = Tcl_GetStringFromObj(objv[2], &amp;len);
<a name="l01084"></a>01084       <span class="keywordflow">if</span>( zBusy &amp;&amp; len&gt;0 ){
<a name="l01085"></a>01085         pDb-&gt;<a class="code" href="structSqliteDb.html#a7cb84aabdfbedd95240e06775fb180ef">zBusy</a> = Tcl_Alloc( len + 1 );
<a name="l01086"></a>01086         memcpy(pDb-&gt;<a class="code" href="structSqliteDb.html#a7cb84aabdfbedd95240e06775fb180ef">zBusy</a>, zBusy, len+1);
<a name="l01087"></a>01087       }<span class="keywordflow">else</span>{
<a name="l01088"></a>01088         pDb-&gt;<a class="code" href="structSqliteDb.html#a7cb84aabdfbedd95240e06775fb180ef">zBusy</a> = 0;
<a name="l01089"></a>01089       }
<a name="l01090"></a>01090       <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a7cb84aabdfbedd95240e06775fb180ef">zBusy</a> ){
<a name="l01091"></a>01091         pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a> = interp;
<a name="l01092"></a>01092         <a class="code" href="main_8c.html#ad9e56fa98ede849233984bfae15a82a0">sqlite3_busy_handler</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, <a class="code" href="tclsqlite_8c.html#a56dc0aae05dbc7067c1e5133198a033b">DbBusyHandler</a>, pDb);
<a name="l01093"></a>01093       }<span class="keywordflow">else</span>{
<a name="l01094"></a>01094         <a class="code" href="main_8c.html#ad9e56fa98ede849233984bfae15a82a0">sqlite3_busy_handler</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, 0, 0);
<a name="l01095"></a>01095       }
<a name="l01096"></a>01096     }
<a name="l01097"></a>01097     <span class="keywordflow">break</span>;
<a name="l01098"></a>01098   }
<a name="l01099"></a>01099 
<a name="l01100"></a>01100   <span class="comment">/*     $db cache flush</span>
<a name="l01101"></a>01101 <span class="comment">  **     $db cache size n</span>
<a name="l01102"></a>01102 <span class="comment">  **</span>
<a name="l01103"></a>01103 <span class="comment">  ** Flush the prepared statement cache, or set the maximum number of</span>
<a name="l01104"></a>01104 <span class="comment">  ** cached statements.</span>
<a name="l01105"></a>01105 <span class="comment">  */</span>
<a name="l01106"></a>01106   <span class="keywordflow">case</span> DB_CACHE: {
<a name="l01107"></a>01107     <span class="keywordtype">char</span> *subCmd;
<a name="l01108"></a>01108     <span class="keywordtype">int</span> n;
<a name="l01109"></a>01109 
<a name="l01110"></a>01110     <span class="keywordflow">if</span>( objc&lt;=2 ){
<a name="l01111"></a>01111       Tcl_WrongNumArgs(interp, 1, objv, <span class="stringliteral">&quot;cache option ?arg?&quot;</span>);
<a name="l01112"></a>01112       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01113"></a>01113     }
<a name="l01114"></a>01114     subCmd = Tcl_GetStringFromObj( objv[2], 0 );
<a name="l01115"></a>01115     <span class="keywordflow">if</span>( *subCmd==<span class="charliteral">&apos;f&apos;</span> &amp;&amp; strcmp(subCmd,<span class="stringliteral">&quot;flush&quot;</span>)==0 ){
<a name="l01116"></a>01116       <span class="keywordflow">if</span>( objc!=3 ){
<a name="l01117"></a>01117         Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;flush&quot;</span>);
<a name="l01118"></a>01118         <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01119"></a>01119       }<span class="keywordflow">else</span>{
<a name="l01120"></a>01120         <a class="code" href="tclsqlite_8c.html#a48c8393e76d28d7d1b252df3297074b2">flushStmtCache</a>( pDb );
<a name="l01121"></a>01121       }
<a name="l01122"></a>01122     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( *subCmd==<span class="charliteral">&apos;s&apos;</span> &amp;&amp; strcmp(subCmd,<span class="stringliteral">&quot;size&quot;</span>)==0 ){
<a name="l01123"></a>01123       <span class="keywordflow">if</span>( objc!=4 ){
<a name="l01124"></a>01124         Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;size n&quot;</span>);
<a name="l01125"></a>01125         <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01126"></a>01126       }<span class="keywordflow">else</span>{
<a name="l01127"></a>01127         <span class="keywordflow">if</span>( TCL_ERROR==Tcl_GetIntFromObj(interp, objv[3], &amp;n) ){
<a name="l01128"></a>01128           Tcl_AppendResult( interp, <span class="stringliteral">&quot;cannot convert \&quot;&quot;</span>, 
<a name="l01129"></a>01129                Tcl_GetStringFromObj(objv[3],0), <span class="stringliteral">&quot;\&quot; to integer&quot;</span>, 0);
<a name="l01130"></a>01130           <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01131"></a>01131         }<span class="keywordflow">else</span>{
<a name="l01132"></a>01132           <span class="keywordflow">if</span>( n&lt;0 ){
<a name="l01133"></a>01133             <a class="code" href="tclsqlite_8c.html#a48c8393e76d28d7d1b252df3297074b2">flushStmtCache</a>( pDb );
<a name="l01134"></a>01134             n = 0;
<a name="l01135"></a>01135           }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( n&gt;<a class="code" href="tclsqlite_8c.html#a93755ba605854fcbb9615f3c8def160c">MAX_PREPARED_STMTS</a> ){
<a name="l01136"></a>01136             n = <a class="code" href="tclsqlite_8c.html#a93755ba605854fcbb9615f3c8def160c">MAX_PREPARED_STMTS</a>;
<a name="l01137"></a>01137           }
<a name="l01138"></a>01138           pDb-&gt;<a class="code" href="structSqliteDb.html#a552e45c18680c2bfb6962b361b40204f">maxStmt</a> = n;
<a name="l01139"></a>01139         }
<a name="l01140"></a>01140       }
<a name="l01141"></a>01141     }<span class="keywordflow">else</span>{
<a name="l01142"></a>01142       Tcl_AppendResult( interp, <span class="stringliteral">&quot;bad option \&quot;&quot;</span>, 
<a name="l01143"></a>01143           Tcl_GetStringFromObj(objv[2],0), <span class="stringliteral">&quot;\&quot;: must be flush or size&quot;</span>, 0);
<a name="l01144"></a>01144       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01145"></a>01145     }
<a name="l01146"></a>01146     <span class="keywordflow">break</span>;
<a name="l01147"></a>01147   }
<a name="l01148"></a>01148 
<a name="l01149"></a>01149   <span class="comment">/*     $db changes</span>
<a name="l01150"></a>01150 <span class="comment">  **</span>
<a name="l01151"></a>01151 <span class="comment">  ** Return the number of rows that were modified, inserted, or deleted by</span>
<a name="l01152"></a>01152 <span class="comment">  ** the most recent INSERT, UPDATE or DELETE statement, not including </span>
<a name="l01153"></a>01153 <span class="comment">  ** any changes made by trigger programs.</span>
<a name="l01154"></a>01154 <span class="comment">  */</span>
<a name="l01155"></a>01155   <span class="keywordflow">case</span> DB_CHANGES: {
<a name="l01156"></a>01156     Tcl_Obj *pResult;
<a name="l01157"></a>01157     <span class="keywordflow">if</span>( objc!=2 ){
<a name="l01158"></a>01158       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01159"></a>01159       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01160"></a>01160     }
<a name="l01161"></a>01161     pResult = Tcl_GetObjResult(interp);
<a name="l01162"></a>01162     Tcl_SetIntObj(pResult, <a class="code" href="main_8c.html#a072b54e89366ed009ccb83972bee3cff">sqlite3_changes</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>));
<a name="l01163"></a>01163     <span class="keywordflow">break</span>;
<a name="l01164"></a>01164   }
<a name="l01165"></a>01165 
<a name="l01166"></a>01166   <span class="comment">/*    $db close</span>
<a name="l01167"></a>01167 <span class="comment">  **</span>
<a name="l01168"></a>01168 <span class="comment">  ** Shutdown the database</span>
<a name="l01169"></a>01169 <span class="comment">  */</span>
<a name="l01170"></a>01170   <span class="keywordflow">case</span> DB_CLOSE: {
<a name="l01171"></a>01171     Tcl_DeleteCommand(interp, Tcl_GetStringFromObj(objv[0], 0));
<a name="l01172"></a>01172     <span class="keywordflow">break</span>;
<a name="l01173"></a>01173   }
<a name="l01174"></a>01174 
<a name="l01175"></a>01175   <span class="comment">/*</span>
<a name="l01176"></a>01176 <span class="comment">  **     $db collate NAME SCRIPT</span>
<a name="l01177"></a>01177 <span class="comment">  **</span>
<a name="l01178"></a>01178 <span class="comment">  ** Create a new SQL collation function called NAME.  Whenever</span>
<a name="l01179"></a>01179 <span class="comment">  ** that function is called, invoke SCRIPT to evaluate the function.</span>
<a name="l01180"></a>01180 <span class="comment">  */</span>
<a name="l01181"></a>01181   <span class="keywordflow">case</span> DB_COLLATE: {
<a name="l01182"></a>01182     <a class="code" href="structSqlCollate.html">SqlCollate</a> *pCollate;
<a name="l01183"></a>01183     <span class="keywordtype">char</span> *zName;
<a name="l01184"></a>01184     <span class="keywordtype">char</span> *zScript;
<a name="l01185"></a>01185     <span class="keywordtype">int</span> nScript;
<a name="l01186"></a>01186     <span class="keywordflow">if</span>( objc!=4 ){
<a name="l01187"></a>01187       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;NAME SCRIPT&quot;</span>);
<a name="l01188"></a>01188       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01189"></a>01189     }
<a name="l01190"></a>01190     zName = Tcl_GetStringFromObj(objv[2], 0);
<a name="l01191"></a>01191     zScript = Tcl_GetStringFromObj(objv[3], &amp;nScript);
<a name="l01192"></a>01192     pCollate = (<a class="code" href="structSqlCollate.html">SqlCollate</a>*)Tcl_Alloc( <span class="keyword">sizeof</span>(*pCollate) + nScript + 1 );
<a name="l01193"></a>01193     <span class="keywordflow">if</span>( pCollate==0 ) <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01194"></a>01194     pCollate-&gt;<a class="code" href="structSqlCollate.html#a635f16f99114a708d2c7e2211be056d5">interp</a> = interp;
<a name="l01195"></a>01195     pCollate-&gt;<a class="code" href="structSqlCollate.html#a45b5c1e7332d72fa455af40de09c2417">pNext</a> = pDb-&gt;<a class="code" href="structSqliteDb.html#a17b422014e06eceb32cf75eb6e0ef9ac">pCollate</a>;
<a name="l01196"></a>01196     pCollate-&gt;<a class="code" href="structSqlCollate.html#af6d57ee2d119ce791fbf0898774fb31a">zScript</a> = (<span class="keywordtype">char</span>*)&amp;pCollate[1];
<a name="l01197"></a>01197     pDb-&gt;<a class="code" href="structSqliteDb.html#a17b422014e06eceb32cf75eb6e0ef9ac">pCollate</a> = pCollate;
<a name="l01198"></a>01198     memcpy(pCollate-&gt;<a class="code" href="structSqlCollate.html#af6d57ee2d119ce791fbf0898774fb31a">zScript</a>, zScript, nScript+1);
<a name="l01199"></a>01199     <span class="keywordflow">if</span>( <a class="code" href="main_8c.html#ad33fd4664f24cf7f5ab6cfa5238eca1a">sqlite3_create_collation</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, zName, <a class="code" href="sqlite3_8h.html#a7a65f15cad0da22be8ebc0c70f526d32">SQLITE_UTF8</a>, 
<a name="l01200"></a>01200         pCollate, <a class="code" href="tclsqlite_8c.html#a8de38d7d066bf5766ec88b4cf015c3af">tclSqlCollate</a>) ){
<a name="l01201"></a>01201       Tcl_SetResult(interp, (<span class="keywordtype">char</span> *)<a class="code" href="main_8c.html#ad2a9feca40ee5a7c629c2af6d0ae1d27">sqlite3_errmsg</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>), TCL_VOLATILE);
<a name="l01202"></a>01202       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01203"></a>01203     }
<a name="l01204"></a>01204     <span class="keywordflow">break</span>;
<a name="l01205"></a>01205   }
<a name="l01206"></a>01206 
<a name="l01207"></a>01207   <span class="comment">/*</span>
<a name="l01208"></a>01208 <span class="comment">  **     $db collation_needed SCRIPT</span>
<a name="l01209"></a>01209 <span class="comment">  **</span>
<a name="l01210"></a>01210 <span class="comment">  ** Create a new SQL collation function called NAME.  Whenever</span>
<a name="l01211"></a>01211 <span class="comment">  ** that function is called, invoke SCRIPT to evaluate the function.</span>
<a name="l01212"></a>01212 <span class="comment">  */</span>
<a name="l01213"></a>01213   <span class="keywordflow">case</span> DB_COLLATION_NEEDED: {
<a name="l01214"></a>01214     <span class="keywordflow">if</span>( objc!=3 ){
<a name="l01215"></a>01215       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;SCRIPT&quot;</span>);
<a name="l01216"></a>01216       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01217"></a>01217     }
<a name="l01218"></a>01218     <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a1d39f77f9f33e5e9434652544530b177">pCollateNeeded</a> ){
<a name="l01219"></a>01219       Tcl_DecrRefCount(pDb-&gt;<a class="code" href="structSqliteDb.html#a1d39f77f9f33e5e9434652544530b177">pCollateNeeded</a>);
<a name="l01220"></a>01220     }
<a name="l01221"></a>01221     pDb-&gt;<a class="code" href="structSqliteDb.html#a1d39f77f9f33e5e9434652544530b177">pCollateNeeded</a> = Tcl_DuplicateObj(objv[2]);
<a name="l01222"></a>01222     Tcl_IncrRefCount(pDb-&gt;<a class="code" href="structSqliteDb.html#a1d39f77f9f33e5e9434652544530b177">pCollateNeeded</a>);
<a name="l01223"></a>01223     <a class="code" href="main_8c.html#aa86e42aa83812d262cf0bdfaabe7db19">sqlite3_collation_needed</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, pDb, <a class="code" href="tclsqlite_8c.html#a24621091d2c6b4947d0fceac8ee6e0a5">tclCollateNeeded</a>);
<a name="l01224"></a>01224     <span class="keywordflow">break</span>;
<a name="l01225"></a>01225   }
<a name="l01226"></a>01226 
<a name="l01227"></a>01227   <span class="comment">/*    $db commit_hook ?CALLBACK?</span>
<a name="l01228"></a>01228 <span class="comment">  **</span>
<a name="l01229"></a>01229 <span class="comment">  ** Invoke the given callback just before committing every SQL transaction.</span>
<a name="l01230"></a>01230 <span class="comment">  ** If the callback throws an exception or returns non-zero, then the</span>
<a name="l01231"></a>01231 <span class="comment">  ** transaction is aborted.  If CALLBACK is an empty string, the callback</span>
<a name="l01232"></a>01232 <span class="comment">  ** is disabled.</span>
<a name="l01233"></a>01233 <span class="comment">  */</span>
<a name="l01234"></a>01234   <span class="keywordflow">case</span> DB_COMMIT_HOOK: {
<a name="l01235"></a>01235     <span class="keywordflow">if</span>( objc&gt;3 ){
<a name="l01236"></a>01236       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;?CALLBACK?&quot;</span>);
<a name="l01237"></a>01237       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01238"></a>01238     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( objc==2 ){
<a name="l01239"></a>01239       <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a4a926744dbe738f8c4103899ead38e7e">zCommit</a> ){
<a name="l01240"></a>01240         Tcl_AppendResult(interp, pDb-&gt;<a class="code" href="structSqliteDb.html#a4a926744dbe738f8c4103899ead38e7e">zCommit</a>, 0);
<a name="l01241"></a>01241       }
<a name="l01242"></a>01242     }<span class="keywordflow">else</span>{
<a name="l01243"></a>01243       <span class="keywordtype">char</span> *zCommit;
<a name="l01244"></a>01244       <span class="keywordtype">int</span> len;
<a name="l01245"></a>01245       <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a4a926744dbe738f8c4103899ead38e7e">zCommit</a> ){
<a name="l01246"></a>01246         Tcl_Free(pDb-&gt;<a class="code" href="structSqliteDb.html#a4a926744dbe738f8c4103899ead38e7e">zCommit</a>);
<a name="l01247"></a>01247       }
<a name="l01248"></a>01248       zCommit = Tcl_GetStringFromObj(objv[2], &amp;len);
<a name="l01249"></a>01249       <span class="keywordflow">if</span>( zCommit &amp;&amp; len&gt;0 ){
<a name="l01250"></a>01250         pDb-&gt;<a class="code" href="structSqliteDb.html#a4a926744dbe738f8c4103899ead38e7e">zCommit</a> = Tcl_Alloc( len + 1 );
<a name="l01251"></a>01251         memcpy(pDb-&gt;<a class="code" href="structSqliteDb.html#a4a926744dbe738f8c4103899ead38e7e">zCommit</a>, zCommit, len+1);
<a name="l01252"></a>01252       }<span class="keywordflow">else</span>{
<a name="l01253"></a>01253         pDb-&gt;<a class="code" href="structSqliteDb.html#a4a926744dbe738f8c4103899ead38e7e">zCommit</a> = 0;
<a name="l01254"></a>01254       }
<a name="l01255"></a>01255       <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a4a926744dbe738f8c4103899ead38e7e">zCommit</a> ){
<a name="l01256"></a>01256         pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a> = interp;
<a name="l01257"></a>01257         <a class="code" href="main_8c.html#a828725f97729a5bd0631ccffb8940b5c">sqlite3_commit_hook</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, <a class="code" href="tclsqlite_8c.html#a629fc836419a9008a39bc371f445a690">DbCommitHandler</a>, pDb);
<a name="l01258"></a>01258       }<span class="keywordflow">else</span>{
<a name="l01259"></a>01259         <a class="code" href="main_8c.html#a828725f97729a5bd0631ccffb8940b5c">sqlite3_commit_hook</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, 0, 0);
<a name="l01260"></a>01260       }
<a name="l01261"></a>01261     }
<a name="l01262"></a>01262     <span class="keywordflow">break</span>;
<a name="l01263"></a>01263   }
<a name="l01264"></a>01264 
<a name="l01265"></a>01265   <span class="comment">/*    $db complete SQL</span>
<a name="l01266"></a>01266 <span class="comment">  **</span>
<a name="l01267"></a>01267 <span class="comment">  ** Return TRUE if SQL is a complete SQL statement.  Return FALSE if</span>
<a name="l01268"></a>01268 <span class="comment">  ** additional lines of input are needed.  This is similar to the</span>
<a name="l01269"></a>01269 <span class="comment">  ** built-in &quot;info complete&quot; command of Tcl.</span>
<a name="l01270"></a>01270 <span class="comment">  */</span>
<a name="l01271"></a>01271   <span class="keywordflow">case</span> DB_COMPLETE: {
<a name="l01272"></a>01272 <span class="preprocessor">#ifndef SQLITE_OMIT_COMPLETE</span>
<a name="l01273"></a>01273 <span class="preprocessor"></span>    Tcl_Obj *pResult;
<a name="l01274"></a>01274     <span class="keywordtype">int</span> isComplete;
<a name="l01275"></a>01275     <span class="keywordflow">if</span>( objc!=3 ){
<a name="l01276"></a>01276       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;SQL&quot;</span>);
<a name="l01277"></a>01277       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01278"></a>01278     }
<a name="l01279"></a>01279     isComplete = <a class="code" href="complete_8c.html#a8eec9a0a9bbde7efd4dd0cb6d15d2ddf">sqlite3_complete</a>( Tcl_GetStringFromObj(objv[2], 0) );
<a name="l01280"></a>01280     pResult = Tcl_GetObjResult(interp);
<a name="l01281"></a>01281     Tcl_SetBooleanObj(pResult, isComplete);
<a name="l01282"></a>01282 <span class="preprocessor">#endif</span>
<a name="l01283"></a>01283 <span class="preprocessor"></span>    <span class="keywordflow">break</span>;
<a name="l01284"></a>01284   }
<a name="l01285"></a>01285 
<a name="l01286"></a>01286   <span class="comment">/*    $db copy conflict-algorithm table filename ?SEPARATOR? ?NULLINDICATOR?</span>
<a name="l01287"></a>01287 <span class="comment">  **</span>
<a name="l01288"></a>01288 <span class="comment">  ** Copy data into table from filename, optionally using SEPARATOR</span>
<a name="l01289"></a>01289 <span class="comment">  ** as column separators.  If a column contains a null string, or the</span>
<a name="l01290"></a>01290 <span class="comment">  ** value of NULLINDICATOR, a NULL is inserted for the column.</span>
<a name="l01291"></a>01291 <span class="comment">  ** conflict-algorithm is one of the sqlite conflict algorithms:</span>
<a name="l01292"></a>01292 <span class="comment">  **    rollback, abort, fail, ignore, replace</span>
<a name="l01293"></a>01293 <span class="comment">  ** On success, return the number of lines processed, not necessarily same</span>
<a name="l01294"></a>01294 <span class="comment">  ** as &apos;db changes&apos; due to conflict-algorithm selected.</span>
<a name="l01295"></a>01295 <span class="comment">  **</span>
<a name="l01296"></a>01296 <span class="comment">  ** This code is basically an implementation/enhancement of</span>
<a name="l01297"></a>01297 <span class="comment">  ** the sqlite3 shell.c &quot;.import&quot; command.</span>
<a name="l01298"></a>01298 <span class="comment">  **</span>
<a name="l01299"></a>01299 <span class="comment">  ** This command usage is equivalent to the sqlite2.x COPY statement,</span>
<a name="l01300"></a>01300 <span class="comment">  ** which imports file data into a table using the PostgreSQL COPY file format:</span>
<a name="l01301"></a>01301 <span class="comment">  **   $db copy $conflit_algo $table_name $filename \t \\N</span>
<a name="l01302"></a>01302 <span class="comment">  */</span>
<a name="l01303"></a>01303   <span class="keywordflow">case</span> DB_COPY: {
<a name="l01304"></a>01304     <span class="keywordtype">char</span> *zTable;               <span class="comment">/* Insert data into this table */</span>
<a name="l01305"></a>01305     <span class="keywordtype">char</span> *zFile;                <span class="comment">/* The file from which to extract data */</span>
<a name="l01306"></a>01306     <span class="keywordtype">char</span> *zConflict;            <span class="comment">/* The conflict algorithm to use */</span>
<a name="l01307"></a>01307     <a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> *pStmt;        <span class="comment">/* A statement */</span>
<a name="l01308"></a>01308     <span class="keywordtype">int</span> nCol;                   <span class="comment">/* Number of columns in the table */</span>
<a name="l01309"></a>01309     <span class="keywordtype">int</span> nByte;                  <span class="comment">/* Number of bytes in an SQL string */</span>
<a name="l01310"></a>01310     <span class="keywordtype">int</span> i, j;                   <span class="comment">/* Loop counters */</span>
<a name="l01311"></a>01311     <span class="keywordtype">int</span> nSep;                   <span class="comment">/* Number of bytes in zSep[] */</span>
<a name="l01312"></a>01312     <span class="keywordtype">int</span> nNull;                  <span class="comment">/* Number of bytes in zNull[] */</span>
<a name="l01313"></a>01313     <span class="keywordtype">char</span> *zSql;                 <span class="comment">/* An SQL statement */</span>
<a name="l01314"></a>01314     <span class="keywordtype">char</span> *zLine;                <span class="comment">/* A single line of input from the file */</span>
<a name="l01315"></a>01315     <span class="keywordtype">char</span> **azCol;               <span class="comment">/* zLine[] broken up into columns */</span>
<a name="l01316"></a>01316     <span class="keywordtype">char</span> *zCommit;              <span class="comment">/* How to commit changes */</span>
<a name="l01317"></a>01317     FILE *in;                   <span class="comment">/* The input file */</span>
<a name="l01318"></a>01318     <span class="keywordtype">int</span> lineno = 0;             <span class="comment">/* Line number of input file */</span>
<a name="l01319"></a>01319     <span class="keywordtype">char</span> zLineNum[80];          <span class="comment">/* Line number print buffer */</span>
<a name="l01320"></a>01320     Tcl_Obj *pResult;           <span class="comment">/* interp result */</span>
<a name="l01321"></a>01321 
<a name="l01322"></a>01322     <span class="keywordtype">char</span> *zSep;
<a name="l01323"></a>01323     <span class="keywordtype">char</span> *zNull;
<a name="l01324"></a>01324     <span class="keywordflow">if</span>( objc&lt;5 || objc&gt;7 ){
<a name="l01325"></a>01325       Tcl_WrongNumArgs(interp, 2, objv, 
<a name="l01326"></a>01326          <span class="stringliteral">&quot;CONFLICT-ALGORITHM TABLE FILENAME ?SEPARATOR? ?NULLINDICATOR?&quot;</span>);
<a name="l01327"></a>01327       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01328"></a>01328     }
<a name="l01329"></a>01329     <span class="keywordflow">if</span>( objc&gt;=6 ){
<a name="l01330"></a>01330       zSep = Tcl_GetStringFromObj(objv[5], 0);
<a name="l01331"></a>01331     }<span class="keywordflow">else</span>{
<a name="l01332"></a>01332       zSep = <span class="stringliteral">&quot;\t&quot;</span>;
<a name="l01333"></a>01333     }
<a name="l01334"></a>01334     <span class="keywordflow">if</span>( objc&gt;=7 ){
<a name="l01335"></a>01335       zNull = Tcl_GetStringFromObj(objv[6], 0);
<a name="l01336"></a>01336     }<span class="keywordflow">else</span>{
<a name="l01337"></a>01337       zNull = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01338"></a>01338     }
<a name="l01339"></a>01339     zConflict = Tcl_GetStringFromObj(objv[2], 0);
<a name="l01340"></a>01340     zTable = Tcl_GetStringFromObj(objv[3], 0);
<a name="l01341"></a>01341     zFile = Tcl_GetStringFromObj(objv[4], 0);
<a name="l01342"></a>01342     nSep = strlen(zSep);
<a name="l01343"></a>01343     nNull = strlen(zNull);
<a name="l01344"></a>01344     <span class="keywordflow">if</span>( nSep==0 ){
<a name="l01345"></a>01345       Tcl_AppendResult(interp,<span class="stringliteral">&quot;Error: non-null separator required for copy&quot;</span>,0);
<a name="l01346"></a>01346       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01347"></a>01347     }
<a name="l01348"></a>01348     <span class="keywordflow">if</span>(strcmp(zConflict, <span class="stringliteral">&quot;rollback&quot;</span>) != 0 &amp;&amp;
<a name="l01349"></a>01349        strcmp(zConflict, <span class="stringliteral">&quot;abort&quot;</span>   ) != 0 &amp;&amp;
<a name="l01350"></a>01350        strcmp(zConflict, <span class="stringliteral">&quot;fail&quot;</span>    ) != 0 &amp;&amp;
<a name="l01351"></a>01351        strcmp(zConflict, <span class="stringliteral">&quot;ignore&quot;</span>  ) != 0 &amp;&amp;
<a name="l01352"></a>01352        strcmp(zConflict, <span class="stringliteral">&quot;replace&quot;</span> ) != 0 ) {
<a name="l01353"></a>01353       Tcl_AppendResult(interp, <span class="stringliteral">&quot;Error: \&quot;&quot;</span>, zConflict, 
<a name="l01354"></a>01354             <span class="stringliteral">&quot;\&quot;, conflict-algorithm must be one of: rollback, &quot;</span>
<a name="l01355"></a>01355             <span class="stringliteral">&quot;abort, fail, ignore, or replace&quot;</span>, 0);
<a name="l01356"></a>01356       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01357"></a>01357     }
<a name="l01358"></a>01358     zSql = <a class="code" href="printf_8c.html#a708f6775f57f33c17e982512a00df665">sqlite3_mprintf</a>(<span class="stringliteral">&quot;SELECT * FROM &apos;%q&apos;&quot;</span>, zTable);
<a name="l01359"></a>01359     <span class="keywordflow">if</span>( zSql==0 ){
<a name="l01360"></a>01360       Tcl_AppendResult(interp, <span class="stringliteral">&quot;Error: no such table: &quot;</span>, zTable, 0);
<a name="l01361"></a>01361       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01362"></a>01362     }
<a name="l01363"></a>01363     nByte = strlen(zSql);
<a name="l01364"></a>01364     rc = <a class="code" href="prepare_8c.html#a2322405eadeb95539ec7c96e2cfdf38b">sqlite3_prepare</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, zSql, -1, &amp;pStmt, 0);
<a name="l01365"></a>01365     <a class="code" href="malloc_8c.html#a89d4380358f918be2a8e2171d95bbb04">sqlite3_free</a>(zSql);
<a name="l01366"></a>01366     <span class="keywordflow">if</span>( rc ){
<a name="l01367"></a>01367       Tcl_AppendResult(interp, <span class="stringliteral">&quot;Error: &quot;</span>, <a class="code" href="main_8c.html#ad2a9feca40ee5a7c629c2af6d0ae1d27">sqlite3_errmsg</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>), 0);
<a name="l01368"></a>01368       nCol = 0;
<a name="l01369"></a>01369     }<span class="keywordflow">else</span>{
<a name="l01370"></a>01370       nCol = <a class="code" href="sqlite3_8h.html#a7a4eefc77c19b661a6ba063ddf12326a">sqlite3_column_count</a>(pStmt);
<a name="l01371"></a>01371     }
<a name="l01372"></a>01372     <a class="code" href="sqlite3_8h.html#aaf6c3dbc23f33c0752588425c7e9d498">sqlite3_finalize</a>(pStmt);
<a name="l01373"></a>01373     <span class="keywordflow">if</span>( nCol==0 ) {
<a name="l01374"></a>01374       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01375"></a>01375     }
<a name="l01376"></a>01376     zSql = malloc( nByte + 50 + nCol*2 );
<a name="l01377"></a>01377     <span class="keywordflow">if</span>( zSql==0 ) {
<a name="l01378"></a>01378       Tcl_AppendResult(interp, <span class="stringliteral">&quot;Error: can&apos;t malloc()&quot;</span>, 0);
<a name="l01379"></a>01379       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01380"></a>01380     }
<a name="l01381"></a>01381     <a class="code" href="printf_8c.html#aa62e83e27ab0a63e15f9f844c17c595f">sqlite3_snprintf</a>(nByte+50, zSql, <span class="stringliteral">&quot;INSERT OR %q INTO &apos;%q&apos; VALUES(?&quot;</span>,
<a name="l01382"></a>01382          zConflict, zTable);
<a name="l01383"></a>01383     j = strlen(zSql);
<a name="l01384"></a>01384     <span class="keywordflow">for</span>(i=1; i&lt;nCol; i++){
<a name="l01385"></a>01385       zSql[j++] = <span class="charliteral">&apos;,&apos;</span>;
<a name="l01386"></a>01386       zSql[j++] = <span class="charliteral">&apos;?&apos;</span>;
<a name="l01387"></a>01387     }
<a name="l01388"></a>01388     zSql[j++] = <span class="charliteral">&apos;)&apos;</span>;
<a name="l01389"></a>01389     zSql[j] = 0;
<a name="l01390"></a>01390     rc = <a class="code" href="prepare_8c.html#a2322405eadeb95539ec7c96e2cfdf38b">sqlite3_prepare</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, zSql, -1, &amp;pStmt, 0);
<a name="l01391"></a>01391     free(zSql);
<a name="l01392"></a>01392     <span class="keywordflow">if</span>( rc ){
<a name="l01393"></a>01393       Tcl_AppendResult(interp, <span class="stringliteral">&quot;Error: &quot;</span>, <a class="code" href="main_8c.html#ad2a9feca40ee5a7c629c2af6d0ae1d27">sqlite3_errmsg</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>), 0);
<a name="l01394"></a>01394       <a class="code" href="sqlite3_8h.html#aaf6c3dbc23f33c0752588425c7e9d498">sqlite3_finalize</a>(pStmt);
<a name="l01395"></a>01395       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01396"></a>01396     }
<a name="l01397"></a>01397     in = fopen(zFile, <span class="stringliteral">&quot;rb&quot;</span>);
<a name="l01398"></a>01398     <span class="keywordflow">if</span>( in==0 ){
<a name="l01399"></a>01399       Tcl_AppendResult(interp, <span class="stringliteral">&quot;Error: cannot open file: &quot;</span>, zFile, NULL);
<a name="l01400"></a>01400       <a class="code" href="sqlite3_8h.html#aaf6c3dbc23f33c0752588425c7e9d498">sqlite3_finalize</a>(pStmt);
<a name="l01401"></a>01401       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01402"></a>01402     }
<a name="l01403"></a>01403     azCol = malloc( <span class="keyword">sizeof</span>(azCol[0])*(nCol+1) );
<a name="l01404"></a>01404     <span class="keywordflow">if</span>( azCol==0 ) {
<a name="l01405"></a>01405       Tcl_AppendResult(interp, <span class="stringliteral">&quot;Error: can&apos;t malloc()&quot;</span>, 0);
<a name="l01406"></a>01406       fclose(in);
<a name="l01407"></a>01407       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01408"></a>01408     }
<a name="l01409"></a>01409     (void)<a class="code" href="legacy_8c.html#ada787486cf95a994521cfd0c64e853e4">sqlite3_exec</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, <span class="stringliteral">&quot;BEGIN&quot;</span>, 0, 0, 0);
<a name="l01410"></a>01410     zCommit = <span class="stringliteral">&quot;COMMIT&quot;</span>;
<a name="l01411"></a>01411     <span class="keywordflow">while</span>( (zLine = <a class="code" href="tclsqlite_8c.html#a54ce176c00bd08f2bfeb77b1ef1a6f94">local_getline</a>(0, in))!=0 ){
<a name="l01412"></a>01412       <span class="keywordtype">char</span> *z;
<a name="l01413"></a>01413       i = 0;
<a name="l01414"></a>01414       lineno++;
<a name="l01415"></a>01415       azCol[0] = zLine;
<a name="l01416"></a>01416       <span class="keywordflow">for</span>(i=0, z=zLine; *z; z++){
<a name="l01417"></a>01417         <span class="keywordflow">if</span>( *z==zSep[0] &amp;&amp; strncmp(z, zSep, nSep)==0 ){
<a name="l01418"></a>01418           *z = 0;
<a name="l01419"></a>01419           i++;
<a name="l01420"></a>01420           <span class="keywordflow">if</span>( i&lt;nCol ){
<a name="l01421"></a>01421             azCol[i] = &amp;z[nSep];
<a name="l01422"></a>01422             z += nSep-1;
<a name="l01423"></a>01423           }
<a name="l01424"></a>01424         }
<a name="l01425"></a>01425       }
<a name="l01426"></a>01426       <span class="keywordflow">if</span>( i+1!=nCol ){
<a name="l01427"></a>01427         <span class="keywordtype">char</span> *zErr;
<a name="l01428"></a>01428         <span class="keywordtype">int</span> nErr = strlen(zFile) + 200;
<a name="l01429"></a>01429         zErr = malloc(nErr);
<a name="l01430"></a>01430         <span class="keywordflow">if</span>( zErr ){
<a name="l01431"></a>01431           <a class="code" href="printf_8c.html#aa62e83e27ab0a63e15f9f844c17c595f">sqlite3_snprintf</a>(nErr, zErr,
<a name="l01432"></a>01432              <span class="stringliteral">&quot;Error: %s line %d: expected %d columns of data but found %d&quot;</span>,
<a name="l01433"></a>01433              zFile, lineno, nCol, i+1);
<a name="l01434"></a>01434           Tcl_AppendResult(interp, zErr, 0);
<a name="l01435"></a>01435           free(zErr);
<a name="l01436"></a>01436         }
<a name="l01437"></a>01437         zCommit = <span class="stringliteral">&quot;ROLLBACK&quot;</span>;
<a name="l01438"></a>01438         <span class="keywordflow">break</span>;
<a name="l01439"></a>01439       }
<a name="l01440"></a>01440       <span class="keywordflow">for</span>(i=0; i&lt;nCol; i++){
<a name="l01441"></a>01441         <span class="comment">/* check for null data, if so, bind as null */</span>
<a name="l01442"></a>01442         <span class="keywordflow">if</span> ((nNull&gt;0 &amp;&amp; strcmp(azCol[i], zNull)==0) || strlen(azCol[i])==0) {
<a name="l01443"></a>01443           <a class="code" href="sqlite3_8h.html#a361e2e79de6e4a728c4ec7d48f1762ea">sqlite3_bind_null</a>(pStmt, i+1);
<a name="l01444"></a>01444         }<span class="keywordflow">else</span>{
<a name="l01445"></a>01445           <a class="code" href="sqlite3_8h.html#a154a83560a7c30758ad266cbb248de11">sqlite3_bind_text</a>(pStmt, i+1, azCol[i], -1, <a class="code" href="sqlite3_8h.html#a98b49797a7a15e2a570532fc2b5537c8">SQLITE_STATIC</a>);
<a name="l01446"></a>01446         }
<a name="l01447"></a>01447       }
<a name="l01448"></a>01448       <a class="code" href="sqlite3_8h.html#ae04a3cf3ae391dabf1161cc0e040e9e8">sqlite3_step</a>(pStmt);
<a name="l01449"></a>01449       rc = <a class="code" href="sqlite3_8h.html#a4f90cba6b396574cf3d5b1ac009de0c7">sqlite3_reset</a>(pStmt);
<a name="l01450"></a>01450       free(zLine);
<a name="l01451"></a>01451       <span class="keywordflow">if</span>( rc!=<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> ){
<a name="l01452"></a>01452         Tcl_AppendResult(interp,<span class="stringliteral">&quot;Error: &quot;</span>, <a class="code" href="main_8c.html#ad2a9feca40ee5a7c629c2af6d0ae1d27">sqlite3_errmsg</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>), 0);
<a name="l01453"></a>01453         zCommit = <span class="stringliteral">&quot;ROLLBACK&quot;</span>;
<a name="l01454"></a>01454         <span class="keywordflow">break</span>;
<a name="l01455"></a>01455       }
<a name="l01456"></a>01456     }
<a name="l01457"></a>01457     free(azCol);
<a name="l01458"></a>01458     fclose(in);
<a name="l01459"></a>01459     <a class="code" href="sqlite3_8h.html#aaf6c3dbc23f33c0752588425c7e9d498">sqlite3_finalize</a>(pStmt);
<a name="l01460"></a>01460     (void)<a class="code" href="legacy_8c.html#ada787486cf95a994521cfd0c64e853e4">sqlite3_exec</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, zCommit, 0, 0, 0);
<a name="l01461"></a>01461 
<a name="l01462"></a>01462     <span class="keywordflow">if</span>( zCommit[0] == <span class="charliteral">&apos;C&apos;</span> ){
<a name="l01463"></a>01463       <span class="comment">/* success, set result as number of lines processed */</span>
<a name="l01464"></a>01464       pResult = Tcl_GetObjResult(interp);
<a name="l01465"></a>01465       Tcl_SetIntObj(pResult, lineno);
<a name="l01466"></a>01466       rc = TCL_OK;
<a name="l01467"></a>01467     }<span class="keywordflow">else</span>{
<a name="l01468"></a>01468       <span class="comment">/* failure, append lineno where failed */</span>
<a name="l01469"></a>01469       <a class="code" href="printf_8c.html#aa62e83e27ab0a63e15f9f844c17c595f">sqlite3_snprintf</a>(<span class="keyword">sizeof</span>(zLineNum), zLineNum,<span class="stringliteral">&quot;%d&quot;</span>,lineno);
<a name="l01470"></a>01470       Tcl_AppendResult(interp,<span class="stringliteral">&quot;, failed while processing line: &quot;</span>,zLineNum,0);
<a name="l01471"></a>01471       rc = TCL_ERROR;
<a name="l01472"></a>01472     }
<a name="l01473"></a>01473     <span class="keywordflow">break</span>;
<a name="l01474"></a>01474   }
<a name="l01475"></a>01475 
<a name="l01476"></a>01476   <span class="comment">/*</span>
<a name="l01477"></a>01477 <span class="comment">  **    $db enable_load_extension BOOLEAN</span>
<a name="l01478"></a>01478 <span class="comment">  **</span>
<a name="l01479"></a>01479 <span class="comment">  ** Turn the extension loading feature on or off.  It if off by</span>
<a name="l01480"></a>01480 <span class="comment">  ** default.</span>
<a name="l01481"></a>01481 <span class="comment">  */</span>
<a name="l01482"></a>01482   <span class="keywordflow">case</span> DB_ENABLE_LOAD_EXTENSION: {
<a name="l01483"></a>01483 <span class="preprocessor">#ifndef SQLITE_OMIT_LOAD_EXTENSION</span>
<a name="l01484"></a>01484 <span class="preprocessor"></span>    <span class="keywordtype">int</span> onoff;
<a name="l01485"></a>01485     <span class="keywordflow">if</span>( objc!=3 ){
<a name="l01486"></a>01486       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;BOOLEAN&quot;</span>);
<a name="l01487"></a>01487       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01488"></a>01488     }
<a name="l01489"></a>01489     <span class="keywordflow">if</span>( Tcl_GetBooleanFromObj(interp, objv[2], &amp;onoff) ){
<a name="l01490"></a>01490       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01491"></a>01491     }
<a name="l01492"></a>01492     <a class="code" href="loadext_8c.html#a474f82f1c0396e53147181d17ee32a03">sqlite3_enable_load_extension</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, onoff);
<a name="l01493"></a>01493     <span class="keywordflow">break</span>;
<a name="l01494"></a>01494 <span class="preprocessor">#else</span>
<a name="l01495"></a>01495 <span class="preprocessor"></span>    Tcl_AppendResult(interp, <span class="stringliteral">&quot;extension loading is turned off at compile-time&quot;</span>,
<a name="l01496"></a>01496                      0);
<a name="l01497"></a>01497     <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01498"></a>01498 <span class="preprocessor">#endif</span>
<a name="l01499"></a>01499 <span class="preprocessor"></span>  }
<a name="l01500"></a>01500 
<a name="l01501"></a>01501   <span class="comment">/*</span>
<a name="l01502"></a>01502 <span class="comment">  **    $db errorcode</span>
<a name="l01503"></a>01503 <span class="comment">  **</span>
<a name="l01504"></a>01504 <span class="comment">  ** Return the numeric error code that was returned by the most recent</span>
<a name="l01505"></a>01505 <span class="comment">  ** call to sqlite3_exec().</span>
<a name="l01506"></a>01506 <span class="comment">  */</span>
<a name="l01507"></a>01507   <span class="keywordflow">case</span> DB_ERRORCODE: {
<a name="l01508"></a>01508     Tcl_SetObjResult(interp, Tcl_NewIntObj(<a class="code" href="main_8c.html#aacf8bb5cc3e174eca0c6aab77aa9d4ec">sqlite3_errcode</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>)));
<a name="l01509"></a>01509     <span class="keywordflow">break</span>;
<a name="l01510"></a>01510   }
<a name="l01511"></a>01511    
<a name="l01512"></a>01512   <span class="comment">/*</span>
<a name="l01513"></a>01513 <span class="comment">  **    $db eval $sql ?array? ?{  ...code... }?</span>
<a name="l01514"></a>01514 <span class="comment">  **    $db onecolumn $sql</span>
<a name="l01515"></a>01515 <span class="comment">  **</span>
<a name="l01516"></a>01516 <span class="comment">  ** The SQL statement in $sql is evaluated.  For each row, the values are</span>
<a name="l01517"></a>01517 <span class="comment">  ** placed in elements of the array named &quot;array&quot; and ...code... is executed.</span>
<a name="l01518"></a>01518 <span class="comment">  ** If &quot;array&quot; and &quot;code&quot; are omitted, then no callback is every invoked.</span>
<a name="l01519"></a>01519 <span class="comment">  ** If &quot;array&quot; is an empty string, then the values are placed in variables</span>
<a name="l01520"></a>01520 <span class="comment">  ** that have the same name as the fields extracted by the query.</span>
<a name="l01521"></a>01521 <span class="comment">  **</span>
<a name="l01522"></a>01522 <span class="comment">  ** The onecolumn method is the equivalent of:</span>
<a name="l01523"></a>01523 <span class="comment">  **     lindex [$db eval $sql] 0</span>
<a name="l01524"></a>01524 <span class="comment">  */</span>
<a name="l01525"></a>01525   <span class="keywordflow">case</span> DB_ONECOLUMN:
<a name="l01526"></a>01526   <span class="keywordflow">case</span> DB_EVAL:
<a name="l01527"></a>01527   <span class="keywordflow">case</span> DB_EXISTS: {
<a name="l01528"></a>01528     <span class="keywordtype">char</span> <span class="keyword">const</span> *zSql;      <span class="comment">/* Next SQL statement to execute */</span>
<a name="l01529"></a>01529     <span class="keywordtype">char</span> <span class="keyword">const</span> *zLeft;     <span class="comment">/* What is left after first stmt in zSql */</span>
<a name="l01530"></a>01530     <a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> *pStmt;   <span class="comment">/* Compiled SQL statment */</span>
<a name="l01531"></a>01531     Tcl_Obj *pArray;       <span class="comment">/* Name of array into which results are written */</span>
<a name="l01532"></a>01532     Tcl_Obj *pScript;      <span class="comment">/* Script to run for each result set */</span>
<a name="l01533"></a>01533     Tcl_Obj **apParm;      <span class="comment">/* Parameters that need a Tcl_DecrRefCount() */</span>
<a name="l01534"></a>01534     <span class="keywordtype">int</span> nParm;             <span class="comment">/* Number of entries used in apParm[] */</span>
<a name="l01535"></a>01535     Tcl_Obj *aParm[10];    <span class="comment">/* Static space for apParm[] in the common case */</span>
<a name="l01536"></a>01536     Tcl_Obj *pRet;         <span class="comment">/* Value to be returned */</span>
<a name="l01537"></a>01537     <a class="code" href="structSqlPreparedStmt.html">SqlPreparedStmt</a> *pPreStmt;  <span class="comment">/* Pointer to a prepared statement */</span>
<a name="l01538"></a>01538     <span class="keywordtype">int</span> rc2;
<a name="l01539"></a>01539 
<a name="l01540"></a>01540     <span class="keywordflow">if</span>( choice==DB_EVAL ){
<a name="l01541"></a>01541       <span class="keywordflow">if</span>( objc&lt;3 || objc&gt;5 ){
<a name="l01542"></a>01542         Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;SQL ?ARRAY-NAME? ?SCRIPT?&quot;</span>);
<a name="l01543"></a>01543         <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01544"></a>01544       }
<a name="l01545"></a>01545       pRet = Tcl_NewObj();
<a name="l01546"></a>01546       Tcl_IncrRefCount(pRet);
<a name="l01547"></a>01547     }<span class="keywordflow">else</span>{
<a name="l01548"></a>01548       <span class="keywordflow">if</span>( objc!=3 ){
<a name="l01549"></a>01549         Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;SQL&quot;</span>);
<a name="l01550"></a>01550         <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01551"></a>01551       }
<a name="l01552"></a>01552       <span class="keywordflow">if</span>( choice==DB_EXISTS ){
<a name="l01553"></a>01553         pRet = Tcl_NewBooleanObj(0);
<a name="l01554"></a>01554         Tcl_IncrRefCount(pRet);
<a name="l01555"></a>01555       }<span class="keywordflow">else</span>{
<a name="l01556"></a>01556         pRet = 0;
<a name="l01557"></a>01557       }
<a name="l01558"></a>01558     }
<a name="l01559"></a>01559     <span class="keywordflow">if</span>( objc==3 ){
<a name="l01560"></a>01560       pArray = pScript = 0;
<a name="l01561"></a>01561     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( objc==4 ){
<a name="l01562"></a>01562       pArray = 0;
<a name="l01563"></a>01563       pScript = objv[3];
<a name="l01564"></a>01564     }<span class="keywordflow">else</span>{
<a name="l01565"></a>01565       pArray = objv[3];
<a name="l01566"></a>01566       <span class="keywordflow">if</span>( Tcl_GetString(pArray)[0]==0 ) pArray = 0;
<a name="l01567"></a>01567       pScript = objv[4];
<a name="l01568"></a>01568     }
<a name="l01569"></a>01569 
<a name="l01570"></a>01570     Tcl_IncrRefCount(objv[2]);
<a name="l01571"></a>01571     zSql = Tcl_GetStringFromObj(objv[2], 0);
<a name="l01572"></a>01572     <span class="keywordflow">while</span>( rc==TCL_OK &amp;&amp; zSql[0] ){
<a name="l01573"></a>01573       <span class="keywordtype">int</span> i;                     <span class="comment">/* Loop counter */</span>
<a name="l01574"></a>01574       <span class="keywordtype">int</span> nVar;                  <span class="comment">/* Number of bind parameters in the pStmt */</span>
<a name="l01575"></a>01575       <span class="keywordtype">int</span> nCol = -1;             <span class="comment">/* Number of columns in the result set */</span>
<a name="l01576"></a>01576       Tcl_Obj **apColName = 0;   <span class="comment">/* Array of column names */</span>
<a name="l01577"></a>01577       <span class="keywordtype">int</span> len;                   <span class="comment">/* String length of zSql */</span>
<a name="l01578"></a>01578   
<a name="l01579"></a>01579       <span class="comment">/* Try to find a SQL statement that has already been compiled and</span>
<a name="l01580"></a>01580 <span class="comment">      ** which matches the next sequence of SQL.</span>
<a name="l01581"></a>01581 <span class="comment">      */</span>
<a name="l01582"></a>01582       pStmt = 0;
<a name="l01583"></a>01583       len = strlen(zSql);
<a name="l01584"></a>01584       <span class="keywordflow">for</span>(pPreStmt = pDb-&gt;<a class="code" href="structSqliteDb.html#a622c25c8c19cd96236513cb643bb34b3">stmtList</a>; pPreStmt; pPreStmt=pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#ab507bc5e962f1c1f1f27dc7468c3bee1">pNext</a>){
<a name="l01585"></a>01585         <span class="keywordtype">int</span> n = pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#a3bdc15903b54995e489270392aaef9f9">nSql</a>;
<a name="l01586"></a>01586         <span class="keywordflow">if</span>( len&gt;=n 
<a name="l01587"></a>01587             &amp;&amp; memcmp(pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#adf0ae473efb12e525ffae189e7965295">zSql</a>, zSql, n)==0
<a name="l01588"></a>01588             &amp;&amp; (zSql[n]==0 || zSql[n-1]==<span class="charliteral">&apos;;&apos;</span>)
<a name="l01589"></a>01589         ){
<a name="l01590"></a>01590           pStmt = pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#a1281d141acc5a7e88d0c006814b437cf">pStmt</a>;
<a name="l01591"></a>01591           zLeft = &amp;zSql[pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#a3bdc15903b54995e489270392aaef9f9">nSql</a>];
<a name="l01592"></a>01592 
<a name="l01593"></a>01593           <span class="comment">/* When a prepared statement is found, unlink it from the</span>
<a name="l01594"></a>01594 <span class="comment">          ** cache list.  It will later be added back to the beginning</span>
<a name="l01595"></a>01595 <span class="comment">          ** of the cache list in order to implement LRU replacement.</span>
<a name="l01596"></a>01596 <span class="comment">          */</span>
<a name="l01597"></a>01597           <span class="keywordflow">if</span>( pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#a11f690895aa6c427b38cf62c572a44c5">pPrev</a> ){
<a name="l01598"></a>01598             pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#a11f690895aa6c427b38cf62c572a44c5">pPrev</a>-&gt;<a class="code" href="structSqlPreparedStmt.html#ab507bc5e962f1c1f1f27dc7468c3bee1">pNext</a> = pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#ab507bc5e962f1c1f1f27dc7468c3bee1">pNext</a>;
<a name="l01599"></a>01599           }<span class="keywordflow">else</span>{
<a name="l01600"></a>01600             pDb-&gt;<a class="code" href="structSqliteDb.html#a622c25c8c19cd96236513cb643bb34b3">stmtList</a> = pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#ab507bc5e962f1c1f1f27dc7468c3bee1">pNext</a>;
<a name="l01601"></a>01601           }
<a name="l01602"></a>01602           <span class="keywordflow">if</span>( pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#ab507bc5e962f1c1f1f27dc7468c3bee1">pNext</a> ){
<a name="l01603"></a>01603             pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#ab507bc5e962f1c1f1f27dc7468c3bee1">pNext</a>-&gt;<a class="code" href="structSqlPreparedStmt.html#a11f690895aa6c427b38cf62c572a44c5">pPrev</a> = pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#a11f690895aa6c427b38cf62c572a44c5">pPrev</a>;
<a name="l01604"></a>01604           }<span class="keywordflow">else</span>{
<a name="l01605"></a>01605             pDb-&gt;<a class="code" href="structSqliteDb.html#a6d38e9086103c95838cf9e5110a7831c">stmtLast</a> = pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#a11f690895aa6c427b38cf62c572a44c5">pPrev</a>;
<a name="l01606"></a>01606           }
<a name="l01607"></a>01607           pDb-&gt;<a class="code" href="structSqliteDb.html#aea14c71b9b28d06f7c3094e6069560a2">nStmt</a>--;
<a name="l01608"></a>01608           <span class="keywordflow">break</span>;
<a name="l01609"></a>01609         }
<a name="l01610"></a>01610       }
<a name="l01611"></a>01611   
<a name="l01612"></a>01612       <span class="comment">/* If no prepared statement was found.  Compile the SQL text</span>
<a name="l01613"></a>01613 <span class="comment">      */</span>
<a name="l01614"></a>01614       <span class="keywordflow">if</span>( pStmt==0 ){
<a name="l01615"></a>01615         <span class="keywordflow">if</span>( <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>!=<a class="code" href="prepare_8c.html#a2798d2a1d90446bee6e9fa880fc659c1">sqlite3_prepare_v2</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, zSql, -1, &amp;pStmt, &amp;zLeft) ){
<a name="l01616"></a>01616           Tcl_SetObjResult(interp, <a class="code" href="tclsqlite_8c.html#a6f3d1a8f249e127f14772767875ac9b2">dbTextToObj</a>(<a class="code" href="main_8c.html#ad2a9feca40ee5a7c629c2af6d0ae1d27">sqlite3_errmsg</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>)));
<a name="l01617"></a>01617           rc = TCL_ERROR;
<a name="l01618"></a>01618           <span class="keywordflow">break</span>;
<a name="l01619"></a>01619         }
<a name="l01620"></a>01620         <span class="keywordflow">if</span>( pStmt==0 ){
<a name="l01621"></a>01621           <span class="keywordflow">if</span>( <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>!=<a class="code" href="main_8c.html#aacf8bb5cc3e174eca0c6aab77aa9d4ec">sqlite3_errcode</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>) ){
<a name="l01622"></a>01622             <span class="comment">/* A compile-time error in the statement</span>
<a name="l01623"></a>01623 <span class="comment">            */</span>
<a name="l01624"></a>01624             Tcl_SetObjResult(interp, <a class="code" href="tclsqlite_8c.html#a6f3d1a8f249e127f14772767875ac9b2">dbTextToObj</a>(<a class="code" href="main_8c.html#ad2a9feca40ee5a7c629c2af6d0ae1d27">sqlite3_errmsg</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>)));
<a name="l01625"></a>01625             rc = TCL_ERROR;
<a name="l01626"></a>01626             <span class="keywordflow">break</span>;
<a name="l01627"></a>01627           }<span class="keywordflow">else</span>{
<a name="l01628"></a>01628             <span class="comment">/* The statement was a no-op.  Continue to the next statement</span>
<a name="l01629"></a>01629 <span class="comment">            ** in the SQL string.</span>
<a name="l01630"></a>01630 <span class="comment">            */</span>
<a name="l01631"></a>01631             zSql = zLeft;
<a name="l01632"></a>01632             <span class="keywordflow">continue</span>;
<a name="l01633"></a>01633           }
<a name="l01634"></a>01634         }
<a name="l01635"></a>01635         assert( pPreStmt==0 );
<a name="l01636"></a>01636       }
<a name="l01637"></a>01637 
<a name="l01638"></a>01638       <span class="comment">/* Bind values to parameters that begin with $ or :</span>
<a name="l01639"></a>01639 <span class="comment">      */</span>  
<a name="l01640"></a>01640       nVar = <a class="code" href="sqlite3_8h.html#ad664d81503303011b38a48547dd50391">sqlite3_bind_parameter_count</a>(pStmt);
<a name="l01641"></a>01641       nParm = 0;
<a name="l01642"></a>01642       <span class="keywordflow">if</span>( nVar&gt;<span class="keyword">sizeof</span>(aParm)/<span class="keyword">sizeof</span>(aParm[0]) ){
<a name="l01643"></a>01643         apParm = (Tcl_Obj**)Tcl_Alloc(nVar*<span class="keyword">sizeof</span>(apParm[0]));
<a name="l01644"></a>01644       }<span class="keywordflow">else</span>{
<a name="l01645"></a>01645         apParm = aParm;
<a name="l01646"></a>01646       }
<a name="l01647"></a>01647       <span class="keywordflow">for</span>(i=1; i&lt;=nVar; i++){
<a name="l01648"></a>01648         <span class="keyword">const</span> <span class="keywordtype">char</span> *zVar = <a class="code" href="sqlite3_8h.html#a812b6ded8a4fb9992d608e7f2cf4561e">sqlite3_bind_parameter_name</a>(pStmt, i);
<a name="l01649"></a>01649         <span class="keywordflow">if</span>( zVar!=0 &amp;&amp; (zVar[0]==<span class="charliteral">&apos;$&apos;</span> || zVar[0]==<span class="charliteral">&apos;:&apos;</span> || zVar[0]==<span class="charliteral">&apos;@&apos;</span>) ){
<a name="l01650"></a>01650           Tcl_Obj *pVar = Tcl_GetVar2Ex(interp, &amp;zVar[1], 0, 0);
<a name="l01651"></a>01651           <span class="keywordflow">if</span>( pVar ){
<a name="l01652"></a>01652             <span class="keywordtype">int</span> n;
<a name="l01653"></a>01653             <a class="code" href="sqliteInt_8h.html#a74a0f6424ae628af25f23f0a35f6ead3">u8</a> *data;
<a name="l01654"></a>01654             <span class="keywordtype">char</span> *zType = pVar-&gt;typePtr ? pVar-&gt;typePtr-&gt;name : <span class="stringliteral">&quot;&quot;</span>;
<a name="l01655"></a>01655             <span class="keywordtype">char</span> c = zType[0];
<a name="l01656"></a>01656             <span class="keywordflow">if</span>( zVar[0]==<span class="charliteral">&apos;@&apos;</span> ||
<a name="l01657"></a>01657                (c==<span class="charliteral">&apos;b&apos;</span> &amp;&amp; strcmp(zType,<span class="stringliteral">&quot;bytearray&quot;</span>)==0 &amp;&amp; pVar-&gt;bytes==0) ){
<a name="l01658"></a>01658               <span class="comment">/* Load a BLOB type if the Tcl variable is a bytearray and</span>
<a name="l01659"></a>01659 <span class="comment">              ** it has no string representation or the host</span>
<a name="l01660"></a>01660 <span class="comment">              ** parameter name begins with &quot;@&quot;. */</span>
<a name="l01661"></a>01661               data = Tcl_GetByteArrayFromObj(pVar, &amp;n);
<a name="l01662"></a>01662               <a class="code" href="sqlite3_8h.html#a31729e3159ba77c17d7fb51a7f468e8e">sqlite3_bind_blob</a>(pStmt, i, data, n, <a class="code" href="sqlite3_8h.html#a98b49797a7a15e2a570532fc2b5537c8">SQLITE_STATIC</a>);
<a name="l01663"></a>01663               Tcl_IncrRefCount(pVar);
<a name="l01664"></a>01664               apParm[nParm++] = pVar;
<a name="l01665"></a>01665             }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( c==<span class="charliteral">&apos;b&apos;</span> &amp;&amp; strcmp(zType,<span class="stringliteral">&quot;boolean&quot;</span>)==0 ){
<a name="l01666"></a>01666               Tcl_GetIntFromObj(interp, pVar, &amp;n);
<a name="l01667"></a>01667               <a class="code" href="sqlite3_8h.html#acb3c1ebeca0b79c87807bf9d7c13ae9c">sqlite3_bind_int</a>(pStmt, i, n);
<a name="l01668"></a>01668             }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( c==<span class="charliteral">&apos;d&apos;</span> &amp;&amp; strcmp(zType,<span class="stringliteral">&quot;double&quot;</span>)==0 ){
<a name="l01669"></a>01669               <span class="keywordtype">double</span> r;
<a name="l01670"></a>01670               Tcl_GetDoubleFromObj(interp, pVar, &amp;r);
<a name="l01671"></a>01671               <a class="code" href="sqlite3_8h.html#a1e47a8d85788a7b85a00f868e1df61c2">sqlite3_bind_double</a>(pStmt, i, r);
<a name="l01672"></a>01672             }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( (c==<span class="charliteral">&apos;w&apos;</span> &amp;&amp; strcmp(zType,<span class="stringliteral">&quot;wideInt&quot;</span>)==0) ||
<a name="l01673"></a>01673                   (c==<span class="charliteral">&apos;i&apos;</span> &amp;&amp; strcmp(zType,<span class="stringliteral">&quot;int&quot;</span>)==0) ){
<a name="l01674"></a>01674               Tcl_WideInt v;
<a name="l01675"></a>01675               Tcl_GetWideIntFromObj(interp, pVar, &amp;v);
<a name="l01676"></a>01676               <a class="code" href="sqlite3_8h.html#aefd78e20f41e9d96f27b755e8ef54578">sqlite3_bind_int64</a>(pStmt, i, v);
<a name="l01677"></a>01677             }<span class="keywordflow">else</span>{
<a name="l01678"></a>01678               data = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)Tcl_GetStringFromObj(pVar, &amp;n);
<a name="l01679"></a>01679               <a class="code" href="sqlite3_8h.html#a154a83560a7c30758ad266cbb248de11">sqlite3_bind_text</a>(pStmt, i, (<span class="keywordtype">char</span> *)data, n, <a class="code" href="sqlite3_8h.html#a98b49797a7a15e2a570532fc2b5537c8">SQLITE_STATIC</a>);
<a name="l01680"></a>01680               Tcl_IncrRefCount(pVar);
<a name="l01681"></a>01681               apParm[nParm++] = pVar;
<a name="l01682"></a>01682             }
<a name="l01683"></a>01683           }<span class="keywordflow">else</span>{
<a name="l01684"></a>01684             <a class="code" href="sqlite3_8h.html#a361e2e79de6e4a728c4ec7d48f1762ea">sqlite3_bind_null</a>( pStmt, i );
<a name="l01685"></a>01685           }
<a name="l01686"></a>01686         }
<a name="l01687"></a>01687       }
<a name="l01688"></a>01688 
<a name="l01689"></a>01689       <span class="comment">/* Execute the SQL</span>
<a name="l01690"></a>01690 <span class="comment">      */</span>
<a name="l01691"></a>01691       <span class="keywordflow">while</span>( rc==TCL_OK &amp;&amp; pStmt &amp;&amp; <a class="code" href="sqlite3_8h.html#a624365823d0b11a99ccb49e9bb5f8fcf">SQLITE_ROW</a>==<a class="code" href="sqlite3_8h.html#ae04a3cf3ae391dabf1161cc0e040e9e8">sqlite3_step</a>(pStmt) ){
<a name="l01692"></a>01692 
<a name="l01693"></a>01693   <span class="comment">/* Compute column names. This must be done after the first successful</span>
<a name="l01694"></a>01694 <span class="comment">  ** call to sqlite3_step(), in case the query is recompiled and the</span>
<a name="l01695"></a>01695 <span class="comment">        ** number or names of the returned columns changes. </span>
<a name="l01696"></a>01696 <span class="comment">        */</span>
<a name="l01697"></a>01697         assert(!pArray||pScript);
<a name="l01698"></a>01698         <span class="keywordflow">if</span> (nCol &lt; 0) {
<a name="l01699"></a>01699           Tcl_Obj ***ap = (pScript?&amp;apColName:0);
<a name="l01700"></a>01700           nCol = <a class="code" href="tclsqlite_8c.html#ac55ef9d4d1678546df62817c5e37d70d">computeColumnNames</a>(interp, pStmt, ap, pArray);
<a name="l01701"></a>01701         }
<a name="l01702"></a>01702 
<a name="l01703"></a>01703         <span class="keywordflow">for</span>(i=0; i&lt;nCol; i++){
<a name="l01704"></a>01704           Tcl_Obj *pVal;
<a name="l01705"></a>01705           
<a name="l01706"></a>01706           <span class="comment">/* Set pVal to contain the i&apos;th column of this row. */</span>
<a name="l01707"></a>01707           <span class="keywordflow">switch</span>( <a class="code" href="sqlite3_8h.html#a7e076f91f53b4936cd6f2ce4b078bcc1">sqlite3_column_type</a>(pStmt, i) ){
<a name="l01708"></a>01708             <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a26c29a137b2a35bbde7048e5e48b794a">SQLITE_BLOB</a>: {
<a name="l01709"></a>01709               <span class="keywordtype">int</span> bytes = <a class="code" href="sqlite3_8h.html#a139c52b22f8c1183edf7708fa291aec4">sqlite3_column_bytes</a>(pStmt, i);
<a name="l01710"></a>01710               <span class="keyword">const</span> <span class="keywordtype">char</span> *zBlob = <a class="code" href="sqlite3_8h.html#a5d8f43f1554039ceb9bec0bbffd63887">sqlite3_column_blob</a>(pStmt, i);
<a name="l01711"></a>01711               <span class="keywordflow">if</span>( !zBlob ) bytes = 0;
<a name="l01712"></a>01712               pVal = Tcl_NewByteArrayObj((<a class="code" href="sqliteInt_8h.html#a74a0f6424ae628af25f23f0a35f6ead3">u8</a>*)zBlob, bytes);
<a name="l01713"></a>01713               <span class="keywordflow">break</span>;
<a name="l01714"></a>01714             }
<a name="l01715"></a>01715             <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a7453d71905f10fa330940428f8abe21c">SQLITE_INTEGER</a>: {
<a name="l01716"></a>01716               <a class="code" href="sqlite3_8h.html#a520a95f9080c018b2fade39885bd2e2a">sqlite_int64</a> v = <a class="code" href="sqlite3_8h.html#ab4682ca3ca98c59191beb769e0503ed1">sqlite3_column_int64</a>(pStmt, i);
<a name="l01717"></a>01717               <span class="keywordflow">if</span>( v&gt;=-2147483647 &amp;&amp; v&lt;=2147483647 ){
<a name="l01718"></a>01718                 pVal = Tcl_NewIntObj(v);
<a name="l01719"></a>01719               }<span class="keywordflow">else</span>{
<a name="l01720"></a>01720                 pVal = Tcl_NewWideIntObj(v);
<a name="l01721"></a>01721               }
<a name="l01722"></a>01722               <span class="keywordflow">break</span>;
<a name="l01723"></a>01723             }
<a name="l01724"></a>01724             <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#a0f415018bddf6542e69792aee0357984">SQLITE_FLOAT</a>: {
<a name="l01725"></a>01725               <span class="keywordtype">double</span> r = <a class="code" href="sqlite3_8h.html#a838a6af471e90bc080b08a6219099de9">sqlite3_column_double</a>(pStmt, i);
<a name="l01726"></a>01726               pVal = Tcl_NewDoubleObj(r);
<a name="l01727"></a>01727               <span class="keywordflow">break</span>;
<a name="l01728"></a>01728             }
<a name="l01729"></a>01729             <span class="keywordflow">case</span> <a class="code" href="sqlite3_8h.html#afd180931f2d06d6c245791d187da5802">SQLITE_NULL</a>: {
<a name="l01730"></a>01730               pVal = <a class="code" href="tclsqlite_8c.html#a6f3d1a8f249e127f14772767875ac9b2">dbTextToObj</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a64ee061174a00304836817ce20507035">zNull</a>);
<a name="l01731"></a>01731               <span class="keywordflow">break</span>;
<a name="l01732"></a>01732             }
<a name="l01733"></a>01733             <span class="keywordflow">default</span>: {
<a name="l01734"></a>01734               pVal = <a class="code" href="tclsqlite_8c.html#a6f3d1a8f249e127f14772767875ac9b2">dbTextToObj</a>((<span class="keywordtype">char</span> *)<a class="code" href="sqlite3_8h.html#adebe4cf494727dd2e9c0d22c2a629d2f">sqlite3_column_text</a>(pStmt, i));
<a name="l01735"></a>01735               <span class="keywordflow">break</span>;
<a name="l01736"></a>01736             }
<a name="l01737"></a>01737           }
<a name="l01738"></a>01738   
<a name="l01739"></a>01739           <span class="keywordflow">if</span>( pScript ){
<a name="l01740"></a>01740             <span class="keywordflow">if</span>( pArray==0 ){
<a name="l01741"></a>01741               Tcl_ObjSetVar2(interp, apColName[i], 0, pVal, 0);
<a name="l01742"></a>01742             }<span class="keywordflow">else</span>{
<a name="l01743"></a>01743               Tcl_ObjSetVar2(interp, pArray, apColName[i], pVal, 0);
<a name="l01744"></a>01744             }
<a name="l01745"></a>01745           }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( choice==DB_ONECOLUMN ){
<a name="l01746"></a>01746             assert( pRet==0 );
<a name="l01747"></a>01747             <span class="keywordflow">if</span>( pRet==0 ){
<a name="l01748"></a>01748               pRet = pVal;
<a name="l01749"></a>01749               Tcl_IncrRefCount(pRet);
<a name="l01750"></a>01750             }
<a name="l01751"></a>01751             rc = TCL_BREAK;
<a name="l01752"></a>01752             i = nCol;
<a name="l01753"></a>01753           }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( choice==DB_EXISTS ){
<a name="l01754"></a>01754             Tcl_DecrRefCount(pRet);
<a name="l01755"></a>01755             pRet = Tcl_NewBooleanObj(1);
<a name="l01756"></a>01756             Tcl_IncrRefCount(pRet);
<a name="l01757"></a>01757             rc = TCL_BREAK;
<a name="l01758"></a>01758             i = nCol;
<a name="l01759"></a>01759           }<span class="keywordflow">else</span>{
<a name="l01760"></a>01760             Tcl_ListObjAppendElement(interp, pRet, pVal);
<a name="l01761"></a>01761           }
<a name="l01762"></a>01762         }
<a name="l01763"></a>01763   
<a name="l01764"></a>01764         <span class="keywordflow">if</span>( pScript ){
<a name="l01765"></a>01765           pDb-&gt;<a class="code" href="structSqliteDb.html#aae182504912cf9d112003530cf1b6fe5">nStep</a> = <a class="code" href="sqlite3_8h.html#a5d8eba9a4be991011200ce6b495faf03">sqlite3_stmt_status</a>(pStmt, 
<a name="l01766"></a>01766                                   <a class="code" href="sqlite3_8h.html#af449097c5bd48942fc2d3710bcaa0cfa">SQLITE_STMTSTATUS_FULLSCAN_STEP</a>, 0);
<a name="l01767"></a>01767           pDb-&gt;<a class="code" href="structSqliteDb.html#ac3fcd48fdcfc407666f0fdf443cb3ffd">nSort</a> = <a class="code" href="sqlite3_8h.html#a5d8eba9a4be991011200ce6b495faf03">sqlite3_stmt_status</a>(pStmt,
<a name="l01768"></a>01768                                   <a class="code" href="sqlite3_8h.html#a4238439563e9849daae4d9b54cadde3a">SQLITE_STMTSTATUS_SORT</a>, 0);
<a name="l01769"></a>01769           rc = Tcl_EvalObjEx(interp, pScript, 0);
<a name="l01770"></a>01770           <span class="keywordflow">if</span>( rc==TCL_CONTINUE ){
<a name="l01771"></a>01771             rc = TCL_OK;
<a name="l01772"></a>01772           }
<a name="l01773"></a>01773         }
<a name="l01774"></a>01774       }
<a name="l01775"></a>01775       <span class="keywordflow">if</span>( rc==TCL_BREAK ){
<a name="l01776"></a>01776         rc = TCL_OK;
<a name="l01777"></a>01777       }
<a name="l01778"></a>01778 
<a name="l01779"></a>01779       <span class="comment">/* Free the column name objects */</span>
<a name="l01780"></a>01780       <span class="keywordflow">if</span>( pScript ){
<a name="l01781"></a>01781         <span class="comment">/* If the query returned no rows, but an array variable was </span>
<a name="l01782"></a>01782 <span class="comment">        ** specified, call computeColumnNames() now to populate the </span>
<a name="l01783"></a>01783 <span class="comment">        ** arrayname(*) variable.</span>
<a name="l01784"></a>01784 <span class="comment">        */</span>
<a name="l01785"></a>01785         <span class="keywordflow">if</span> (pArray &amp;&amp; nCol &lt; 0) {
<a name="l01786"></a>01786           Tcl_Obj ***ap = (pScript?&amp;apColName:0);
<a name="l01787"></a>01787           nCol = <a class="code" href="tclsqlite_8c.html#ac55ef9d4d1678546df62817c5e37d70d">computeColumnNames</a>(interp, pStmt, ap, pArray);
<a name="l01788"></a>01788         }
<a name="l01789"></a>01789         <span class="keywordflow">for</span>(i=0; i&lt;nCol; i++){
<a name="l01790"></a>01790           Tcl_DecrRefCount(apColName[i]);
<a name="l01791"></a>01791         }
<a name="l01792"></a>01792         Tcl_Free((<span class="keywordtype">char</span>*)apColName);
<a name="l01793"></a>01793       }
<a name="l01794"></a>01794 
<a name="l01795"></a>01795       <span class="comment">/* Free the bound string and blob parameters */</span>
<a name="l01796"></a>01796       <span class="keywordflow">for</span>(i=0; i&lt;nParm; i++){
<a name="l01797"></a>01797         Tcl_DecrRefCount(apParm[i]);
<a name="l01798"></a>01798       }
<a name="l01799"></a>01799       <span class="keywordflow">if</span>( apParm!=aParm ){
<a name="l01800"></a>01800         Tcl_Free((<span class="keywordtype">char</span>*)apParm);
<a name="l01801"></a>01801       }
<a name="l01802"></a>01802 
<a name="l01803"></a>01803       <span class="comment">/* Reset the statement.  If the result code is SQLITE_SCHEMA, then</span>
<a name="l01804"></a>01804 <span class="comment">      ** flush the statement cache and try the statement again.</span>
<a name="l01805"></a>01805 <span class="comment">      */</span>
<a name="l01806"></a>01806       rc2 = <a class="code" href="sqlite3_8h.html#a4f90cba6b396574cf3d5b1ac009de0c7">sqlite3_reset</a>(pStmt);
<a name="l01807"></a>01807       pDb-&gt;<a class="code" href="structSqliteDb.html#aae182504912cf9d112003530cf1b6fe5">nStep</a> = <a class="code" href="sqlite3_8h.html#a5d8eba9a4be991011200ce6b495faf03">sqlite3_stmt_status</a>(pStmt, 
<a name="l01808"></a>01808                                   <a class="code" href="sqlite3_8h.html#af449097c5bd48942fc2d3710bcaa0cfa">SQLITE_STMTSTATUS_FULLSCAN_STEP</a>, 1);
<a name="l01809"></a>01809       pDb-&gt;<a class="code" href="structSqliteDb.html#ac3fcd48fdcfc407666f0fdf443cb3ffd">nSort</a> = <a class="code" href="sqlite3_8h.html#a5d8eba9a4be991011200ce6b495faf03">sqlite3_stmt_status</a>(pStmt,
<a name="l01810"></a>01810                                   <a class="code" href="sqlite3_8h.html#a4238439563e9849daae4d9b54cadde3a">SQLITE_STMTSTATUS_SORT</a>, 1);
<a name="l01811"></a>01811       <span class="keywordflow">if</span>( <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>!=rc2 ){
<a name="l01812"></a>01812         <span class="comment">/* If a run-time error occurs, report the error and stop reading</span>
<a name="l01813"></a>01813 <span class="comment">        ** the SQL</span>
<a name="l01814"></a>01814 <span class="comment">        */</span>
<a name="l01815"></a>01815         Tcl_SetObjResult(interp, <a class="code" href="tclsqlite_8c.html#a6f3d1a8f249e127f14772767875ac9b2">dbTextToObj</a>(<a class="code" href="main_8c.html#ad2a9feca40ee5a7c629c2af6d0ae1d27">sqlite3_errmsg</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>)));
<a name="l01816"></a>01816         <a class="code" href="sqlite3_8h.html#aaf6c3dbc23f33c0752588425c7e9d498">sqlite3_finalize</a>(pStmt);
<a name="l01817"></a>01817         rc = TCL_ERROR;
<a name="l01818"></a>01818         <span class="keywordflow">if</span>( pPreStmt ) Tcl_Free((<span class="keywordtype">char</span>*)pPreStmt);
<a name="l01819"></a>01819         <span class="keywordflow">break</span>;
<a name="l01820"></a>01820       }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a552e45c18680c2bfb6962b361b40204f">maxStmt</a>&lt;=0 ){
<a name="l01821"></a>01821         <span class="comment">/* If the cache is turned off, deallocated the statement */</span>
<a name="l01822"></a>01822         <span class="keywordflow">if</span>( pPreStmt ) Tcl_Free((<span class="keywordtype">char</span>*)pPreStmt);
<a name="l01823"></a>01823         <a class="code" href="sqlite3_8h.html#aaf6c3dbc23f33c0752588425c7e9d498">sqlite3_finalize</a>(pStmt);
<a name="l01824"></a>01824       }<span class="keywordflow">else</span>{
<a name="l01825"></a>01825         <span class="comment">/* Everything worked and the cache is operational.</span>
<a name="l01826"></a>01826 <span class="comment">        ** Create a new SqlPreparedStmt structure if we need one.</span>
<a name="l01827"></a>01827 <span class="comment">        ** (If we already have one we can just reuse it.)</span>
<a name="l01828"></a>01828 <span class="comment">        */</span>
<a name="l01829"></a>01829         <span class="keywordflow">if</span>( pPreStmt==0 ){
<a name="l01830"></a>01830           len = zLeft - zSql;
<a name="l01831"></a>01831           pPreStmt = (<a class="code" href="structSqlPreparedStmt.html">SqlPreparedStmt</a>*)Tcl_Alloc( <span class="keyword">sizeof</span>(*pPreStmt) );
<a name="l01832"></a>01832           <span class="keywordflow">if</span>( pPreStmt==0 ) <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01833"></a>01833           pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#a1281d141acc5a7e88d0c006814b437cf">pStmt</a> = pStmt;
<a name="l01834"></a>01834           pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#a3bdc15903b54995e489270392aaef9f9">nSql</a> = len;
<a name="l01835"></a>01835           pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#adf0ae473efb12e525ffae189e7965295">zSql</a> = <a class="code" href="sqlite3_8h.html#a08e26e378f63456743e0a39d13eb193e">sqlite3_sql</a>(pStmt);
<a name="l01836"></a>01836           assert( strlen(pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#adf0ae473efb12e525ffae189e7965295">zSql</a>)==len );
<a name="l01837"></a>01837           assert( 0==memcmp(pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#adf0ae473efb12e525ffae189e7965295">zSql</a>, zSql, len) );
<a name="l01838"></a>01838         }
<a name="l01839"></a>01839 
<a name="l01840"></a>01840         <span class="comment">/* Add the prepared statement to the beginning of the cache list</span>
<a name="l01841"></a>01841 <span class="comment">        */</span>
<a name="l01842"></a>01842         pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#ab507bc5e962f1c1f1f27dc7468c3bee1">pNext</a> = pDb-&gt;<a class="code" href="structSqliteDb.html#a622c25c8c19cd96236513cb643bb34b3">stmtList</a>;
<a name="l01843"></a>01843         pPreStmt-&gt;<a class="code" href="structSqlPreparedStmt.html#a11f690895aa6c427b38cf62c572a44c5">pPrev</a> = 0;
<a name="l01844"></a>01844         <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a622c25c8c19cd96236513cb643bb34b3">stmtList</a> ){
<a name="l01845"></a>01845          pDb-&gt;<a class="code" href="structSqliteDb.html#a622c25c8c19cd96236513cb643bb34b3">stmtList</a>-&gt;<a class="code" href="structSqlPreparedStmt.html#a11f690895aa6c427b38cf62c572a44c5">pPrev</a> = pPreStmt;
<a name="l01846"></a>01846         }
<a name="l01847"></a>01847         pDb-&gt;<a class="code" href="structSqliteDb.html#a622c25c8c19cd96236513cb643bb34b3">stmtList</a> = pPreStmt;
<a name="l01848"></a>01848         <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a6d38e9086103c95838cf9e5110a7831c">stmtLast</a>==0 ){
<a name="l01849"></a>01849           assert( pDb-&gt;<a class="code" href="structSqliteDb.html#aea14c71b9b28d06f7c3094e6069560a2">nStmt</a>==0 );
<a name="l01850"></a>01850           pDb-&gt;<a class="code" href="structSqliteDb.html#a6d38e9086103c95838cf9e5110a7831c">stmtLast</a> = pPreStmt;
<a name="l01851"></a>01851         }<span class="keywordflow">else</span>{
<a name="l01852"></a>01852           assert( pDb-&gt;<a class="code" href="structSqliteDb.html#aea14c71b9b28d06f7c3094e6069560a2">nStmt</a>&gt;0 );
<a name="l01853"></a>01853         }
<a name="l01854"></a>01854         pDb-&gt;<a class="code" href="structSqliteDb.html#aea14c71b9b28d06f7c3094e6069560a2">nStmt</a>++;
<a name="l01855"></a>01855    
<a name="l01856"></a>01856         <span class="comment">/* If we have too many statement in cache, remove the surplus from the</span>
<a name="l01857"></a>01857 <span class="comment">        ** end of the cache list.</span>
<a name="l01858"></a>01858 <span class="comment">        */</span>
<a name="l01859"></a>01859         <span class="keywordflow">while</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#aea14c71b9b28d06f7c3094e6069560a2">nStmt</a>&gt;pDb-&gt;<a class="code" href="structSqliteDb.html#a552e45c18680c2bfb6962b361b40204f">maxStmt</a> ){
<a name="l01860"></a>01860           <a class="code" href="sqlite3_8h.html#aaf6c3dbc23f33c0752588425c7e9d498">sqlite3_finalize</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a6d38e9086103c95838cf9e5110a7831c">stmtLast</a>-&gt;<a class="code" href="structSqlPreparedStmt.html#a1281d141acc5a7e88d0c006814b437cf">pStmt</a>);
<a name="l01861"></a>01861           pDb-&gt;<a class="code" href="structSqliteDb.html#a6d38e9086103c95838cf9e5110a7831c">stmtLast</a> = pDb-&gt;<a class="code" href="structSqliteDb.html#a6d38e9086103c95838cf9e5110a7831c">stmtLast</a>-&gt;<a class="code" href="structSqlPreparedStmt.html#a11f690895aa6c427b38cf62c572a44c5">pPrev</a>;
<a name="l01862"></a>01862           Tcl_Free((<span class="keywordtype">char</span>*)pDb-&gt;<a class="code" href="structSqliteDb.html#a6d38e9086103c95838cf9e5110a7831c">stmtLast</a>-&gt;<a class="code" href="structSqlPreparedStmt.html#ab507bc5e962f1c1f1f27dc7468c3bee1">pNext</a>);
<a name="l01863"></a>01863           pDb-&gt;<a class="code" href="structSqliteDb.html#a6d38e9086103c95838cf9e5110a7831c">stmtLast</a>-&gt;<a class="code" href="structSqlPreparedStmt.html#ab507bc5e962f1c1f1f27dc7468c3bee1">pNext</a> = 0;
<a name="l01864"></a>01864           pDb-&gt;<a class="code" href="structSqliteDb.html#aea14c71b9b28d06f7c3094e6069560a2">nStmt</a>--;
<a name="l01865"></a>01865         }
<a name="l01866"></a>01866       }
<a name="l01867"></a>01867 
<a name="l01868"></a>01868       <span class="comment">/* Proceed to the next statement */</span>
<a name="l01869"></a>01869       zSql = zLeft;
<a name="l01870"></a>01870     }
<a name="l01871"></a>01871     Tcl_DecrRefCount(objv[2]);
<a name="l01872"></a>01872 
<a name="l01873"></a>01873     <span class="keywordflow">if</span>( pRet ){
<a name="l01874"></a>01874       <span class="keywordflow">if</span>( rc==TCL_OK ){
<a name="l01875"></a>01875         Tcl_SetObjResult(interp, pRet);
<a name="l01876"></a>01876       }
<a name="l01877"></a>01877       Tcl_DecrRefCount(pRet);
<a name="l01878"></a>01878     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( rc==TCL_OK ){
<a name="l01879"></a>01879       Tcl_ResetResult(interp);
<a name="l01880"></a>01880     }
<a name="l01881"></a>01881     <span class="keywordflow">break</span>;
<a name="l01882"></a>01882   }
<a name="l01883"></a>01883 
<a name="l01884"></a>01884   <span class="comment">/*</span>
<a name="l01885"></a>01885 <span class="comment">  **     $db function NAME [-argcount N] SCRIPT</span>
<a name="l01886"></a>01886 <span class="comment">  **</span>
<a name="l01887"></a>01887 <span class="comment">  ** Create a new SQL function called NAME.  Whenever that function is</span>
<a name="l01888"></a>01888 <span class="comment">  ** called, invoke SCRIPT to evaluate the function.</span>
<a name="l01889"></a>01889 <span class="comment">  */</span>
<a name="l01890"></a>01890   <span class="keywordflow">case</span> DB_FUNCTION: {
<a name="l01891"></a>01891     <a class="code" href="structSqlFunc.html">SqlFunc</a> *pFunc;
<a name="l01892"></a>01892     Tcl_Obj *pScript;
<a name="l01893"></a>01893     <span class="keywordtype">char</span> *zName;
<a name="l01894"></a>01894     <span class="keywordtype">int</span> nArg = -1;
<a name="l01895"></a>01895     <span class="keywordflow">if</span>( objc==6 ){
<a name="l01896"></a>01896       <span class="keyword">const</span> <span class="keywordtype">char</span> *z = Tcl_GetString(objv[3]);
<a name="l01897"></a>01897       <span class="keywordtype">int</span> n = strlen(z);
<a name="l01898"></a>01898       <span class="keywordflow">if</span>( n&gt;2 &amp;&amp; strncmp(z, <span class="stringliteral">&quot;-argcount&quot;</span>,n)==0 ){
<a name="l01899"></a>01899         <span class="keywordflow">if</span>( Tcl_GetIntFromObj(interp, objv[4], &amp;nArg) ) <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01900"></a>01900         <span class="keywordflow">if</span>( nArg&lt;0 ){
<a name="l01901"></a>01901           Tcl_AppendResult(interp, <span class="stringliteral">&quot;number of arguments must be non-negative&quot;</span>,
<a name="l01902"></a>01902                            (<span class="keywordtype">char</span>*)0);
<a name="l01903"></a>01903           <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01904"></a>01904         }
<a name="l01905"></a>01905       }
<a name="l01906"></a>01906       pScript = objv[5];
<a name="l01907"></a>01907     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( objc!=4 ){
<a name="l01908"></a>01908       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;NAME [-argcount N] SCRIPT&quot;</span>);
<a name="l01909"></a>01909       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01910"></a>01910     }<span class="keywordflow">else</span>{
<a name="l01911"></a>01911       pScript = objv[3];
<a name="l01912"></a>01912     }
<a name="l01913"></a>01913     zName = Tcl_GetStringFromObj(objv[2], 0);
<a name="l01914"></a>01914     pFunc = <a class="code" href="tclsqlite_8c.html#a378ebd8ae922e39802c72ed5b31c9534">findSqlFunc</a>(pDb, zName);
<a name="l01915"></a>01915     <span class="keywordflow">if</span>( pFunc==0 ) <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01916"></a>01916     <span class="keywordflow">if</span>( pFunc-&gt;<a class="code" href="structSqlFunc.html#a0e421ba3739e20e3985a1152666efd15">pScript</a> ){
<a name="l01917"></a>01917       Tcl_DecrRefCount(pFunc-&gt;<a class="code" href="structSqlFunc.html#a0e421ba3739e20e3985a1152666efd15">pScript</a>);
<a name="l01918"></a>01918     }
<a name="l01919"></a>01919     pFunc-&gt;<a class="code" href="structSqlFunc.html#a0e421ba3739e20e3985a1152666efd15">pScript</a> = pScript;
<a name="l01920"></a>01920     Tcl_IncrRefCount(pScript);
<a name="l01921"></a>01921     pFunc-&gt;<a class="code" href="structSqlFunc.html#a536b8b8164a7be75f4b092dd3a4146bc">useEvalObjv</a> = <a class="code" href="tclsqlite_8c.html#aec8737fc43abc8a5ed8b6b9044fec1d5">safeToUseEvalObjv</a>(interp, pScript);
<a name="l01922"></a>01922     rc = <a class="code" href="main_8c.html#a41b5bf5dea935444f161b3e51b761b86">sqlite3_create_function</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, zName, nArg, <a class="code" href="sqlite3_8h.html#a7a65f15cad0da22be8ebc0c70f526d32">SQLITE_UTF8</a>,
<a name="l01923"></a>01923         pFunc, <a class="code" href="tclsqlite_8c.html#ae43d451c5e8846f9e3b4c21dca31dc20">tclSqlFunc</a>, 0, 0);
<a name="l01924"></a>01924     <span class="keywordflow">if</span>( rc!=<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> ){
<a name="l01925"></a>01925       rc = TCL_ERROR;
<a name="l01926"></a>01926       Tcl_SetResult(interp, (<span class="keywordtype">char</span> *)<a class="code" href="main_8c.html#ad2a9feca40ee5a7c629c2af6d0ae1d27">sqlite3_errmsg</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>), TCL_VOLATILE);
<a name="l01927"></a>01927     }
<a name="l01928"></a>01928     <span class="keywordflow">break</span>;
<a name="l01929"></a>01929   }
<a name="l01930"></a>01930 
<a name="l01931"></a>01931   <span class="comment">/*</span>
<a name="l01932"></a>01932 <span class="comment">  **     $db incrblob ?-readonly? ?DB? TABLE COLUMN ROWID</span>
<a name="l01933"></a>01933 <span class="comment">  */</span>
<a name="l01934"></a>01934   <span class="keywordflow">case</span> DB_INCRBLOB: {
<a name="l01935"></a>01935 <span class="preprocessor">#ifdef SQLITE_OMIT_INCRBLOB</span>
<a name="l01936"></a>01936 <span class="preprocessor"></span>    Tcl_AppendResult(interp, <span class="stringliteral">&quot;incrblob not available in this build&quot;</span>, 0);
<a name="l01937"></a>01937     <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01938"></a>01938 <span class="preprocessor">#else</span>
<a name="l01939"></a>01939 <span class="preprocessor"></span>    <span class="keywordtype">int</span> isReadonly = 0;
<a name="l01940"></a>01940     <span class="keyword">const</span> <span class="keywordtype">char</span> *zDb = <span class="stringliteral">&quot;main&quot;</span>;
<a name="l01941"></a>01941     <span class="keyword">const</span> <span class="keywordtype">char</span> *zTable;
<a name="l01942"></a>01942     <span class="keyword">const</span> <span class="keywordtype">char</span> *zColumn;
<a name="l01943"></a>01943     <a class="code" href="sqlite3_8h.html#a520a95f9080c018b2fade39885bd2e2a">sqlite_int64</a> iRow;
<a name="l01944"></a>01944 
<a name="l01945"></a>01945     <span class="comment">/* Check for the -readonly option */</span>
<a name="l01946"></a>01946     <span class="keywordflow">if</span>( objc&gt;3 &amp;&amp; strcmp(Tcl_GetString(objv[2]), <span class="stringliteral">&quot;-readonly&quot;</span>)==0 ){
<a name="l01947"></a>01947       isReadonly = 1;
<a name="l01948"></a>01948     }
<a name="l01949"></a>01949 
<a name="l01950"></a>01950     <span class="keywordflow">if</span>( objc!=(5+isReadonly) &amp;&amp; objc!=(6+isReadonly) ){
<a name="l01951"></a>01951       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;?-readonly? ?DB? TABLE COLUMN ROWID&quot;</span>);
<a name="l01952"></a>01952       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01953"></a>01953     }
<a name="l01954"></a>01954 
<a name="l01955"></a>01955     <span class="keywordflow">if</span>( objc==(6+isReadonly) ){
<a name="l01956"></a>01956       zDb = Tcl_GetString(objv[2]);
<a name="l01957"></a>01957     }
<a name="l01958"></a>01958     zTable = Tcl_GetString(objv[objc-3]);
<a name="l01959"></a>01959     zColumn = Tcl_GetString(objv[objc-2]);
<a name="l01960"></a>01960     rc = Tcl_GetWideIntFromObj(interp, objv[objc-1], &amp;iRow);
<a name="l01961"></a>01961 
<a name="l01962"></a>01962     <span class="keywordflow">if</span>( rc==TCL_OK ){
<a name="l01963"></a>01963       rc = <a class="code" href="tclsqlite_8c.html#a31dc80b70a971817e5105c0b2a1ab14e">createIncrblobChannel</a>(
<a name="l01964"></a>01964           interp, pDb, zDb, zTable, zColumn, iRow, isReadonly
<a name="l01965"></a>01965       );
<a name="l01966"></a>01966     }
<a name="l01967"></a>01967 <span class="preprocessor">#endif</span>
<a name="l01968"></a>01968 <span class="preprocessor"></span>    <span class="keywordflow">break</span>;
<a name="l01969"></a>01969   }
<a name="l01970"></a>01970 
<a name="l01971"></a>01971   <span class="comment">/*</span>
<a name="l01972"></a>01972 <span class="comment">  **     $db interrupt</span>
<a name="l01973"></a>01973 <span class="comment">  **</span>
<a name="l01974"></a>01974 <span class="comment">  ** Interrupt the execution of the inner-most SQL interpreter.  This</span>
<a name="l01975"></a>01975 <span class="comment">  ** causes the SQL statement to return an error of SQLITE_INTERRUPT.</span>
<a name="l01976"></a>01976 <span class="comment">  */</span>
<a name="l01977"></a>01977   <span class="keywordflow">case</span> DB_INTERRUPT: {
<a name="l01978"></a>01978     <a class="code" href="main_8c.html#a6105f4c9687e243ce3d1706b34100c5f">sqlite3_interrupt</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>);
<a name="l01979"></a>01979     <span class="keywordflow">break</span>;
<a name="l01980"></a>01980   }
<a name="l01981"></a>01981 
<a name="l01982"></a>01982   <span class="comment">/*</span>
<a name="l01983"></a>01983 <span class="comment">  **     $db nullvalue ?STRING?</span>
<a name="l01984"></a>01984 <span class="comment">  **</span>
<a name="l01985"></a>01985 <span class="comment">  ** Change text used when a NULL comes back from the database. If ?STRING?</span>
<a name="l01986"></a>01986 <span class="comment">  ** is not present, then the current string used for NULL is returned.</span>
<a name="l01987"></a>01987 <span class="comment">  ** If STRING is present, then STRING is returned.</span>
<a name="l01988"></a>01988 <span class="comment">  **</span>
<a name="l01989"></a>01989 <span class="comment">  */</span>
<a name="l01990"></a>01990   <span class="keywordflow">case</span> DB_NULLVALUE: {
<a name="l01991"></a>01991     <span class="keywordflow">if</span>( objc!=2 &amp;&amp; objc!=3 ){
<a name="l01992"></a>01992       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;NULLVALUE&quot;</span>);
<a name="l01993"></a>01993       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l01994"></a>01994     }
<a name="l01995"></a>01995     <span class="keywordflow">if</span>( objc==3 ){
<a name="l01996"></a>01996       <span class="keywordtype">int</span> len;
<a name="l01997"></a>01997       <span class="keywordtype">char</span> *zNull = Tcl_GetStringFromObj(objv[2], &amp;len);
<a name="l01998"></a>01998       <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a64ee061174a00304836817ce20507035">zNull</a> ){
<a name="l01999"></a>01999         Tcl_Free(pDb-&gt;<a class="code" href="structSqliteDb.html#a64ee061174a00304836817ce20507035">zNull</a>);
<a name="l02000"></a>02000       }
<a name="l02001"></a>02001       <span class="keywordflow">if</span>( zNull &amp;&amp; len&gt;0 ){
<a name="l02002"></a>02002         pDb-&gt;<a class="code" href="structSqliteDb.html#a64ee061174a00304836817ce20507035">zNull</a> = Tcl_Alloc( len + 1 );
<a name="l02003"></a>02003         strncpy(pDb-&gt;<a class="code" href="structSqliteDb.html#a64ee061174a00304836817ce20507035">zNull</a>, zNull, len);
<a name="l02004"></a>02004         pDb-&gt;<a class="code" href="structSqliteDb.html#a64ee061174a00304836817ce20507035">zNull</a>[len] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02005"></a>02005       }<span class="keywordflow">else</span>{
<a name="l02006"></a>02006         pDb-&gt;<a class="code" href="structSqliteDb.html#a64ee061174a00304836817ce20507035">zNull</a> = 0;
<a name="l02007"></a>02007       }
<a name="l02008"></a>02008     }
<a name="l02009"></a>02009     Tcl_SetObjResult(interp, <a class="code" href="tclsqlite_8c.html#a6f3d1a8f249e127f14772767875ac9b2">dbTextToObj</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a64ee061174a00304836817ce20507035">zNull</a>));
<a name="l02010"></a>02010     <span class="keywordflow">break</span>;
<a name="l02011"></a>02011   }
<a name="l02012"></a>02012 
<a name="l02013"></a>02013   <span class="comment">/*</span>
<a name="l02014"></a>02014 <span class="comment">  **     $db last_insert_rowid </span>
<a name="l02015"></a>02015 <span class="comment">  **</span>
<a name="l02016"></a>02016 <span class="comment">  ** Return an integer which is the ROWID for the most recent insert.</span>
<a name="l02017"></a>02017 <span class="comment">  */</span>
<a name="l02018"></a>02018   <span class="keywordflow">case</span> DB_LAST_INSERT_ROWID: {
<a name="l02019"></a>02019     Tcl_Obj *pResult;
<a name="l02020"></a>02020     Tcl_WideInt rowid;
<a name="l02021"></a>02021     <span class="keywordflow">if</span>( objc!=2 ){
<a name="l02022"></a>02022       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02023"></a>02023       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02024"></a>02024     }
<a name="l02025"></a>02025     rowid = <a class="code" href="main_8c.html#ac09d49376c77414ba143635184b7ee10">sqlite3_last_insert_rowid</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>);
<a name="l02026"></a>02026     pResult = Tcl_GetObjResult(interp);
<a name="l02027"></a>02027     Tcl_SetWideIntObj(pResult, rowid);
<a name="l02028"></a>02028     <span class="keywordflow">break</span>;
<a name="l02029"></a>02029   }
<a name="l02030"></a>02030 
<a name="l02031"></a>02031   <span class="comment">/*</span>
<a name="l02032"></a>02032 <span class="comment">  ** The DB_ONECOLUMN method is implemented together with DB_EVAL.</span>
<a name="l02033"></a>02033 <span class="comment">  */</span>
<a name="l02034"></a>02034 
<a name="l02035"></a>02035   <span class="comment">/*    $db progress ?N CALLBACK?</span>
<a name="l02036"></a>02036 <span class="comment">  ** </span>
<a name="l02037"></a>02037 <span class="comment">  ** Invoke the given callback every N virtual machine opcodes while executing</span>
<a name="l02038"></a>02038 <span class="comment">  ** queries.</span>
<a name="l02039"></a>02039 <span class="comment">  */</span>
<a name="l02040"></a>02040   <span class="keywordflow">case</span> DB_PROGRESS: {
<a name="l02041"></a>02041     <span class="keywordflow">if</span>( objc==2 ){
<a name="l02042"></a>02042       <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#ab113606884e65607ecbc4c6471f9e09c">zProgress</a> ){
<a name="l02043"></a>02043         Tcl_AppendResult(interp, pDb-&gt;<a class="code" href="structSqliteDb.html#ab113606884e65607ecbc4c6471f9e09c">zProgress</a>, 0);
<a name="l02044"></a>02044       }
<a name="l02045"></a>02045     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( objc==4 ){
<a name="l02046"></a>02046       <span class="keywordtype">char</span> *zProgress;
<a name="l02047"></a>02047       <span class="keywordtype">int</span> len;
<a name="l02048"></a>02048       <span class="keywordtype">int</span> N;
<a name="l02049"></a>02049       <span class="keywordflow">if</span>( TCL_OK!=Tcl_GetIntFromObj(interp, objv[2], &amp;N) ){
<a name="l02050"></a>02050         <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02051"></a>02051       };
<a name="l02052"></a>02052       <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#ab113606884e65607ecbc4c6471f9e09c">zProgress</a> ){
<a name="l02053"></a>02053         Tcl_Free(pDb-&gt;<a class="code" href="structSqliteDb.html#ab113606884e65607ecbc4c6471f9e09c">zProgress</a>);
<a name="l02054"></a>02054       }
<a name="l02055"></a>02055       zProgress = Tcl_GetStringFromObj(objv[3], &amp;len);
<a name="l02056"></a>02056       <span class="keywordflow">if</span>( zProgress &amp;&amp; len&gt;0 ){
<a name="l02057"></a>02057         pDb-&gt;<a class="code" href="structSqliteDb.html#ab113606884e65607ecbc4c6471f9e09c">zProgress</a> = Tcl_Alloc( len + 1 );
<a name="l02058"></a>02058         memcpy(pDb-&gt;<a class="code" href="structSqliteDb.html#ab113606884e65607ecbc4c6471f9e09c">zProgress</a>, zProgress, len+1);
<a name="l02059"></a>02059       }<span class="keywordflow">else</span>{
<a name="l02060"></a>02060         pDb-&gt;<a class="code" href="structSqliteDb.html#ab113606884e65607ecbc4c6471f9e09c">zProgress</a> = 0;
<a name="l02061"></a>02061       }
<a name="l02062"></a>02062 <span class="preprocessor">#ifndef SQLITE_OMIT_PROGRESS_CALLBACK</span>
<a name="l02063"></a>02063 <span class="preprocessor"></span>      <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#ab113606884e65607ecbc4c6471f9e09c">zProgress</a> ){
<a name="l02064"></a>02064         pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a> = interp;
<a name="l02065"></a>02065         <a class="code" href="main_8c.html#a041dcfc0abb0d0cc1c3eb2f463eacf21">sqlite3_progress_handler</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, N, <a class="code" href="tclsqlite_8c.html#acf066efc07635c9ea4c7da980ae0d104">DbProgressHandler</a>, pDb);
<a name="l02066"></a>02066       }<span class="keywordflow">else</span>{
<a name="l02067"></a>02067         <a class="code" href="main_8c.html#a041dcfc0abb0d0cc1c3eb2f463eacf21">sqlite3_progress_handler</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, 0, 0, 0);
<a name="l02068"></a>02068       }
<a name="l02069"></a>02069 <span class="preprocessor">#endif</span>
<a name="l02070"></a>02070 <span class="preprocessor"></span>    }<span class="keywordflow">else</span>{
<a name="l02071"></a>02071       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;N CALLBACK&quot;</span>);
<a name="l02072"></a>02072       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02073"></a>02073     }
<a name="l02074"></a>02074     <span class="keywordflow">break</span>;
<a name="l02075"></a>02075   }
<a name="l02076"></a>02076 
<a name="l02077"></a>02077   <span class="comment">/*    $db profile ?CALLBACK?</span>
<a name="l02078"></a>02078 <span class="comment">  **</span>
<a name="l02079"></a>02079 <span class="comment">  ** Make arrangements to invoke the CALLBACK routine after each SQL statement</span>
<a name="l02080"></a>02080 <span class="comment">  ** that has run.  The text of the SQL and the amount of elapse time are</span>
<a name="l02081"></a>02081 <span class="comment">  ** appended to CALLBACK before the script is run.</span>
<a name="l02082"></a>02082 <span class="comment">  */</span>
<a name="l02083"></a>02083   <span class="keywordflow">case</span> DB_PROFILE: {
<a name="l02084"></a>02084     <span class="keywordflow">if</span>( objc&gt;3 ){
<a name="l02085"></a>02085       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;?CALLBACK?&quot;</span>);
<a name="l02086"></a>02086       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02087"></a>02087     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( objc==2 ){
<a name="l02088"></a>02088       <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#aef8682a8fa0aa5f8a07233130354fd8f">zProfile</a> ){
<a name="l02089"></a>02089         Tcl_AppendResult(interp, pDb-&gt;<a class="code" href="structSqliteDb.html#aef8682a8fa0aa5f8a07233130354fd8f">zProfile</a>, 0);
<a name="l02090"></a>02090       }
<a name="l02091"></a>02091     }<span class="keywordflow">else</span>{
<a name="l02092"></a>02092       <span class="keywordtype">char</span> *zProfile;
<a name="l02093"></a>02093       <span class="keywordtype">int</span> len;
<a name="l02094"></a>02094       <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#aef8682a8fa0aa5f8a07233130354fd8f">zProfile</a> ){
<a name="l02095"></a>02095         Tcl_Free(pDb-&gt;<a class="code" href="structSqliteDb.html#aef8682a8fa0aa5f8a07233130354fd8f">zProfile</a>);
<a name="l02096"></a>02096       }
<a name="l02097"></a>02097       zProfile = Tcl_GetStringFromObj(objv[2], &amp;len);
<a name="l02098"></a>02098       <span class="keywordflow">if</span>( zProfile &amp;&amp; len&gt;0 ){
<a name="l02099"></a>02099         pDb-&gt;<a class="code" href="structSqliteDb.html#aef8682a8fa0aa5f8a07233130354fd8f">zProfile</a> = Tcl_Alloc( len + 1 );
<a name="l02100"></a>02100         memcpy(pDb-&gt;<a class="code" href="structSqliteDb.html#aef8682a8fa0aa5f8a07233130354fd8f">zProfile</a>, zProfile, len+1);
<a name="l02101"></a>02101       }<span class="keywordflow">else</span>{
<a name="l02102"></a>02102         pDb-&gt;<a class="code" href="structSqliteDb.html#aef8682a8fa0aa5f8a07233130354fd8f">zProfile</a> = 0;
<a name="l02103"></a>02103       }
<a name="l02104"></a>02104 <span class="preprocessor">#ifndef SQLITE_OMIT_TRACE</span>
<a name="l02105"></a>02105 <span class="preprocessor"></span>      <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#aef8682a8fa0aa5f8a07233130354fd8f">zProfile</a> ){
<a name="l02106"></a>02106         pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a> = interp;
<a name="l02107"></a>02107         <a class="code" href="main_8c.html#a3badf08d067f30a21833f788f40c32b2">sqlite3_profile</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, <a class="code" href="tclsqlite_8c.html#a2373a1e082dbf49565c10bcd0ce91a61">DbProfileHandler</a>, pDb);
<a name="l02108"></a>02108       }<span class="keywordflow">else</span>{
<a name="l02109"></a>02109         <a class="code" href="main_8c.html#a3badf08d067f30a21833f788f40c32b2">sqlite3_profile</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, 0, 0);
<a name="l02110"></a>02110       }
<a name="l02111"></a>02111 <span class="preprocessor">#endif</span>
<a name="l02112"></a>02112 <span class="preprocessor"></span>    }
<a name="l02113"></a>02113     <span class="keywordflow">break</span>;
<a name="l02114"></a>02114   }
<a name="l02115"></a>02115 
<a name="l02116"></a>02116   <span class="comment">/*</span>
<a name="l02117"></a>02117 <span class="comment">  **     $db rekey KEY</span>
<a name="l02118"></a>02118 <span class="comment">  **</span>
<a name="l02119"></a>02119 <span class="comment">  ** Change the encryption key on the currently open database.</span>
<a name="l02120"></a>02120 <span class="comment">  */</span>
<a name="l02121"></a>02121   <span class="keywordflow">case</span> DB_REKEY: {
<a name="l02122"></a>02122     <span class="keywordtype">int</span> nKey;
<a name="l02123"></a>02123     <span class="keywordtype">void</span> *pKey;
<a name="l02124"></a>02124     <span class="keywordflow">if</span>( objc!=3 ){
<a name="l02125"></a>02125       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;KEY&quot;</span>);
<a name="l02126"></a>02126       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02127"></a>02127     }
<a name="l02128"></a>02128     pKey = Tcl_GetByteArrayFromObj(objv[2], &amp;nKey);
<a name="l02129"></a>02129 <span class="preprocessor">#ifdef SQLITE_HAS_CODEC</span>
<a name="l02130"></a>02130 <span class="preprocessor"></span>    rc = <a class="code" href="sqlite3_8h.html#a6541f0ba18825303b0f5a566b8f6fb52">sqlite3_rekey</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, pKey, nKey);
<a name="l02131"></a>02131     <span class="keywordflow">if</span>( rc ){
<a name="l02132"></a>02132       Tcl_AppendResult(interp, <a class="code" href="main_8c.html#a02d1b390ceb669b8e689f27ea7134cad">sqlite3ErrStr</a>(rc), 0);
<a name="l02133"></a>02133       rc = TCL_ERROR;
<a name="l02134"></a>02134     }
<a name="l02135"></a>02135 <span class="preprocessor">#endif</span>
<a name="l02136"></a>02136 <span class="preprocessor"></span>    <span class="keywordflow">break</span>;
<a name="l02137"></a>02137   }
<a name="l02138"></a>02138 
<a name="l02139"></a>02139   <span class="comment">/*</span>
<a name="l02140"></a>02140 <span class="comment">  **     $db status (step|sort)</span>
<a name="l02141"></a>02141 <span class="comment">  **</span>
<a name="l02142"></a>02142 <span class="comment">  ** Display SQLITE_STMTSTATUS_FULLSCAN_STEP or </span>
<a name="l02143"></a>02143 <span class="comment">  ** SQLITE_STMTSTATUS_SORT for the most recent eval.</span>
<a name="l02144"></a>02144 <span class="comment">  */</span>
<a name="l02145"></a>02145   <span class="keywordflow">case</span> DB_STATUS: {
<a name="l02146"></a>02146     <span class="keywordtype">int</span> v;
<a name="l02147"></a>02147     <span class="keyword">const</span> <span class="keywordtype">char</span> *zOp;
<a name="l02148"></a>02148     <span class="keywordflow">if</span>( objc!=3 ){
<a name="l02149"></a>02149       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;(step|sort)&quot;</span>);
<a name="l02150"></a>02150       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02151"></a>02151     }
<a name="l02152"></a>02152     zOp = Tcl_GetString(objv[2]);
<a name="l02153"></a>02153     <span class="keywordflow">if</span>( strcmp(zOp, <span class="stringliteral">&quot;step&quot;</span>)==0 ){
<a name="l02154"></a>02154       v = pDb-&gt;<a class="code" href="structSqliteDb.html#aae182504912cf9d112003530cf1b6fe5">nStep</a>;
<a name="l02155"></a>02155     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(zOp, <span class="stringliteral">&quot;sort&quot;</span>)==0 ){
<a name="l02156"></a>02156       v = pDb-&gt;<a class="code" href="structSqliteDb.html#ac3fcd48fdcfc407666f0fdf443cb3ffd">nSort</a>;
<a name="l02157"></a>02157     }<span class="keywordflow">else</span>{
<a name="l02158"></a>02158       Tcl_AppendResult(interp, <span class="stringliteral">&quot;bad argument: should be step or sort&quot;</span>, 
<a name="l02159"></a>02159             (<span class="keywordtype">char</span>*)0);
<a name="l02160"></a>02160       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02161"></a>02161     }
<a name="l02162"></a>02162     Tcl_SetObjResult(interp, Tcl_NewIntObj(v));
<a name="l02163"></a>02163     <span class="keywordflow">break</span>;
<a name="l02164"></a>02164   }
<a name="l02165"></a>02165   
<a name="l02166"></a>02166   <span class="comment">/*</span>
<a name="l02167"></a>02167 <span class="comment">  **     $db timeout MILLESECONDS</span>
<a name="l02168"></a>02168 <span class="comment">  **</span>
<a name="l02169"></a>02169 <span class="comment">  ** Delay for the number of milliseconds specified when a file is locked.</span>
<a name="l02170"></a>02170 <span class="comment">  */</span>
<a name="l02171"></a>02171   <span class="keywordflow">case</span> DB_TIMEOUT: {
<a name="l02172"></a>02172     <span class="keywordtype">int</span> ms;
<a name="l02173"></a>02173     <span class="keywordflow">if</span>( objc!=3 ){
<a name="l02174"></a>02174       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;MILLISECONDS&quot;</span>);
<a name="l02175"></a>02175       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02176"></a>02176     }
<a name="l02177"></a>02177     <span class="keywordflow">if</span>( Tcl_GetIntFromObj(interp, objv[2], &amp;ms) ) <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02178"></a>02178     <a class="code" href="main_8c.html#abb532938097030cd9a72bc442e12a549">sqlite3_busy_timeout</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, ms);
<a name="l02179"></a>02179     <span class="keywordflow">break</span>;
<a name="l02180"></a>02180   }
<a name="l02181"></a>02181   
<a name="l02182"></a>02182   <span class="comment">/*</span>
<a name="l02183"></a>02183 <span class="comment">  **     $db total_changes</span>
<a name="l02184"></a>02184 <span class="comment">  **</span>
<a name="l02185"></a>02185 <span class="comment">  ** Return the number of rows that were modified, inserted, or deleted </span>
<a name="l02186"></a>02186 <span class="comment">  ** since the database handle was created.</span>
<a name="l02187"></a>02187 <span class="comment">  */</span>
<a name="l02188"></a>02188   <span class="keywordflow">case</span> DB_TOTAL_CHANGES: {
<a name="l02189"></a>02189     Tcl_Obj *pResult;
<a name="l02190"></a>02190     <span class="keywordflow">if</span>( objc!=2 ){
<a name="l02191"></a>02191       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02192"></a>02192       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02193"></a>02193     }
<a name="l02194"></a>02194     pResult = Tcl_GetObjResult(interp);
<a name="l02195"></a>02195     Tcl_SetIntObj(pResult, <a class="code" href="main_8c.html#ac49cd48c8f4de5e37ada7167342dcf97">sqlite3_total_changes</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>));
<a name="l02196"></a>02196     <span class="keywordflow">break</span>;
<a name="l02197"></a>02197   }
<a name="l02198"></a>02198 
<a name="l02199"></a>02199   <span class="comment">/*    $db trace ?CALLBACK?</span>
<a name="l02200"></a>02200 <span class="comment">  **</span>
<a name="l02201"></a>02201 <span class="comment">  ** Make arrangements to invoke the CALLBACK routine for each SQL statement</span>
<a name="l02202"></a>02202 <span class="comment">  ** that is executed.  The text of the SQL is appended to CALLBACK before</span>
<a name="l02203"></a>02203 <span class="comment">  ** it is executed.</span>
<a name="l02204"></a>02204 <span class="comment">  */</span>
<a name="l02205"></a>02205   <span class="keywordflow">case</span> DB_TRACE: {
<a name="l02206"></a>02206     <span class="keywordflow">if</span>( objc&gt;3 ){
<a name="l02207"></a>02207       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;?CALLBACK?&quot;</span>);
<a name="l02208"></a>02208       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02209"></a>02209     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( objc==2 ){
<a name="l02210"></a>02210       <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a74b96df446ab216017644fdab5c95ac3">zTrace</a> ){
<a name="l02211"></a>02211         Tcl_AppendResult(interp, pDb-&gt;<a class="code" href="structSqliteDb.html#a74b96df446ab216017644fdab5c95ac3">zTrace</a>, 0);
<a name="l02212"></a>02212       }
<a name="l02213"></a>02213     }<span class="keywordflow">else</span>{
<a name="l02214"></a>02214       <span class="keywordtype">char</span> *zTrace;
<a name="l02215"></a>02215       <span class="keywordtype">int</span> len;
<a name="l02216"></a>02216       <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a74b96df446ab216017644fdab5c95ac3">zTrace</a> ){
<a name="l02217"></a>02217         Tcl_Free(pDb-&gt;<a class="code" href="structSqliteDb.html#a74b96df446ab216017644fdab5c95ac3">zTrace</a>);
<a name="l02218"></a>02218       }
<a name="l02219"></a>02219       zTrace = Tcl_GetStringFromObj(objv[2], &amp;len);
<a name="l02220"></a>02220       <span class="keywordflow">if</span>( zTrace &amp;&amp; len&gt;0 ){
<a name="l02221"></a>02221         pDb-&gt;<a class="code" href="structSqliteDb.html#a74b96df446ab216017644fdab5c95ac3">zTrace</a> = Tcl_Alloc( len + 1 );
<a name="l02222"></a>02222         memcpy(pDb-&gt;<a class="code" href="structSqliteDb.html#a74b96df446ab216017644fdab5c95ac3">zTrace</a>, zTrace, len+1);
<a name="l02223"></a>02223       }<span class="keywordflow">else</span>{
<a name="l02224"></a>02224         pDb-&gt;<a class="code" href="structSqliteDb.html#a74b96df446ab216017644fdab5c95ac3">zTrace</a> = 0;
<a name="l02225"></a>02225       }
<a name="l02226"></a>02226 <span class="preprocessor">#ifndef SQLITE_OMIT_TRACE</span>
<a name="l02227"></a>02227 <span class="preprocessor"></span>      <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structSqliteDb.html#a74b96df446ab216017644fdab5c95ac3">zTrace</a> ){
<a name="l02228"></a>02228         pDb-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a> = interp;
<a name="l02229"></a>02229         <a class="code" href="main_8c.html#aa2303296f1355f956c4f095e36b292a6">sqlite3_trace</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, <a class="code" href="tclsqlite_8c.html#a6085723754eea01de4e1731063631def">DbTraceHandler</a>, pDb);
<a name="l02230"></a>02230       }<span class="keywordflow">else</span>{
<a name="l02231"></a>02231         <a class="code" href="main_8c.html#aa2303296f1355f956c4f095e36b292a6">sqlite3_trace</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, 0, 0);
<a name="l02232"></a>02232       }
<a name="l02233"></a>02233 <span class="preprocessor">#endif</span>
<a name="l02234"></a>02234 <span class="preprocessor"></span>    }
<a name="l02235"></a>02235     <span class="keywordflow">break</span>;
<a name="l02236"></a>02236   }
<a name="l02237"></a>02237 
<a name="l02238"></a>02238   <span class="comment">/*    $db transaction [-deferred|-immediate|-exclusive] SCRIPT</span>
<a name="l02239"></a>02239 <span class="comment">  **</span>
<a name="l02240"></a>02240 <span class="comment">  ** Start a new transaction (if we are not already in the midst of a</span>
<a name="l02241"></a>02241 <span class="comment">  ** transaction) and execute the TCL script SCRIPT.  After SCRIPT</span>
<a name="l02242"></a>02242 <span class="comment">  ** completes, either commit the transaction or roll it back if SCRIPT</span>
<a name="l02243"></a>02243 <span class="comment">  ** throws an exception.  Or if no new transation was started, do nothing.</span>
<a name="l02244"></a>02244 <span class="comment">  ** pass the exception on up the stack.</span>
<a name="l02245"></a>02245 <span class="comment">  **</span>
<a name="l02246"></a>02246 <span class="comment">  ** This command was inspired by Dave Thomas&apos;s talk on Ruby at the</span>
<a name="l02247"></a>02247 <span class="comment">  ** 2005 O&apos;Reilly Open Source Convention (OSCON).</span>
<a name="l02248"></a>02248 <span class="comment">  */</span>
<a name="l02249"></a>02249   <span class="keywordflow">case</span> DB_TRANSACTION: {
<a name="l02250"></a>02250     <span class="keywordtype">int</span> inTrans;
<a name="l02251"></a>02251     Tcl_Obj *pScript;
<a name="l02252"></a>02252     <span class="keyword">const</span> <span class="keywordtype">char</span> *zBegin = <span class="stringliteral">&quot;BEGIN&quot;</span>;
<a name="l02253"></a>02253     <span class="keywordflow">if</span>( objc!=3 &amp;&amp; objc!=4 ){
<a name="l02254"></a>02254       Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;[TYPE] SCRIPT&quot;</span>);
<a name="l02255"></a>02255       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02256"></a>02256     }
<a name="l02257"></a>02257     <span class="keywordflow">if</span>( objc==3 ){
<a name="l02258"></a>02258       pScript = objv[2];
<a name="l02259"></a>02259     } <span class="keywordflow">else</span> {
<a name="l02260"></a>02260       <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *TTYPE_strs[] = {
<a name="l02261"></a>02261         <span class="stringliteral">&quot;deferred&quot;</span>,   <span class="stringliteral">&quot;exclusive&quot;</span>,  <span class="stringliteral">&quot;immediate&quot;</span>, 0
<a name="l02262"></a>02262       };
<a name="l02263"></a>02263       <span class="keyword">enum</span> TTYPE_enum {
<a name="l02264"></a>02264         TTYPE_DEFERRED, TTYPE_EXCLUSIVE, TTYPE_IMMEDIATE
<a name="l02265"></a>02265       };
<a name="l02266"></a>02266       <span class="keywordtype">int</span> <a class="code" href="lobject_8h.html#acd205ab396b96fba48e1f758c17a2cf3">ttype</a>;
<a name="l02267"></a>02267       <span class="keywordflow">if</span>( Tcl_GetIndexFromObj(interp, objv[2], TTYPE_strs, <span class="stringliteral">&quot;transaction type&quot;</span>,
<a name="l02268"></a>02268                               0, &amp;ttype) ){
<a name="l02269"></a>02269         <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02270"></a>02270       }
<a name="l02271"></a>02271       <span class="keywordflow">switch</span>( (<span class="keyword">enum</span> TTYPE_enum)ttype ){
<a name="l02272"></a>02272         <span class="keywordflow">case</span> TTYPE_DEFERRED:    <span class="comment">/* no-op */</span>;                 <span class="keywordflow">break</span>;
<a name="l02273"></a>02273         <span class="keywordflow">case</span> TTYPE_EXCLUSIVE:   zBegin = <span class="stringliteral">&quot;BEGIN EXCLUSIVE&quot;</span>;  <span class="keywordflow">break</span>;
<a name="l02274"></a>02274         <span class="keywordflow">case</span> TTYPE_IMMEDIATE:   zBegin = <span class="stringliteral">&quot;BEGIN IMMEDIATE&quot;</span>;  <span class="keywordflow">break</span>;
<a name="l02275"></a>02275       }
<a name="l02276"></a>02276       pScript = objv[3];
<a name="l02277"></a>02277     }
<a name="l02278"></a>02278     inTrans = !<a class="code" href="main_8c.html#ab4082c8ffa8937d87b35878143536d70">sqlite3_get_autocommit</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>);
<a name="l02279"></a>02279     <span class="keywordflow">if</span>( !inTrans ){
<a name="l02280"></a>02280       pDb-&gt;<a class="code" href="structSqliteDb.html#af48d5c43dfbd5b0f4b4fab2214996989">disableAuth</a>++;
<a name="l02281"></a>02281       (void)<a class="code" href="legacy_8c.html#ada787486cf95a994521cfd0c64e853e4">sqlite3_exec</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, zBegin, 0, 0, 0);
<a name="l02282"></a>02282       pDb-&gt;<a class="code" href="structSqliteDb.html#af48d5c43dfbd5b0f4b4fab2214996989">disableAuth</a>--;
<a name="l02283"></a>02283     }
<a name="l02284"></a>02284     rc = Tcl_EvalObjEx(interp, pScript, 0);
<a name="l02285"></a>02285     <span class="keywordflow">if</span>( !inTrans ){
<a name="l02286"></a>02286       <span class="keyword">const</span> <span class="keywordtype">char</span> *zEnd;
<a name="l02287"></a>02287       <span class="keywordflow">if</span>( rc==TCL_ERROR ){
<a name="l02288"></a>02288         zEnd = <span class="stringliteral">&quot;ROLLBACK&quot;</span>;
<a name="l02289"></a>02289       } <span class="keywordflow">else</span> {
<a name="l02290"></a>02290         zEnd = <span class="stringliteral">&quot;COMMIT&quot;</span>;
<a name="l02291"></a>02291       }
<a name="l02292"></a>02292       pDb-&gt;<a class="code" href="structSqliteDb.html#af48d5c43dfbd5b0f4b4fab2214996989">disableAuth</a>++;
<a name="l02293"></a>02293       <span class="keywordflow">if</span>( <a class="code" href="legacy_8c.html#ada787486cf95a994521cfd0c64e853e4">sqlite3_exec</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, zEnd, 0, 0, 0) ){
<a name="l02294"></a>02294         <a class="code" href="legacy_8c.html#ada787486cf95a994521cfd0c64e853e4">sqlite3_exec</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, <span class="stringliteral">&quot;ROLLBACK&quot;</span>, 0, 0, 0);
<a name="l02295"></a>02295       }
<a name="l02296"></a>02296       pDb-&gt;<a class="code" href="structSqliteDb.html#af48d5c43dfbd5b0f4b4fab2214996989">disableAuth</a>--;
<a name="l02297"></a>02297     }
<a name="l02298"></a>02298     <span class="keywordflow">break</span>;
<a name="l02299"></a>02299   }
<a name="l02300"></a>02300 
<a name="l02301"></a>02301   <span class="comment">/*</span>
<a name="l02302"></a>02302 <span class="comment">  **    $db update_hook ?script?</span>
<a name="l02303"></a>02303 <span class="comment">  **    $db rollback_hook ?script?</span>
<a name="l02304"></a>02304 <span class="comment">  */</span>
<a name="l02305"></a>02305   <span class="keywordflow">case</span> DB_UPDATE_HOOK: 
<a name="l02306"></a>02306   <span class="keywordflow">case</span> DB_ROLLBACK_HOOK: {
<a name="l02307"></a>02307 
<a name="l02308"></a>02308     <span class="comment">/* set ppHook to point at pUpdateHook or pRollbackHook, depending on </span>
<a name="l02309"></a>02309 <span class="comment">    ** whether [$db update_hook] or [$db rollback_hook] was invoked.</span>
<a name="l02310"></a>02310 <span class="comment">    */</span>
<a name="l02311"></a>02311     Tcl_Obj **ppHook; 
<a name="l02312"></a>02312     <span class="keywordflow">if</span>( choice==DB_UPDATE_HOOK ){
<a name="l02313"></a>02313       ppHook = &amp;pDb-&gt;<a class="code" href="structSqliteDb.html#a54f8f8788f9e9a5a061076b7377d23d3">pUpdateHook</a>;
<a name="l02314"></a>02314     }<span class="keywordflow">else</span>{
<a name="l02315"></a>02315       ppHook = &amp;pDb-&gt;<a class="code" href="structSqliteDb.html#a5dbd38263d99aff24eaadd2ef522e823">pRollbackHook</a>;
<a name="l02316"></a>02316     }
<a name="l02317"></a>02317 
<a name="l02318"></a>02318     <span class="keywordflow">if</span>( objc!=2 &amp;&amp; objc!=3 ){
<a name="l02319"></a>02319        Tcl_WrongNumArgs(interp, 2, objv, <span class="stringliteral">&quot;?SCRIPT?&quot;</span>);
<a name="l02320"></a>02320        <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02321"></a>02321     }
<a name="l02322"></a>02322     <span class="keywordflow">if</span>( *ppHook ){
<a name="l02323"></a>02323       Tcl_SetObjResult(interp, *ppHook);
<a name="l02324"></a>02324       <span class="keywordflow">if</span>( objc==3 ){
<a name="l02325"></a>02325         Tcl_DecrRefCount(*ppHook);
<a name="l02326"></a>02326         *ppHook = 0;
<a name="l02327"></a>02327       }
<a name="l02328"></a>02328     }
<a name="l02329"></a>02329     <span class="keywordflow">if</span>( objc==3 ){
<a name="l02330"></a>02330       assert( !(*ppHook) );
<a name="l02331"></a>02331       <span class="keywordflow">if</span>( Tcl_GetCharLength(objv[2])&gt;0 ){
<a name="l02332"></a>02332         *ppHook = objv[2];
<a name="l02333"></a>02333         Tcl_IncrRefCount(*ppHook);
<a name="l02334"></a>02334       }
<a name="l02335"></a>02335     }
<a name="l02336"></a>02336 
<a name="l02337"></a>02337     <a class="code" href="main_8c.html#a899c015481952aeceb29c84e9e07def9">sqlite3_update_hook</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, (pDb-&gt;<a class="code" href="structSqliteDb.html#a54f8f8788f9e9a5a061076b7377d23d3">pUpdateHook</a>?<a class="code" href="tclsqlite_8c.html#a4bff178401a9ed6126bdeb1e8fc240c4">DbUpdateHandler</a>:0), pDb);
<a name="l02338"></a>02338     <a class="code" href="main_8c.html#a7eef1571c09a048977f874d287e4a92e">sqlite3_rollback_hook</a>(pDb-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>,(pDb-&gt;<a class="code" href="structSqliteDb.html#a5dbd38263d99aff24eaadd2ef522e823">pRollbackHook</a>?<a class="code" href="tclsqlite_8c.html#a0371dcddfbb6458bdca2808ecd7d85aa">DbRollbackHandler</a>:0),pDb);
<a name="l02339"></a>02339 
<a name="l02340"></a>02340     <span class="keywordflow">break</span>;
<a name="l02341"></a>02341   }
<a name="l02342"></a>02342 
<a name="l02343"></a>02343   <span class="comment">/*    $db version</span>
<a name="l02344"></a>02344 <span class="comment">  **</span>
<a name="l02345"></a>02345 <span class="comment">  ** Return the version string for this database.</span>
<a name="l02346"></a>02346 <span class="comment">  */</span>
<a name="l02347"></a>02347   <span class="keywordflow">case</span> DB_VERSION: {
<a name="l02348"></a>02348     Tcl_SetResult(interp, (<span class="keywordtype">char</span> *)<a class="code" href="main_8c.html#a56d672edfba3f5456e468cfb98061083">sqlite3_libversion</a>(), TCL_STATIC);
<a name="l02349"></a>02349     <span class="keywordflow">break</span>;
<a name="l02350"></a>02350   }
<a name="l02351"></a>02351 
<a name="l02352"></a>02352 
<a name="l02353"></a>02353   } <span class="comment">/* End of the SWITCH statement */</span>
<a name="l02354"></a>02354   <span class="keywordflow">return</span> rc;
<a name="l02355"></a>02355 }
<a name="l02356"></a>02356 
<a name="l02357"></a>02357 <span class="comment">/*</span>
<a name="l02358"></a>02358 <span class="comment">**   sqlite3 DBNAME FILENAME ?-vfs VFSNAME? ?-key KEY? ?-readonly BOOLEAN?</span>
<a name="l02359"></a>02359 <span class="comment">**                           ?-create BOOLEAN? ?-nomutex BOOLEAN?</span>
<a name="l02360"></a>02360 <span class="comment">**</span>
<a name="l02361"></a>02361 <span class="comment">** This is the main Tcl command.  When the &quot;sqlite&quot; Tcl command is</span>
<a name="l02362"></a>02362 <span class="comment">** invoked, this routine runs to process that command.</span>
<a name="l02363"></a>02363 <span class="comment">**</span>
<a name="l02364"></a>02364 <span class="comment">** The first argument, DBNAME, is an arbitrary name for a new</span>
<a name="l02365"></a>02365 <span class="comment">** database connection.  This command creates a new command named</span>
<a name="l02366"></a>02366 <span class="comment">** DBNAME that is used to control that connection.  The database</span>
<a name="l02367"></a>02367 <span class="comment">** connection is deleted when the DBNAME command is deleted.</span>
<a name="l02368"></a>02368 <span class="comment">**</span>
<a name="l02369"></a>02369 <span class="comment">** The second argument is the name of the database file.</span>
<a name="l02370"></a>02370 <span class="comment">**</span>
<a name="l02371"></a>02371 <span class="comment">*/</span>
<a name="l02372"></a><a class="code" href="tclsqlite_8c.html#a064eddeda7fdf73b1b35b870a9a26f2a">02372</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#a064eddeda7fdf73b1b35b870a9a26f2a">DbMain</a>(<span class="keywordtype">void</span> *cd, Tcl_Interp *interp, <span class="keywordtype">int</span> objc,Tcl_Obj *<span class="keyword">const</span>*objv){
<a name="l02373"></a>02373   <a class="code" href="structSqliteDb.html">SqliteDb</a> *p;
<a name="l02374"></a>02374   <span class="keywordtype">void</span> *pKey = 0;
<a name="l02375"></a>02375   <span class="keywordtype">int</span> nKey = 0;
<a name="l02376"></a>02376   <span class="keyword">const</span> <span class="keywordtype">char</span> *zArg;
<a name="l02377"></a>02377   <span class="keywordtype">char</span> *zErrMsg;
<a name="l02378"></a>02378   <span class="keywordtype">int</span> i;
<a name="l02379"></a>02379   <span class="keyword">const</span> <span class="keywordtype">char</span> *zFile;
<a name="l02380"></a>02380   <span class="keyword">const</span> <span class="keywordtype">char</span> *zVfs = 0;
<a name="l02381"></a>02381   <span class="keywordtype">int</span> flags = <a class="code" href="sqlite3_8h.html#a3eb39cf04a78fae3b553b96d65f93419">SQLITE_OPEN_READWRITE</a> | <a class="code" href="sqlite3_8h.html#a06cff06321a46ca610a29c8f125f9c08">SQLITE_OPEN_CREATE</a> | <a class="code" href="sqlite3_8h.html#ab4d0050d1ecf3e6da55e205c5f65aa5a">SQLITE_OPEN_NOMUTEX</a>;
<a name="l02382"></a>02382   Tcl_DString translatedFilename;
<a name="l02383"></a>02383   <span class="keywordflow">if</span>( objc==2 ){
<a name="l02384"></a>02384     zArg = Tcl_GetStringFromObj(objv[1], 0);
<a name="l02385"></a>02385     <span class="keywordflow">if</span>( strcmp(zArg,<span class="stringliteral">&quot;-version&quot;</span>)==0 ){
<a name="l02386"></a>02386       Tcl_AppendResult(interp,<a class="code" href="main_8c.html#a466e673c61615dd237c6917c2f95de44">sqlite3_version</a>,0);
<a name="l02387"></a>02387       <span class="keywordflow">return</span> TCL_OK;
<a name="l02388"></a>02388     }
<a name="l02389"></a>02389     <span class="keywordflow">if</span>( strcmp(zArg,<span class="stringliteral">&quot;-has-codec&quot;</span>)==0 ){
<a name="l02390"></a>02390 <span class="preprocessor">#ifdef SQLITE_HAS_CODEC</span>
<a name="l02391"></a>02391 <span class="preprocessor"></span>      Tcl_AppendResult(interp,<span class="stringliteral">&quot;1&quot;</span>,0);
<a name="l02392"></a>02392 <span class="preprocessor">#else</span>
<a name="l02393"></a>02393 <span class="preprocessor"></span>      Tcl_AppendResult(interp,<span class="stringliteral">&quot;0&quot;</span>,0);
<a name="l02394"></a>02394 <span class="preprocessor">#endif</span>
<a name="l02395"></a>02395 <span class="preprocessor"></span>      <span class="keywordflow">return</span> TCL_OK;
<a name="l02396"></a>02396     }
<a name="l02397"></a>02397   }
<a name="l02398"></a>02398   <span class="keywordflow">for</span>(i=3; i+1&lt;objc; i+=2){
<a name="l02399"></a>02399     zArg = Tcl_GetString(objv[i]);
<a name="l02400"></a>02400     <span class="keywordflow">if</span>( strcmp(zArg,<span class="stringliteral">&quot;-key&quot;</span>)==0 ){
<a name="l02401"></a>02401       pKey = Tcl_GetByteArrayFromObj(objv[i+1], &amp;nKey);
<a name="l02402"></a>02402     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(zArg, <span class="stringliteral">&quot;-vfs&quot;</span>)==0 ){
<a name="l02403"></a>02403       i++;
<a name="l02404"></a>02404       zVfs = Tcl_GetString(objv[i]);
<a name="l02405"></a>02405     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(zArg, <span class="stringliteral">&quot;-readonly&quot;</span>)==0 ){
<a name="l02406"></a>02406       <span class="keywordtype">int</span> b;
<a name="l02407"></a>02407       <span class="keywordflow">if</span>( Tcl_GetBooleanFromObj(interp, objv[i+1], &amp;b) ) <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02408"></a>02408       <span class="keywordflow">if</span>( b ){
<a name="l02409"></a>02409         flags &amp;= ~(<a class="code" href="sqlite3_8h.html#a3eb39cf04a78fae3b553b96d65f93419">SQLITE_OPEN_READWRITE</a>|<a class="code" href="sqlite3_8h.html#a06cff06321a46ca610a29c8f125f9c08">SQLITE_OPEN_CREATE</a>);
<a name="l02410"></a>02410         flags |= <a class="code" href="sqlite3_8h.html#a9f0b8777cdd16d53be7a2e1ccf759ff1">SQLITE_OPEN_READONLY</a>;
<a name="l02411"></a>02411       }<span class="keywordflow">else</span>{
<a name="l02412"></a>02412         flags &amp;= ~<a class="code" href="sqlite3_8h.html#a9f0b8777cdd16d53be7a2e1ccf759ff1">SQLITE_OPEN_READONLY</a>;
<a name="l02413"></a>02413         flags |= <a class="code" href="sqlite3_8h.html#a3eb39cf04a78fae3b553b96d65f93419">SQLITE_OPEN_READWRITE</a>;
<a name="l02414"></a>02414       }
<a name="l02415"></a>02415     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(zArg, <span class="stringliteral">&quot;-create&quot;</span>)==0 ){
<a name="l02416"></a>02416       <span class="keywordtype">int</span> b;
<a name="l02417"></a>02417       <span class="keywordflow">if</span>( Tcl_GetBooleanFromObj(interp, objv[i+1], &amp;b) ) <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02418"></a>02418       <span class="keywordflow">if</span>( b &amp;&amp; (flags &amp; <a class="code" href="sqlite3_8h.html#a9f0b8777cdd16d53be7a2e1ccf759ff1">SQLITE_OPEN_READONLY</a>)==0 ){
<a name="l02419"></a>02419         flags |= <a class="code" href="sqlite3_8h.html#a06cff06321a46ca610a29c8f125f9c08">SQLITE_OPEN_CREATE</a>;
<a name="l02420"></a>02420       }<span class="keywordflow">else</span>{
<a name="l02421"></a>02421         flags &amp;= ~<a class="code" href="sqlite3_8h.html#a06cff06321a46ca610a29c8f125f9c08">SQLITE_OPEN_CREATE</a>;
<a name="l02422"></a>02422       }
<a name="l02423"></a>02423     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(zArg, <span class="stringliteral">&quot;-nomutex&quot;</span>)==0 ){
<a name="l02424"></a>02424       <span class="keywordtype">int</span> b;
<a name="l02425"></a>02425       <span class="keywordflow">if</span>( Tcl_GetBooleanFromObj(interp, objv[i+1], &amp;b) ) <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02426"></a>02426       <span class="keywordflow">if</span>( b ){
<a name="l02427"></a>02427         flags |= <a class="code" href="sqlite3_8h.html#ab4d0050d1ecf3e6da55e205c5f65aa5a">SQLITE_OPEN_NOMUTEX</a>;
<a name="l02428"></a>02428         flags &amp;= ~<a class="code" href="sqlite3_8h.html#a3a4f53ba5c88813a1c9b73d74d34835f">SQLITE_OPEN_FULLMUTEX</a>;
<a name="l02429"></a>02429       }<span class="keywordflow">else</span>{
<a name="l02430"></a>02430         flags &amp;= ~<a class="code" href="sqlite3_8h.html#ab4d0050d1ecf3e6da55e205c5f65aa5a">SQLITE_OPEN_NOMUTEX</a>;
<a name="l02431"></a>02431       }
<a name="l02432"></a>02432    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(zArg, <span class="stringliteral">&quot;-fullmutex&quot;</span>)==0 ){
<a name="l02433"></a>02433       <span class="keywordtype">int</span> b;
<a name="l02434"></a>02434       <span class="keywordflow">if</span>( Tcl_GetBooleanFromObj(interp, objv[i+1], &amp;b) ) <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02435"></a>02435       <span class="keywordflow">if</span>( b ){
<a name="l02436"></a>02436         flags |= <a class="code" href="sqlite3_8h.html#a3a4f53ba5c88813a1c9b73d74d34835f">SQLITE_OPEN_FULLMUTEX</a>;
<a name="l02437"></a>02437         flags &amp;= ~<a class="code" href="sqlite3_8h.html#ab4d0050d1ecf3e6da55e205c5f65aa5a">SQLITE_OPEN_NOMUTEX</a>;
<a name="l02438"></a>02438       }<span class="keywordflow">else</span>{
<a name="l02439"></a>02439         flags &amp;= ~<a class="code" href="sqlite3_8h.html#a3a4f53ba5c88813a1c9b73d74d34835f">SQLITE_OPEN_FULLMUTEX</a>;
<a name="l02440"></a>02440       }
<a name="l02441"></a>02441     }<span class="keywordflow">else</span>{
<a name="l02442"></a>02442       Tcl_AppendResult(interp, <span class="stringliteral">&quot;unknown option: &quot;</span>, zArg, (<span class="keywordtype">char</span>*)0);
<a name="l02443"></a>02443       <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02444"></a>02444     }
<a name="l02445"></a>02445   }
<a name="l02446"></a>02446   <span class="keywordflow">if</span>( objc&lt;3 || (objc&amp;1)!=1 ){
<a name="l02447"></a>02447     Tcl_WrongNumArgs(interp, 1, objv, 
<a name="l02448"></a>02448       <span class="stringliteral">&quot;HANDLE FILENAME ?-vfs VFSNAME? ?-readonly BOOLEAN? ?-create BOOLEAN?&quot;</span>
<a name="l02449"></a>02449       <span class="stringliteral">&quot; ?-nomutex BOOLEAN? ?-fullmutex BOOLEAN?&quot;</span>
<a name="l02450"></a>02450 #ifdef SQLITE_HAS_CODEC
<a name="l02451"></a>02451       <span class="stringliteral">&quot; ?-key CODECKEY?&quot;</span>
<a name="l02452"></a>02452 #endif
<a name="l02453"></a>02453     );
<a name="l02454"></a>02454     <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02455"></a>02455   }
<a name="l02456"></a>02456   zErrMsg = 0;
<a name="l02457"></a>02457   p = (<a class="code" href="structSqliteDb.html">SqliteDb</a>*)Tcl_Alloc( <span class="keyword">sizeof</span>(*p) );
<a name="l02458"></a>02458   <span class="keywordflow">if</span>( p==0 ){
<a name="l02459"></a>02459     Tcl_SetResult(interp, <span class="stringliteral">&quot;malloc failed&quot;</span>, TCL_STATIC);
<a name="l02460"></a>02460     <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02461"></a>02461   }
<a name="l02462"></a>02462   memset(p, 0, <span class="keyword">sizeof</span>(*p));
<a name="l02463"></a>02463   zFile = Tcl_GetStringFromObj(objv[2], 0);
<a name="l02464"></a>02464   zFile = Tcl_TranslateFileName(interp, zFile, &amp;translatedFilename);
<a name="l02465"></a>02465   <a class="code" href="main_8c.html#a1da30d4a82d60a86c588b588f204aed8">sqlite3_open_v2</a>(zFile, &amp;p-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, flags, zVfs);
<a name="l02466"></a>02466   Tcl_DStringFree(&amp;translatedFilename);
<a name="l02467"></a>02467   <span class="keywordflow">if</span>( <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>!=<a class="code" href="main_8c.html#aacf8bb5cc3e174eca0c6aab77aa9d4ec">sqlite3_errcode</a>(p-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>) ){
<a name="l02468"></a>02468     zErrMsg = <a class="code" href="printf_8c.html#a708f6775f57f33c17e982512a00df665">sqlite3_mprintf</a>(<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="main_8c.html#ad2a9feca40ee5a7c629c2af6d0ae1d27">sqlite3_errmsg</a>(p-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>));
<a name="l02469"></a>02469     <a class="code" href="main_8c.html#ad8b9c470f85398febda75993b66a8827">sqlite3_close</a>(p-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>);
<a name="l02470"></a>02470     p-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a> = 0;
<a name="l02471"></a>02471   }
<a name="l02472"></a>02472 <span class="preprocessor">#ifdef SQLITE_HAS_CODEC</span>
<a name="l02473"></a>02473 <span class="preprocessor"></span>  <span class="keywordflow">if</span>( p-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a> ){
<a name="l02474"></a>02474     <a class="code" href="sqlite3_8h.html#ac4de60b5d95588cc54ed9a8e0d6780e2">sqlite3_key</a>(p-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>, pKey, nKey);
<a name="l02475"></a>02475   }
<a name="l02476"></a>02476 <span class="preprocessor">#endif</span>
<a name="l02477"></a>02477 <span class="preprocessor"></span>  <span class="keywordflow">if</span>( p-&gt;<a class="code" href="structSqliteDb.html#a2db4eb58da2a12f35b5322bd851d1b9e">db</a>==0 ){
<a name="l02478"></a>02478     Tcl_SetResult(interp, zErrMsg, TCL_VOLATILE);
<a name="l02479"></a>02479     Tcl_Free((<span class="keywordtype">char</span>*)p);
<a name="l02480"></a>02480     <a class="code" href="malloc_8c.html#a89d4380358f918be2a8e2171d95bbb04">sqlite3_free</a>(zErrMsg);
<a name="l02481"></a>02481     <span class="keywordflow">return</span> TCL_ERROR;
<a name="l02482"></a>02482   }
<a name="l02483"></a>02483   p-&gt;<a class="code" href="structSqliteDb.html#a552e45c18680c2bfb6962b361b40204f">maxStmt</a> = <a class="code" href="tclsqlite_8c.html#a2871e2af97e334d5dac2253b786e129e">NUM_PREPARED_STMTS</a>;
<a name="l02484"></a>02484   p-&gt;<a class="code" href="structSqliteDb.html#a947de3580b850dffb7c3580dfee84adb">interp</a> = interp;
<a name="l02485"></a>02485   zArg = Tcl_GetStringFromObj(objv[1], 0);
<a name="l02486"></a>02486   Tcl_CreateObjCommand(interp, zArg, <a class="code" href="tclsqlite_8c.html#aa0fb8e0d5de83fd3540f057c460087d1">DbObjCmd</a>, (<span class="keywordtype">char</span>*)p, <a class="code" href="tclsqlite_8c.html#a2dc21f3170c84e31f611875e0629bf84">DbDeleteCmd</a>);
<a name="l02487"></a>02487   <span class="keywordflow">return</span> TCL_OK;
<a name="l02488"></a>02488 }
<a name="l02489"></a>02489 
<a name="l02490"></a>02490 <span class="comment">/*</span>
<a name="l02491"></a>02491 <span class="comment">** Provide a dummy Tcl_InitStubs if we are using this as a static</span>
<a name="l02492"></a>02492 <span class="comment">** library.</span>
<a name="l02493"></a>02493 <span class="comment">*/</span>
<a name="l02494"></a>02494 <span class="preprocessor">#ifndef USE_TCL_STUBS</span>
<a name="l02495"></a>02495 <span class="preprocessor"></span><span class="preprocessor"># undef  Tcl_InitStubs</span>
<a name="l02496"></a><a class="code" href="tclsqlite_8c.html#a797783149f7d8a2780046a08a3a77a62">02496</a> <span class="preprocessor"></span><span class="preprocessor"># define Tcl_InitStubs(a,b,c)</span>
<a name="l02497"></a>02497 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l02498"></a>02498 <span class="preprocessor"></span>
<a name="l02499"></a>02499 <span class="comment">/*</span>
<a name="l02500"></a>02500 <span class="comment">** Make sure we have a PACKAGE_VERSION macro defined.  This will be</span>
<a name="l02501"></a>02501 <span class="comment">** defined automatically by the TEA makefile.  But other makefiles</span>
<a name="l02502"></a>02502 <span class="comment">** do not define it.</span>
<a name="l02503"></a>02503 <span class="comment">*/</span>
<a name="l02504"></a>02504 <span class="preprocessor">#ifndef PACKAGE_VERSION</span>
<a name="l02505"></a><a class="code" href="tclsqlite_8c.html#aa326a05d5e30f9e9a4bb0b4469d5d0c0">02505</a> <span class="preprocessor"></span><span class="preprocessor"># define PACKAGE_VERSION SQLITE_VERSION</span>
<a name="l02506"></a>02506 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l02507"></a>02507 <span class="preprocessor"></span>
<a name="l02508"></a>02508 <span class="comment">/*</span>
<a name="l02509"></a>02509 <span class="comment">** Initialize this module.</span>
<a name="l02510"></a>02510 <span class="comment">**</span>
<a name="l02511"></a>02511 <span class="comment">** This Tcl module contains only a single new Tcl command named &quot;sqlite&quot;.</span>
<a name="l02512"></a>02512 <span class="comment">** (Hence there is no namespace.  There is no point in using a namespace</span>
<a name="l02513"></a>02513 <span class="comment">** if the extension only supplies one new name!)  The &quot;sqlite&quot; command is</span>
<a name="l02514"></a>02514 <span class="comment">** used to open a new SQLite database.  See the DbMain() routine above</span>
<a name="l02515"></a>02515 <span class="comment">** for additional information.</span>
<a name="l02516"></a>02516 <span class="comment">*/</span>
<a name="l02517"></a><a class="code" href="tclsqlite_8c.html#af3f46995e51ff14b7386d79278951b23">02517</a> EXTERN <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#af3f46995e51ff14b7386d79278951b23">Sqlite3_Init</a>(Tcl_Interp *interp){
<a name="l02518"></a>02518   <a class="code" href="tclsqlite_8c.html#a797783149f7d8a2780046a08a3a77a62">Tcl_InitStubs</a>(interp, <span class="stringliteral">&quot;8.4&quot;</span>, 0);
<a name="l02519"></a>02519   Tcl_CreateObjCommand(interp, <span class="stringliteral">&quot;sqlite3&quot;</span>, (Tcl_ObjCmdProc*)<a class="code" href="tclsqlite_8c.html#a064eddeda7fdf73b1b35b870a9a26f2a">DbMain</a>, 0, 0);
<a name="l02520"></a>02520   Tcl_PkgProvide(interp, <span class="stringliteral">&quot;sqlite3&quot;</span>, <a class="code" href="tclsqlite_8c.html#aa326a05d5e30f9e9a4bb0b4469d5d0c0">PACKAGE_VERSION</a>);
<a name="l02521"></a>02521   Tcl_CreateObjCommand(interp, <span class="stringliteral">&quot;sqlite&quot;</span>, (Tcl_ObjCmdProc*)DbMain, 0, 0);
<a name="l02522"></a>02522   Tcl_PkgProvide(interp, <span class="stringliteral">&quot;sqlite&quot;</span>, <a class="code" href="tclsqlite_8c.html#aa326a05d5e30f9e9a4bb0b4469d5d0c0">PACKAGE_VERSION</a>);
<a name="l02523"></a>02523   <span class="keywordflow">return</span> TCL_OK;
<a name="l02524"></a>02524 }
<a name="l02525"></a><a class="code" href="tclsqlite_8c.html#af872f01d68d900c8af9fc0a88fa7f425">02525</a> EXTERN <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#af872f01d68d900c8af9fc0a88fa7f425">Tclsqlite3_Init</a>(Tcl_Interp *interp){ <span class="keywordflow">return</span> <a class="code" href="tclsqlite_8c.html#af3f46995e51ff14b7386d79278951b23">Sqlite3_Init</a>(interp); }
<a name="l02526"></a><a class="code" href="tclsqlite_8c.html#adf0950f93321415a5f3395b2e361885b">02526</a> EXTERN <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#adf0950f93321415a5f3395b2e361885b">Sqlite3_SafeInit</a>(Tcl_Interp *interp){ <span class="keywordflow">return</span> TCL_OK; }
<a name="l02527"></a><a class="code" href="tclsqlite_8c.html#ab56bae539295f5b07a66bb3a91b56e11">02527</a> EXTERN <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#ab56bae539295f5b07a66bb3a91b56e11">Tclsqlite3_SafeInit</a>(Tcl_Interp *interp){ <span class="keywordflow">return</span> TCL_OK; }
<a name="l02528"></a><a class="code" href="tclsqlite_8c.html#a5af17aebeb2bfe4f16fc1d3163e398d1">02528</a> EXTERN <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#a5af17aebeb2bfe4f16fc1d3163e398d1">Sqlite3_Unload</a>(Tcl_Interp *interp, <span class="keywordtype">int</span> flags){ <span class="keywordflow">return</span> TCL_OK; }
<a name="l02529"></a><a class="code" href="tclsqlite_8c.html#a265a9cba63fa4b8801019178e1ed1672">02529</a> EXTERN <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#a265a9cba63fa4b8801019178e1ed1672">Tclsqlite3_Unload</a>(Tcl_Interp *interp, <span class="keywordtype">int</span> flags){ <span class="keywordflow">return</span> TCL_OK; }
<a name="l02530"></a><a class="code" href="tclsqlite_8c.html#aaa885a5ab29d80c40fdaae683db3b09d">02530</a> EXTERN <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#aaa885a5ab29d80c40fdaae683db3b09d">Sqlite3_SafeUnload</a>(Tcl_Interp *interp, <span class="keywordtype">int</span> flags){ <span class="keywordflow">return</span> TCL_OK; }
<a name="l02531"></a><a class="code" href="tclsqlite_8c.html#a7b87af91baaa5e8cf8d41da67862dbf4">02531</a> EXTERN <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#a7b87af91baaa5e8cf8d41da67862dbf4">Tclsqlite3_SafeUnload</a>(Tcl_Interp *interp, <span class="keywordtype">int</span> flags){ <span class="keywordflow">return</span> TCL_OK;}
<a name="l02532"></a>02532 
<a name="l02533"></a>02533 
<a name="l02534"></a>02534 <span class="preprocessor">#ifndef SQLITE_3_SUFFIX_ONLY</span>
<a name="l02535"></a><a class="code" href="tclsqlite_8c.html#a079bee24cfe04324d0895b148a3e7fb3">02535</a> <span class="preprocessor"></span>EXTERN <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#a079bee24cfe04324d0895b148a3e7fb3">Sqlite_Init</a>(Tcl_Interp *interp){ <span class="keywordflow">return</span> <a class="code" href="tclsqlite_8c.html#af3f46995e51ff14b7386d79278951b23">Sqlite3_Init</a>(interp); }
<a name="l02536"></a><a class="code" href="tclsqlite_8c.html#a04444997cf96cf07fc17fad2ea2801ea">02536</a> EXTERN <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#a04444997cf96cf07fc17fad2ea2801ea">Tclsqlite_Init</a>(Tcl_Interp *interp){ <span class="keywordflow">return</span> <a class="code" href="tclsqlite_8c.html#af3f46995e51ff14b7386d79278951b23">Sqlite3_Init</a>(interp); }
<a name="l02537"></a><a class="code" href="tclsqlite_8c.html#a95c62c2174cc13df645c66d9185962dc">02537</a> EXTERN <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#a95c62c2174cc13df645c66d9185962dc">Sqlite_SafeInit</a>(Tcl_Interp *interp){ <span class="keywordflow">return</span> TCL_OK; }
<a name="l02538"></a><a class="code" href="tclsqlite_8c.html#a72d03532b7f4ea8a1afa81d60a5bb56f">02538</a> EXTERN <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#a72d03532b7f4ea8a1afa81d60a5bb56f">Tclsqlite_SafeInit</a>(Tcl_Interp *interp){ <span class="keywordflow">return</span> TCL_OK; }
<a name="l02539"></a><a class="code" href="tclsqlite_8c.html#ab4dede27dd82877e6893c95f55649547">02539</a> EXTERN <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#ab4dede27dd82877e6893c95f55649547">Sqlite_Unload</a>(Tcl_Interp *interp, <span class="keywordtype">int</span> flags){ <span class="keywordflow">return</span> TCL_OK; }
<a name="l02540"></a><a class="code" href="tclsqlite_8c.html#ad3045f2d56b0bb4695a5080168cc90a7">02540</a> EXTERN <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#ad3045f2d56b0bb4695a5080168cc90a7">Tclsqlite_Unload</a>(Tcl_Interp *interp, <span class="keywordtype">int</span> flags){ <span class="keywordflow">return</span> TCL_OK; }
<a name="l02541"></a><a class="code" href="tclsqlite_8c.html#ab6754c9f5e52df90566028abe3b33193">02541</a> EXTERN <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#ab6754c9f5e52df90566028abe3b33193">Sqlite_SafeUnload</a>(Tcl_Interp *interp, <span class="keywordtype">int</span> flags){ <span class="keywordflow">return</span> TCL_OK; }
<a name="l02542"></a><a class="code" href="tclsqlite_8c.html#a196002aecc96e71d108a0e842ba9daed">02542</a> EXTERN <span class="keywordtype">int</span> <a class="code" href="tclsqlite_8c.html#a196002aecc96e71d108a0e842ba9daed">Tclsqlite_SafeUnload</a>(Tcl_Interp *interp, <span class="keywordtype">int</span> flags){ <span class="keywordflow">return</span> TCL_OK;}
<a name="l02543"></a>02543 <span class="preprocessor">#endif</span>
<a name="l02544"></a>02544 <span class="preprocessor"></span>
<a name="l02545"></a>02545 <span class="preprocessor">#ifdef TCLSH</span>
<a name="l02546"></a>02546 <span class="preprocessor"></span><span class="comment">/*****************************************************************************</span>
<a name="l02547"></a>02547 <span class="comment">** The code that follows is used to build standalone TCL interpreters</span>
<a name="l02548"></a>02548 <span class="comment">** that are statically linked with SQLite.  </span>
<a name="l02549"></a>02549 <span class="comment">*/</span>
<a name="l02550"></a>02550 
<a name="l02551"></a>02551 <span class="comment">/*</span>
<a name="l02552"></a>02552 <span class="comment">** If the macro TCLSH is one, then put in code this for the</span>
<a name="l02553"></a>02553 <span class="comment">** &quot;main&quot; routine that will initialize Tcl and take input from</span>
<a name="l02554"></a>02554 <span class="comment">** standard input, or if a file is named on the command line</span>
<a name="l02555"></a>02555 <span class="comment">** the TCL interpreter reads and evaluates that file.</span>
<a name="l02556"></a>02556 <span class="comment">*/</span>
<a name="l02557"></a>02557 <span class="preprocessor">#if TCLSH==1</span>
<a name="l02558"></a>02558 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">char</span> zMainloop[] =
<a name="l02559"></a>02559   <span class="stringliteral">&quot;set line {}\n&quot;</span>
<a name="l02560"></a>02560   <span class="stringliteral">&quot;while {![eof stdin]} {\n&quot;</span>
<a name="l02561"></a>02561     <span class="stringliteral">&quot;if {$line!=\&quot;\&quot;} {\n&quot;</span>
<a name="l02562"></a>02562       <span class="stringliteral">&quot;puts -nonewline \&quot;&gt; \&quot;\n&quot;</span>
<a name="l02563"></a>02563     <span class="stringliteral">&quot;} else {\n&quot;</span>
<a name="l02564"></a>02564       <span class="stringliteral">&quot;puts -nonewline \&quot;% \&quot;\n&quot;</span>
<a name="l02565"></a>02565     <span class="stringliteral">&quot;}\n&quot;</span>
<a name="l02566"></a>02566     <span class="stringliteral">&quot;flush stdout\n&quot;</span>
<a name="l02567"></a>02567     <span class="stringliteral">&quot;append line [gets stdin]\n&quot;</span>
<a name="l02568"></a>02568     <span class="stringliteral">&quot;if {[info complete $line]} {\n&quot;</span>
<a name="l02569"></a>02569       <span class="stringliteral">&quot;if {[catch {uplevel #0 $line} result]} {\n&quot;</span>
<a name="l02570"></a>02570         <span class="stringliteral">&quot;puts stderr \&quot;Error: $result\&quot;\n&quot;</span>
<a name="l02571"></a>02571       <span class="stringliteral">&quot;} elseif {$result!=\&quot;\&quot;} {\n&quot;</span>
<a name="l02572"></a>02572         <span class="stringliteral">&quot;puts $result\n&quot;</span>
<a name="l02573"></a>02573       <span class="stringliteral">&quot;}\n&quot;</span>
<a name="l02574"></a>02574       <span class="stringliteral">&quot;set line {}\n&quot;</span>
<a name="l02575"></a>02575     <span class="stringliteral">&quot;} else {\n&quot;</span>
<a name="l02576"></a>02576       <span class="stringliteral">&quot;append line \\n\n&quot;</span>
<a name="l02577"></a>02577     <span class="stringliteral">&quot;}\n&quot;</span>
<a name="l02578"></a>02578   <span class="stringliteral">&quot;}\n&quot;</span>
<a name="l02579"></a>02579 ;
<a name="l02580"></a>02580 <span class="preprocessor">#endif</span>
<a name="l02581"></a>02581 <span class="preprocessor"></span>
<a name="l02582"></a>02582 <span class="comment">/*</span>
<a name="l02583"></a>02583 <span class="comment">** If the macro TCLSH is two, then get the main loop code out of</span>
<a name="l02584"></a>02584 <span class="comment">** the separate file &quot;spaceanal_tcl.h&quot;.</span>
<a name="l02585"></a>02585 <span class="comment">*/</span>
<a name="l02586"></a>02586 <span class="preprocessor">#if TCLSH==2</span>
<a name="l02587"></a>02587 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">char</span> zMainloop[] = 
<a name="l02588"></a>02588 <span class="preprocessor">#include &quot;spaceanal_tcl.h&quot;</span>
<a name="l02589"></a>02589 ;
<a name="l02590"></a>02590 <span class="preprocessor">#endif</span>
<a name="l02591"></a>02591 <span class="preprocessor"></span>
<a name="l02592"></a>02592 <span class="preprocessor">#define TCLSH_MAIN main   </span><span class="comment">/* Needed to fake out mktclapp */</span>
<a name="l02593"></a>02593 <span class="keywordtype">int</span> TCLSH_MAIN(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv){
<a name="l02594"></a>02594   Tcl_Interp *interp;
<a name="l02595"></a>02595   Tcl_FindExecutable(argv[0]);
<a name="l02596"></a>02596   interp = Tcl_CreateInterp();
<a name="l02597"></a>02597   <a class="code" href="tclsqlite_8c.html#af3f46995e51ff14b7386d79278951b23">Sqlite3_Init</a>(interp);
<a name="l02598"></a>02598 <span class="preprocessor">#ifdef SQLITE_TEST</span>
<a name="l02599"></a>02599 <span class="preprocessor"></span>  {
<a name="l02600"></a>02600     <span class="keyword">extern</span> <span class="keywordtype">int</span> Md5_Init(Tcl_Interp*);
<a name="l02601"></a>02601     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqliteconfig_Init(Tcl_Interp*);
<a name="l02602"></a>02602     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetest1_Init(Tcl_Interp*);
<a name="l02603"></a>02603     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetest2_Init(Tcl_Interp*);
<a name="l02604"></a>02604     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetest3_Init(Tcl_Interp*);
<a name="l02605"></a>02605     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetest4_Init(Tcl_Interp*);
<a name="l02606"></a>02606     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetest5_Init(Tcl_Interp*);
<a name="l02607"></a>02607     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetest6_Init(Tcl_Interp*);
<a name="l02608"></a>02608     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetest7_Init(Tcl_Interp*);
<a name="l02609"></a>02609     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetest8_Init(Tcl_Interp*);
<a name="l02610"></a>02610     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetest9_Init(Tcl_Interp*);
<a name="l02611"></a>02611     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetestasync_Init(Tcl_Interp*);
<a name="l02612"></a>02612     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetest_autoext_Init(Tcl_Interp*);
<a name="l02613"></a>02613     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetest_func_Init(Tcl_Interp*);
<a name="l02614"></a>02614     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetest_hexio_Init(Tcl_Interp*);
<a name="l02615"></a>02615     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetest_malloc_Init(Tcl_Interp*);
<a name="l02616"></a>02616     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetest_mutex_Init(Tcl_Interp*);
<a name="l02617"></a>02617     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetestschema_Init(Tcl_Interp*);
<a name="l02618"></a>02618     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetestsse_Init(Tcl_Interp*);
<a name="l02619"></a>02619     <span class="keyword">extern</span> <span class="keywordtype">int</span> Sqlitetesttclvar_Init(Tcl_Interp*);
<a name="l02620"></a>02620     <span class="keyword">extern</span> <span class="keywordtype">int</span> SqlitetestThread_Init(Tcl_Interp*);
<a name="l02621"></a>02621     <span class="keyword">extern</span> <span class="keywordtype">int</span> SqlitetestOnefile_Init();
<a name="l02622"></a>02622     <span class="keyword">extern</span> <span class="keywordtype">int</span> SqlitetestOsinst_Init(Tcl_Interp*);
<a name="l02623"></a>02623 
<a name="l02624"></a>02624     Md5_Init(interp);
<a name="l02625"></a>02625     Sqliteconfig_Init(interp);
<a name="l02626"></a>02626     Sqlitetest1_Init(interp);
<a name="l02627"></a>02627     Sqlitetest2_Init(interp);
<a name="l02628"></a>02628     Sqlitetest3_Init(interp);
<a name="l02629"></a>02629     Sqlitetest4_Init(interp);
<a name="l02630"></a>02630     Sqlitetest5_Init(interp);
<a name="l02631"></a>02631     Sqlitetest6_Init(interp);
<a name="l02632"></a>02632     Sqlitetest7_Init(interp);
<a name="l02633"></a>02633     Sqlitetest8_Init(interp);
<a name="l02634"></a>02634     Sqlitetest9_Init(interp);
<a name="l02635"></a>02635     Sqlitetestasync_Init(interp);
<a name="l02636"></a>02636     Sqlitetest_autoext_Init(interp);
<a name="l02637"></a>02637     Sqlitetest_func_Init(interp);
<a name="l02638"></a>02638     Sqlitetest_hexio_Init(interp);
<a name="l02639"></a>02639     Sqlitetest_malloc_Init(interp);
<a name="l02640"></a>02640     Sqlitetest_mutex_Init(interp);
<a name="l02641"></a>02641     Sqlitetestschema_Init(interp);
<a name="l02642"></a>02642     Sqlitetesttclvar_Init(interp);
<a name="l02643"></a>02643     SqlitetestThread_Init(interp);
<a name="l02644"></a>02644     SqlitetestOnefile_Init(interp);
<a name="l02645"></a>02645     SqlitetestOsinst_Init(interp);
<a name="l02646"></a>02646 
<a name="l02647"></a>02647 <span class="preprocessor">#ifdef SQLITE_SSE</span>
<a name="l02648"></a>02648 <span class="preprocessor"></span>    Sqlitetestsse_Init(interp);
<a name="l02649"></a>02649 <span class="preprocessor">#endif</span>
<a name="l02650"></a>02650 <span class="preprocessor"></span>  }
<a name="l02651"></a>02651 <span class="preprocessor">#endif</span>
<a name="l02652"></a>02652 <span class="preprocessor"></span>  <span class="keywordflow">if</span>( argc&gt;=2 || TCLSH==2 ){
<a name="l02653"></a>02653     <span class="keywordtype">int</span> i;
<a name="l02654"></a>02654     <span class="keywordtype">char</span> zArgc[32];
<a name="l02655"></a>02655     <a class="code" href="printf_8c.html#aa62e83e27ab0a63e15f9f844c17c595f">sqlite3_snprintf</a>(<span class="keyword">sizeof</span>(zArgc), zArgc, <span class="stringliteral">&quot;%d&quot;</span>, argc-(3-TCLSH));
<a name="l02656"></a>02656     Tcl_SetVar(interp,<span class="stringliteral">&quot;argc&quot;</span>, zArgc, TCL_GLOBAL_ONLY);
<a name="l02657"></a>02657     Tcl_SetVar(interp,<span class="stringliteral">&quot;argv0&quot;</span>,argv[1],TCL_GLOBAL_ONLY);
<a name="l02658"></a>02658     Tcl_SetVar(interp,<span class="stringliteral">&quot;argv&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, TCL_GLOBAL_ONLY);
<a name="l02659"></a>02659     <span class="keywordflow">for</span>(i=3-TCLSH; i&lt;argc; i++){
<a name="l02660"></a>02660       Tcl_SetVar(interp, <span class="stringliteral">&quot;argv&quot;</span>, argv[i],
<a name="l02661"></a>02661           TCL_GLOBAL_ONLY | TCL_LIST_ELEMENT | TCL_APPEND_VALUE);
<a name="l02662"></a>02662     }
<a name="l02663"></a>02663     <span class="keywordflow">if</span>( TCLSH==1 &amp;&amp; Tcl_EvalFile(interp, argv[1])!=TCL_OK ){
<a name="l02664"></a>02664       <span class="keyword">const</span> <span class="keywordtype">char</span> *zInfo = Tcl_GetVar(interp, <span class="stringliteral">&quot;errorInfo&quot;</span>, TCL_GLOBAL_ONLY);
<a name="l02665"></a>02665       <span class="keywordflow">if</span>( zInfo==0 ) zInfo = interp-&gt;result;
<a name="l02666"></a>02666       fprintf(stderr,<span class="stringliteral">&quot;%s: %s\n&quot;</span>, *argv, zInfo);
<a name="l02667"></a>02667       <span class="keywordflow">return</span> 1;
<a name="l02668"></a>02668     }
<a name="l02669"></a>02669   }
<a name="l02670"></a>02670   <span class="keywordflow">if</span>( argc&lt;=1 || TCLSH==2 ){
<a name="l02671"></a>02671     Tcl_GlobalEval(interp, zMainloop);
<a name="l02672"></a>02672   }
<a name="l02673"></a>02673   <span class="keywordflow">return</span> 0;
<a name="l02674"></a>02674 }
<a name="l02675"></a>02675 <span class="preprocessor">#endif </span><span class="comment">/* TCLSH */</span>
</pre></div></div>
<hr size="1">

<p style="text-align: right;">
  <a href="http://www.contextlogger.org/">ContextLogger2</a>&#8212;ContextLogger2 Logger Daemon Internals&#8212;<small>Generated on Mon May 2 13:49:56 2011 by&nbsp;<a href="http://www.doxygen.org/">Doxygen</a> 1.6.1</small>
</p>

</body>
</html>
