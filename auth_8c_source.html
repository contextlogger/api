<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ContextLogger2 Logger Daemon Internals: auth.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_53e7feede50ae4cb655a635f658a2b4e.html">sqlite3h</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_a0c08fff43b69094a2511677d8587129.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_05c6b5177aad09a72e8ee1adc608dac0.html">sqlite3</a>
  </div>
</div>
<div class="contents">
<h1>auth.c</h1><a href="auth_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">** 2003 January 11</span>
<a name="l00003"></a>00003 <span class="comment">**</span>
<a name="l00004"></a>00004 <span class="comment">** The author disclaims copyright to this source code.  In place of</span>
<a name="l00005"></a>00005 <span class="comment">** a legal notice, here is a blessing:</span>
<a name="l00006"></a>00006 <span class="comment">**</span>
<a name="l00007"></a>00007 <span class="comment">**    May you do good and not evil.</span>
<a name="l00008"></a>00008 <span class="comment">**    May you find forgiveness for yourself and forgive others.</span>
<a name="l00009"></a>00009 <span class="comment">**    May you share freely, never taking more than you give.</span>
<a name="l00010"></a>00010 <span class="comment">**</span>
<a name="l00011"></a>00011 <span class="comment">*************************************************************************</span>
<a name="l00012"></a>00012 <span class="comment">** This file contains code used to implement the sqlite3_set_authorizer()</span>
<a name="l00013"></a>00013 <span class="comment">** API.  This facility is an optional feature of the library.  Embedded</span>
<a name="l00014"></a>00014 <span class="comment">** systems that do not need this facility may omit it by recompiling</span>
<a name="l00015"></a>00015 <span class="comment">** the library with -DSQLITE_OMIT_AUTHORIZATION=1</span>
<a name="l00016"></a>00016 <span class="comment">**</span>
<a name="l00017"></a>00017 <span class="comment">** $Id: auth.c,v 1.29 2007/09/18 15:55:07 drh Exp $</span>
<a name="l00018"></a>00018 <span class="comment">*/</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="sqliteInt_8h.html">sqliteInt.h</a>&quot;</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="comment">/*</span>
<a name="l00022"></a>00022 <span class="comment">** All of the code in this file may be omitted by defining a single</span>
<a name="l00023"></a>00023 <span class="comment">** macro.</span>
<a name="l00024"></a>00024 <span class="comment">*/</span>
<a name="l00025"></a>00025 <span class="preprocessor">#ifndef SQLITE_OMIT_AUTHORIZATION</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span>
<a name="l00027"></a>00027 <span class="comment">/*</span>
<a name="l00028"></a>00028 <span class="comment">** Set or clear the access authorization function.</span>
<a name="l00029"></a>00029 <span class="comment">**</span>
<a name="l00030"></a>00030 <span class="comment">** The access authorization function is be called during the compilation</span>
<a name="l00031"></a>00031 <span class="comment">** phase to verify that the user has read and/or write access permission on</span>
<a name="l00032"></a>00032 <span class="comment">** various fields of the database.  The first argument to the auth function</span>
<a name="l00033"></a>00033 <span class="comment">** is a copy of the 3rd argument to this routine.  The second argument</span>
<a name="l00034"></a>00034 <span class="comment">** to the auth function is one of these constants:</span>
<a name="l00035"></a>00035 <span class="comment">**</span>
<a name="l00036"></a>00036 <span class="comment">**       SQLITE_CREATE_INDEX</span>
<a name="l00037"></a>00037 <span class="comment">**       SQLITE_CREATE_TABLE</span>
<a name="l00038"></a>00038 <span class="comment">**       SQLITE_CREATE_TEMP_INDEX</span>
<a name="l00039"></a>00039 <span class="comment">**       SQLITE_CREATE_TEMP_TABLE</span>
<a name="l00040"></a>00040 <span class="comment">**       SQLITE_CREATE_TEMP_TRIGGER</span>
<a name="l00041"></a>00041 <span class="comment">**       SQLITE_CREATE_TEMP_VIEW</span>
<a name="l00042"></a>00042 <span class="comment">**       SQLITE_CREATE_TRIGGER</span>
<a name="l00043"></a>00043 <span class="comment">**       SQLITE_CREATE_VIEW</span>
<a name="l00044"></a>00044 <span class="comment">**       SQLITE_DELETE</span>
<a name="l00045"></a>00045 <span class="comment">**       SQLITE_DROP_INDEX</span>
<a name="l00046"></a>00046 <span class="comment">**       SQLITE_DROP_TABLE</span>
<a name="l00047"></a>00047 <span class="comment">**       SQLITE_DROP_TEMP_INDEX</span>
<a name="l00048"></a>00048 <span class="comment">**       SQLITE_DROP_TEMP_TABLE</span>
<a name="l00049"></a>00049 <span class="comment">**       SQLITE_DROP_TEMP_TRIGGER</span>
<a name="l00050"></a>00050 <span class="comment">**       SQLITE_DROP_TEMP_VIEW</span>
<a name="l00051"></a>00051 <span class="comment">**       SQLITE_DROP_TRIGGER</span>
<a name="l00052"></a>00052 <span class="comment">**       SQLITE_DROP_VIEW</span>
<a name="l00053"></a>00053 <span class="comment">**       SQLITE_INSERT</span>
<a name="l00054"></a>00054 <span class="comment">**       SQLITE_PRAGMA</span>
<a name="l00055"></a>00055 <span class="comment">**       SQLITE_READ</span>
<a name="l00056"></a>00056 <span class="comment">**       SQLITE_SELECT</span>
<a name="l00057"></a>00057 <span class="comment">**       SQLITE_TRANSACTION</span>
<a name="l00058"></a>00058 <span class="comment">**       SQLITE_UPDATE</span>
<a name="l00059"></a>00059 <span class="comment">**</span>
<a name="l00060"></a>00060 <span class="comment">** The third and fourth arguments to the auth function are the name of</span>
<a name="l00061"></a>00061 <span class="comment">** the table and the column that are being accessed.  The auth function</span>
<a name="l00062"></a>00062 <span class="comment">** should return either SQLITE_OK, SQLITE_DENY, or SQLITE_IGNORE.  If</span>
<a name="l00063"></a>00063 <span class="comment">** SQLITE_OK is returned, it means that access is allowed.  SQLITE_DENY</span>
<a name="l00064"></a>00064 <span class="comment">** means that the SQL statement will never-run - the sqlite3_exec() call</span>
<a name="l00065"></a>00065 <span class="comment">** will return with an error.  SQLITE_IGNORE means that the SQL statement</span>
<a name="l00066"></a>00066 <span class="comment">** should run but attempts to read the specified column will return NULL</span>
<a name="l00067"></a>00067 <span class="comment">** and attempts to write the column will be ignored.</span>
<a name="l00068"></a>00068 <span class="comment">**</span>
<a name="l00069"></a>00069 <span class="comment">** Setting the auth function to NULL disables this hook.  The default</span>
<a name="l00070"></a>00070 <span class="comment">** setting of the auth function is NULL.</span>
<a name="l00071"></a>00071 <span class="comment">*/</span>
<a name="l00072"></a><a class="code" href="sqlite3_8h.html#abd8b56491f13d4ca8f155a7c4854e970">00072</a> <span class="keywordtype">int</span> <a class="code" href="auth_8c.html#a4777b652e17be2d2c2ad64a2ea8eb735">sqlite3_set_authorizer</a>(
<a name="l00073"></a>00073   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a>,
<a name="l00074"></a>00074   <span class="keywordtype">int</span> (*xAuth)(<span class="keywordtype">void</span>*,<span class="keywordtype">int</span>,<span class="keyword">const</span> <span class="keywordtype">char</span>*,<span class="keyword">const</span> <span class="keywordtype">char</span>*,<span class="keyword">const</span> <span class="keywordtype">char</span>*,<span class="keyword">const</span> <span class="keywordtype">char</span>*),
<a name="l00075"></a>00075   <span class="keywordtype">void</span> *pArg
<a name="l00076"></a>00076 ){
<a name="l00077"></a>00077   <a class="code" href="mutex_8h.html#afbab5dc0108b65678f2fa579473041ac">sqlite3_mutex_enter</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>);
<a name="l00078"></a>00078   db-&gt;<a class="code" href="structsqlite3.html#a7eb4472cad41b37417fcc6d2cc0561fa">xAuth</a> = xAuth;
<a name="l00079"></a>00079   db-&gt;<a class="code" href="structsqlite3.html#a1c50e81c5e4a6e1faeea93489accd53f">pAuthArg</a> = pArg;
<a name="l00080"></a>00080   <a class="code" href="sqliteInt_8h.html#ac49dbebed4f062b16e866f024c262e95">sqlite3ExpirePreparedStatements</a>(db);
<a name="l00081"></a>00081   <a class="code" href="mutex_8h.html#aba06556afc1a17868af4675ba856701c">sqlite3_mutex_leave</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>);
<a name="l00082"></a>00082   <span class="keywordflow">return</span> <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00083"></a>00083 }
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="comment">/*</span>
<a name="l00086"></a>00086 <span class="comment">** Write an error message into pParse-&gt;zErrMsg that explains that the</span>
<a name="l00087"></a>00087 <span class="comment">** user-supplied authorization function returned an illegal value.</span>
<a name="l00088"></a>00088 <span class="comment">*/</span>
<a name="l00089"></a><a class="code" href="auth_8c.html#ad9779fdebf1cdc5dea568637873bbdff">00089</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="auth_8c.html#ad9779fdebf1cdc5dea568637873bbdff">sqliteAuthBadReturnCode</a>(<a class="code" href="structParse.html">Parse</a> *pParse, <span class="keywordtype">int</span> rc){
<a name="l00090"></a>00090   <a class="code" href="sqliteInt_8h.html#af5069bb768199c3dab949999e7e6e19c">sqlite3ErrorMsg</a>(pParse, <span class="stringliteral">&quot;illegal return value (%d) from the &quot;</span>
<a name="l00091"></a>00091     <span class="stringliteral">&quot;authorization function - should be SQLITE_OK, SQLITE_IGNORE, &quot;</span>
<a name="l00092"></a>00092     <span class="stringliteral">&quot;or SQLITE_DENY&quot;</span>, rc);
<a name="l00093"></a>00093   pParse-&gt;<a class="code" href="structParse.html#a897c2ea40a1065d49a134f18ca251637">rc</a> = <a class="code" href="sqlite3_8h.html#afda25cd6575e87558d2b7cd4a6585f2f">SQLITE_ERROR</a>;
<a name="l00094"></a>00094 }
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="comment">/*</span>
<a name="l00097"></a>00097 <span class="comment">** The pExpr should be a TK_COLUMN expression.  The table referred to</span>
<a name="l00098"></a>00098 <span class="comment">** is in pTabList or else it is the NEW or OLD table of a trigger.  </span>
<a name="l00099"></a>00099 <span class="comment">** Check to see if it is OK to read this particular column.</span>
<a name="l00100"></a>00100 <span class="comment">**</span>
<a name="l00101"></a>00101 <span class="comment">** If the auth function returns SQLITE_IGNORE, change the TK_COLUMN </span>
<a name="l00102"></a>00102 <span class="comment">** instruction into a TK_NULL.  If the auth function returns SQLITE_DENY,</span>
<a name="l00103"></a>00103 <span class="comment">** then generate an error.</span>
<a name="l00104"></a>00104 <span class="comment">*/</span>
<a name="l00105"></a><a class="code" href="sqliteInt_8h.html#af101d70ce83931c3d91f88e9f1c9fb56">00105</a> <span class="keywordtype">void</span> <a class="code" href="auth_8c.html#a1a9b6da6d50ebd2c7d3d0157a7f4b8dc">sqlite3AuthRead</a>(
<a name="l00106"></a>00106   <a class="code" href="structParse.html">Parse</a> *pParse,        <span class="comment">/* The parser context */</span>
<a name="l00107"></a>00107   <a class="code" href="structExpr.html">Expr</a> *pExpr,          <span class="comment">/* The expression to check authorization on */</span>
<a name="l00108"></a>00108   <a class="code" href="structSchema.html">Schema</a> *pSchema,      <span class="comment">/* The schema of the expression */</span>
<a name="l00109"></a>00109   <a class="code" href="structSrcList.html">SrcList</a> *pTabList     <span class="comment">/* All table that pExpr might refer to */</span>
<a name="l00110"></a>00110 ){
<a name="l00111"></a>00111   <a class="code" href="structsqlite3.html">sqlite3</a> *db = pParse-&gt;<a class="code" href="structParse.html#a44364e5e1197927f89864ec345bc5491">db</a>;
<a name="l00112"></a>00112   <span class="keywordtype">int</span> rc;
<a name="l00113"></a>00113   <a class="code" href="structTable.html">Table</a> *pTab = 0;      <span class="comment">/* The table being read */</span>
<a name="l00114"></a>00114   <span class="keyword">const</span> <span class="keywordtype">char</span> *zCol;     <span class="comment">/* Name of the column of the table */</span>
<a name="l00115"></a>00115   <span class="keywordtype">int</span> iSrc;             <span class="comment">/* Index in pTabList-&gt;a[] of table being read */</span>
<a name="l00116"></a>00116   <span class="keyword">const</span> <span class="keywordtype">char</span> *zDBase;   <span class="comment">/* Name of database being accessed */</span>
<a name="l00117"></a>00117   <a class="code" href="structTriggerStack.html">TriggerStack</a> *pStack; <span class="comment">/* The stack of current triggers */</span>
<a name="l00118"></a>00118   <span class="keywordtype">int</span> iDb;              <span class="comment">/* The index of the database the expression refers to */</span>
<a name="l00119"></a>00119 
<a name="l00120"></a>00120   <span class="keywordflow">if</span>( db-&gt;<a class="code" href="structsqlite3.html#a7eb4472cad41b37417fcc6d2cc0561fa">xAuth</a>==0 ) <span class="keywordflow">return</span>;
<a name="l00121"></a>00121   <span class="keywordflow">if</span>( pExpr-&gt;<a class="code" href="structExpr.html#a101c55ddb6c149d95f0327831eb78225">op</a>!=<a class="code" href="parse_8h.html#aa9797d74ed12e3d684448443027d1167">TK_COLUMN</a> ) <span class="keywordflow">return</span>;
<a name="l00122"></a>00122   iDb = <a class="code" href="prepare_8c.html#aecd8922611e561d76d5e9f16655e8a7c">sqlite3SchemaToIndex</a>(pParse-&gt;<a class="code" href="structParse.html#a44364e5e1197927f89864ec345bc5491">db</a>, pSchema);
<a name="l00123"></a>00123   <span class="keywordflow">if</span>( iDb&lt;0 ){
<a name="l00124"></a>00124     <span class="comment">/* An attempt to read a column out of a subquery or other</span>
<a name="l00125"></a>00125 <span class="comment">    ** temporary table. */</span>
<a name="l00126"></a>00126     <span class="keywordflow">return</span>;
<a name="l00127"></a>00127   }
<a name="l00128"></a>00128   <span class="keywordflow">for</span>(iSrc=0; pTabList &amp;&amp; iSrc&lt;pTabList-&gt;<a class="code" href="structSrcList.html#a99c1d923c49fc0598d92f1cb54958ef4">nSrc</a>; iSrc++){
<a name="l00129"></a>00129     <span class="keywordflow">if</span>( pExpr-&gt;<a class="code" href="structExpr.html#af8e273f4d7d173bfb5996ed09054611c">iTable</a>==pTabList-&gt;<a class="code" href="structSrcList.html#acd181938f7144b40022b28072247aa3d">a</a>[iSrc].<a class="code" href="structSrcList_1_1SrcList__item.html#af2e8aae90bd7a00b814db5a2d31f6607">iCursor</a> ) <span class="keywordflow">break</span>;
<a name="l00130"></a>00130   }
<a name="l00131"></a>00131   <span class="keywordflow">if</span>( iSrc&gt;=0 &amp;&amp; pTabList &amp;&amp; iSrc&lt;pTabList-&gt;nSrc ){
<a name="l00132"></a>00132     pTab = pTabList-&gt;<a class="code" href="structSrcList.html#acd181938f7144b40022b28072247aa3d">a</a>[iSrc].<a class="code" href="structSrcList_1_1SrcList__item.html#a8779b2d10d0e25af78ad90e57f9cd4f6">pTab</a>;
<a name="l00133"></a>00133   }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( (pStack = pParse-&gt;<a class="code" href="structParse.html#a1ae8776978de122f725acd37784522ed">trigStack</a>)!=0 ){
<a name="l00134"></a>00134     <span class="comment">/* This must be an attempt to read the NEW or OLD pseudo-tables</span>
<a name="l00135"></a>00135 <span class="comment">    ** of a trigger.</span>
<a name="l00136"></a>00136 <span class="comment">    */</span>
<a name="l00137"></a>00137     assert( pExpr-&gt;<a class="code" href="structExpr.html#af8e273f4d7d173bfb5996ed09054611c">iTable</a>==pStack-&gt;<a class="code" href="structTriggerStack.html#aaa2f7172de0450219e6ee99864a030bb">newIdx</a> || pExpr-&gt;<a class="code" href="structExpr.html#af8e273f4d7d173bfb5996ed09054611c">iTable</a>==pStack-&gt;<a class="code" href="structTriggerStack.html#a6499348b4eebb46d7d335881964adb68">oldIdx</a> );
<a name="l00138"></a>00138     pTab = pStack-&gt;<a class="code" href="structTriggerStack.html#a3ba86bbbdd3780f8a1df171643c03819">pTab</a>;
<a name="l00139"></a>00139   }
<a name="l00140"></a>00140   <span class="keywordflow">if</span>( pTab==0 ) <span class="keywordflow">return</span>;
<a name="l00141"></a>00141   <span class="keywordflow">if</span>( pExpr-&gt;<a class="code" href="structExpr.html#ad4f6ca9306015f5b6b608bda7baedc9e">iColumn</a>&gt;=0 ){
<a name="l00142"></a>00142     assert( pExpr-&gt;<a class="code" href="structExpr.html#ad4f6ca9306015f5b6b608bda7baedc9e">iColumn</a>&lt;pTab-&gt;<a class="code" href="structTable.html#a2b3925b85368f0367322ab66bf289163">nCol</a> );
<a name="l00143"></a>00143     zCol = pTab-&gt;<a class="code" href="structTable.html#a87ec3b706ecf9545bd9ed582a12ce3e7">aCol</a>[pExpr-&gt;<a class="code" href="structExpr.html#ad4f6ca9306015f5b6b608bda7baedc9e">iColumn</a>].<a class="code" href="structColumn.html#a6450a4e9fde68b3a2d79425d826eccc3">zName</a>;
<a name="l00144"></a>00144   }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( pTab-&gt;<a class="code" href="structTable.html#ab6c8b60da43ccc8a2e2b5b65cc74058f">iPKey</a>&gt;=0 ){
<a name="l00145"></a>00145     assert( pTab-&gt;<a class="code" href="structTable.html#ab6c8b60da43ccc8a2e2b5b65cc74058f">iPKey</a>&lt;pTab-&gt;<a class="code" href="structTable.html#a2b3925b85368f0367322ab66bf289163">nCol</a> );
<a name="l00146"></a>00146     zCol = pTab-&gt;<a class="code" href="structTable.html#a87ec3b706ecf9545bd9ed582a12ce3e7">aCol</a>[pTab-&gt;<a class="code" href="structTable.html#ab6c8b60da43ccc8a2e2b5b65cc74058f">iPKey</a>].<a class="code" href="structColumn.html#a6450a4e9fde68b3a2d79425d826eccc3">zName</a>;
<a name="l00147"></a>00147   }<span class="keywordflow">else</span>{
<a name="l00148"></a>00148     zCol = <span class="stringliteral">&quot;ROWID&quot;</span>;
<a name="l00149"></a>00149   }
<a name="l00150"></a>00150   assert( iDb&gt;=0 &amp;&amp; iDb&lt;db-&gt;nDb );
<a name="l00151"></a>00151   zDBase = db-&gt;<a class="code" href="structsqlite3.html#a0abe1dccdea5f43e6c49360b42749697">aDb</a>[iDb].<a class="code" href="structDb.html#a6df2b5d7c8fd68e92cea961d9e3b279b">zName</a>;
<a name="l00152"></a>00152   rc = db-&gt;<a class="code" href="structsqlite3.html#a7eb4472cad41b37417fcc6d2cc0561fa">xAuth</a>(db-&gt;<a class="code" href="structsqlite3.html#a1c50e81c5e4a6e1faeea93489accd53f">pAuthArg</a>, <a class="code" href="sqlite3_8h.html#a3f1a55857de47148723f789496f8731b">SQLITE_READ</a>, pTab-&gt;<a class="code" href="structTable.html#a20ca62607d6da596b1016b76cf677809">zName</a>, zCol, zDBase, 
<a name="l00153"></a>00153                  pParse-&gt;<a class="code" href="structParse.html#a12c6e2fb69848bcc57169d44993c351f">zAuthContext</a>);
<a name="l00154"></a>00154   <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#a5148e80e8b93241486549be6842ecb7b">SQLITE_IGNORE</a> ){
<a name="l00155"></a>00155     pExpr-&gt;<a class="code" href="structExpr.html#a101c55ddb6c149d95f0327831eb78225">op</a> = <a class="code" href="parse_8h.html#a46eb52a90a0a11358d9d6cfba8430ee2">TK_NULL</a>;
<a name="l00156"></a>00156   }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#aac54c702b6175785e3300e9172b5f9bb">SQLITE_DENY</a> ){
<a name="l00157"></a>00157     <span class="keywordflow">if</span>( db-&gt;<a class="code" href="structsqlite3.html#a03d047bc289999b0e39d8637f0762489">nDb</a>&gt;2 || iDb!=0 ){
<a name="l00158"></a>00158       <a class="code" href="sqliteInt_8h.html#af5069bb768199c3dab949999e7e6e19c">sqlite3ErrorMsg</a>(pParse, <span class="stringliteral">&quot;access to %s.%s.%s is prohibited&quot;</span>, 
<a name="l00159"></a>00159          zDBase, pTab-&gt;<a class="code" href="structTable.html#a20ca62607d6da596b1016b76cf677809">zName</a>, zCol);
<a name="l00160"></a>00160     }<span class="keywordflow">else</span>{
<a name="l00161"></a>00161       <a class="code" href="sqliteInt_8h.html#af5069bb768199c3dab949999e7e6e19c">sqlite3ErrorMsg</a>(pParse, <span class="stringliteral">&quot;access to %s.%s is prohibited&quot;</span>,pTab-&gt;<a class="code" href="structTable.html#a20ca62607d6da596b1016b76cf677809">zName</a>,zCol);
<a name="l00162"></a>00162     }
<a name="l00163"></a>00163     pParse-&gt;<a class="code" href="structParse.html#a897c2ea40a1065d49a134f18ca251637">rc</a> = <a class="code" href="sqlite3_8h.html#ab4954b805784b958300b203fda451283">SQLITE_AUTH</a>;
<a name="l00164"></a>00164   }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( rc!=<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> ){
<a name="l00165"></a>00165     <a class="code" href="auth_8c.html#ad9779fdebf1cdc5dea568637873bbdff">sqliteAuthBadReturnCode</a>(pParse, rc);
<a name="l00166"></a>00166   }
<a name="l00167"></a>00167 }
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 <span class="comment">/*</span>
<a name="l00170"></a>00170 <span class="comment">** Do an authorization check using the code and arguments given.  Return</span>
<a name="l00171"></a>00171 <span class="comment">** either SQLITE_OK (zero) or SQLITE_IGNORE or SQLITE_DENY.  If SQLITE_DENY</span>
<a name="l00172"></a>00172 <span class="comment">** is returned, then the error count and error message in pParse are</span>
<a name="l00173"></a>00173 <span class="comment">** modified appropriately.</span>
<a name="l00174"></a>00174 <span class="comment">*/</span>
<a name="l00175"></a><a class="code" href="sqliteInt_8h.html#a152bd95b2aaa56e54b54d2d6de15fbbf">00175</a> <span class="keywordtype">int</span> <a class="code" href="auth_8c.html#a7c993bc216f5c07cf032f3123167d658">sqlite3AuthCheck</a>(
<a name="l00176"></a>00176   <a class="code" href="structParse.html">Parse</a> *pParse,
<a name="l00177"></a>00177   <span class="keywordtype">int</span> code,
<a name="l00178"></a>00178   <span class="keyword">const</span> <span class="keywordtype">char</span> *zArg1,
<a name="l00179"></a>00179   <span class="keyword">const</span> <span class="keywordtype">char</span> *zArg2,
<a name="l00180"></a>00180   <span class="keyword">const</span> <span class="keywordtype">char</span> *zArg3
<a name="l00181"></a>00181 ){
<a name="l00182"></a>00182   <a class="code" href="structsqlite3.html">sqlite3</a> *db = pParse-&gt;<a class="code" href="structParse.html#a44364e5e1197927f89864ec345bc5491">db</a>;
<a name="l00183"></a>00183   <span class="keywordtype">int</span> rc;
<a name="l00184"></a>00184 
<a name="l00185"></a>00185   <span class="comment">/* Don&apos;t do any authorization checks if the database is initialising</span>
<a name="l00186"></a>00186 <span class="comment">  ** or if the parser is being invoked from within sqlite3_declare_vtab.</span>
<a name="l00187"></a>00187 <span class="comment">  */</span>
<a name="l00188"></a>00188   <span class="keywordflow">if</span>( db-&gt;<a class="code" href="structsqlite3.html#a14bb7fbfa6b662021069fcdf6b334d70">init</a>.<a class="code" href="structsqlite3_1_1sqlite3InitInfo.html#a6ac01842e0ae68023cb60fea93bd8688">busy</a> || <a class="code" href="sqliteInt_8h.html#aa2b209cc5834d5f703df3c53ecf9767d">IN_DECLARE_VTAB</a> ){
<a name="l00189"></a>00189     <span class="keywordflow">return</span> <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00190"></a>00190   }
<a name="l00191"></a>00191 
<a name="l00192"></a>00192   <span class="keywordflow">if</span>( db-&gt;<a class="code" href="structsqlite3.html#a7eb4472cad41b37417fcc6d2cc0561fa">xAuth</a>==0 ){
<a name="l00193"></a>00193     <span class="keywordflow">return</span> <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00194"></a>00194   }
<a name="l00195"></a>00195   rc = db-&gt;<a class="code" href="structsqlite3.html#a7eb4472cad41b37417fcc6d2cc0561fa">xAuth</a>(db-&gt;<a class="code" href="structsqlite3.html#a1c50e81c5e4a6e1faeea93489accd53f">pAuthArg</a>, code, zArg1, zArg2, zArg3, pParse-&gt;<a class="code" href="structParse.html#a12c6e2fb69848bcc57169d44993c351f">zAuthContext</a>);
<a name="l00196"></a>00196   <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#aac54c702b6175785e3300e9172b5f9bb">SQLITE_DENY</a> ){
<a name="l00197"></a>00197     <a class="code" href="sqliteInt_8h.html#af5069bb768199c3dab949999e7e6e19c">sqlite3ErrorMsg</a>(pParse, <span class="stringliteral">&quot;not authorized&quot;</span>);
<a name="l00198"></a>00198     pParse-&gt;<a class="code" href="structParse.html#a897c2ea40a1065d49a134f18ca251637">rc</a> = <a class="code" href="sqlite3_8h.html#ab4954b805784b958300b203fda451283">SQLITE_AUTH</a>;
<a name="l00199"></a>00199   }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( rc!=<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> &amp;&amp; rc!=<a class="code" href="sqlite3_8h.html#a5148e80e8b93241486549be6842ecb7b">SQLITE_IGNORE</a> ){
<a name="l00200"></a>00200     rc = <a class="code" href="sqlite3_8h.html#aac54c702b6175785e3300e9172b5f9bb">SQLITE_DENY</a>;
<a name="l00201"></a>00201     <a class="code" href="auth_8c.html#ad9779fdebf1cdc5dea568637873bbdff">sqliteAuthBadReturnCode</a>(pParse, rc);
<a name="l00202"></a>00202   }
<a name="l00203"></a>00203   <span class="keywordflow">return</span> rc;
<a name="l00204"></a>00204 }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206 <span class="comment">/*</span>
<a name="l00207"></a>00207 <span class="comment">** Push an authorization context.  After this routine is called, the</span>
<a name="l00208"></a>00208 <span class="comment">** zArg3 argument to authorization callbacks will be zContext until</span>
<a name="l00209"></a>00209 <span class="comment">** popped.  Or if pParse==0, this routine is a no-op.</span>
<a name="l00210"></a>00210 <span class="comment">*/</span>
<a name="l00211"></a><a class="code" href="sqliteInt_8h.html#a85bc28c7299f690eb0a6809518451437">00211</a> <span class="keywordtype">void</span> <a class="code" href="auth_8c.html#a576bbfae0c3aa52e4ff82e9c684d256b">sqlite3AuthContextPush</a>(
<a name="l00212"></a>00212   <a class="code" href="structParse.html">Parse</a> *pParse,
<a name="l00213"></a>00213   <a class="code" href="structAuthContext.html">AuthContext</a> *pContext, 
<a name="l00214"></a>00214   <span class="keyword">const</span> <span class="keywordtype">char</span> *zContext
<a name="l00215"></a>00215 ){
<a name="l00216"></a>00216   pContext-&gt;<a class="code" href="structAuthContext.html#a8df2931d8f4facf59073c92315b00bfa">pParse</a> = pParse;
<a name="l00217"></a>00217   <span class="keywordflow">if</span>( pParse ){
<a name="l00218"></a>00218     pContext-&gt;<a class="code" href="structAuthContext.html#a1b095b152b72326476ac3f7edcaee78a">zAuthContext</a> = pParse-&gt;<a class="code" href="structParse.html#a12c6e2fb69848bcc57169d44993c351f">zAuthContext</a>;
<a name="l00219"></a>00219     pParse-&gt;<a class="code" href="structParse.html#a12c6e2fb69848bcc57169d44993c351f">zAuthContext</a> = zContext;
<a name="l00220"></a>00220   }
<a name="l00221"></a>00221 }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 <span class="comment">/*</span>
<a name="l00224"></a>00224 <span class="comment">** Pop an authorization context that was previously pushed</span>
<a name="l00225"></a>00225 <span class="comment">** by sqlite3AuthContextPush</span>
<a name="l00226"></a>00226 <span class="comment">*/</span>
<a name="l00227"></a><a class="code" href="sqliteInt_8h.html#a261811be34fa71ddea91c6a226e63ee9">00227</a> <span class="keywordtype">void</span> <a class="code" href="auth_8c.html#ad5affaa3a39509a85cc03e0e946b5a05">sqlite3AuthContextPop</a>(<a class="code" href="structAuthContext.html">AuthContext</a> *pContext){
<a name="l00228"></a>00228   <span class="keywordflow">if</span>( pContext-&gt;<a class="code" href="structAuthContext.html#a8df2931d8f4facf59073c92315b00bfa">pParse</a> ){
<a name="l00229"></a>00229     pContext-&gt;<a class="code" href="structAuthContext.html#a8df2931d8f4facf59073c92315b00bfa">pParse</a>-&gt;<a class="code" href="structParse.html#a12c6e2fb69848bcc57169d44993c351f">zAuthContext</a> = pContext-&gt;<a class="code" href="structAuthContext.html#a1b095b152b72326476ac3f7edcaee78a">zAuthContext</a>;
<a name="l00230"></a>00230     pContext-&gt;<a class="code" href="structAuthContext.html#a8df2931d8f4facf59073c92315b00bfa">pParse</a> = 0;
<a name="l00231"></a>00231   }
<a name="l00232"></a>00232 }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234 <span class="preprocessor">#endif </span><span class="comment">/* SQLITE_OMIT_AUTHORIZATION */</span>
</pre></div></div>
<hr size="1">

<p style="text-align: right;">
  <a href="http://www.contextlogger.org/">ContextLogger2</a>&#8212;ContextLogger2 Logger Daemon Internals&#8212;<small>Generated on Mon May 2 13:49:51 2011 by&nbsp;<a href="http://www.doxygen.org/">Doxygen</a> 1.6.1</small>
</p>

</body>
</html>
