<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ContextLogger2 Logger Daemon Internals: lgc.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_0a42b8d7a42fdff37378486477d8f5e0.html">lua</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_3536dc5472cf8658af6f2f3c074e6fb2.html">src</a>
  </div>
</div>
<div class="contents">
<h1>lgc.c</h1><a href="lgc_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">** $Id: lgc.c,v 2.38.1.1 2007/12/27 13:02:25 roberto Exp $</span>
<a name="l00003"></a>00003 <span class="comment">** Garbage Collector</span>
<a name="l00004"></a>00004 <span class="comment">** See Copyright Notice in lua.h</span>
<a name="l00005"></a>00005 <span class="comment">*/</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00008"></a>00008 
<a name="l00009"></a><a class="code" href="lgc_8c.html#a61d084c4959fdcc23103ae67105b3472">00009</a> <span class="preprocessor">#define lgc_c</span>
<a name="l00010"></a><a class="code" href="lgc_8c.html#abf0b3947b59218777a8e928a10be205b">00010</a> <span class="preprocessor"></span><span class="preprocessor">#define LUA_CORE</span>
<a name="l00011"></a>00011 <span class="preprocessor"></span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="lua_8h.html">lua.h</a>&quot;</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="ldebug_8h.html">ldebug.h</a>&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="ldo_8h.html">ldo.h</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="lfunc_8h.html">lfunc.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="lgc_8h.html">lgc.h</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="lmem_8h.html">lmem.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="lobject_8h.html">lobject.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="lstate_8h.html">lstate.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="lstring_8h.html">lstring.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="ltable_8h.html">ltable.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="ltm_8h.html">ltm.h</a>&quot;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 
<a name="l00026"></a><a class="code" href="lgc_8c.html#aeb6367d26a4bde87314453841fc5b80c">00026</a> <span class="preprocessor">#define GCSTEPSIZE  1024u</span>
<a name="l00027"></a><a class="code" href="lgc_8c.html#ac31abb557425090d41f055c797049ba8">00027</a> <span class="preprocessor"></span><span class="preprocessor">#define GCSWEEPMAX  40</span>
<a name="l00028"></a><a class="code" href="lgc_8c.html#ac6240a70277f6388ab6795b7dc30cb1c">00028</a> <span class="preprocessor"></span><span class="preprocessor">#define GCSWEEPCOST 10</span>
<a name="l00029"></a><a class="code" href="lgc_8c.html#a84dfd5e385ed6792c171df6b6a972179">00029</a> <span class="preprocessor"></span><span class="preprocessor">#define GCFINALIZECOST  100</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span>
<a name="l00031"></a>00031 
<a name="l00032"></a><a class="code" href="lgc_8c.html#abcd0f3f515cda3ec0ca62941f0c7ad3e">00032</a> <span class="preprocessor">#define maskmarks cast_byte(~(bitmask(BLACKBIT)|WHITEBITS))</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span>
<a name="l00034"></a><a class="code" href="lgc_8c.html#ada061b1d508c516b2e53f546521b3eeb">00034</a> <span class="preprocessor">#define makewhite(g,x)  \</span>
<a name="l00035"></a>00035 <span class="preprocessor">   ((x)-&gt;gch.marked = cast_byte(((x)-&gt;gch.marked &amp; maskmarks) | luaC_white(g)))</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span>
<a name="l00037"></a><a class="code" href="lgc_8c.html#aa598e08eb28253fce9f1ebec51a6a739">00037</a> <span class="preprocessor">#define white2gray(x) reset2bits((x)-&gt;gch.marked, WHITE0BIT, WHITE1BIT)</span>
<a name="l00038"></a><a class="code" href="lgc_8c.html#a9490dca59c8a4d659ff7522257943f63">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define black2gray(x) resetbit((x)-&gt;gch.marked, BLACKBIT)</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span>
<a name="l00040"></a><a class="code" href="lgc_8c.html#a220f3c1132e8df620410ed6de1a75b49">00040</a> <span class="preprocessor">#define stringmark(s) reset2bits((s)-&gt;tsv.marked, WHITE0BIT, WHITE1BIT)</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>
<a name="l00042"></a>00042 
<a name="l00043"></a><a class="code" href="lgc_8c.html#a14e1f262784acec7fb2c97cae1e241a2">00043</a> <span class="preprocessor">#define isfinalized(u)    testbit((u)-&gt;marked, FINALIZEDBIT)</span>
<a name="l00044"></a><a class="code" href="lgc_8c.html#a27a77307b90dae514183dc73279ba46b">00044</a> <span class="preprocessor"></span><span class="preprocessor">#define markfinalized(u)  l_setbit((u)-&gt;marked, FINALIZEDBIT)</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>
<a name="l00046"></a>00046 
<a name="l00047"></a><a class="code" href="lgc_8c.html#ac92cf2e20106bb0a9b68e0cdb74b286b">00047</a> <span class="preprocessor">#define KEYWEAK         bitmask(KEYWEAKBIT)</span>
<a name="l00048"></a><a class="code" href="lgc_8c.html#acd04fc135b64ac6efe5ba024efa5d8f1">00048</a> <span class="preprocessor"></span><span class="preprocessor">#define VALUEWEAK       bitmask(VALUEWEAKBIT)</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 
<a name="l00052"></a><a class="code" href="lgc_8c.html#a2dd4136ac29665568973c074bc450849">00052</a> <span class="preprocessor">#define markvalue(g,o) { checkconsistency(o); \</span>
<a name="l00053"></a>00053 <span class="preprocessor">  if (iscollectable(o) &amp;&amp; iswhite(gcvalue(o))) reallymarkobject(g,gcvalue(o)); }</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span>
<a name="l00055"></a><a class="code" href="lgc_8c.html#a6ae72c43e48b29944e55933df7f15482">00055</a> <span class="preprocessor">#define markobject(g,t) { if (iswhite(obj2gco(t))) \</span>
<a name="l00056"></a>00056 <span class="preprocessor">    reallymarkobject(g, obj2gco(t)); }</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span>
<a name="l00058"></a>00058 
<a name="l00059"></a><a class="code" href="lgc_8c.html#acfcd1e13d0ba5f0a594ac7e977c337d7">00059</a> <span class="preprocessor">#define setthreshold(g)  (g-&gt;GCthreshold = (g-&gt;estimate/100) * g-&gt;gcpause)</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span>
<a name="l00061"></a>00061 
<a name="l00062"></a><a class="code" href="lgc_8c.html#a6ed834aee205ee32cb75522c24051a67">00062</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#a6ed834aee205ee32cb75522c24051a67">removeentry</a> (<a class="code" href="structNode.html">Node</a> *n) {
<a name="l00063"></a>00063   <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(<a class="code" href="lobject_8h.html#a8630c13eaefbeaba1aa0933cab6e0238">ttisnil</a>(<a class="code" href="ltable_8h.html#acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</a>(n)));
<a name="l00064"></a>00064   <span class="keywordflow">if</span> (<a class="code" href="lobject_8h.html#aaabdb414706e6a904461e39967557185">iscollectable</a>(<a class="code" href="ltable_8h.html#ad8f233e3b7156cd470d0ac21d7b54c11">gkey</a>(n)))
<a name="l00065"></a>00065     <a class="code" href="lobject_8h.html#a2816cdd0a22f933ee0b23321b0a200b0">setttype</a>(<a class="code" href="ltable_8h.html#ad8f233e3b7156cd470d0ac21d7b54c11">gkey</a>(n), <a class="code" href="lobject_8h.html#a8626e895a2b49a9b945c96281d854fb5">LUA_TDEADKEY</a>);  <span class="comment">/* dead key; remove it */</span>
<a name="l00066"></a>00066 }
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 
<a name="l00069"></a><a class="code" href="lgc_8c.html#aacf3c8ee0eebd5d5b1cd09da000ad53c">00069</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#aacf3c8ee0eebd5d5b1cd09da000ad53c">reallymarkobject</a> (<a class="code" href="structglobal__State.html">global_State</a> *g, <a class="code" href="unionGCObject.html">GCObject</a> *o) {
<a name="l00070"></a>00070   <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(<a class="code" href="lgc_8h.html#a4c0ce78d476460d2e54914301f4a4bf7">iswhite</a>(o) &amp;&amp; !<a class="code" href="lgc_8h.html#acc409eb45f598d23d8388fc9e96189ea">isdead</a>(g, o));
<a name="l00071"></a>00071   <a class="code" href="lgc_8c.html#aa598e08eb28253fce9f1ebec51a6a739">white2gray</a>(o);
<a name="l00072"></a>00072   <span class="keywordflow">switch</span> (o-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.tt) {
<a name="l00073"></a>00073     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#a57de20d87bb5131a3159f2bd52e3fab6">LUA_TSTRING</a>: {
<a name="l00074"></a>00074       <span class="keywordflow">return</span>;
<a name="l00075"></a>00075     }
<a name="l00076"></a>00076     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#a84fd4c52cea4073671a4cd0eb7026dc7">LUA_TUSERDATA</a>: {
<a name="l00077"></a>00077       <a class="code" href="structTable.html">Table</a> *mt = <a class="code" href="lstate_8h.html#a55e9a228ad0d3a82ee9cfc353002fd8a">gco2u</a>(o)-&gt;metatable;
<a name="l00078"></a>00078       <a class="code" href="lgc_8h.html#ae909eb4aa4c23c6ee7757210c183634d">gray2black</a>(o);  <span class="comment">/* udata are never gray */</span>
<a name="l00079"></a>00079       <span class="keywordflow">if</span> (mt) <a class="code" href="lgc_8c.html#a6ae72c43e48b29944e55933df7f15482">markobject</a>(g, mt);
<a name="l00080"></a>00080       <a class="code" href="lgc_8c.html#a6ae72c43e48b29944e55933df7f15482">markobject</a>(g, <a class="code" href="lstate_8h.html#a55e9a228ad0d3a82ee9cfc353002fd8a">gco2u</a>(o)-&gt;env);
<a name="l00081"></a>00081       <span class="keywordflow">return</span>;
<a name="l00082"></a>00082     }
<a name="l00083"></a>00083     <span class="keywordflow">case</span> <a class="code" href="lobject_8h.html#a3175b6b959953f781a14a9291d9e22b6">LUA_TUPVAL</a>: {
<a name="l00084"></a>00084       <a class="code" href="structUpVal.html">UpVal</a> *uv = <a class="code" href="lstate_8h.html#adc453a25566db47b928eb9bc6f5c7cbe">gco2uv</a>(o);
<a name="l00085"></a>00085       <a class="code" href="lgc_8c.html#a2dd4136ac29665568973c074bc450849">markvalue</a>(g, uv-&gt;<a class="code" href="structUpVal.html#aeb2c6e23d98883dd7f117de69de23e54">v</a>);
<a name="l00086"></a>00086       <span class="keywordflow">if</span> (uv-&gt;<a class="code" href="structUpVal.html#aeb2c6e23d98883dd7f117de69de23e54">v</a> == &amp;uv-&gt;<a class="code" href="structUpVal.html#ad5ec24c0916396cc9c39b5f35e9a6836">u</a>.<a class="code" href="structUpVal.html#abc22d06bbcaf3f197af9c6069c562505">value</a>)  <span class="comment">/* closed? */</span>
<a name="l00087"></a>00087         <a class="code" href="lgc_8h.html#ae909eb4aa4c23c6ee7757210c183634d">gray2black</a>(o);  <span class="comment">/* open upvalues are never black */</span>
<a name="l00088"></a>00088       <span class="keywordflow">return</span>;
<a name="l00089"></a>00089     }
<a name="l00090"></a>00090     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#adaa7fa6e2561c1bc428ba8d265171494">LUA_TFUNCTION</a>: {
<a name="l00091"></a>00091       <a class="code" href="lstate_8h.html#a003658bade3405a30fe2cf7fee2f7e10">gco2cl</a>(o)-&gt;c.gclist = g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a>;
<a name="l00092"></a>00092       g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a> = o;
<a name="l00093"></a>00093       <span class="keywordflow">break</span>;
<a name="l00094"></a>00094     }
<a name="l00095"></a>00095     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#a31620fd8da5b655b7879e16a116ec31a">LUA_TTABLE</a>: {
<a name="l00096"></a>00096       <a class="code" href="lstate_8h.html#aaebbd554090bd0625aa3ec0d5309c235">gco2h</a>(o)-&gt;gclist = g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a>;
<a name="l00097"></a>00097       g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a> = o;
<a name="l00098"></a>00098       <span class="keywordflow">break</span>;
<a name="l00099"></a>00099     }
<a name="l00100"></a>00100     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#a028a8d8aae9580c465aabcd0c11334d9">LUA_TTHREAD</a>: {
<a name="l00101"></a>00101       <a class="code" href="lstate_8h.html#a52c467e11bd40cad5ca78372f7f67b4d">gco2th</a>(o)-&gt;gclist = g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a>;
<a name="l00102"></a>00102       g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a> = o;
<a name="l00103"></a>00103       <span class="keywordflow">break</span>;
<a name="l00104"></a>00104     }
<a name="l00105"></a>00105     <span class="keywordflow">case</span> <a class="code" href="lobject_8h.html#aa2a683d9e42dac5846eefa108297cbf0">LUA_TPROTO</a>: {
<a name="l00106"></a>00106       <a class="code" href="lstate_8h.html#a8792af5dd4539a71f6ed8ddb31d079c3">gco2p</a>(o)-&gt;gclist = g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a>;
<a name="l00107"></a>00107       g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a> = o;
<a name="l00108"></a>00108       <span class="keywordflow">break</span>;
<a name="l00109"></a>00109     }
<a name="l00110"></a>00110     <span class="keywordflow">default</span>: <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(0);
<a name="l00111"></a>00111   }
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 
<a name="l00115"></a><a class="code" href="lgc_8c.html#a183407747db3400e27fa703c2385a704">00115</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#a183407747db3400e27fa703c2385a704">marktmu</a> (<a class="code" href="structglobal__State.html">global_State</a> *g) {
<a name="l00116"></a>00116   <a class="code" href="unionGCObject.html">GCObject</a> *u = g-&gt;<a class="code" href="structglobal__State.html#a8f11ac1643d581a8340f8b894b1ce869">tmudata</a>;
<a name="l00117"></a>00117   <span class="keywordflow">if</span> (u) {
<a name="l00118"></a>00118     <span class="keywordflow">do</span> {
<a name="l00119"></a>00119       u = u-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.next;
<a name="l00120"></a>00120       <a class="code" href="lgc_8c.html#ada061b1d508c516b2e53f546521b3eeb">makewhite</a>(g, u);  <span class="comment">/* may be marked, if left from previous GC */</span>
<a name="l00121"></a>00121       <a class="code" href="lgc_8c.html#aacf3c8ee0eebd5d5b1cd09da000ad53c">reallymarkobject</a>(g, u);
<a name="l00122"></a>00122     } <span class="keywordflow">while</span> (u != g-&gt;<a class="code" href="structglobal__State.html#a8f11ac1643d581a8340f8b894b1ce869">tmudata</a>);
<a name="l00123"></a>00123   }
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 <span class="comment">/* move `dead&apos; udata that need finalization to list `tmudata&apos; */</span>
<a name="l00128"></a><a class="code" href="lgc_8h.html#ab95775a616cbab3dd1f908b72dfed58c">00128</a> <span class="keywordtype">size_t</span> <a class="code" href="lgc_8c.html#a208da9b7b267923ec22a90b2966979f6">luaC_separateudata</a> (<a class="code" href="structlua__State.html">lua_State</a> *L, <span class="keywordtype">int</span> all) {
<a name="l00129"></a>00129   <a class="code" href="structglobal__State.html">global_State</a> *g = <a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L);
<a name="l00130"></a>00130   <span class="keywordtype">size_t</span> deadmem = 0;
<a name="l00131"></a>00131   <a class="code" href="unionGCObject.html">GCObject</a> **p = &amp;g-&gt;<a class="code" href="structglobal__State.html#a2c81856ac69a92580d4330cd1070c7c5">mainthread</a>-&gt;next;
<a name="l00132"></a>00132   <a class="code" href="unionGCObject.html">GCObject</a> *curr;
<a name="l00133"></a>00133   <span class="keywordflow">while</span> ((curr = *p) != NULL) {
<a name="l00134"></a>00134     <span class="keywordflow">if</span> (!(<a class="code" href="lgc_8h.html#a4c0ce78d476460d2e54914301f4a4bf7">iswhite</a>(curr) || all) || <a class="code" href="lgc_8c.html#a14e1f262784acec7fb2c97cae1e241a2">isfinalized</a>(<a class="code" href="lstate_8h.html#a55e9a228ad0d3a82ee9cfc353002fd8a">gco2u</a>(curr)))
<a name="l00135"></a>00135       p = &amp;curr-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.next;  <span class="comment">/* don&apos;t bother with them */</span>
<a name="l00136"></a>00136     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="ltm_8h.html#a0a29ed88450f8f92330a6a411a9c8134">fasttm</a>(L, <a class="code" href="lstate_8h.html#a55e9a228ad0d3a82ee9cfc353002fd8a">gco2u</a>(curr)-&gt;metatable, <a class="code" href="ltm_8h.html#a69e345ae253d250b61a03f1d6871c8d1a01e1b0be5e2785471e19db3665960536">TM_GC</a>) == NULL) {
<a name="l00137"></a>00137       <a class="code" href="lgc_8c.html#a27a77307b90dae514183dc73279ba46b">markfinalized</a>(<a class="code" href="lstate_8h.html#a55e9a228ad0d3a82ee9cfc353002fd8a">gco2u</a>(curr));  <span class="comment">/* don&apos;t need finalization */</span>
<a name="l00138"></a>00138       p = &amp;curr-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.next;
<a name="l00139"></a>00139     }
<a name="l00140"></a>00140     <span class="keywordflow">else</span> {  <span class="comment">/* must call its gc method */</span>
<a name="l00141"></a>00141       deadmem += <a class="code" href="lstring_8h.html#a6f33920ba30f126225528b62bf50c673">sizeudata</a>(<a class="code" href="lstate_8h.html#a55e9a228ad0d3a82ee9cfc353002fd8a">gco2u</a>(curr));
<a name="l00142"></a>00142       <a class="code" href="lgc_8c.html#a27a77307b90dae514183dc73279ba46b">markfinalized</a>(<a class="code" href="lstate_8h.html#a55e9a228ad0d3a82ee9cfc353002fd8a">gco2u</a>(curr));
<a name="l00143"></a>00143       *p = curr-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.next;
<a name="l00144"></a>00144       <span class="comment">/* link `curr&apos; at the end of `tmudata&apos; list */</span>
<a name="l00145"></a>00145       <span class="keywordflow">if</span> (g-&gt;<a class="code" href="structglobal__State.html#a8f11ac1643d581a8340f8b894b1ce869">tmudata</a> == NULL)  <span class="comment">/* list is empty? */</span>
<a name="l00146"></a>00146         g-&gt;<a class="code" href="structglobal__State.html#a8f11ac1643d581a8340f8b894b1ce869">tmudata</a> = curr-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.next = curr;  <span class="comment">/* creates a circular list */</span>
<a name="l00147"></a>00147       <span class="keywordflow">else</span> {
<a name="l00148"></a>00148         curr-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.next = g-&gt;<a class="code" href="structglobal__State.html#a8f11ac1643d581a8340f8b894b1ce869">tmudata</a>-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.next;
<a name="l00149"></a>00149         g-&gt;<a class="code" href="structglobal__State.html#a8f11ac1643d581a8340f8b894b1ce869">tmudata</a>-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.next = curr;
<a name="l00150"></a>00150         g-&gt;<a class="code" href="structglobal__State.html#a8f11ac1643d581a8340f8b894b1ce869">tmudata</a> = curr;
<a name="l00151"></a>00151       }
<a name="l00152"></a>00152     }
<a name="l00153"></a>00153   }
<a name="l00154"></a>00154   <span class="keywordflow">return</span> deadmem;
<a name="l00155"></a>00155 }
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 
<a name="l00158"></a><a class="code" href="lgc_8c.html#a807405a5a9f05f70473f7d1ce4c68378">00158</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lgc_8c.html#a807405a5a9f05f70473f7d1ce4c68378">traversetable</a> (<a class="code" href="structglobal__State.html">global_State</a> *g, <a class="code" href="structTable.html">Table</a> *h) {
<a name="l00159"></a>00159   <span class="keywordtype">int</span> i;
<a name="l00160"></a>00160   <span class="keywordtype">int</span> weakkey = 0;
<a name="l00161"></a>00161   <span class="keywordtype">int</span> weakvalue = 0;
<a name="l00162"></a>00162   <span class="keyword">const</span> <a class="code" href="structlua__TValue.html">TValue</a> *mode;
<a name="l00163"></a>00163   <span class="keywordflow">if</span> (h-&gt;<a class="code" href="structTable.html#a99c20fa696fb6a4e89890efa3819ebdc">metatable</a>)
<a name="l00164"></a>00164     <a class="code" href="lgc_8c.html#a6ae72c43e48b29944e55933df7f15482">markobject</a>(g, h-&gt;<a class="code" href="structTable.html#a99c20fa696fb6a4e89890efa3819ebdc">metatable</a>);
<a name="l00165"></a>00165   mode = <a class="code" href="ltm_8h.html#ab067446141992fa1bfa2f1ca720197fc">gfasttm</a>(g, h-&gt;<a class="code" href="structTable.html#a99c20fa696fb6a4e89890efa3819ebdc">metatable</a>, <a class="code" href="ltm_8h.html#a69e345ae253d250b61a03f1d6871c8d1a5cd07c76b9aff7450d8052363ff2db4e">TM_MODE</a>);
<a name="l00166"></a>00166   <span class="keywordflow">if</span> (mode &amp;&amp; <a class="code" href="lobject_8h.html#a9bdf057a0de8da2ffae3ac35662dd255">ttisstring</a>(mode)) {  <span class="comment">/* is there a weak mode? */</span>
<a name="l00167"></a>00167     weakkey = (strchr(<a class="code" href="lobject_8h.html#ac2c9eedf3ff2c3042445b3b534f161e1">svalue</a>(mode), <span class="charliteral">&apos;k&apos;</span>) != NULL);
<a name="l00168"></a>00168     weakvalue = (strchr(<a class="code" href="lobject_8h.html#ac2c9eedf3ff2c3042445b3b534f161e1">svalue</a>(mode), <span class="charliteral">&apos;v&apos;</span>) != NULL);
<a name="l00169"></a>00169     <span class="keywordflow">if</span> (weakkey || weakvalue) {  <span class="comment">/* is really weak? */</span>
<a name="l00170"></a>00170       h-&gt;marked &amp;= ~(<a class="code" href="lgc_8c.html#ac92cf2e20106bb0a9b68e0cdb74b286b">KEYWEAK</a> | <a class="code" href="lgc_8c.html#acd04fc135b64ac6efe5ba024efa5d8f1">VALUEWEAK</a>);  <span class="comment">/* clear bits */</span>
<a name="l00171"></a>00171       h-&gt;marked |= <a class="code" href="llimits_8h.html#a596f5b6e992f53a5a4e5732083448dd4">cast_byte</a>((weakkey &lt;&lt; <a class="code" href="lgc_8h.html#a8eddc511675ce387499de7eef2df2b5a">KEYWEAKBIT</a>) |
<a name="l00172"></a>00172                              (weakvalue &lt;&lt; <a class="code" href="lgc_8h.html#a19886a9aad85dae047084b6ad1d8bca4">VALUEWEAKBIT</a>));
<a name="l00173"></a>00173       h-&gt;<a class="code" href="structTable.html#a1b6f3d76efed2011a36ee7c78f65aa70">gclist</a> = g-&gt;<a class="code" href="structglobal__State.html#ab84f67e3b1e863392e504e9d13787891">weak</a>;  <span class="comment">/* must be cleared after GC, ... */</span>
<a name="l00174"></a>00174       g-&gt;<a class="code" href="structglobal__State.html#ab84f67e3b1e863392e504e9d13787891">weak</a> = <a class="code" href="lstate_8h.html#a254ca29aba03e47440082d4591a9734e">obj2gco</a>(h);  <span class="comment">/* ... so put in the appropriate list */</span>
<a name="l00175"></a>00175     }
<a name="l00176"></a>00176   }
<a name="l00177"></a>00177   <span class="keywordflow">if</span> (weakkey &amp;&amp; weakvalue) <span class="keywordflow">return</span> 1;
<a name="l00178"></a>00178   <span class="keywordflow">if</span> (!weakvalue) {
<a name="l00179"></a>00179     i = h-&gt;<a class="code" href="structTable.html#a2c648e99fcf88c4660c97e7d9408b50f">sizearray</a>;
<a name="l00180"></a>00180     <span class="keywordflow">while</span> (i--)
<a name="l00181"></a>00181       <a class="code" href="lgc_8c.html#a2dd4136ac29665568973c074bc450849">markvalue</a>(g, &amp;h-&gt;<a class="code" href="structTable.html#a36bebd30ab45163c31feb821c936e160">array</a>[i]);
<a name="l00182"></a>00182   }
<a name="l00183"></a>00183   i = <a class="code" href="lobject_8h.html#a2fbf715e78eaa889ed0fb9d4514e736a">sizenode</a>(h);
<a name="l00184"></a>00184   <span class="keywordflow">while</span> (i--) {
<a name="l00185"></a>00185     <a class="code" href="structNode.html">Node</a> *n = <a class="code" href="ltable_8h.html#a644cfa3b6d4be1782e818a8340b5f78b">gnode</a>(h, i);
<a name="l00186"></a>00186     <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(<a class="code" href="lobject_8h.html#acd205ab396b96fba48e1f758c17a2cf3">ttype</a>(<a class="code" href="ltable_8h.html#ad8f233e3b7156cd470d0ac21d7b54c11">gkey</a>(n)) != <a class="code" href="lobject_8h.html#a8626e895a2b49a9b945c96281d854fb5">LUA_TDEADKEY</a> || <a class="code" href="lobject_8h.html#a8630c13eaefbeaba1aa0933cab6e0238">ttisnil</a>(<a class="code" href="ltable_8h.html#acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</a>(n)));
<a name="l00187"></a>00187     <span class="keywordflow">if</span> (<a class="code" href="lobject_8h.html#a8630c13eaefbeaba1aa0933cab6e0238">ttisnil</a>(<a class="code" href="ltable_8h.html#acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</a>(n)))
<a name="l00188"></a>00188       <a class="code" href="lgc_8c.html#a6ed834aee205ee32cb75522c24051a67">removeentry</a>(n);  <span class="comment">/* remove empty entries */</span>
<a name="l00189"></a>00189     <span class="keywordflow">else</span> {
<a name="l00190"></a>00190       <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(!<a class="code" href="lobject_8h.html#a8630c13eaefbeaba1aa0933cab6e0238">ttisnil</a>(<a class="code" href="ltable_8h.html#ad8f233e3b7156cd470d0ac21d7b54c11">gkey</a>(n)));
<a name="l00191"></a>00191       <span class="keywordflow">if</span> (!weakkey) <a class="code" href="lgc_8c.html#a2dd4136ac29665568973c074bc450849">markvalue</a>(g, <a class="code" href="ltable_8h.html#ad8f233e3b7156cd470d0ac21d7b54c11">gkey</a>(n));
<a name="l00192"></a>00192       <span class="keywordflow">if</span> (!weakvalue) <a class="code" href="lgc_8c.html#a2dd4136ac29665568973c074bc450849">markvalue</a>(g, <a class="code" href="ltable_8h.html#acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</a>(n));
<a name="l00193"></a>00193     }
<a name="l00194"></a>00194   }
<a name="l00195"></a>00195   <span class="keywordflow">return</span> weakkey || weakvalue;
<a name="l00196"></a>00196 }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 
<a name="l00199"></a>00199 <span class="comment">/*</span>
<a name="l00200"></a>00200 <span class="comment">** All marks are conditional because a GC may happen while the</span>
<a name="l00201"></a>00201 <span class="comment">** prototype is still being created</span>
<a name="l00202"></a>00202 <span class="comment">*/</span>
<a name="l00203"></a><a class="code" href="lgc_8c.html#a3447fa36b7629097dd2976567d1801ee">00203</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#a3447fa36b7629097dd2976567d1801ee">traverseproto</a> (<a class="code" href="structglobal__State.html">global_State</a> *g, <a class="code" href="structProto.html">Proto</a> *<a class="code" href="libluasqlite3_8c.html#ae16fcc70ad2cbf55b1906507bcb6fa33">f</a>) {
<a name="l00204"></a>00204   <span class="keywordtype">int</span> i;
<a name="l00205"></a>00205   <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structProto.html#a92b6ec319e7aa1ee8b8ff7807353ad96">source</a>) <a class="code" href="lgc_8c.html#a220f3c1132e8df620410ed6de1a75b49">stringmark</a>(f-&gt;<a class="code" href="structProto.html#a92b6ec319e7aa1ee8b8ff7807353ad96">source</a>);
<a name="l00206"></a>00206   <span class="keywordflow">for</span> (i=0; i&lt;f-&gt;<a class="code" href="structProto.html#a5bd719e0486168f6ecd4b01bf41a7444">sizek</a>; i++)  <span class="comment">/* mark literals */</span>
<a name="l00207"></a>00207     <a class="code" href="lgc_8c.html#a2dd4136ac29665568973c074bc450849">markvalue</a>(g, &amp;f-&gt;<a class="code" href="structProto.html#ae292fb0c0558679704933824ce96eac2">k</a>[i]);
<a name="l00208"></a>00208   <span class="keywordflow">for</span> (i=0; i&lt;f-&gt;<a class="code" href="structProto.html#a6ecec897497ba7d94df6ef69289ef5c0">sizeupvalues</a>; i++) {  <span class="comment">/* mark upvalue names */</span>
<a name="l00209"></a>00209     <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structProto.html#abebc63aea579a1b630efc04d2bf9c4b7">upvalues</a>[i])
<a name="l00210"></a>00210       <a class="code" href="lgc_8c.html#a220f3c1132e8df620410ed6de1a75b49">stringmark</a>(f-&gt;<a class="code" href="structProto.html#abebc63aea579a1b630efc04d2bf9c4b7">upvalues</a>[i]);
<a name="l00211"></a>00211   }
<a name="l00212"></a>00212   <span class="keywordflow">for</span> (i=0; i&lt;f-&gt;<a class="code" href="structProto.html#a73ddad1a18b7c46be46ec32aa2a08632">sizep</a>; i++) {  <span class="comment">/* mark nested protos */</span>
<a name="l00213"></a>00213     <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structProto.html#a54dc8e2e8973007794fa0ab0e4a71461">p</a>[i])
<a name="l00214"></a>00214       <a class="code" href="lgc_8c.html#a6ae72c43e48b29944e55933df7f15482">markobject</a>(g, f-&gt;<a class="code" href="structProto.html#a54dc8e2e8973007794fa0ab0e4a71461">p</a>[i]);
<a name="l00215"></a>00215   }
<a name="l00216"></a>00216   <span class="keywordflow">for</span> (i=0; i&lt;f-&gt;<a class="code" href="structProto.html#ac2ab37e941e8866687f44f7b2f4b95a9">sizelocvars</a>; i++) {  <span class="comment">/* mark local-variable names */</span>
<a name="l00217"></a>00217     <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structProto.html#a24fd00345a3dad92baf371a9c96ba140">locvars</a>[i].<a class="code" href="structLocVar.html#acf62684d78349320b90b4acfa3b6d22a">varname</a>)
<a name="l00218"></a>00218       <a class="code" href="lgc_8c.html#a220f3c1132e8df620410ed6de1a75b49">stringmark</a>(f-&gt;<a class="code" href="structProto.html#a24fd00345a3dad92baf371a9c96ba140">locvars</a>[i].<a class="code" href="structLocVar.html#acf62684d78349320b90b4acfa3b6d22a">varname</a>);
<a name="l00219"></a>00219   }
<a name="l00220"></a>00220 }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 
<a name="l00224"></a><a class="code" href="lgc_8c.html#af211045ee52c61a4d8bbbefb1561202d">00224</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#af211045ee52c61a4d8bbbefb1561202d">traverseclosure</a> (<a class="code" href="structglobal__State.html">global_State</a> *g, <a class="code" href="unionClosure.html">Closure</a> *cl) {
<a name="l00225"></a>00225   <a class="code" href="lgc_8c.html#a6ae72c43e48b29944e55933df7f15482">markobject</a>(g, cl-&gt;<a class="code" href="unionClosure.html#ace9dac5a62b61db682ef0cd86b3b44b1">c</a>.env);
<a name="l00226"></a>00226   <span class="keywordflow">if</span> (cl-&gt;<a class="code" href="unionClosure.html#ace9dac5a62b61db682ef0cd86b3b44b1">c</a>.isC) {
<a name="l00227"></a>00227     <span class="keywordtype">int</span> i;
<a name="l00228"></a>00228     <span class="keywordflow">for</span> (i=0; i&lt;cl-&gt;<a class="code" href="unionClosure.html#ace9dac5a62b61db682ef0cd86b3b44b1">c</a>.nupvalues; i++)  <span class="comment">/* mark its upvalues */</span>
<a name="l00229"></a>00229       <a class="code" href="lgc_8c.html#a2dd4136ac29665568973c074bc450849">markvalue</a>(g, &amp;cl-&gt;<a class="code" href="unionClosure.html#ace9dac5a62b61db682ef0cd86b3b44b1">c</a>.<a class="code" href="structCClosure.html#a75d6bfc66f8ed48b3dd67007be84174f">upvalue</a>[i]);
<a name="l00230"></a>00230   }
<a name="l00231"></a>00231   <span class="keywordflow">else</span> {
<a name="l00232"></a>00232     <span class="keywordtype">int</span> i;
<a name="l00233"></a>00233     <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(cl-&gt;<a class="code" href="unionClosure.html#a8c338ec7dc76078cbee5887857de713c">l</a>.nupvalues == cl-&gt;<a class="code" href="unionClosure.html#a8c338ec7dc76078cbee5887857de713c">l</a>.<a class="code" href="structLClosure.html#a4cf173817d3897b0e70822e70d241d6c">p</a>-&gt;<a class="code" href="structProto.html#ae20e9996154a89085ac03eaaf8f23d32">nups</a>);
<a name="l00234"></a>00234     <a class="code" href="lgc_8c.html#a6ae72c43e48b29944e55933df7f15482">markobject</a>(g, cl-&gt;<a class="code" href="unionClosure.html#a8c338ec7dc76078cbee5887857de713c">l</a>.<a class="code" href="structLClosure.html#a4cf173817d3897b0e70822e70d241d6c">p</a>);
<a name="l00235"></a>00235     <span class="keywordflow">for</span> (i=0; i&lt;cl-&gt;<a class="code" href="unionClosure.html#a8c338ec7dc76078cbee5887857de713c">l</a>.nupvalues; i++)  <span class="comment">/* mark its upvalues */</span>
<a name="l00236"></a>00236       <a class="code" href="lgc_8c.html#a6ae72c43e48b29944e55933df7f15482">markobject</a>(g, cl-&gt;<a class="code" href="unionClosure.html#a8c338ec7dc76078cbee5887857de713c">l</a>.<a class="code" href="structLClosure.html#a94886e7c7df838f5fab36575b0554682">upvals</a>[i]);
<a name="l00237"></a>00237   }
<a name="l00238"></a>00238 }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 
<a name="l00241"></a><a class="code" href="lgc_8c.html#a3091af958bc0821e5c6e49308f91d06d">00241</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#a3091af958bc0821e5c6e49308f91d06d">checkstacksizes</a> (<a class="code" href="structlua__State.html">lua_State</a> *L, <a class="code" href="structlua__TValue.html">StkId</a> max) {
<a name="l00242"></a>00242   <span class="keywordtype">int</span> ci_used = <a class="code" href="llimits_8h.html#a37a9e2c4b53433d34bad0f12a1500c08">cast_int</a>(L-&gt;<a class="code" href="structlua__State.html#a7fbb5727050853f411ad64b4be9ab5c8">ci</a> - L-&gt;<a class="code" href="structlua__State.html#a5e99f3f914a793d73684a19eb96dda3b">base_ci</a>);  <span class="comment">/* number of `ci&apos; in use */</span>
<a name="l00243"></a>00243   <span class="keywordtype">int</span> s_used = <a class="code" href="llimits_8h.html#a37a9e2c4b53433d34bad0f12a1500c08">cast_int</a>(max - L-&gt;<a class="code" href="structlua__State.html#a27e1d5122ef7fffae7542814c72fdd2f">stack</a>);  <span class="comment">/* part of stack in use */</span>
<a name="l00244"></a>00244   <span class="keywordflow">if</span> (L-&gt;<a class="code" href="structlua__State.html#a0b6456a08b1283b41f93626154c62f59">size_ci</a> &gt; <a class="code" href="luaconf_8h.html#a8f182b2922cca9dcc38af489cec4519c">LUAI_MAXCALLS</a>)  <span class="comment">/* handling overflow? */</span>
<a name="l00245"></a>00245     <span class="keywordflow">return</span>;  <span class="comment">/* do not touch the stacks */</span>
<a name="l00246"></a>00246   <span class="keywordflow">if</span> (4*ci_used &lt; L-&gt;size_ci &amp;&amp; 2*BASIC_CI_SIZE &lt; L-&gt;size_ci)
<a name="l00247"></a>00247     <a class="code" href="ldo_8c.html#a4973df8c6b2fda8e72794f8d66cdaca2">luaD_reallocCI</a>(L, L-&gt;<a class="code" href="structlua__State.html#a0b6456a08b1283b41f93626154c62f59">size_ci</a>/2);  <span class="comment">/* still big enough... */</span>
<a name="l00248"></a>00248   <a class="code" href="llimits_8h.html#adb7255da0decb82ca11a64fb830a8af1">condhardstacktests</a>(<a class="code" href="ldo_8c.html#a4973df8c6b2fda8e72794f8d66cdaca2">luaD_reallocCI</a>(L, ci_used + 1));
<a name="l00249"></a>00249   <span class="keywordflow">if</span> (4*s_used &lt; L-&gt;stacksize &amp;&amp;
<a name="l00250"></a>00250       2*(<a class="code" href="lstate_8h.html#a8f869ebbbd09a2c657864e11e3d88453">BASIC_STACK_SIZE</a>+<a class="code" href="lstate_8h.html#a9e690b8e4047af306d2dd1f78a9094d7">EXTRA_STACK</a>) &lt; L-&gt;<a class="code" href="structlua__State.html#a44530127453a374634f7ad22eee9ec6c">stacksize</a>)
<a name="l00251"></a>00251     <a class="code" href="ldo_8c.html#af9e1a13760752fc0ba594072b1fef5f3">luaD_reallocstack</a>(L, L-&gt;<a class="code" href="structlua__State.html#a44530127453a374634f7ad22eee9ec6c">stacksize</a>/2);  <span class="comment">/* still big enough... */</span>
<a name="l00252"></a>00252   <a class="code" href="llimits_8h.html#adb7255da0decb82ca11a64fb830a8af1">condhardstacktests</a>(<a class="code" href="ldo_8c.html#af9e1a13760752fc0ba594072b1fef5f3">luaD_reallocstack</a>(L, s_used));
<a name="l00253"></a>00253 }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255 
<a name="l00256"></a><a class="code" href="lgc_8c.html#a7e8e025193a9593e23222a2300167543">00256</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#a7e8e025193a9593e23222a2300167543">traversestack</a> (<a class="code" href="structglobal__State.html">global_State</a> *g, <a class="code" href="structlua__State.html">lua_State</a> *l) {
<a name="l00257"></a>00257   <a class="code" href="structlua__TValue.html">StkId</a> o, lim;
<a name="l00258"></a>00258   <a class="code" href="structCallInfo.html">CallInfo</a> *ci;
<a name="l00259"></a>00259   <a class="code" href="lgc_8c.html#a2dd4136ac29665568973c074bc450849">markvalue</a>(g, <a class="code" href="lstate_8h.html#a1108b4374aa20059cd53d90b638c0e4b">gt</a>(l));
<a name="l00260"></a>00260   lim = l-&gt;<a class="code" href="structlua__State.html#a195f448e76fd404953fa1962d28212a3">top</a>;
<a name="l00261"></a>00261   <span class="keywordflow">for</span> (ci = l-&gt;<a class="code" href="structlua__State.html#a5e99f3f914a793d73684a19eb96dda3b">base_ci</a>; ci &lt;= l-&gt;ci; ci++) {
<a name="l00262"></a>00262     <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(ci-&gt;<a class="code" href="structCallInfo.html#ae782b06ef00ccfe0720625ffa99b093a">top</a> &lt;= l-&gt;<a class="code" href="structlua__State.html#a797a585a2bdb638bd1ca78c15bbe46fb">stack_last</a>);
<a name="l00263"></a>00263     <span class="keywordflow">if</span> (lim &lt; ci-&gt;top) lim = ci-&gt;<a class="code" href="structCallInfo.html#ae782b06ef00ccfe0720625ffa99b093a">top</a>;
<a name="l00264"></a>00264   }
<a name="l00265"></a>00265   <span class="keywordflow">for</span> (o = l-&gt;<a class="code" href="structlua__State.html#a27e1d5122ef7fffae7542814c72fdd2f">stack</a>; o &lt; l-&gt;top; o++)
<a name="l00266"></a>00266     <a class="code" href="lgc_8c.html#a2dd4136ac29665568973c074bc450849">markvalue</a>(g, o);
<a name="l00267"></a>00267   <span class="keywordflow">for</span> (; o &lt;= lim; o++)
<a name="l00268"></a>00268     <a class="code" href="lobject_8h.html#ad9034def7bbc1965ec3d714d84620b07">setnilvalue</a>(o);
<a name="l00269"></a>00269   <a class="code" href="lgc_8c.html#a3091af958bc0821e5c6e49308f91d06d">checkstacksizes</a>(l, lim);
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 <span class="comment">/*</span>
<a name="l00274"></a>00274 <span class="comment">** traverse one gray object, turning it to black.</span>
<a name="l00275"></a>00275 <span class="comment">** Returns `quantity&apos; traversed.</span>
<a name="l00276"></a>00276 <span class="comment">*/</span>
<a name="l00277"></a><a class="code" href="lgc_8c.html#ab7d3f49b190e7443a0f6f9be5687531d">00277</a> <span class="keyword">static</span> <a class="code" href="llimits_8h.html#a85638ce9e30eaebe04b1c7d0a8f98377">l_mem</a> <a class="code" href="lgc_8c.html#ab7d3f49b190e7443a0f6f9be5687531d">propagatemark</a> (<a class="code" href="structglobal__State.html">global_State</a> *g) {
<a name="l00278"></a>00278   <a class="code" href="unionGCObject.html">GCObject</a> *o = g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a>;
<a name="l00279"></a>00279   <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(<a class="code" href="lgc_8h.html#ad417e22072630b33cf74a3055b27d8d7">isgray</a>(o));
<a name="l00280"></a>00280   <a class="code" href="lgc_8h.html#ae909eb4aa4c23c6ee7757210c183634d">gray2black</a>(o);
<a name="l00281"></a>00281   <span class="keywordflow">switch</span> (o-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.tt) {
<a name="l00282"></a>00282     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#a31620fd8da5b655b7879e16a116ec31a">LUA_TTABLE</a>: {
<a name="l00283"></a>00283       <a class="code" href="structTable.html">Table</a> *h = <a class="code" href="lstate_8h.html#aaebbd554090bd0625aa3ec0d5309c235">gco2h</a>(o);
<a name="l00284"></a>00284       g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a> = h-&gt;<a class="code" href="structTable.html#a1b6f3d76efed2011a36ee7c78f65aa70">gclist</a>;
<a name="l00285"></a>00285       <span class="keywordflow">if</span> (<a class="code" href="lgc_8c.html#a807405a5a9f05f70473f7d1ce4c68378">traversetable</a>(g, h))  <span class="comment">/* table is weak? */</span>
<a name="l00286"></a>00286         <a class="code" href="lgc_8c.html#a9490dca59c8a4d659ff7522257943f63">black2gray</a>(o);  <span class="comment">/* keep it gray */</span>
<a name="l00287"></a>00287       <span class="keywordflow">return</span> <span class="keyword">sizeof</span>(<a class="code" href="structTable.html">Table</a>) + <span class="keyword">sizeof</span>(<a class="code" href="structlua__TValue.html">TValue</a>) * h-&gt;<a class="code" href="structTable.html#a2c648e99fcf88c4660c97e7d9408b50f">sizearray</a> +
<a name="l00288"></a>00288                              <span class="keyword">sizeof</span>(<a class="code" href="structNode.html">Node</a>) * <a class="code" href="lobject_8h.html#a2fbf715e78eaa889ed0fb9d4514e736a">sizenode</a>(h);
<a name="l00289"></a>00289     }
<a name="l00290"></a>00290     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#adaa7fa6e2561c1bc428ba8d265171494">LUA_TFUNCTION</a>: {
<a name="l00291"></a>00291       <a class="code" href="unionClosure.html">Closure</a> *cl = <a class="code" href="lstate_8h.html#a003658bade3405a30fe2cf7fee2f7e10">gco2cl</a>(o);
<a name="l00292"></a>00292       g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a> = cl-&gt;<a class="code" href="unionClosure.html#ace9dac5a62b61db682ef0cd86b3b44b1">c</a>.gclist;
<a name="l00293"></a>00293       <a class="code" href="lgc_8c.html#af211045ee52c61a4d8bbbefb1561202d">traverseclosure</a>(g, cl);
<a name="l00294"></a>00294       <span class="keywordflow">return</span> (cl-&gt;<a class="code" href="unionClosure.html#ace9dac5a62b61db682ef0cd86b3b44b1">c</a>.isC) ? <a class="code" href="lfunc_8h.html#ae0283669f47da8432046d0a24c1db93e">sizeCclosure</a>(cl-&gt;<a class="code" href="unionClosure.html#ace9dac5a62b61db682ef0cd86b3b44b1">c</a>.nupvalues) :
<a name="l00295"></a>00295                            <a class="code" href="lfunc_8h.html#ab5551e284145e5258a8032a97806cfe1">sizeLclosure</a>(cl-&gt;<a class="code" href="unionClosure.html#a8c338ec7dc76078cbee5887857de713c">l</a>.nupvalues);
<a name="l00296"></a>00296     }
<a name="l00297"></a>00297     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#a028a8d8aae9580c465aabcd0c11334d9">LUA_TTHREAD</a>: {
<a name="l00298"></a>00298       <a class="code" href="structlua__State.html">lua_State</a> *th = <a class="code" href="lstate_8h.html#a52c467e11bd40cad5ca78372f7f67b4d">gco2th</a>(o);
<a name="l00299"></a>00299       g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a> = th-&gt;<a class="code" href="structlua__State.html#a0d446661e92287c8409076c970771217">gclist</a>;
<a name="l00300"></a>00300       th-&gt;<a class="code" href="structlua__State.html#a0d446661e92287c8409076c970771217">gclist</a> = g-&gt;<a class="code" href="structglobal__State.html#a2ccaa5d2e98c086489c04e2045082535">grayagain</a>;
<a name="l00301"></a>00301       g-&gt;<a class="code" href="structglobal__State.html#a2ccaa5d2e98c086489c04e2045082535">grayagain</a> = o;
<a name="l00302"></a>00302       <a class="code" href="lgc_8c.html#a9490dca59c8a4d659ff7522257943f63">black2gray</a>(o);
<a name="l00303"></a>00303       <a class="code" href="lgc_8c.html#a7e8e025193a9593e23222a2300167543">traversestack</a>(g, th);
<a name="l00304"></a>00304       <span class="keywordflow">return</span> <span class="keyword">sizeof</span>(<a class="code" href="structlua__State.html">lua_State</a>) + <span class="keyword">sizeof</span>(<a class="code" href="structlua__TValue.html">TValue</a>) * th-&gt;<a class="code" href="structlua__State.html#a44530127453a374634f7ad22eee9ec6c">stacksize</a> +
<a name="l00305"></a>00305                                  <span class="keyword">sizeof</span>(<a class="code" href="structCallInfo.html">CallInfo</a>) * th-&gt;<a class="code" href="structlua__State.html#a0b6456a08b1283b41f93626154c62f59">size_ci</a>;
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307     <span class="keywordflow">case</span> <a class="code" href="lobject_8h.html#aa2a683d9e42dac5846eefa108297cbf0">LUA_TPROTO</a>: {
<a name="l00308"></a>00308       <a class="code" href="structProto.html">Proto</a> *p = <a class="code" href="lstate_8h.html#a8792af5dd4539a71f6ed8ddb31d079c3">gco2p</a>(o);
<a name="l00309"></a>00309       g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a> = p-&gt;<a class="code" href="structProto.html#a7991ec396b493a42b5c7f38b4e162959">gclist</a>;
<a name="l00310"></a>00310       <a class="code" href="lgc_8c.html#a3447fa36b7629097dd2976567d1801ee">traverseproto</a>(g, p);
<a name="l00311"></a>00311       <span class="keywordflow">return</span> <span class="keyword">sizeof</span>(<a class="code" href="structProto.html">Proto</a>) + <span class="keyword">sizeof</span>(<a class="code" href="llimits_8h.html#a2d9700d30c1ae59754ecf50917c04d43">Instruction</a>) * p-&gt;<a class="code" href="structProto.html#a43e4d3849b5859112d93bdc2534a7cc0">sizecode</a> +
<a name="l00312"></a>00312                              <span class="keyword">sizeof</span>(<a class="code" href="structProto.html">Proto</a> *) * p-&gt;<a class="code" href="structProto.html#a73ddad1a18b7c46be46ec32aa2a08632">sizep</a> +
<a name="l00313"></a>00313                              <span class="keyword">sizeof</span>(<a class="code" href="structlua__TValue.html">TValue</a>) * p-&gt;<a class="code" href="structProto.html#a5bd719e0486168f6ecd4b01bf41a7444">sizek</a> + 
<a name="l00314"></a>00314                              <span class="keyword">sizeof</span>(int) * p-&gt;<a class="code" href="structProto.html#a65303ae1d815313f3358a578113fcc6e">sizelineinfo</a> +
<a name="l00315"></a>00315                              <span class="keyword">sizeof</span>(<a class="code" href="structLocVar.html">LocVar</a>) * p-&gt;<a class="code" href="structProto.html#ac2ab37e941e8866687f44f7b2f4b95a9">sizelocvars</a> +
<a name="l00316"></a>00316                              <span class="keyword">sizeof</span>(<a class="code" href="unionTString.html">TString</a> *) * p-&gt;<a class="code" href="structProto.html#a6ecec897497ba7d94df6ef69289ef5c0">sizeupvalues</a>;
<a name="l00317"></a>00317     }
<a name="l00318"></a>00318     <span class="keywordflow">default</span>: <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(0); <span class="keywordflow">return</span> 0;
<a name="l00319"></a>00319   }
<a name="l00320"></a>00320 }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 
<a name="l00323"></a><a class="code" href="lgc_8c.html#a5dc2b7a11d04f03d72a0f691eaae0582">00323</a> <span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="lgc_8c.html#a5dc2b7a11d04f03d72a0f691eaae0582">propagateall</a> (<a class="code" href="structglobal__State.html">global_State</a> *g) {
<a name="l00324"></a>00324   <span class="keywordtype">size_t</span> m = 0;
<a name="l00325"></a>00325   <span class="keywordflow">while</span> (g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a>) m += <a class="code" href="lgc_8c.html#ab7d3f49b190e7443a0f6f9be5687531d">propagatemark</a>(g);
<a name="l00326"></a>00326   <span class="keywordflow">return</span> m;
<a name="l00327"></a>00327 }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 <span class="comment">/*</span>
<a name="l00331"></a>00331 <span class="comment">** The next function tells whether a key or value can be cleared from</span>
<a name="l00332"></a>00332 <span class="comment">** a weak table. Non-collectable objects are never removed from weak</span>
<a name="l00333"></a>00333 <span class="comment">** tables. Strings behave as `values&apos;, so are never removed too. for</span>
<a name="l00334"></a>00334 <span class="comment">** other objects: if really collected, cannot keep them; for userdata</span>
<a name="l00335"></a>00335 <span class="comment">** being finalized, keep them in keys, but not in values</span>
<a name="l00336"></a>00336 <span class="comment">*/</span>
<a name="l00337"></a><a class="code" href="lgc_8c.html#a96ebe5dcb7186f7ee4ff1cc84ea425b9">00337</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lgc_8c.html#a96ebe5dcb7186f7ee4ff1cc84ea425b9">iscleared</a> (<span class="keyword">const</span> <a class="code" href="structlua__TValue.html">TValue</a> *o, <span class="keywordtype">int</span> iskey) {
<a name="l00338"></a>00338   <span class="keywordflow">if</span> (!<a class="code" href="lobject_8h.html#aaabdb414706e6a904461e39967557185">iscollectable</a>(o)) <span class="keywordflow">return</span> 0;
<a name="l00339"></a>00339   <span class="keywordflow">if</span> (<a class="code" href="lobject_8h.html#a9bdf057a0de8da2ffae3ac35662dd255">ttisstring</a>(o)) {
<a name="l00340"></a>00340     <a class="code" href="lgc_8c.html#a220f3c1132e8df620410ed6de1a75b49">stringmark</a>(<a class="code" href="lobject_8h.html#aa6b88d61caae428f98c0289a15ce9f5e">rawtsvalue</a>(o));  <span class="comment">/* strings are `values&apos;, so are never weak */</span>
<a name="l00341"></a>00341     <span class="keywordflow">return</span> 0;
<a name="l00342"></a>00342   }
<a name="l00343"></a>00343   <span class="keywordflow">return</span> <a class="code" href="lgc_8h.html#a4c0ce78d476460d2e54914301f4a4bf7">iswhite</a>(<a class="code" href="lobject_8h.html#a05cdf6070135f10ad37e1048a730b634">gcvalue</a>(o)) ||
<a name="l00344"></a>00344     (<a class="code" href="lobject_8h.html#adb92da594f060270240a415b3483efc2">ttisuserdata</a>(o) &amp;&amp; (!iskey &amp;&amp; <a class="code" href="lgc_8c.html#a14e1f262784acec7fb2c97cae1e241a2">isfinalized</a>(<a class="code" href="lobject_8h.html#a1c49f55d93297e833141fb62903af3ad">uvalue</a>(o))));
<a name="l00345"></a>00345 }
<a name="l00346"></a>00346 
<a name="l00347"></a>00347 
<a name="l00348"></a>00348 <span class="comment">/*</span>
<a name="l00349"></a>00349 <span class="comment">** clear collected entries from weaktables</span>
<a name="l00350"></a>00350 <span class="comment">*/</span>
<a name="l00351"></a><a class="code" href="lgc_8c.html#af61386b12aefeb4a5e9cabae6dcddc65">00351</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#af61386b12aefeb4a5e9cabae6dcddc65">cleartable</a> (<a class="code" href="unionGCObject.html">GCObject</a> *l) {
<a name="l00352"></a>00352   <span class="keywordflow">while</span> (l) {
<a name="l00353"></a>00353     <a class="code" href="structTable.html">Table</a> *h = <a class="code" href="lstate_8h.html#aaebbd554090bd0625aa3ec0d5309c235">gco2h</a>(l);
<a name="l00354"></a>00354     <span class="keywordtype">int</span> i = h-&gt;<a class="code" href="structTable.html#a2c648e99fcf88c4660c97e7d9408b50f">sizearray</a>;
<a name="l00355"></a>00355     <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(<a class="code" href="lgc_8h.html#a25c19ff3161e2a2395ba69fdef49915f">testbit</a>(h-&gt;marked, <a class="code" href="lgc_8h.html#a19886a9aad85dae047084b6ad1d8bca4">VALUEWEAKBIT</a>) ||
<a name="l00356"></a>00356                <a class="code" href="lgc_8h.html#a25c19ff3161e2a2395ba69fdef49915f">testbit</a>(h-&gt;marked, <a class="code" href="lgc_8h.html#a8eddc511675ce387499de7eef2df2b5a">KEYWEAKBIT</a>));
<a name="l00357"></a>00357     <span class="keywordflow">if</span> (<a class="code" href="lgc_8h.html#a25c19ff3161e2a2395ba69fdef49915f">testbit</a>(h-&gt;marked, <a class="code" href="lgc_8h.html#a19886a9aad85dae047084b6ad1d8bca4">VALUEWEAKBIT</a>)) {
<a name="l00358"></a>00358       <span class="keywordflow">while</span> (i--) {
<a name="l00359"></a>00359         <a class="code" href="structlua__TValue.html">TValue</a> *o = &amp;h-&gt;<a class="code" href="structTable.html#a36bebd30ab45163c31feb821c936e160">array</a>[i];
<a name="l00360"></a>00360         <span class="keywordflow">if</span> (<a class="code" href="lgc_8c.html#a96ebe5dcb7186f7ee4ff1cc84ea425b9">iscleared</a>(o, 0))  <span class="comment">/* value was collected? */</span>
<a name="l00361"></a>00361           <a class="code" href="lobject_8h.html#ad9034def7bbc1965ec3d714d84620b07">setnilvalue</a>(o);  <span class="comment">/* remove value */</span>
<a name="l00362"></a>00362       }
<a name="l00363"></a>00363     }
<a name="l00364"></a>00364     i = <a class="code" href="lobject_8h.html#a2fbf715e78eaa889ed0fb9d4514e736a">sizenode</a>(h);
<a name="l00365"></a>00365     <span class="keywordflow">while</span> (i--) {
<a name="l00366"></a>00366       <a class="code" href="structNode.html">Node</a> *n = <a class="code" href="ltable_8h.html#a644cfa3b6d4be1782e818a8340b5f78b">gnode</a>(h, i);
<a name="l00367"></a>00367       <span class="keywordflow">if</span> (!<a class="code" href="lobject_8h.html#a8630c13eaefbeaba1aa0933cab6e0238">ttisnil</a>(<a class="code" href="ltable_8h.html#acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</a>(n)) &amp;&amp;  <span class="comment">/* non-empty entry? */</span>
<a name="l00368"></a>00368           (<a class="code" href="lgc_8c.html#a96ebe5dcb7186f7ee4ff1cc84ea425b9">iscleared</a>(<a class="code" href="ltable_8h.html#ad11c13e5af1b38ffbb95935a53086fdf">key2tval</a>(n), 1) || <a class="code" href="lgc_8c.html#a96ebe5dcb7186f7ee4ff1cc84ea425b9">iscleared</a>(<a class="code" href="ltable_8h.html#acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</a>(n), 0))) {
<a name="l00369"></a>00369         <a class="code" href="lobject_8h.html#ad9034def7bbc1965ec3d714d84620b07">setnilvalue</a>(<a class="code" href="ltable_8h.html#acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</a>(n));  <span class="comment">/* remove value ... */</span>
<a name="l00370"></a>00370         <a class="code" href="lgc_8c.html#a6ed834aee205ee32cb75522c24051a67">removeentry</a>(n);  <span class="comment">/* remove entry from table */</span>
<a name="l00371"></a>00371       }
<a name="l00372"></a>00372     }
<a name="l00373"></a>00373     l = h-&gt;<a class="code" href="structTable.html#a1b6f3d76efed2011a36ee7c78f65aa70">gclist</a>;
<a name="l00374"></a>00374   }
<a name="l00375"></a>00375 }
<a name="l00376"></a>00376 
<a name="l00377"></a>00377 
<a name="l00378"></a><a class="code" href="lgc_8c.html#aa198d7da2a8502ed70adfe1f7ed38f46">00378</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#aa198d7da2a8502ed70adfe1f7ed38f46">freeobj</a> (<a class="code" href="structlua__State.html">lua_State</a> *L, <a class="code" href="unionGCObject.html">GCObject</a> *o) {
<a name="l00379"></a>00379   <span class="keywordflow">switch</span> (o-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.tt) {
<a name="l00380"></a>00380     <span class="keywordflow">case</span> <a class="code" href="lobject_8h.html#aa2a683d9e42dac5846eefa108297cbf0">LUA_TPROTO</a>: <a class="code" href="lfunc_8c.html#a117c26fb473f6165ee84d70d49a741b7">luaF_freeproto</a>(L, <a class="code" href="lstate_8h.html#a8792af5dd4539a71f6ed8ddb31d079c3">gco2p</a>(o)); <span class="keywordflow">break</span>;
<a name="l00381"></a>00381     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#adaa7fa6e2561c1bc428ba8d265171494">LUA_TFUNCTION</a>: <a class="code" href="lfunc_8c.html#a63b9905e2b6f52f6368a8f8019605c99">luaF_freeclosure</a>(L, <a class="code" href="lstate_8h.html#a003658bade3405a30fe2cf7fee2f7e10">gco2cl</a>(o)); <span class="keywordflow">break</span>;
<a name="l00382"></a>00382     <span class="keywordflow">case</span> <a class="code" href="lobject_8h.html#a3175b6b959953f781a14a9291d9e22b6">LUA_TUPVAL</a>: <a class="code" href="lfunc_8c.html#a6dbd6ab01f9845afc18c4d23a1681bcb">luaF_freeupval</a>(L, <a class="code" href="lstate_8h.html#adc453a25566db47b928eb9bc6f5c7cbe">gco2uv</a>(o)); <span class="keywordflow">break</span>;
<a name="l00383"></a>00383     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#a31620fd8da5b655b7879e16a116ec31a">LUA_TTABLE</a>: <a class="code" href="ltable_8c.html#ac6d94de2e83b5b0865b4aca30dec5c8c">luaH_free</a>(L, <a class="code" href="lstate_8h.html#aaebbd554090bd0625aa3ec0d5309c235">gco2h</a>(o)); <span class="keywordflow">break</span>;
<a name="l00384"></a>00384     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#a028a8d8aae9580c465aabcd0c11334d9">LUA_TTHREAD</a>: {
<a name="l00385"></a>00385       <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(<a class="code" href="lstate_8h.html#a52c467e11bd40cad5ca78372f7f67b4d">gco2th</a>(o) != L &amp;&amp; <a class="code" href="lstate_8h.html#a52c467e11bd40cad5ca78372f7f67b4d">gco2th</a>(o) != <a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L)-&gt;mainthread);
<a name="l00386"></a>00386       <a class="code" href="lstate_8c.html#a8c121cf8444c9c54e934aeb509c4b73a">luaE_freethread</a>(L, <a class="code" href="lstate_8h.html#a52c467e11bd40cad5ca78372f7f67b4d">gco2th</a>(o));
<a name="l00387"></a>00387       <span class="keywordflow">break</span>;
<a name="l00388"></a>00388     }
<a name="l00389"></a>00389     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#a57de20d87bb5131a3159f2bd52e3fab6">LUA_TSTRING</a>: {
<a name="l00390"></a>00390       <a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L)-&gt;strt.nuse--;
<a name="l00391"></a>00391       <a class="code" href="lmem_8h.html#a159fd0a4f45c4aa195990526f9d0bf01">luaM_freemem</a>(L, o, <a class="code" href="lstring_8h.html#ad8230fe0e80ccb2a1cf2a79d21c5a009">sizestring</a>(<a class="code" href="lstate_8h.html#af6c16f3aa27ad97ea1bcaa31e05e0b06">gco2ts</a>(o)));
<a name="l00392"></a>00392       <span class="keywordflow">break</span>;
<a name="l00393"></a>00393     }
<a name="l00394"></a>00394     <span class="keywordflow">case</span> <a class="code" href="lua_8h.html#a84fd4c52cea4073671a4cd0eb7026dc7">LUA_TUSERDATA</a>: {
<a name="l00395"></a>00395       <a class="code" href="lmem_8h.html#a159fd0a4f45c4aa195990526f9d0bf01">luaM_freemem</a>(L, o, <a class="code" href="lstring_8h.html#a6f33920ba30f126225528b62bf50c673">sizeudata</a>(<a class="code" href="lstate_8h.html#a55e9a228ad0d3a82ee9cfc353002fd8a">gco2u</a>(o)));
<a name="l00396"></a>00396       <span class="keywordflow">break</span>;
<a name="l00397"></a>00397     }
<a name="l00398"></a>00398     <span class="keywordflow">default</span>: <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(0);
<a name="l00399"></a>00399   }
<a name="l00400"></a>00400 }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402 
<a name="l00403"></a>00403 
<a name="l00404"></a><a class="code" href="lgc_8c.html#a60b41ae74b2202f8b38a8a5b8527de74">00404</a> <span class="preprocessor">#define sweepwholelist(L,p) sweeplist(L,p,MAX_LUMEM)</span>
<a name="l00405"></a>00405 <span class="preprocessor"></span>
<a name="l00406"></a>00406 
<a name="l00407"></a><a class="code" href="lgc_8c.html#a1a347c9874b03409ec489cbf418c40a3">00407</a> <span class="keyword">static</span> <a class="code" href="unionGCObject.html">GCObject</a> **<a class="code" href="lgc_8c.html#a1a347c9874b03409ec489cbf418c40a3">sweeplist</a> (<a class="code" href="structlua__State.html">lua_State</a> *L, <a class="code" href="unionGCObject.html">GCObject</a> **p, <a class="code" href="llimits_8h.html#a5bad522ae691bff7310f85afccf49170">lu_mem</a> count) {
<a name="l00408"></a>00408   <a class="code" href="unionGCObject.html">GCObject</a> *curr;
<a name="l00409"></a>00409   <a class="code" href="structglobal__State.html">global_State</a> *g = <a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L);
<a name="l00410"></a>00410   <span class="keywordtype">int</span> deadmask = <a class="code" href="lgc_8h.html#a486df16493498577d4081a8c231154f0">otherwhite</a>(g);
<a name="l00411"></a>00411   <span class="keywordflow">while</span> ((curr = *p) != NULL &amp;&amp; count-- &gt; 0) {
<a name="l00412"></a>00412     <span class="keywordflow">if</span> (curr-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.tt == <a class="code" href="lua_8h.html#a028a8d8aae9580c465aabcd0c11334d9">LUA_TTHREAD</a>)  <span class="comment">/* sweep open upvalues of each thread */</span>
<a name="l00413"></a>00413       <a class="code" href="lgc_8c.html#a60b41ae74b2202f8b38a8a5b8527de74">sweepwholelist</a>(L, &amp;<a class="code" href="lstate_8h.html#a52c467e11bd40cad5ca78372f7f67b4d">gco2th</a>(curr)-&gt;openupval);
<a name="l00414"></a>00414     <span class="keywordflow">if</span> ((curr-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.marked ^ <a class="code" href="lgc_8h.html#a0acb34c1b3d1234f11ee9fdc34df3f71">WHITEBITS</a>) &amp; deadmask) {  <span class="comment">/* not dead? */</span>
<a name="l00415"></a>00415       <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(!<a class="code" href="lgc_8h.html#acc409eb45f598d23d8388fc9e96189ea">isdead</a>(g, curr) || <a class="code" href="lgc_8h.html#a25c19ff3161e2a2395ba69fdef49915f">testbit</a>(curr-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.marked, <a class="code" href="lgc_8h.html#a67c15c86307cc3d1eb009cee0aab855f">FIXEDBIT</a>));
<a name="l00416"></a>00416       <a class="code" href="lgc_8c.html#ada061b1d508c516b2e53f546521b3eeb">makewhite</a>(g, curr);  <span class="comment">/* make it white (for next cycle) */</span>
<a name="l00417"></a>00417       p = &amp;curr-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.next;
<a name="l00418"></a>00418     }
<a name="l00419"></a>00419     <span class="keywordflow">else</span> {  <span class="comment">/* must erase `curr&apos; */</span>
<a name="l00420"></a>00420       <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(<a class="code" href="lgc_8h.html#acc409eb45f598d23d8388fc9e96189ea">isdead</a>(g, curr) || deadmask == <a class="code" href="lgc_8h.html#af25866c39979dd1f72110cbd3a1a427d">bitmask</a>(<a class="code" href="lgc_8h.html#a79c71f30e4e3374ced9c1f801beb32a4">SFIXEDBIT</a>));
<a name="l00421"></a>00421       *p = curr-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.next;
<a name="l00422"></a>00422       <span class="keywordflow">if</span> (curr == g-&gt;<a class="code" href="structglobal__State.html#a80eccc9fb1fdf5501c58eb11e5dc520e">rootgc</a>)  <span class="comment">/* is the first element of the list? */</span>
<a name="l00423"></a>00423         g-&gt;<a class="code" href="structglobal__State.html#a80eccc9fb1fdf5501c58eb11e5dc520e">rootgc</a> = curr-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.next;  <span class="comment">/* adjust first */</span>
<a name="l00424"></a>00424       <a class="code" href="lgc_8c.html#aa198d7da2a8502ed70adfe1f7ed38f46">freeobj</a>(L, curr);
<a name="l00425"></a>00425     }
<a name="l00426"></a>00426   }
<a name="l00427"></a>00427   <span class="keywordflow">return</span> p;
<a name="l00428"></a>00428 }
<a name="l00429"></a>00429 
<a name="l00430"></a>00430 
<a name="l00431"></a><a class="code" href="lgc_8c.html#aace8516e609d7409e789e7b2c190b9c2">00431</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#aace8516e609d7409e789e7b2c190b9c2">checkSizes</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00432"></a>00432   <a class="code" href="structglobal__State.html">global_State</a> *g = <a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L);
<a name="l00433"></a>00433   <span class="comment">/* check size of string hash */</span>
<a name="l00434"></a>00434   <span class="keywordflow">if</span> (g-&gt;<a class="code" href="structglobal__State.html#a8cdea736db8d268e488aa9e9fa5c992c">strt</a>.<a class="code" href="structstringtable.html#ad7c9469851e685d30693fe5866faf305">nuse</a> &lt; <a class="code" href="llimits_8h.html#af17d62ec9e237a7644de6b9b34a48a34">cast</a>(<a class="code" href="llimits_8h.html#a32baa465eb99f443ffc95cdd546c98cd">lu_int32</a>, g-&gt;<a class="code" href="structglobal__State.html#a8cdea736db8d268e488aa9e9fa5c992c">strt</a>.<a class="code" href="structstringtable.html#a10674affaad79ff819b6aa3b4618b94e">size</a>/4) &amp;&amp;
<a name="l00435"></a>00435       g-&gt;<a class="code" href="structglobal__State.html#a8cdea736db8d268e488aa9e9fa5c992c">strt</a>.<a class="code" href="structstringtable.html#a10674affaad79ff819b6aa3b4618b94e">size</a> &gt; <a class="code" href="llimits_8h.html#a91604f8876fd042d7b1cdbade17927e6">MINSTRTABSIZE</a>*2)
<a name="l00436"></a>00436     <a class="code" href="lstring_8c.html#a88a409a2e7eee2106940f69d7884c471">luaS_resize</a>(L, g-&gt;<a class="code" href="structglobal__State.html#a8cdea736db8d268e488aa9e9fa5c992c">strt</a>.<a class="code" href="structstringtable.html#a10674affaad79ff819b6aa3b4618b94e">size</a>/2);  <span class="comment">/* table is too big */</span>
<a name="l00437"></a>00437   <span class="comment">/* check size of buffer */</span>
<a name="l00438"></a>00438   <span class="keywordflow">if</span> (<a class="code" href="lzio_8h.html#a072ede62ba384b9d5fdedbb80eaf3ee1">luaZ_sizebuffer</a>(&amp;g-&gt;<a class="code" href="structglobal__State.html#a7ba3bd769769241f717761a9bef3be23">buff</a>) &gt; <a class="code" href="llimits_8h.html#aa0320f75a72bf131ae24d39111ac9938">LUA_MINBUFFER</a>*2) {  <span class="comment">/* buffer too big? */</span>
<a name="l00439"></a>00439     <span class="keywordtype">size_t</span> newsize = <a class="code" href="lzio_8h.html#a072ede62ba384b9d5fdedbb80eaf3ee1">luaZ_sizebuffer</a>(&amp;g-&gt;<a class="code" href="structglobal__State.html#a7ba3bd769769241f717761a9bef3be23">buff</a>) / 2;
<a name="l00440"></a>00440     <a class="code" href="lzio_8h.html#ab158420acf019b3a45e8ae6e65b51fdb">luaZ_resizebuffer</a>(L, &amp;g-&gt;<a class="code" href="structglobal__State.html#a7ba3bd769769241f717761a9bef3be23">buff</a>, newsize);
<a name="l00441"></a>00441   }
<a name="l00442"></a>00442 }
<a name="l00443"></a>00443 
<a name="l00444"></a>00444 
<a name="l00445"></a><a class="code" href="lgc_8c.html#aaf7c6e9e6a93da6bb64ffe7654668ba3">00445</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#aaf7c6e9e6a93da6bb64ffe7654668ba3">GCTM</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00446"></a>00446   <a class="code" href="structglobal__State.html">global_State</a> *g = <a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L);
<a name="l00447"></a>00447   <a class="code" href="unionGCObject.html">GCObject</a> *o = g-&gt;<a class="code" href="structglobal__State.html#a8f11ac1643d581a8340f8b894b1ce869">tmudata</a>-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.next;  <span class="comment">/* get first element */</span>
<a name="l00448"></a>00448   <a class="code" href="unionUdata.html">Udata</a> *udata = <a class="code" href="lstate_8h.html#aafc07a99b564b1b307212c61cd9b904a">rawgco2u</a>(o);
<a name="l00449"></a>00449   <span class="keyword">const</span> <a class="code" href="structlua__TValue.html">TValue</a> *tm;
<a name="l00450"></a>00450   <span class="comment">/* remove udata from `tmudata&apos; */</span>
<a name="l00451"></a>00451   <span class="keywordflow">if</span> (o == g-&gt;<a class="code" href="structglobal__State.html#a8f11ac1643d581a8340f8b894b1ce869">tmudata</a>)  <span class="comment">/* last element? */</span>
<a name="l00452"></a>00452     g-&gt;<a class="code" href="structglobal__State.html#a8f11ac1643d581a8340f8b894b1ce869">tmudata</a> = NULL;
<a name="l00453"></a>00453   <span class="keywordflow">else</span>
<a name="l00454"></a>00454     g-&gt;<a class="code" href="structglobal__State.html#a8f11ac1643d581a8340f8b894b1ce869">tmudata</a>-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.next = udata-&gt;<a class="code" href="unionUdata.html#a4f62fc133fc7acfb467e2f289e95669d">uv</a>.next;
<a name="l00455"></a>00455   udata-&gt;<a class="code" href="unionUdata.html#a4f62fc133fc7acfb467e2f289e95669d">uv</a>.next = g-&gt;<a class="code" href="structglobal__State.html#a2c81856ac69a92580d4330cd1070c7c5">mainthread</a>-&gt;next;  <span class="comment">/* return it to `root&apos; list */</span>
<a name="l00456"></a>00456   g-&gt;<a class="code" href="structglobal__State.html#a2c81856ac69a92580d4330cd1070c7c5">mainthread</a>-&gt;next = o;
<a name="l00457"></a>00457   <a class="code" href="lgc_8c.html#ada061b1d508c516b2e53f546521b3eeb">makewhite</a>(g, o);
<a name="l00458"></a>00458   tm = <a class="code" href="ltm_8h.html#a0a29ed88450f8f92330a6a411a9c8134">fasttm</a>(L, udata-&gt;<a class="code" href="unionUdata.html#a4f62fc133fc7acfb467e2f289e95669d">uv</a>.<a class="code" href="unionUdata.html#a39f828bdcf3f046e285ffbecfcaea56b">metatable</a>, <a class="code" href="ltm_8h.html#a69e345ae253d250b61a03f1d6871c8d1a01e1b0be5e2785471e19db3665960536">TM_GC</a>);
<a name="l00459"></a>00459   <span class="keywordflow">if</span> (tm != NULL) {
<a name="l00460"></a>00460     <a class="code" href="llimits_8h.html#ae1fe9ac10d9803bd1d7bdf30b18bad68">lu_byte</a> oldah = L-&gt;<a class="code" href="structlua__State.html#ac2903d4a712ca1c2d114f541636490f5">allowhook</a>;
<a name="l00461"></a>00461     <a class="code" href="llimits_8h.html#a5bad522ae691bff7310f85afccf49170">lu_mem</a> oldt = g-&gt;<a class="code" href="structglobal__State.html#aa9ac0098ecb410b77df6c05188442ac6">GCthreshold</a>;
<a name="l00462"></a>00462     L-&gt;<a class="code" href="structlua__State.html#ac2903d4a712ca1c2d114f541636490f5">allowhook</a> = 0;  <span class="comment">/* stop debug hooks during GC tag method */</span>
<a name="l00463"></a>00463     g-&gt;<a class="code" href="structglobal__State.html#aa9ac0098ecb410b77df6c05188442ac6">GCthreshold</a> = 2*g-&gt;<a class="code" href="structglobal__State.html#a8c2db9bdf2b63884b770acbbc8f0d25c">totalbytes</a>;  <span class="comment">/* avoid GC steps */</span>
<a name="l00464"></a>00464     <a class="code" href="lobject_8h.html#a1c51b9462c606f1f97242fae6b1220d1">setobj2s</a>(L, L-&gt;<a class="code" href="structlua__State.html#a195f448e76fd404953fa1962d28212a3">top</a>, tm);
<a name="l00465"></a>00465     <a class="code" href="lobject_8h.html#ab358ecf44046d8def185fed182944fc1">setuvalue</a>(L, L-&gt;<a class="code" href="structlua__State.html#a195f448e76fd404953fa1962d28212a3">top</a>+1, udata);
<a name="l00466"></a>00466     L-&gt;<a class="code" href="structlua__State.html#a195f448e76fd404953fa1962d28212a3">top</a> += 2;
<a name="l00467"></a>00467     <a class="code" href="ldo_8c.html#a5483fddd87ca999e7d037bf397ab7997">luaD_call</a>(L, L-&gt;<a class="code" href="structlua__State.html#a195f448e76fd404953fa1962d28212a3">top</a> - 2, 0);
<a name="l00468"></a>00468     L-&gt;<a class="code" href="structlua__State.html#ac2903d4a712ca1c2d114f541636490f5">allowhook</a> = oldah;  <span class="comment">/* restore hooks */</span>
<a name="l00469"></a>00469     g-&gt;<a class="code" href="structglobal__State.html#aa9ac0098ecb410b77df6c05188442ac6">GCthreshold</a> = oldt;  <span class="comment">/* restore threshold */</span>
<a name="l00470"></a>00470   }
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 <span class="comment">/*</span>
<a name="l00475"></a>00475 <span class="comment">** Call all GC tag methods</span>
<a name="l00476"></a>00476 <span class="comment">*/</span>
<a name="l00477"></a><a class="code" href="lgc_8h.html#a04f20077e945cc6979d717d61144ae2c">00477</a> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#a0388006a78218c113dfa6cc19d2da373">luaC_callGCTM</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00478"></a>00478   <span class="keywordflow">while</span> (<a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L)-&gt;tmudata)
<a name="l00479"></a>00479     <a class="code" href="lgc_8c.html#aaf7c6e9e6a93da6bb64ffe7654668ba3">GCTM</a>(L);
<a name="l00480"></a>00480 }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482 
<a name="l00483"></a><a class="code" href="lgc_8h.html#af4b3a48a3ac631354692715b9266ef7e">00483</a> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#a5cb43c5bd8d56c50047cbe33f55f1520">luaC_freeall</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00484"></a>00484   <a class="code" href="structglobal__State.html">global_State</a> *g = <a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L);
<a name="l00485"></a>00485   <span class="keywordtype">int</span> i;
<a name="l00486"></a>00486   g-&gt;<a class="code" href="structglobal__State.html#a31fbedd19538500531d49532226a001a">currentwhite</a> = <a class="code" href="lgc_8h.html#a0acb34c1b3d1234f11ee9fdc34df3f71">WHITEBITS</a> | <a class="code" href="lgc_8h.html#af25866c39979dd1f72110cbd3a1a427d">bitmask</a>(<a class="code" href="lgc_8h.html#a79c71f30e4e3374ced9c1f801beb32a4">SFIXEDBIT</a>);  <span class="comment">/* mask to collect all elements */</span>
<a name="l00487"></a>00487   <a class="code" href="lgc_8c.html#a60b41ae74b2202f8b38a8a5b8527de74">sweepwholelist</a>(L, &amp;g-&gt;<a class="code" href="structglobal__State.html#a80eccc9fb1fdf5501c58eb11e5dc520e">rootgc</a>);
<a name="l00488"></a>00488   <span class="keywordflow">for</span> (i = 0; i &lt; g-&gt;<a class="code" href="structglobal__State.html#a8cdea736db8d268e488aa9e9fa5c992c">strt</a>.<a class="code" href="structstringtable.html#a10674affaad79ff819b6aa3b4618b94e">size</a>; i++)  <span class="comment">/* free all string lists */</span>
<a name="l00489"></a>00489     <a class="code" href="lgc_8c.html#a60b41ae74b2202f8b38a8a5b8527de74">sweepwholelist</a>(L, &amp;g-&gt;<a class="code" href="structglobal__State.html#a8cdea736db8d268e488aa9e9fa5c992c">strt</a>.<a class="code" href="structstringtable.html#a132ba77978bbf9852ad840e11975e347">hash</a>[i]);
<a name="l00490"></a>00490 }
<a name="l00491"></a>00491 
<a name="l00492"></a>00492 
<a name="l00493"></a><a class="code" href="lgc_8c.html#a9e8dd447c32dde7eeb9fc5da83df09b1">00493</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#a9e8dd447c32dde7eeb9fc5da83df09b1">markmt</a> (<a class="code" href="structglobal__State.html">global_State</a> *g) {
<a name="l00494"></a>00494   <span class="keywordtype">int</span> i;
<a name="l00495"></a>00495   <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="lobject_8h.html#a7d349e859d6c2d9ca1f6b0c1da21a807">NUM_TAGS</a>; i++)
<a name="l00496"></a>00496     <span class="keywordflow">if</span> (g-&gt;<a class="code" href="structglobal__State.html#a8ce9f738bca2651030dad5f034525d89">mt</a>[i]) <a class="code" href="lgc_8c.html#a6ae72c43e48b29944e55933df7f15482">markobject</a>(g, g-&gt;<a class="code" href="structglobal__State.html#a8ce9f738bca2651030dad5f034525d89">mt</a>[i]);
<a name="l00497"></a>00497 }
<a name="l00498"></a>00498 
<a name="l00499"></a>00499 
<a name="l00500"></a>00500 <span class="comment">/* mark root set */</span>
<a name="l00501"></a><a class="code" href="lgc_8c.html#a6c876056ffab0ba795f687f326243a62">00501</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#a6c876056ffab0ba795f687f326243a62">markroot</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00502"></a>00502   <a class="code" href="structglobal__State.html">global_State</a> *g = <a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L);
<a name="l00503"></a>00503   g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a> = NULL;
<a name="l00504"></a>00504   g-&gt;<a class="code" href="structglobal__State.html#a2ccaa5d2e98c086489c04e2045082535">grayagain</a> = NULL;
<a name="l00505"></a>00505   g-&gt;<a class="code" href="structglobal__State.html#ab84f67e3b1e863392e504e9d13787891">weak</a> = NULL;
<a name="l00506"></a>00506   <a class="code" href="lgc_8c.html#a6ae72c43e48b29944e55933df7f15482">markobject</a>(g, g-&gt;<a class="code" href="structglobal__State.html#a2c81856ac69a92580d4330cd1070c7c5">mainthread</a>);
<a name="l00507"></a>00507   <span class="comment">/* make global table be traversed before main stack */</span>
<a name="l00508"></a>00508   <a class="code" href="lgc_8c.html#a2dd4136ac29665568973c074bc450849">markvalue</a>(g, <a class="code" href="lstate_8h.html#a1108b4374aa20059cd53d90b638c0e4b">gt</a>(g-&gt;<a class="code" href="structglobal__State.html#a2c81856ac69a92580d4330cd1070c7c5">mainthread</a>));
<a name="l00509"></a>00509   <a class="code" href="lgc_8c.html#a2dd4136ac29665568973c074bc450849">markvalue</a>(g, <a class="code" href="lstate_8h.html#ad294d19c007815f4c238efbd221ea705">registry</a>(L));
<a name="l00510"></a>00510   <a class="code" href="lgc_8c.html#a9e8dd447c32dde7eeb9fc5da83df09b1">markmt</a>(g);
<a name="l00511"></a>00511   g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> = <a class="code" href="lgc_8h.html#a2ed301793747f3a2d0a7fc7d64d482fd">GCSpropagate</a>;
<a name="l00512"></a>00512 }
<a name="l00513"></a>00513 
<a name="l00514"></a>00514 
<a name="l00515"></a><a class="code" href="lgc_8c.html#a846c8a9319e7fb8d2cbc00cadd55205d">00515</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#a846c8a9319e7fb8d2cbc00cadd55205d">remarkupvals</a> (<a class="code" href="structglobal__State.html">global_State</a> *g) {
<a name="l00516"></a>00516   <a class="code" href="structUpVal.html">UpVal</a> *uv;
<a name="l00517"></a>00517   <span class="keywordflow">for</span> (uv = g-&gt;<a class="code" href="structglobal__State.html#a640a585a8c5d8c68b1c0118010b7674f">uvhead</a>.<a class="code" href="structUpVal.html#ad5ec24c0916396cc9c39b5f35e9a6836">u</a>.<a class="code" href="structUpVal.html#a8d2b48730d5699d66dc5a3f604d227b4">l</a>.next; uv != &amp;g-&gt;<a class="code" href="structglobal__State.html#a640a585a8c5d8c68b1c0118010b7674f">uvhead</a>; uv = uv-&gt;<a class="code" href="structUpVal.html#ad5ec24c0916396cc9c39b5f35e9a6836">u</a>.<a class="code" href="structUpVal.html#a8d2b48730d5699d66dc5a3f604d227b4">l</a>.next) {
<a name="l00518"></a>00518     <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(uv-&gt;<a class="code" href="structUpVal.html#ad5ec24c0916396cc9c39b5f35e9a6836">u</a>.<a class="code" href="structUpVal.html#a8d2b48730d5699d66dc5a3f604d227b4">l</a>.next-&gt;u.l.prev == uv &amp;&amp; uv-&gt;<a class="code" href="structUpVal.html#ad5ec24c0916396cc9c39b5f35e9a6836">u</a>.<a class="code" href="structUpVal.html#a8d2b48730d5699d66dc5a3f604d227b4">l</a>.prev-&gt;u.l.next == uv);
<a name="l00519"></a>00519     <span class="keywordflow">if</span> (<a class="code" href="lgc_8h.html#ad417e22072630b33cf74a3055b27d8d7">isgray</a>(<a class="code" href="lstate_8h.html#a254ca29aba03e47440082d4591a9734e">obj2gco</a>(uv)))
<a name="l00520"></a>00520       <a class="code" href="lgc_8c.html#a2dd4136ac29665568973c074bc450849">markvalue</a>(g, uv-&gt;<a class="code" href="structUpVal.html#aeb2c6e23d98883dd7f117de69de23e54">v</a>);
<a name="l00521"></a>00521   }
<a name="l00522"></a>00522 }
<a name="l00523"></a>00523 
<a name="l00524"></a>00524 
<a name="l00525"></a><a class="code" href="lgc_8c.html#a4658390b66f99413613f84b14b15127a">00525</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#a4658390b66f99413613f84b14b15127a">atomic</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00526"></a>00526   <a class="code" href="structglobal__State.html">global_State</a> *g = <a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L);
<a name="l00527"></a>00527   <span class="keywordtype">size_t</span> udsize;  <span class="comment">/* total size of userdata to be finalized */</span>
<a name="l00528"></a>00528   <span class="comment">/* remark occasional upvalues of (maybe) dead threads */</span>
<a name="l00529"></a>00529   <a class="code" href="lgc_8c.html#a846c8a9319e7fb8d2cbc00cadd55205d">remarkupvals</a>(g);
<a name="l00530"></a>00530   <span class="comment">/* traverse objects cautch by write barrier and by &apos;remarkupvals&apos; */</span>
<a name="l00531"></a>00531   <a class="code" href="lgc_8c.html#a5dc2b7a11d04f03d72a0f691eaae0582">propagateall</a>(g);
<a name="l00532"></a>00532   <span class="comment">/* remark weak tables */</span>
<a name="l00533"></a>00533   g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a> = g-&gt;<a class="code" href="structglobal__State.html#ab84f67e3b1e863392e504e9d13787891">weak</a>;
<a name="l00534"></a>00534   g-&gt;<a class="code" href="structglobal__State.html#ab84f67e3b1e863392e504e9d13787891">weak</a> = NULL;
<a name="l00535"></a>00535   <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(!<a class="code" href="lgc_8h.html#a4c0ce78d476460d2e54914301f4a4bf7">iswhite</a>(<a class="code" href="lstate_8h.html#a254ca29aba03e47440082d4591a9734e">obj2gco</a>(g-&gt;<a class="code" href="structglobal__State.html#a2c81856ac69a92580d4330cd1070c7c5">mainthread</a>)));
<a name="l00536"></a>00536   <a class="code" href="lgc_8c.html#a6ae72c43e48b29944e55933df7f15482">markobject</a>(g, L);  <span class="comment">/* mark running thread */</span>
<a name="l00537"></a>00537   <a class="code" href="lgc_8c.html#a9e8dd447c32dde7eeb9fc5da83df09b1">markmt</a>(g);  <span class="comment">/* mark basic metatables (again) */</span>
<a name="l00538"></a>00538   <a class="code" href="lgc_8c.html#a5dc2b7a11d04f03d72a0f691eaae0582">propagateall</a>(g);
<a name="l00539"></a>00539   <span class="comment">/* remark gray again */</span>
<a name="l00540"></a>00540   g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a> = g-&gt;<a class="code" href="structglobal__State.html#a2ccaa5d2e98c086489c04e2045082535">grayagain</a>;
<a name="l00541"></a>00541   g-&gt;<a class="code" href="structglobal__State.html#a2ccaa5d2e98c086489c04e2045082535">grayagain</a> = NULL;
<a name="l00542"></a>00542   <a class="code" href="lgc_8c.html#a5dc2b7a11d04f03d72a0f691eaae0582">propagateall</a>(g);
<a name="l00543"></a>00543   udsize = <a class="code" href="lgc_8c.html#a208da9b7b267923ec22a90b2966979f6">luaC_separateudata</a>(L, 0);  <span class="comment">/* separate userdata to be finalized */</span>
<a name="l00544"></a>00544   <a class="code" href="lgc_8c.html#a183407747db3400e27fa703c2385a704">marktmu</a>(g);  <span class="comment">/* mark `preserved&apos; userdata */</span>
<a name="l00545"></a>00545   udsize += <a class="code" href="lgc_8c.html#a5dc2b7a11d04f03d72a0f691eaae0582">propagateall</a>(g);  <span class="comment">/* remark, to propagate `preserveness&apos; */</span>
<a name="l00546"></a>00546   <a class="code" href="lgc_8c.html#af61386b12aefeb4a5e9cabae6dcddc65">cleartable</a>(g-&gt;<a class="code" href="structglobal__State.html#ab84f67e3b1e863392e504e9d13787891">weak</a>);  <span class="comment">/* remove collected objects from weak tables */</span>
<a name="l00547"></a>00547   <span class="comment">/* flip current white */</span>
<a name="l00548"></a>00548   g-&gt;<a class="code" href="structglobal__State.html#a31fbedd19538500531d49532226a001a">currentwhite</a> = <a class="code" href="llimits_8h.html#a596f5b6e992f53a5a4e5732083448dd4">cast_byte</a>(<a class="code" href="lgc_8h.html#a486df16493498577d4081a8c231154f0">otherwhite</a>(g));
<a name="l00549"></a>00549   g-&gt;<a class="code" href="structglobal__State.html#a3ed87bf66fdfcaa467c0a1f49078885e">sweepstrgc</a> = 0;
<a name="l00550"></a>00550   g-&gt;<a class="code" href="structglobal__State.html#a357ff5a5981fc6c64825508c7718fbbc">sweepgc</a> = &amp;g-&gt;<a class="code" href="structglobal__State.html#a80eccc9fb1fdf5501c58eb11e5dc520e">rootgc</a>;
<a name="l00551"></a>00551   g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> = <a class="code" href="lgc_8h.html#abab475c862e8b12eaa5116240f9eb585">GCSsweepstring</a>;
<a name="l00552"></a>00552   g-&gt;<a class="code" href="structglobal__State.html#ae46cf63c1cff8908ab4f36a9918962b6">estimate</a> = g-&gt;<a class="code" href="structglobal__State.html#a8c2db9bdf2b63884b770acbbc8f0d25c">totalbytes</a> - udsize;  <span class="comment">/* first estimate */</span>
<a name="l00553"></a>00553 }
<a name="l00554"></a>00554 
<a name="l00555"></a>00555 
<a name="l00556"></a><a class="code" href="lgc_8c.html#ab48072941cba39be43a7bd6d9eabc72a">00556</a> <span class="keyword">static</span> <a class="code" href="llimits_8h.html#a85638ce9e30eaebe04b1c7d0a8f98377">l_mem</a> <a class="code" href="lgc_8c.html#ab48072941cba39be43a7bd6d9eabc72a">singlestep</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00557"></a>00557   <a class="code" href="structglobal__State.html">global_State</a> *g = <a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L);
<a name="l00558"></a>00558   <span class="comment">/*lua_checkmemory(L);*/</span>
<a name="l00559"></a>00559   <span class="keywordflow">switch</span> (g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a>) {
<a name="l00560"></a>00560     <span class="keywordflow">case</span> <a class="code" href="lgc_8h.html#ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</a>: {
<a name="l00561"></a>00561       <a class="code" href="lgc_8c.html#a6c876056ffab0ba795f687f326243a62">markroot</a>(L);  <span class="comment">/* start a new collection */</span>
<a name="l00562"></a>00562       <span class="keywordflow">return</span> 0;
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564     <span class="keywordflow">case</span> <a class="code" href="lgc_8h.html#a2ed301793747f3a2d0a7fc7d64d482fd">GCSpropagate</a>: {
<a name="l00565"></a>00565       <span class="keywordflow">if</span> (g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a>)
<a name="l00566"></a>00566         <span class="keywordflow">return</span> <a class="code" href="lgc_8c.html#ab7d3f49b190e7443a0f6f9be5687531d">propagatemark</a>(g);
<a name="l00567"></a>00567       <span class="keywordflow">else</span> {  <span class="comment">/* no more `gray&apos; objects */</span>
<a name="l00568"></a>00568         <a class="code" href="lgc_8c.html#a4658390b66f99413613f84b14b15127a">atomic</a>(L);  <span class="comment">/* finish mark phase */</span>
<a name="l00569"></a>00569         <span class="keywordflow">return</span> 0;
<a name="l00570"></a>00570       }
<a name="l00571"></a>00571     }
<a name="l00572"></a>00572     <span class="keywordflow">case</span> <a class="code" href="lgc_8h.html#abab475c862e8b12eaa5116240f9eb585">GCSsweepstring</a>: {
<a name="l00573"></a>00573       <a class="code" href="llimits_8h.html#a5bad522ae691bff7310f85afccf49170">lu_mem</a> old = g-&gt;<a class="code" href="structglobal__State.html#a8c2db9bdf2b63884b770acbbc8f0d25c">totalbytes</a>;
<a name="l00574"></a>00574       <a class="code" href="lgc_8c.html#a60b41ae74b2202f8b38a8a5b8527de74">sweepwholelist</a>(L, &amp;g-&gt;<a class="code" href="structglobal__State.html#a8cdea736db8d268e488aa9e9fa5c992c">strt</a>.<a class="code" href="structstringtable.html#a132ba77978bbf9852ad840e11975e347">hash</a>[g-&gt;<a class="code" href="structglobal__State.html#a3ed87bf66fdfcaa467c0a1f49078885e">sweepstrgc</a>++]);
<a name="l00575"></a>00575       <span class="keywordflow">if</span> (g-&gt;<a class="code" href="structglobal__State.html#a3ed87bf66fdfcaa467c0a1f49078885e">sweepstrgc</a> &gt;= g-&gt;<a class="code" href="structglobal__State.html#a8cdea736db8d268e488aa9e9fa5c992c">strt</a>.<a class="code" href="structstringtable.html#a10674affaad79ff819b6aa3b4618b94e">size</a>)  <span class="comment">/* nothing more to sweep? */</span>
<a name="l00576"></a>00576         g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> = <a class="code" href="lgc_8h.html#a3396f37021e6f155dff7d2b8384af376">GCSsweep</a>;  <span class="comment">/* end sweep-string phase */</span>
<a name="l00577"></a>00577       <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(old &gt;= g-&gt;<a class="code" href="structglobal__State.html#a8c2db9bdf2b63884b770acbbc8f0d25c">totalbytes</a>);
<a name="l00578"></a>00578       g-&gt;<a class="code" href="structglobal__State.html#ae46cf63c1cff8908ab4f36a9918962b6">estimate</a> -= old - g-&gt;<a class="code" href="structglobal__State.html#a8c2db9bdf2b63884b770acbbc8f0d25c">totalbytes</a>;
<a name="l00579"></a>00579       <span class="keywordflow">return</span> <a class="code" href="lgc_8c.html#ac6240a70277f6388ab6795b7dc30cb1c">GCSWEEPCOST</a>;
<a name="l00580"></a>00580     }
<a name="l00581"></a>00581     <span class="keywordflow">case</span> <a class="code" href="lgc_8h.html#a3396f37021e6f155dff7d2b8384af376">GCSsweep</a>: {
<a name="l00582"></a>00582       <a class="code" href="llimits_8h.html#a5bad522ae691bff7310f85afccf49170">lu_mem</a> old = g-&gt;<a class="code" href="structglobal__State.html#a8c2db9bdf2b63884b770acbbc8f0d25c">totalbytes</a>;
<a name="l00583"></a>00583       g-&gt;<a class="code" href="structglobal__State.html#a357ff5a5981fc6c64825508c7718fbbc">sweepgc</a> = <a class="code" href="lgc_8c.html#a1a347c9874b03409ec489cbf418c40a3">sweeplist</a>(L, g-&gt;<a class="code" href="structglobal__State.html#a357ff5a5981fc6c64825508c7718fbbc">sweepgc</a>, <a class="code" href="lgc_8c.html#ac31abb557425090d41f055c797049ba8">GCSWEEPMAX</a>);
<a name="l00584"></a>00584       <span class="keywordflow">if</span> (*g-&gt;<a class="code" href="structglobal__State.html#a357ff5a5981fc6c64825508c7718fbbc">sweepgc</a> == NULL) {  <span class="comment">/* nothing more to sweep? */</span>
<a name="l00585"></a>00585         <a class="code" href="lgc_8c.html#aace8516e609d7409e789e7b2c190b9c2">checkSizes</a>(L);
<a name="l00586"></a>00586         g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> = <a class="code" href="lgc_8h.html#ab993ca92b5620de4d945286a5338d52b">GCSfinalize</a>;  <span class="comment">/* end sweep phase */</span>
<a name="l00587"></a>00587       }
<a name="l00588"></a>00588       <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(old &gt;= g-&gt;<a class="code" href="structglobal__State.html#a8c2db9bdf2b63884b770acbbc8f0d25c">totalbytes</a>);
<a name="l00589"></a>00589       g-&gt;<a class="code" href="structglobal__State.html#ae46cf63c1cff8908ab4f36a9918962b6">estimate</a> -= old - g-&gt;<a class="code" href="structglobal__State.html#a8c2db9bdf2b63884b770acbbc8f0d25c">totalbytes</a>;
<a name="l00590"></a>00590       <span class="keywordflow">return</span> <a class="code" href="lgc_8c.html#ac31abb557425090d41f055c797049ba8">GCSWEEPMAX</a>*<a class="code" href="lgc_8c.html#ac6240a70277f6388ab6795b7dc30cb1c">GCSWEEPCOST</a>;
<a name="l00591"></a>00591     }
<a name="l00592"></a>00592     <span class="keywordflow">case</span> <a class="code" href="lgc_8h.html#ab993ca92b5620de4d945286a5338d52b">GCSfinalize</a>: {
<a name="l00593"></a>00593       <span class="keywordflow">if</span> (g-&gt;<a class="code" href="structglobal__State.html#a8f11ac1643d581a8340f8b894b1ce869">tmudata</a>) {
<a name="l00594"></a>00594         <a class="code" href="lgc_8c.html#aaf7c6e9e6a93da6bb64ffe7654668ba3">GCTM</a>(L);
<a name="l00595"></a>00595         <span class="keywordflow">if</span> (g-&gt;<a class="code" href="structglobal__State.html#ae46cf63c1cff8908ab4f36a9918962b6">estimate</a> &gt; <a class="code" href="lgc_8c.html#a84dfd5e385ed6792c171df6b6a972179">GCFINALIZECOST</a>)
<a name="l00596"></a>00596           g-&gt;<a class="code" href="structglobal__State.html#ae46cf63c1cff8908ab4f36a9918962b6">estimate</a> -= <a class="code" href="lgc_8c.html#a84dfd5e385ed6792c171df6b6a972179">GCFINALIZECOST</a>;
<a name="l00597"></a>00597         <span class="keywordflow">return</span> <a class="code" href="lgc_8c.html#a84dfd5e385ed6792c171df6b6a972179">GCFINALIZECOST</a>;
<a name="l00598"></a>00598       }
<a name="l00599"></a>00599       <span class="keywordflow">else</span> {
<a name="l00600"></a>00600         g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> = <a class="code" href="lgc_8h.html#ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</a>;  <span class="comment">/* end collection */</span>
<a name="l00601"></a>00601         g-&gt;<a class="code" href="structglobal__State.html#a2900d5228c66bb92f2d121306bc7d4b1">gcdept</a> = 0;
<a name="l00602"></a>00602         <span class="keywordflow">return</span> 0;
<a name="l00603"></a>00603       }
<a name="l00604"></a>00604     }
<a name="l00605"></a>00605     <span class="keywordflow">default</span>: <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(0); <span class="keywordflow">return</span> 0;
<a name="l00606"></a>00606   }
<a name="l00607"></a>00607 }
<a name="l00608"></a>00608 
<a name="l00609"></a>00609 
<a name="l00610"></a><a class="code" href="lgc_8h.html#a6c71cc4b9e503c0e96c0c4ffcff93900">00610</a> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#ab0133eb7bb37a0a690e0ef71fbc13414">luaC_step</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00611"></a>00611   <a class="code" href="structglobal__State.html">global_State</a> *g = <a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L);
<a name="l00612"></a>00612   <a class="code" href="llimits_8h.html#a85638ce9e30eaebe04b1c7d0a8f98377">l_mem</a> lim = (<a class="code" href="lgc_8c.html#aeb6367d26a4bde87314453841fc5b80c">GCSTEPSIZE</a>/100) * g-&gt;<a class="code" href="structglobal__State.html#acd2271d481c60fa86f30577f88227e1e">gcstepmul</a>;
<a name="l00613"></a>00613   if (lim == 0)
<a name="l00614"></a>00614     lim = (<a class="code" href="llimits_8h.html#a5e67dd5554c315bda4b54cd5ed0e846e">MAX_LUMEM</a>-1)/2;  <span class="comment">/* no limit */</span>
<a name="l00615"></a>00615   g-&gt;<a class="code" href="structglobal__State.html#a2900d5228c66bb92f2d121306bc7d4b1">gcdept</a> += g-&gt;<a class="code" href="structglobal__State.html#a8c2db9bdf2b63884b770acbbc8f0d25c">totalbytes</a> - g-&gt;<a class="code" href="structglobal__State.html#aa9ac0098ecb410b77df6c05188442ac6">GCthreshold</a>;
<a name="l00616"></a>00616   <span class="keywordflow">do</span> {
<a name="l00617"></a>00617     lim -= <a class="code" href="lgc_8c.html#ab48072941cba39be43a7bd6d9eabc72a">singlestep</a>(L);
<a name="l00618"></a>00618     <span class="keywordflow">if</span> (g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> == <a class="code" href="lgc_8h.html#ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</a>)
<a name="l00619"></a>00619       <span class="keywordflow">break</span>;
<a name="l00620"></a>00620   } <span class="keywordflow">while</span> (lim &gt; 0);
<a name="l00621"></a>00621   <span class="keywordflow">if</span> (g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> != <a class="code" href="lgc_8h.html#ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</a>) {
<a name="l00622"></a>00622     <span class="keywordflow">if</span> (g-&gt;<a class="code" href="structglobal__State.html#a2900d5228c66bb92f2d121306bc7d4b1">gcdept</a> &lt; <a class="code" href="lgc_8c.html#aeb6367d26a4bde87314453841fc5b80c">GCSTEPSIZE</a>)
<a name="l00623"></a>00623       g-&gt;<a class="code" href="structglobal__State.html#aa9ac0098ecb410b77df6c05188442ac6">GCthreshold</a> = g-&gt;<a class="code" href="structglobal__State.html#a8c2db9bdf2b63884b770acbbc8f0d25c">totalbytes</a> + <a class="code" href="lgc_8c.html#aeb6367d26a4bde87314453841fc5b80c">GCSTEPSIZE</a>;  <span class="comment">/* - lim/g-&gt;gcstepmul;*/</span>
<a name="l00624"></a>00624     <span class="keywordflow">else</span> {
<a name="l00625"></a>00625       g-&gt;<a class="code" href="structglobal__State.html#a2900d5228c66bb92f2d121306bc7d4b1">gcdept</a> -= <a class="code" href="lgc_8c.html#aeb6367d26a4bde87314453841fc5b80c">GCSTEPSIZE</a>;
<a name="l00626"></a>00626       g-&gt;<a class="code" href="structglobal__State.html#aa9ac0098ecb410b77df6c05188442ac6">GCthreshold</a> = g-&gt;<a class="code" href="structglobal__State.html#a8c2db9bdf2b63884b770acbbc8f0d25c">totalbytes</a>;
<a name="l00627"></a>00627     }
<a name="l00628"></a>00628   }
<a name="l00629"></a>00629   <span class="keywordflow">else</span> {
<a name="l00630"></a>00630     <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(g-&gt;<a class="code" href="structglobal__State.html#a8c2db9bdf2b63884b770acbbc8f0d25c">totalbytes</a> &gt;= g-&gt;<a class="code" href="structglobal__State.html#ae46cf63c1cff8908ab4f36a9918962b6">estimate</a>);
<a name="l00631"></a>00631     <a class="code" href="lgc_8c.html#acfcd1e13d0ba5f0a594ac7e977c337d7">setthreshold</a>(g);
<a name="l00632"></a>00632   }
<a name="l00633"></a>00633 }
<a name="l00634"></a>00634 
<a name="l00635"></a>00635 
<a name="l00636"></a><a class="code" href="lgc_8h.html#a171f6d2cda412ee264e5d9c0fe48a0fa">00636</a> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#a42a86c66ac02f72ad364f92a946a09e7">luaC_fullgc</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00637"></a>00637   <a class="code" href="structglobal__State.html">global_State</a> *g = <a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L);
<a name="l00638"></a>00638   <span class="keywordflow">if</span> (g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> &lt;= <a class="code" href="lgc_8h.html#a2ed301793747f3a2d0a7fc7d64d482fd">GCSpropagate</a>) {
<a name="l00639"></a>00639     <span class="comment">/* reset sweep marks to sweep all elements (returning them to white) */</span>
<a name="l00640"></a>00640     g-&gt;<a class="code" href="structglobal__State.html#a3ed87bf66fdfcaa467c0a1f49078885e">sweepstrgc</a> = 0;
<a name="l00641"></a>00641     g-&gt;<a class="code" href="structglobal__State.html#a357ff5a5981fc6c64825508c7718fbbc">sweepgc</a> = &amp;g-&gt;<a class="code" href="structglobal__State.html#a80eccc9fb1fdf5501c58eb11e5dc520e">rootgc</a>;
<a name="l00642"></a>00642     <span class="comment">/* reset other collector lists */</span>
<a name="l00643"></a>00643     g-&gt;<a class="code" href="structglobal__State.html#a2d96e2afbc62ff832ab660ed4c357696">gray</a> = NULL;
<a name="l00644"></a>00644     g-&gt;<a class="code" href="structglobal__State.html#a2ccaa5d2e98c086489c04e2045082535">grayagain</a> = NULL;
<a name="l00645"></a>00645     g-&gt;<a class="code" href="structglobal__State.html#ab84f67e3b1e863392e504e9d13787891">weak</a> = NULL;
<a name="l00646"></a>00646     g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> = <a class="code" href="lgc_8h.html#abab475c862e8b12eaa5116240f9eb585">GCSsweepstring</a>;
<a name="l00647"></a>00647   }
<a name="l00648"></a>00648   <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> != <a class="code" href="lgc_8h.html#ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</a> &amp;&amp; g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> != <a class="code" href="lgc_8h.html#a2ed301793747f3a2d0a7fc7d64d482fd">GCSpropagate</a>);
<a name="l00649"></a>00649   <span class="comment">/* finish any pending sweep phase */</span>
<a name="l00650"></a>00650   <span class="keywordflow">while</span> (g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> != <a class="code" href="lgc_8h.html#ab993ca92b5620de4d945286a5338d52b">GCSfinalize</a>) {
<a name="l00651"></a>00651     <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> == <a class="code" href="lgc_8h.html#abab475c862e8b12eaa5116240f9eb585">GCSsweepstring</a> || g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> == <a class="code" href="lgc_8h.html#a3396f37021e6f155dff7d2b8384af376">GCSsweep</a>);
<a name="l00652"></a>00652     <a class="code" href="lgc_8c.html#ab48072941cba39be43a7bd6d9eabc72a">singlestep</a>(L);
<a name="l00653"></a>00653   }
<a name="l00654"></a>00654   <a class="code" href="lgc_8c.html#a6c876056ffab0ba795f687f326243a62">markroot</a>(L);
<a name="l00655"></a>00655   <span class="keywordflow">while</span> (g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> != <a class="code" href="lgc_8h.html#ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</a>) {
<a name="l00656"></a>00656     <a class="code" href="lgc_8c.html#ab48072941cba39be43a7bd6d9eabc72a">singlestep</a>(L);
<a name="l00657"></a>00657   }
<a name="l00658"></a>00658   <a class="code" href="lgc_8c.html#acfcd1e13d0ba5f0a594ac7e977c337d7">setthreshold</a>(g);
<a name="l00659"></a>00659 }
<a name="l00660"></a>00660 
<a name="l00661"></a>00661 
<a name="l00662"></a><a class="code" href="lgc_8h.html#a8af3e9ea3e7a6faf417e70fff8bef712">00662</a> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#a229ccb24a4a31f5906cf5ef0add24754">luaC_barrierf</a> (<a class="code" href="structlua__State.html">lua_State</a> *L, <a class="code" href="unionGCObject.html">GCObject</a> *o, <a class="code" href="unionGCObject.html">GCObject</a> *v) {
<a name="l00663"></a>00663   <a class="code" href="structglobal__State.html">global_State</a> *g = <a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L);
<a name="l00664"></a>00664   <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(<a class="code" href="lgc_8h.html#ac1e4847ad9a91e4cea36520dc9078365">isblack</a>(o) &amp;&amp; <a class="code" href="lgc_8h.html#a4c0ce78d476460d2e54914301f4a4bf7">iswhite</a>(v) &amp;&amp; !<a class="code" href="lgc_8h.html#acc409eb45f598d23d8388fc9e96189ea">isdead</a>(g, v) &amp;&amp; !<a class="code" href="lgc_8h.html#acc409eb45f598d23d8388fc9e96189ea">isdead</a>(g, o));
<a name="l00665"></a>00665   <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> != <a class="code" href="lgc_8h.html#ab993ca92b5620de4d945286a5338d52b">GCSfinalize</a> &amp;&amp; g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> != <a class="code" href="lgc_8h.html#ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</a>);
<a name="l00666"></a>00666   <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(<a class="code" href="lobject_8h.html#acd205ab396b96fba48e1f758c17a2cf3">ttype</a>(&amp;o-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>) != <a class="code" href="lua_8h.html#a31620fd8da5b655b7879e16a116ec31a">LUA_TTABLE</a>);
<a name="l00667"></a>00667   <span class="comment">/* must keep invariant? */</span>
<a name="l00668"></a>00668   <span class="keywordflow">if</span> (g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> == <a class="code" href="lgc_8h.html#a2ed301793747f3a2d0a7fc7d64d482fd">GCSpropagate</a>)
<a name="l00669"></a>00669     <a class="code" href="lgc_8c.html#aacf3c8ee0eebd5d5b1cd09da000ad53c">reallymarkobject</a>(g, v);  <span class="comment">/* restore invariant */</span>
<a name="l00670"></a>00670   <span class="keywordflow">else</span>  <span class="comment">/* don&apos;t mind */</span>
<a name="l00671"></a>00671     <a class="code" href="lgc_8c.html#ada061b1d508c516b2e53f546521b3eeb">makewhite</a>(g, o);  <span class="comment">/* mark as white just to avoid other barriers */</span>
<a name="l00672"></a>00672 }
<a name="l00673"></a>00673 
<a name="l00674"></a>00674 
<a name="l00675"></a><a class="code" href="lgc_8h.html#a631a021cec501addf77027ac3390f9db">00675</a> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#aba54389e20a51b6687ff598c44bd0d98">luaC_barrierback</a> (<a class="code" href="structlua__State.html">lua_State</a> *L, <a class="code" href="structTable.html">Table</a> *t) {
<a name="l00676"></a>00676   <a class="code" href="structglobal__State.html">global_State</a> *g = <a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L);
<a name="l00677"></a>00677   <a class="code" href="unionGCObject.html">GCObject</a> *o = <a class="code" href="lstate_8h.html#a254ca29aba03e47440082d4591a9734e">obj2gco</a>(t);
<a name="l00678"></a>00678   <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(<a class="code" href="lgc_8h.html#ac1e4847ad9a91e4cea36520dc9078365">isblack</a>(o) &amp;&amp; !<a class="code" href="lgc_8h.html#acc409eb45f598d23d8388fc9e96189ea">isdead</a>(g, o));
<a name="l00679"></a>00679   <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> != <a class="code" href="lgc_8h.html#ab993ca92b5620de4d945286a5338d52b">GCSfinalize</a> &amp;&amp; g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> != <a class="code" href="lgc_8h.html#ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</a>);
<a name="l00680"></a>00680   <a class="code" href="lgc_8c.html#a9490dca59c8a4d659ff7522257943f63">black2gray</a>(o);  <span class="comment">/* make table gray (again) */</span>
<a name="l00681"></a>00681   t-&gt;<a class="code" href="structTable.html#a1b6f3d76efed2011a36ee7c78f65aa70">gclist</a> = g-&gt;<a class="code" href="structglobal__State.html#a2ccaa5d2e98c086489c04e2045082535">grayagain</a>;
<a name="l00682"></a>00682   g-&gt;<a class="code" href="structglobal__State.html#a2ccaa5d2e98c086489c04e2045082535">grayagain</a> = o;
<a name="l00683"></a>00683 }
<a name="l00684"></a>00684 
<a name="l00685"></a>00685 
<a name="l00686"></a><a class="code" href="lgc_8h.html#a6c742071a99df1a3c8b40055f08cf43b">00686</a> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#a8ceb43f94e1513c18f99e7d2ee6f944e">luaC_link</a> (<a class="code" href="structlua__State.html">lua_State</a> *L, <a class="code" href="unionGCObject.html">GCObject</a> *o, <a class="code" href="llimits_8h.html#ae1fe9ac10d9803bd1d7bdf30b18bad68">lu_byte</a> tt) {
<a name="l00687"></a>00687   <a class="code" href="structglobal__State.html">global_State</a> *g = <a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L);
<a name="l00688"></a>00688   o-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.next = g-&gt;<a class="code" href="structglobal__State.html#a80eccc9fb1fdf5501c58eb11e5dc520e">rootgc</a>;
<a name="l00689"></a>00689   g-&gt;<a class="code" href="structglobal__State.html#a80eccc9fb1fdf5501c58eb11e5dc520e">rootgc</a> = o;
<a name="l00690"></a>00690   o-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.marked = <a class="code" href="lgc_8h.html#afaa8a52c4097cf3a5eacd88db94092da">luaC_white</a>(g);
<a name="l00691"></a>00691   o-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.tt = tt;
<a name="l00692"></a>00692 }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694 
<a name="l00695"></a><a class="code" href="lgc_8h.html#a6753bc0cfa5484b060d845bc02fd4d4f">00695</a> <span class="keywordtype">void</span> <a class="code" href="lgc_8c.html#adde678e39ce00c71973bef8ceadda409">luaC_linkupval</a> (<a class="code" href="structlua__State.html">lua_State</a> *L, <a class="code" href="structUpVal.html">UpVal</a> *uv) {
<a name="l00696"></a>00696   <a class="code" href="structglobal__State.html">global_State</a> *g = <a class="code" href="lstate_8h.html#a103db2de6edf3420c6c6c9a282562406">G</a>(L);
<a name="l00697"></a>00697   <a class="code" href="unionGCObject.html">GCObject</a> *o = <a class="code" href="lstate_8h.html#a254ca29aba03e47440082d4591a9734e">obj2gco</a>(uv);
<a name="l00698"></a>00698   o-&gt;<a class="code" href="unionGCObject.html#a1abd8f26ec7f6d3c47da2b9411b87a95">gch</a>.next = g-&gt;<a class="code" href="structglobal__State.html#a80eccc9fb1fdf5501c58eb11e5dc520e">rootgc</a>;  <span class="comment">/* link upvalue into `rootgc&apos; list */</span>
<a name="l00699"></a>00699   g-&gt;<a class="code" href="structglobal__State.html#a80eccc9fb1fdf5501c58eb11e5dc520e">rootgc</a> = o;
<a name="l00700"></a>00700   <span class="keywordflow">if</span> (<a class="code" href="lgc_8h.html#ad417e22072630b33cf74a3055b27d8d7">isgray</a>(o)) { 
<a name="l00701"></a>00701     <span class="keywordflow">if</span> (g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> == <a class="code" href="lgc_8h.html#a2ed301793747f3a2d0a7fc7d64d482fd">GCSpropagate</a>) {
<a name="l00702"></a>00702       <a class="code" href="lgc_8h.html#ae909eb4aa4c23c6ee7757210c183634d">gray2black</a>(o);  <span class="comment">/* closed upvalues need barrier */</span>
<a name="l00703"></a>00703       <a class="code" href="lgc_8h.html#a21660a316c42bc1aad10f115e2261bca">luaC_barrier</a>(L, uv, uv-&gt;<a class="code" href="structUpVal.html#aeb2c6e23d98883dd7f117de69de23e54">v</a>);
<a name="l00704"></a>00704     }
<a name="l00705"></a>00705     <span class="keywordflow">else</span> {  <span class="comment">/* sweep phase: sweep it (turning it into white) */</span>
<a name="l00706"></a>00706       <a class="code" href="lgc_8c.html#ada061b1d508c516b2e53f546521b3eeb">makewhite</a>(g, o);
<a name="l00707"></a>00707       <a class="code" href="llimits_8h.html#a5978f5fda715bd80e845df1e16ad7780">lua_assert</a>(g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> != <a class="code" href="lgc_8h.html#ab993ca92b5620de4d945286a5338d52b">GCSfinalize</a> &amp;&amp; g-&gt;<a class="code" href="structglobal__State.html#aea4d494b8b9accef389f2be8830f7a84">gcstate</a> != <a class="code" href="lgc_8h.html#ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</a>);
<a name="l00708"></a>00708     }
<a name="l00709"></a>00709   }
<a name="l00710"></a>00710 }
<a name="l00711"></a>00711 
</pre></div></div>
<hr size="1">

<p style="text-align: right;">
  <a href="http://www.contextlogger.org/">ContextLogger2</a>&#8212;ContextLogger2 Logger Daemon Internals&#8212;<small>Generated on Mon May 2 13:49:54 2011 by&nbsp;<a href="http://www.doxygen.org/">Doxygen</a> 1.6.1</small>
</p>

</body>
</html>
