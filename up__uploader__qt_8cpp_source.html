<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ContextLogger2 Logger Daemon Internals: up_uploader_qt.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_ce488f798153ac6666006744a35bf93c.html">src</a>
  </div>
</div>
<div class="contents">
<h1>up_uploader_qt.cpp</h1><a href="up__uploader__qt_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> !concept {:name =&gt; &quot;Multipart HTTP posting (Qt)&quot;,</span>
<a name="l00003"></a>00003 <span class="comment">   :desc =&gt; &quot;Multipart HTTP(S) POSTing using the QtNetwork API.&quot;}</span>
<a name="l00004"></a>00004 <span class="comment">*/</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="preprocessor">#include &quot;<a class="code" href="up__uploader__qt__private_8hpp.html">up_uploader_qt_private.hpp</a>&quot;</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;<a class="code" href="cf__query_8h.html">cf_query.h</a>&quot;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;<a class="code" href="er__errors_8h.html">er_errors.h</a>&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;<a class="code" href="ld__log__db_8h.html">ld_log_db.h</a>&quot;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;<a class="code" href="up__private_8h.html">up_private.h</a>&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="ut__exceptions_8hpp.html">ut_exceptions.hpp</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="utils__cl2_8h.html">utils_cl2.h</a>&quot;</span>
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="moment__parser_8h.html">moment_parser.h</a>&quot;</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="assertions_8h.html">common/assertions.h</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="error__list_8h.html">common/error_list.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="gx__exception_8hpp.html">common/gx_exception.hpp</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="logging__qt_8hpp.html">common/logging_qt.hpp</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="logging-time_8h.html">common/logging-time.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="platform__error_8h.html">common/platform_error.h</a>&quot;</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;QNetworkConfiguration&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;QNetworkConfigurationManager&gt;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;QtDebug&gt;</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="preprocessor">#if defined(__SYMBIAN32__)</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="epoc-iap_8h.html">epoc-iap.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="shared_2common_2epoc-time_8h.html">common/epoc-time.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#endif </span><span class="comment">/* __SYMBIAN32__ */</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="comment">// --------------------------------------------------</span>
<a name="l00039"></a>00039 <span class="comment">// CUploader</span>
<a name="l00040"></a>00040 <span class="comment">// --------------------------------------------------</span>
<a name="l00041"></a>00041 
<a name="l00042"></a><a class="code" href="up__uploader__qt_8cpp.html#af4021e9f52da176d129c08bae4bff1ee">00042</a> <span class="keyword">static</span> time_t <a class="code" href="up__uploader__qt_8cpp.html#af4021e9f52da176d129c08bae4bff1ee">TimeNow</a>()
<a name="l00043"></a>00043 {
<a name="l00044"></a>00044   time_t now = time(NULL);
<a name="l00045"></a>00045   <span class="keywordflow">if</span> (now == -1)
<a name="l00046"></a>00046     <a class="code" href="er__errors_8h.html#a5f74b6eea0be228404efd4a23c25f406">er_log_errno</a>(<a class="code" href="er__errors_8h.html#a74b7465a12d63ad80bc10d1ebaf900d8">er_FATAL</a>, <span class="stringliteral">&quot;time(NULL) failed&quot;</span>);
<a name="l00047"></a>00047   <span class="keywordflow">return</span> now;
<a name="l00048"></a>00048 }
<a name="l00049"></a>00049 
<a name="l00050"></a><a class="code" href="up__uploader__qt_8cpp.html#ad2025ddb82d60edae93987e6f767622e">00050</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="up__uploader__qt_8cpp.html#ad2025ddb82d60edae93987e6f767622e">DataChanged</a>(<a class="code" href="struct__bb__Blackboard.html">bb_Blackboard</a>* bb, <span class="keyword">enum</span> <a class="code" href="bb__blackboard_8h.html#a222fef21537286535b17c6146c9b2d3c">bb_DataType</a> dt,
<a name="l00051"></a>00051       gpointer data, <span class="keywordtype">int</span> len, gpointer arg)
<a name="l00052"></a>00052 {
<a name="l00053"></a>00053   (void)dt;
<a name="l00054"></a>00054   (void)len;
<a name="l00055"></a>00055   <a class="code" href="classCUploader.html">CUploader</a>* <span class="keyword">self</span> = (<a class="code" href="classCUploader.html">CUploader</a>*)arg;
<a name="l00056"></a>00056   <a class="code" href="structbb__Board.html">bb_Board</a>* bd = <a class="code" href="bb__blackboard_8cpp.html#a294701be39c14209dcaee7744b96402d">bb_Blackboard_board</a>(bb);
<a name="l00057"></a>00057   <span class="keywordtype">bool</span> val = bd-&gt;<a class="code" href="structbb__Board.html#a896d6a366639326f6bc84697a5ba6f13">uploads_allowed</a>;
<a name="l00058"></a>00058   <span class="keyword">self</span>-&gt;Set_uploads_allowed(val);
<a name="l00059"></a>00059 }
<a name="l00060"></a>00060 
<a name="l00061"></a><a class="code" href="classCUploader.html#ace5ae9888069998cee1e31e361928ec9">00061</a> <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#a869ad02862eb3a9512b463bed0166632">CUploader::Set_uploads_allowed</a>(<span class="keywordtype">bool</span> val)
<a name="l00062"></a>00062 {
<a name="l00063"></a>00063   <a class="code" href="classCUploader.html#afd82e74323ae66d14e5ecde74816346e">i_uploads_allowed</a> = val;
<a name="l00064"></a>00064   <a class="code" href="classCUploader.html#a5ef684506d69ad304799073847d49466">StateChanged</a>();
<a name="l00065"></a>00065 }
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#a7d0420ae53dc4e28195b47424735bf9c">CUploader::BbRegisterL</a>()
<a name="l00068"></a>00068 {
<a name="l00069"></a>00069   <span class="comment">// Initial value (internal).</span>
<a name="l00070"></a>00070   <a class="code" href="struct__bb__Blackboard.html">bb_Blackboard</a>* bb = <a class="code" href="ac__app__context_8h.html#a97a19629a1eaca64ac8add20b98a3ff7">ac_global_Blackboard</a>;
<a name="l00071"></a>00071   <a class="code" href="structbb__Board.html">bb_Board</a>* bd = <a class="code" href="bb__blackboard_8cpp.html#a294701be39c14209dcaee7744b96402d">bb_Blackboard_board</a>(bb);
<a name="l00072"></a>00072   <a class="code" href="classCUploader.html#afd82e74323ae66d14e5ecde74816346e">i_uploads_allowed</a> = bd-&gt;<a class="code" href="structbb__Board.html#a896d6a366639326f6bc84697a5ba6f13">uploads_allowed</a>;
<a name="l00073"></a>00073 
<a name="l00074"></a>00074   <span class="comment">// Closure init.</span>
<a name="l00075"></a>00075   <a class="code" href="classCUploader.html#acbc128a46c19b8a4301dbed07893ddd2">iClosure</a>.<a class="code" href="structbb__Closure.html#acdcf2f7d3d9ba87069bff77b1ca703ee">changed</a> = <a class="code" href="up__uploader__qt_8cpp.html#ad2025ddb82d60edae93987e6f767622e">DataChanged</a>;
<a name="l00076"></a>00076   <a class="code" href="classCUploader.html#acbc128a46c19b8a4301dbed07893ddd2">iClosure</a>.<a class="code" href="structbb__Closure.html#ad9c363d7bd60564e26d1f1be39431d0d">arg</a> = <span class="keyword">this</span>;
<a name="l00077"></a>00077 
<a name="l00078"></a>00078   <span class="comment">// Registration proper.</span>
<a name="l00079"></a>00079   <span class="keywordflow">if</span> (!<a class="code" href="bb__blackboard_8cpp.html#ae56eaa4623aae09a8cf227a04765e23d">bb_Blackboard_register</a>(bb,
<a name="l00080"></a>00080             <a class="code" href="bb__blackboard_8h.html#a222fef21537286535b17c6146c9b2d3cadc02a7115f39bba686cff64df486eed2">bb_dt_uploads_allowed</a>,
<a name="l00081"></a>00081             <a class="code" href="classCUploader.html#acbc128a46c19b8a4301dbed07893ddd2">iClosure</a>, NULL))
<a name="l00082"></a>00082     <span class="keywordflow">throw</span> std::bad_alloc();
<a name="l00083"></a>00083 }
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#a01f18806311d8427e83ec9a0ffb686a3">CUploader::BbUnregister</a>()
<a name="l00086"></a>00086 {
<a name="l00087"></a>00087   <a class="code" href="bb__blackboard_8cpp.html#acdc041c049bf2f36084ffaa1c5abd9c3">bb_Blackboard_unregister</a>(<a class="code" href="ac__app__context_8h.html#a97a19629a1eaca64ac8add20b98a3ff7">ac_global_Blackboard</a>, <a class="code" href="classCUploader.html#acbc128a46c19b8a4301dbed07893ddd2">iClosure</a>);
<a name="l00088"></a>00088 }
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="comment">// The effect is not immediate. Will only take effect when the next</span>
<a name="l00091"></a>00091 <span class="comment">// poster is created.</span>
<a name="l00092"></a>00092 <span class="comment">// </span>
<a name="l00093"></a>00093 <span class="comment">// We do logging here to make it possible to find out if the setting</span>
<a name="l00094"></a>00094 <span class="comment">// change succeeded.</span>
<a name="l00095"></a><a class="code" href="classCUploader.html#a671b8c00013f6b33e9b06c6afb73773d">00095</a> <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#a6ca925501e959ac4f0c80d9bb2d15be8">CUploader::RefreshIap</a>(<span class="keywordtype">bool</span> aNotInitial)
<a name="l00096"></a>00096 {
<a name="l00097"></a>00097 <span class="preprocessor">#if defined(__SYMBIAN32__)</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span>  <span class="comment">// TUint32 coercion hopefully okay.</span>
<a name="l00099"></a>00099   <a class="code" href="classCUploader.html#aa953cb1329615922f652147edc26aeec">iIapId</a> = (TUint32)<a class="code" href="cf__query_8c.html#aae1ba270e1d99ca4d19cb7807144de53">get_config_iap_id</a>();
<a name="l00100"></a>00100   <span class="keywordflow">if</span> (aNotInitial)
<a name="l00101"></a>00101     <a class="code" href="ld__log__db_8c.html#a593a2e358ba9033bbd885a1acd1ab3c2">log_db_log_status</a>(<a class="code" href="classCUploader.html#a728b07158dc2504b67356a3730b9ce96">GetLogDb</a>(), NULL, <span class="stringliteral">&quot;Uploader IAP changed to %d&quot;</span>, <a class="code" href="classCUploader.html#aa953cb1329615922f652147edc26aeec">iIapId</a>);
<a name="l00102"></a>00102 <span class="preprocessor">#endif </span><span class="comment">/* __SYMBIAN32__ */</span>
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a><a class="code" href="classCUploader.html#abd72c69b8c1cea8e726fe7d2d8533e2d">00105</a> <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#a8342a0c1cd6c9a337622a7c97ff4e7bf">CUploader::RefreshSnapshotTimeExpr</a>(<span class="keywordtype">bool</span> aNotInitial)
<a name="l00106"></a>00106 {
<a name="l00107"></a>00107   GError* localError = NULL;
<a name="l00108"></a>00108   gchar* newOne = NULL;
<a name="l00109"></a>00109   <span class="keywordflow">if</span> (!<a class="code" href="cf__query_8c.html#aae33847556354f3294a275e5313b6cf4">get_ConfigDb_str</a>(<span class="stringliteral">&quot;uploader.time_expr&quot;</span>, 
<a name="l00110"></a>00110       &amp;newOne, <a class="code" href="current__config_8hrh.html#a18bc428fa2c653e19d5a91265bfd3124">__UPLOAD_TIME_EXPR__</a>, 
<a name="l00111"></a>00111       &amp;localError)) {
<a name="l00112"></a>00112     <span class="keywordflow">if</span> (aNotInitial)
<a name="l00113"></a>00113       <a class="code" href="er__errors_8c.html#a542fa1ff2a1ef4a06a2192eb88e22960">gx_dblog_error_free_check</a>(<a class="code" href="classCUploader.html#a728b07158dc2504b67356a3730b9ce96">GetLogDb</a>(), localError, NULL);
<a name="l00114"></a>00114     <span class="keywordflow">else</span>
<a name="l00115"></a>00115       <a class="code" href="er__errors_8c.html#a332ee12cbfe0ec4695eabe72008ec90e">gx_error_free</a>(localError);
<a name="l00116"></a>00116   } <span class="keywordflow">else</span> {
<a name="l00117"></a>00117     assert(newOne != NULL);
<a name="l00118"></a>00118     g_free(<a class="code" href="classCUploader.html#aaacff6a16f6085d4e82467d09449b844">iSnapshotTimeExpr</a>);
<a name="l00119"></a>00119     <a class="code" href="classCUploader.html#aaacff6a16f6085d4e82467d09449b844">iSnapshotTimeExpr</a> = newOne;
<a name="l00120"></a>00120     <a class="code" href="logging__c_8h.html#a919260af80d8c36d20780bd23f20fa5a">logt</a>(<span class="stringliteral">&quot;got time expression&quot;</span>);
<a name="l00121"></a>00121     <a class="code" href="logging__c_8h.html#a919260af80d8c36d20780bd23f20fa5a">logt</a>(<a class="code" href="classCUploader.html#aaacff6a16f6085d4e82467d09449b844">iSnapshotTimeExpr</a>);
<a name="l00122"></a>00122     <span class="keywordflow">if</span> (aNotInitial) {
<a name="l00123"></a>00123       <a class="code" href="ld__log__db_8c.html#a593a2e358ba9033bbd885a1acd1ab3c2">log_db_log_status</a>(<a class="code" href="classCUploader.html#a728b07158dc2504b67356a3730b9ce96">GetLogDb</a>(), NULL, <span class="stringliteral">&quot;Upload time expression set to &apos;%s&apos;&quot;</span>,
<a name="l00124"></a>00124       newOne);
<a name="l00125"></a>00125 
<a name="l00126"></a>00126       <span class="comment">// We may need to recompute the next snapshot time based on the</span>
<a name="l00127"></a>00127       <span class="comment">// new expression. But if a previosly set time has already</span>
<a name="l00128"></a>00128       <span class="comment">// passed, then that is not affected by the expression change.</span>
<a name="l00129"></a>00129       <span class="comment">// What is past is past.</span>
<a name="l00130"></a>00130       {
<a name="l00131"></a>00131   <span class="keywordflow">if</span> (<a class="code" href="classCUploader.html#aec0d7af7fba5b97153166800ab462309">iSnapshotTimerAo</a>.isActive())
<a name="l00132"></a>00132     <a class="code" href="classCUploader.html#aec0d7af7fba5b97153166800ab462309">iSnapshotTimerAo</a>.stop();
<a name="l00133"></a>00133   <a class="code" href="classCUploader.html#ab45a1c61ed10cfac50fe97d8c8bfa8b7">iNoNextSnapshotTime</a> = <span class="keyword">false</span>;
<a name="l00134"></a>00134   <a class="code" href="classCUploader.html#a5ef684506d69ad304799073847d49466">StateChanged</a>();
<a name="l00135"></a>00135       }
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137   }
<a name="l00138"></a>00138 }
<a name="l00139"></a>00139 
<a name="l00140"></a><a class="code" href="up__uploader__qt_8cpp.html#ae3e73e78ecb335c1f52065ab1ab915ec">00140</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="up__uploader__qt_8cpp.html#ae3e73e78ecb335c1f52065ab1ab915ec">KBoundary</a> = <span class="stringliteral">&quot;-----AaB03xeql7dsxeql7ds&quot;</span>;
<a name="l00141"></a>00141 
<a name="l00142"></a><a class="code" href="classCUploader.html#a7d7cb15fd9925cb19b0ba1604b883b08">00142</a> <a class="code" href="classCUploader.html#a7d7cb15fd9925cb19b0ba1604b883b08">CUploader::CUploader</a>(<a class="code" href="struct__ac__AppContext.html">ac_AppContext</a>* aAppContext) :
<a name="l00143"></a>00143   iAppContext(aAppContext), iNoConfig(false),
<a name="l00144"></a>00144   iNoOldFiles(false),
<a name="l00145"></a>00145   iNumPostFailures(0),
<a name="l00146"></a>00146   iPostSession(NULL), iFileToPost(NULL), 
<a name="l00147"></a>00147   iSnapshotTimePassed(false), iSnapshotTimeExpr(NULL),
<a name="l00148"></a>00148   iNoNextSnapshotTime(false)
<a name="l00149"></a>00149 {
<a name="l00150"></a>00150   <span class="comment">// Ensure that uploads directory exists.</span>
<a name="l00151"></a>00151   GError* mdError = NULL;
<a name="l00152"></a>00152   <span class="keywordflow">if</span> (!<a class="code" href="utils__cl2_8c.html#a35fa13fa70550087b3a031403c7b1cb0">mkdir_p</a>(<a class="code" href="ac__app__context_8h.html#a0fd2cfda764ade87d6a5ada79eca4987">LOG_UPLOADS_DIR</a>, &amp;mdError)) {
<a name="l00153"></a>00153     <a class="code" href="er__errors_8h.html#a0f3362e469d9427660e2f1fd290b5eb2">er_log_gerror</a>(<a class="code" href="er__errors_8h.html#a74b7465a12d63ad80bc10d1ebaf900d8">er_FATAL</a>|<a class="code" href="er__errors_8h.html#a586203382212832772429f0a9cbb3774">er_FREE</a>, mdError, 
<a name="l00154"></a>00154       <span class="stringliteral">&quot;failure creating uploads directory&quot;</span>);
<a name="l00155"></a>00155   }
<a name="l00156"></a>00156 
<a name="l00157"></a>00157   <span class="keyword">const</span> gchar* upload_url = <a class="code" href="ac__app__context_8h.html#a4df528c22dbfba3523ec1646aa0ae690">ac_STATIC_GET</a>(upload_url);
<a name="l00158"></a>00158   <span class="keywordflow">if</span> (!upload_url) {
<a name="l00159"></a>00159     <a class="code" href="classCUploader.html#a53862c92a4820d4f291bb0289ad72ce8">iNoConfig</a> = <span class="keyword">true</span>;
<a name="l00160"></a>00160     <a class="code" href="logging__c_8h.html#a919260af80d8c36d20780bd23f20fa5a">logt</a>(<span class="stringliteral">&quot;uploads disabled: no upload URL&quot;</span>);
<a name="l00161"></a>00161   } <span class="keywordflow">else</span> {
<a name="l00162"></a>00162     <a class="code" href="logging__c_8h.html#abea298723ad956e744c9efec71512dd0">logg</a>(<span class="stringliteral">&quot;upload URL: %s&quot;</span>, upload_url);
<a name="l00163"></a>00163     <a class="code" href="classCUploader.html#a0f7c390d2e45965508103bca64249a48">iNetworkRequest</a>.setUrl(QUrl(upload_url));
<a name="l00164"></a>00164     QByteArray ct(<span class="stringliteral">&quot;multipart/form-data, boundary=&quot;</span>);
<a name="l00165"></a>00165     ct.append(KBoundary);
<a name="l00166"></a>00166     <a class="code" href="classCUploader.html#a0f7c390d2e45965508103bca64249a48">iNetworkRequest</a>.setHeader(QNetworkRequest::ContentTypeHeader, ct);
<a name="l00167"></a>00167     <a class="code" href="classCUploader.html#a0f7c390d2e45965508103bca64249a48">iNetworkRequest</a>.setRawHeader(<span class="stringliteral">&quot;Connection&quot;</span>, <span class="stringliteral">&quot;close&quot;</span>);
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     <span class="comment">// On Symbian we currently assume that CA public certs are</span>
<a name="l00170"></a>00170     <span class="comment">// installed system wide.</span>
<a name="l00171"></a>00171 <span class="preprocessor">#if !defined(__SYMBIAN32__)</span>
<a name="l00172"></a>00172 <span class="preprocessor"></span>    <a class="code" href="classCUploader.html#a6b11b4f5b111d5816862ee7d80bf9977">iSslConfiguration</a> = QSslConfiguration::defaultConfiguration();
<a name="l00173"></a>00173     QList&lt;QSslCertificate&gt; caList = <a class="code" href="classCUploader.html#a6b11b4f5b111d5816862ee7d80bf9977">iSslConfiguration</a>.caCertificates();
<a name="l00174"></a>00174     QList&lt;QSslCertificate&gt; myList = QSslCertificate::fromPath(<span class="stringliteral">&quot;etc/ca-certs/*.crt&quot;</span>, QSsl::Pem, QRegExp::Wildcard);
<a name="l00175"></a>00175     caList.append(myList);
<a name="l00176"></a>00176 <span class="preprocessor">#if 1</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> (<span class="keyword">const</span> QSslCertificate&amp; cert, myList) {
<a name="l00178"></a>00178       <a class="code" href="logging__qt_8hpp.html#a32ef4624a2b1f90cbf5b7e0c08050f39">qxDebug</a>() &lt;&lt; cert.issuerInfo(QSslCertificate::Organization);
<a name="l00179"></a>00179     }
<a name="l00180"></a>00180 <span class="preprocessor">#endif</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span><span class="preprocessor">#if 1</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span>    <span class="comment">// This should make server authentication succeed, but it does not, due to Qt bug http://bugreports.qt.nokia.com/browse/QTBUG-13684. See ./src/network/ssl/qsslerror.cpp. It is wrong to say that our &quot;root CA certificate is not trusted for this purpose&quot; as it is a CA certificate that we have specified as such.</span>
<a name="l00183"></a>00183     <a class="code" href="classCUploader.html#a6b11b4f5b111d5816862ee7d80bf9977">iSslConfiguration</a>.setCaCertificates(caList);
<a name="l00184"></a>00184     <a class="code" href="classCUploader.html#a0f7c390d2e45965508103bca64249a48">iNetworkRequest</a>.setSslConfiguration(<a class="code" href="classCUploader.html#a6b11b4f5b111d5816862ee7d80bf9977">iSslConfiguration</a>);
<a name="l00185"></a>00185 <span class="preprocessor">#else</span>
<a name="l00186"></a>00186 <span class="preprocessor"></span>    <span class="comment">// So let us try this global setting instead. Of course we do not want to do this more than once as it is a global setting. But no, this does not work either.</span>
<a name="l00187"></a>00187     QList&lt;QSslCertificate&gt; curList = QSslSocket::defaultCaCertificates();
<a name="l00188"></a>00188     <span class="keywordflow">foreach</span> (<span class="keyword">const</span> QSslCertificate&amp; cert, myList) {
<a name="l00189"></a>00189       <span class="keywordflow">if</span> (!curList.contains(cert)) {
<a name="l00190"></a>00190   <a class="code" href="logging__qt_8hpp.html#a32ef4624a2b1f90cbf5b7e0c08050f39">qxDebug</a>() &lt;&lt; <span class="stringliteral">&quot;globally adding CA&quot;</span> &lt;&lt; cert.issuerInfo(QSslCertificate::Organization);
<a name="l00191"></a>00191   QSslSocket::addDefaultCaCertificates(myList);
<a name="l00192"></a>00192       }
<a name="l00193"></a>00193     }
<a name="l00194"></a>00194 <span class="preprocessor">#endif</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* not __SYMBIAN32__ */</span>
<a name="l00196"></a>00196   }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198   <a class="code" href="classCUploader.html#a6ca925501e959ac4f0c80d9bb2d15be8">RefreshIap</a>(<span class="keyword">false</span>);
<a name="l00199"></a>00199 <span class="preprocessor">#if defined(__SYMBIAN32__)</span>
<a name="l00200"></a>00200 <span class="preprocessor"></span>  <a class="code" href="logging__c_8h.html#abea298723ad956e744c9efec71512dd0">logg</a>(<span class="stringliteral">&quot;uploader using IAP %d&quot;</span>, <a class="code" href="classCUploader.html#aa953cb1329615922f652147edc26aeec">iIapId</a>);
<a name="l00201"></a>00201 <span class="preprocessor">#endif </span><span class="comment">/* __SYMBIAN32__ */</span>
<a name="l00202"></a>00202 
<a name="l00203"></a>00203   <span class="comment">//qxDebug() &lt;&lt; &quot;testing qxDebug&quot;;</span>
<a name="l00204"></a>00204 <span class="preprocessor">#if defined(__SYMBIAN32__)</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span>  <span class="comment">// Beware of naming clashes, as both Mobility and Qt Network have these classes. </span>
<a name="l00206"></a>00206   <span class="comment">// Requires Qt 4.7, unless using the Mobility version.</span>
<a name="l00207"></a>00207   <span class="comment">// http://doc.qt.nokia.com/qtmobility-1.1.0-beta/bearer-management.html</span>
<a name="l00208"></a>00208   QNetworkConfigurationManager mgr;
<a name="l00209"></a>00209   QList&lt;QNetworkConfiguration&gt; cfgList = mgr.allConfigurations();
<a name="l00210"></a>00210   <span class="comment">// We want to print out the list of configurations. Perhaps we can</span>
<a name="l00211"></a>00211   <span class="comment">// select one by platform specific ID, which we already have. It</span>
<a name="l00212"></a>00212   <span class="comment">// seems that currently on Symbian^3 we get no configurations even if</span>
<a name="l00213"></a>00213   <span class="comment">// IAP entries do exist.</span>
<a name="l00214"></a>00214   <a class="code" href="logging__c_8h.html#a919260af80d8c36d20780bd23f20fa5a">logt</a>(<span class="stringliteral">&quot;network config list begin&quot;</span>);
<a name="l00215"></a>00215   <span class="keywordflow">foreach</span> (<span class="keyword">const</span> QNetworkConfiguration&amp; cfg, cfgList) {
<a name="l00216"></a>00216     <a class="code" href="logging__c_8h.html#a919260af80d8c36d20780bd23f20fa5a">logt</a>(<span class="stringliteral">&quot;config entry:&quot;</span>);
<a name="l00217"></a>00217     <a class="code" href="logging__qt_8hpp.html#a32ef4624a2b1f90cbf5b7e0c08050f39">qxDebug</a>() &lt;&lt; cfg.identifier() &lt;&lt; cfg.name() &lt;&lt; cfg.bearerTypeName();
<a name="l00218"></a>00218   }
<a name="l00219"></a>00219   <a class="code" href="logging__c_8h.html#a919260af80d8c36d20780bd23f20fa5a">logt</a>(<span class="stringliteral">&quot;network config list end&quot;</span>);
<a name="l00220"></a>00220   <span class="comment">//iNetworkAccessManager.setConfiguration(cfg);</span>
<a name="l00221"></a>00221 <span class="preprocessor">#endif </span><span class="comment">/* __SYMBIAN32__ */</span>
<a name="l00222"></a>00222 
<a name="l00223"></a>00223   <a class="code" href="classCUploader.html#ad8f5425d22b1ad5240dfa0a5e8df3501">iPostTimerAo</a>.setSingleShot(<span class="keyword">true</span>);
<a name="l00224"></a>00224   connect(&amp;<a class="code" href="classCUploader.html#ad8f5425d22b1ad5240dfa0a5e8df3501">iPostTimerAo</a>, SIGNAL(timeout()), 
<a name="l00225"></a>00225     <span class="keyword">this</span>, SLOT(<a class="code" href="classCUploader.html#a2790d34d65cbb89696e9b472b2317ed2">handlePosterTimerEvent</a>()));
<a name="l00226"></a>00226   connect(&amp;<a class="code" href="classCUploader.html#aec0d7af7fba5b97153166800ab462309">iSnapshotTimerAo</a>, SIGNAL(timeout()), 
<a name="l00227"></a>00227     <span class="keyword">this</span>, SLOT(<a class="code" href="classCUploader.html#a42fd8fcab728607568e02fbbe36f5cd6">handleSnapshotTimerEvent</a>()));
<a name="l00228"></a>00228 
<a name="l00229"></a>00229   <a class="code" href="classCUploader.html#a8342a0c1cd6c9a337622a7c97ff4e7bf">RefreshSnapshotTimeExpr</a>(<span class="keyword">false</span>);
<a name="l00230"></a>00230   <a class="code" href="classCUploader.html#a61a3d8f069a60d87110c2718b9143946">iSnapshotTimeCtx</a> = <a class="code" href="up__uploader__qt_8cpp.html#af4021e9f52da176d129c08bae4bff1ee">TimeNow</a>();
<a name="l00231"></a>00231   <span class="comment">//logg(&quot;using snapshot time &apos;%s&apos;&quot;, iSnapshotTimeExpr);</span>
<a name="l00232"></a>00232 
<a name="l00233"></a>00233   <span class="comment">// Note that if this ConstructL() leaves, the dtor of this will</span>
<a name="l00234"></a>00234   <span class="comment">// unregister us. xxx</span>
<a name="l00235"></a>00235   <a class="code" href="classCUploader.html#a7d0420ae53dc4e28195b47424735bf9c">BbRegisterL</a>();
<a name="l00236"></a>00236 
<a name="l00237"></a>00237   <a class="code" href="classCUploader.html#aaf851c238e691609ec2a2b1e17845013">StateChangedL</a>();
<a name="l00238"></a>00238 }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 <a class="code" href="classCUploader.html#a9a83910f608f918d224cf87d15bd1ea9">CUploader::~CUploader</a>()
<a name="l00241"></a>00241 {
<a name="l00242"></a>00242   <a class="code" href="classCUploader.html#a01f18806311d8427e83ec9a0ffb686a3">BbUnregister</a>();
<a name="l00243"></a>00243   <a class="code" href="classCUploader.html#a9082efa2cd23dd596fb56cc330a35b5d">DestroyPosterAo</a>();
<a name="l00244"></a>00244   g_free(<a class="code" href="classCUploader.html#aaacff6a16f6085d4e82467d09449b844">iSnapshotTimeExpr</a>); <span class="comment">// safe when NULL</span>
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#a5bb59f6cd4340d71a9b6700d795d46f9">CUploader::Inactivate</a>()
<a name="l00248"></a>00248 {
<a name="l00249"></a>00249   <a class="code" href="classCUploader.html#a9082efa2cd23dd596fb56cc330a35b5d">DestroyPosterAo</a>();
<a name="l00250"></a>00250   <span class="keywordflow">if</span> (<a class="code" href="classCUploader.html#aec0d7af7fba5b97153166800ab462309">iSnapshotTimerAo</a>.isActive()) 
<a name="l00251"></a>00251     <a class="code" href="classCUploader.html#aec0d7af7fba5b97153166800ab462309">iSnapshotTimerAo</a>.stop();
<a name="l00252"></a>00252   <span class="keywordflow">if</span> (<a class="code" href="classCUploader.html#ad8f5425d22b1ad5240dfa0a5e8df3501">iPostTimerAo</a>.isActive()) 
<a name="l00253"></a>00253     <a class="code" href="classCUploader.html#ad8f5425d22b1ad5240dfa0a5e8df3501">iPostTimerAo</a>.stop();
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 
<a name="l00256"></a><a class="code" href="classCUploader.html#a42ea538f71329c1c56ae30a6c1b57373">00256</a> <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#ab7bf872d2485eeac131838d1bcc63b37">CUploader::FatalError</a>(<span class="keyword">const</span> std::exception &amp;ex)
<a name="l00257"></a>00257 {
<a name="l00258"></a>00258   <a class="code" href="classCUploader.html#a5bb59f6cd4340d71a9b6700d795d46f9">Inactivate</a>();
<a name="l00259"></a>00259   <a class="code" href="er__errors_8h.html#a38fb855b186279a938f48b0407296a29">er_log_none</a>(<a class="code" href="er__errors_8h.html#a74b7465a12d63ad80bc10d1ebaf900d8">er_FATAL</a>, <span class="stringliteral">&quot;error in uploader: %s&quot;</span>, ex.what());
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00262"></a><a class="code" href="up__uploader__qt_8cpp.html#a9ae37fe9db831fa47bb58b434b651897">00262</a> <span class="preprocessor">#define CATCH_FATAL(_act)     \</span>
<a name="l00263"></a>00263 <span class="preprocessor">  try {           \</span>
<a name="l00264"></a>00264 <span class="preprocessor">    _act ;          \</span>
<a name="l00265"></a>00265 <span class="preprocessor">  } catch (const std::exception &amp;_ex) {   \</span>
<a name="l00266"></a>00266 <span class="preprocessor">    FatalError(_ex);        \</span>
<a name="l00267"></a>00267 <span class="preprocessor">  }</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span>
<a name="l00269"></a>00269 <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#a5ef684506d69ad304799073847d49466">CUploader::StateChanged</a>()
<a name="l00270"></a>00270 {
<a name="l00271"></a>00271   <a class="code" href="up__uploader__qt_8cpp.html#a9ae37fe9db831fa47bb58b434b651897">CATCH_FATAL</a>(<a class="code" href="classCUploader.html#aaf851c238e691609ec2a2b1e17845013">StateChangedL</a>());
<a name="l00272"></a>00272 }
<a name="l00273"></a>00273 
<a name="l00274"></a><a class="code" href="structScopedPointerGfree.html">00274</a> <span class="keyword">struct </span><a class="code" href="structScopedPointerGfree.html">ScopedPointerGfree</a>
<a name="l00275"></a>00275 {
<a name="l00276"></a><a class="code" href="structScopedPointerGfree.html#af94dd1d0ebd50fc11fae8c4ba66508b8">00276</a>   <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="structScopedPointerGfree.html#af94dd1d0ebd50fc11fae8c4ba66508b8">cleanup</a>(gchar* pointer)
<a name="l00277"></a>00277   {
<a name="l00278"></a>00278     g_free(pointer);
<a name="l00279"></a>00279   }
<a name="l00280"></a>00280 };
<a name="l00281"></a>00281 
<a name="l00282"></a>00282 <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#afdaacaad9a951e2dffb3fbbe56264d16">CUploader::NextOldFileL</a>()
<a name="l00283"></a>00283 {
<a name="l00284"></a>00284   <span class="keywordflow">if</span> (<a class="code" href="classCUploader.html#a218321e8998867affb63121ad4e2fbea">iNoOldFiles</a>) <span class="keywordflow">return</span>;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286   DELETE_Z(<a class="code" href="classCUploader.html#a0e16a1cb5b1666917c153c4f42bd2c72">iFileToPost</a>);
<a name="l00287"></a>00287 
<a name="l00288"></a>00288   GError* <a class="code" href="lundump_8c.html#a6776ffdd5e2abf4119b1d45731e9e668">error</a> = NULL;
<a name="l00289"></a>00289   gchar* pathname = NULL;
<a name="l00290"></a>00290   <span class="keywordflow">if</span> (<a class="code" href="up__private_8h.html#afdeb95a0a1edbd975e06c948820e6055">getNextOldLogFile</a>(&amp;pathname, &amp;error)) {
<a name="l00291"></a>00291     <span class="keywordflow">if</span> (pathname) {
<a name="l00292"></a>00292       <a class="code" href="er__errors_8h.html#a812dd79a9d8d1eb96710602911653d44">dblogg</a>(<span class="stringliteral">&quot;found old log file &apos;%s&apos;&quot;</span>, pathname);
<a name="l00293"></a>00293       QScopedPointer&lt;gchar, ScopedPointerGfree&gt; pn(pathname);
<a name="l00294"></a>00294       QString qs = QString::fromUtf8(pathname);
<a name="l00295"></a>00295       <span class="comment">//qDebug() &lt;&lt; qs;</span>
<a name="l00296"></a>00296       <a class="code" href="classCUploader.html#a0e16a1cb5b1666917c153c4f42bd2c72">iFileToPost</a> = q_check_ptr(<span class="keyword">new</span> QFile(qs));
<a name="l00297"></a>00297       <span class="comment">//qDebug() &lt;&lt; (iFileToPost-&gt;fileName().toLocal8Bit());</span>
<a name="l00298"></a>00298       <span class="keywordflow">return</span>;
<a name="l00299"></a>00299     } <span class="keywordflow">else</span> {
<a name="l00300"></a>00300       <a class="code" href="classCUploader.html#a218321e8998867affb63121ad4e2fbea">iNoOldFiles</a> = <span class="keyword">true</span>;
<a name="l00301"></a>00301       <a class="code" href="er__errors_8h.html#ab339605c1c09843b74ed9beabd5bd8f9">dblogt</a>(<span class="stringliteral">&quot;no more old files to upload&quot;</span>);
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303   } <span class="keywordflow">else</span> {
<a name="l00304"></a>00304     <a class="code" href="er__errors_8h.html#a0f3362e469d9427660e2f1fd290b5eb2">er_log_gerror</a>(<a class="code" href="er__errors_8h.html#a74b7465a12d63ad80bc10d1ebaf900d8">er_FATAL</a>|<a class="code" href="er__errors_8h.html#a586203382212832772429f0a9cbb3774">er_FREE</a>, error, <span class="stringliteral">&quot;getting next log file&quot;</span>);
<a name="l00305"></a>00305   }
<a name="l00306"></a>00306 }
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 <span class="comment">// External API.</span>
<a name="l00309"></a>00309 <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#a546539871f8458b4aa2fd3eef5e7dd11">CUploader::RequestSnapshot</a>()
<a name="l00310"></a>00310 {
<a name="l00311"></a>00311   <a class="code" href="classCUploader.html#a5b9c4bcae12126c8aaaa45fc07655cdd">iSnapshotTimePassed</a> = <span class="keyword">true</span>;
<a name="l00312"></a>00312   <span class="keywordflow">if</span> (<a class="code" href="classCUploader.html#aec0d7af7fba5b97153166800ab462309">iSnapshotTimerAo</a>.isActive())
<a name="l00313"></a>00313     <a class="code" href="classCUploader.html#aec0d7af7fba5b97153166800ab462309">iSnapshotTimerAo</a>.stop();
<a name="l00314"></a>00314   <a class="code" href="classCUploader.html#a5ef684506d69ad304799073847d49466">StateChanged</a>();
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 
<a name="l00317"></a>00317 <span class="comment">// Computes next snapshot time (if any), and sets a timer for it as</span>
<a name="l00318"></a>00318 <span class="comment">// appropriate.</span>
<a name="l00319"></a>00319 <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#af1fc7f25fd6a84a14e219b54b26fea38">CUploader::SetSnapshotTimerL</a>()
<a name="l00320"></a>00320 {
<a name="l00321"></a>00321   assert(!<a class="code" href="classCUploader.html#a5b9c4bcae12126c8aaaa45fc07655cdd">iSnapshotTimePassed</a>);
<a name="l00322"></a>00322   <span class="keywordflow">if</span> (<a class="code" href="classCUploader.html#aec0d7af7fba5b97153166800ab462309">iSnapshotTimerAo</a>.isActive())
<a name="l00323"></a>00323     <a class="code" href="classCUploader.html#aec0d7af7fba5b97153166800ab462309">iSnapshotTimerAo</a>.stop();
<a name="l00324"></a>00324   <span class="keywordflow">if</span> (<a class="code" href="classCUploader.html#ab45a1c61ed10cfac50fe97d8c8bfa8b7">iNoNextSnapshotTime</a>) 
<a name="l00325"></a>00325     <span class="keywordflow">return</span>; <span class="comment">// flag to avoid needless computation</span>
<a name="l00326"></a>00326   time_t now = <a class="code" href="up__uploader__qt_8cpp.html#af4021e9f52da176d129c08bae4bff1ee">TimeNow</a>();
<a name="l00327"></a>00327   time_t ctx = <a class="code" href="classCUploader.html#a61a3d8f069a60d87110c2718b9143946">iSnapshotTimeCtx</a>;
<a name="l00328"></a>00328   time_t snaptime;
<a name="l00329"></a>00329   GError* parseError = NULL;
<a name="l00330"></a>00330   <span class="keywordflow">if</span> (!<a class="code" href="moment__parser_8c.html#a3b561db93363a8b9ba04e519664f4e9c">parse_moment</a>(<a class="code" href="classCUploader.html#aaacff6a16f6085d4e82467d09449b844">iSnapshotTimeExpr</a>, ctx, now, &amp;snaptime, &amp;parseError)) {
<a name="l00331"></a>00331     <a class="code" href="er__errors_8h.html#ad92f37060baa709eb2fe5d2548b993e2">gx_dblog_error_free</a>(<a class="code" href="classCUploader.html#a728b07158dc2504b67356a3730b9ce96">GetLogDb</a>(), parseError);
<a name="l00332"></a>00332     <a class="code" href="classCUploader.html#ab45a1c61ed10cfac50fe97d8c8bfa8b7">iNoNextSnapshotTime</a> = <span class="keyword">true</span>;
<a name="l00333"></a>00333     <span class="keywordflow">return</span>;
<a name="l00334"></a>00334   }
<a name="l00335"></a>00335   <span class="keywordflow">if</span> (!snaptime) {
<a name="l00336"></a>00336     <a class="code" href="er__errors_8h.html#ab339605c1c09843b74ed9beabd5bd8f9">dblogt</a>(<span class="stringliteral">&quot;no snapshot time upcoming&quot;</span>);
<a name="l00337"></a>00337     <a class="code" href="classCUploader.html#ab45a1c61ed10cfac50fe97d8c8bfa8b7">iNoNextSnapshotTime</a> = <span class="keyword">true</span>;
<a name="l00338"></a>00338     <span class="keywordflow">return</span>;
<a name="l00339"></a>00339   }
<a name="l00340"></a>00340   <a class="code" href="logging__c_8h.html#a919260af80d8c36d20780bd23f20fa5a">logt</a>(<span class="stringliteral">&quot;next snapshot time computed&quot;</span>);
<a name="l00341"></a>00341   <a class="code" href="logging-time_8h.html#a662c6f718fffc4f4db9b5ddd4e289cda">log_time</a>(snaptime);
<a name="l00342"></a>00342 
<a name="l00343"></a>00343   QDateTime atTime;
<a name="l00344"></a>00344   atTime.setTime_t(snaptime);
<a name="l00345"></a>00345   atTime = atTime.toUTC();
<a name="l00346"></a>00346 <span class="preprocessor">#if __DO_LOGGING__</span>
<a name="l00347"></a>00347 <span class="preprocessor"></span>  <span class="keywordtype">int</span> diffTime = snaptime - now;
<a name="l00348"></a>00348   <a class="code" href="logging__c_8h.html#abea298723ad956e744c9efec71512dd0">logg</a>(<span class="stringliteral">&quot;snapshot %d secs from now&quot;</span>, diffTime);
<a name="l00349"></a>00349   <a class="code" href="logging__qt_8hpp.html#a32ef4624a2b1f90cbf5b7e0c08050f39">qxDebug</a>() &lt;&lt; <span class="stringliteral">&quot;snapshot time at&quot;</span> &lt;&lt; atTime &lt;&lt; <span class="stringliteral">&quot; UTC&quot;</span>;
<a name="l00350"></a>00350 <span class="preprocessor">#endif</span>
<a name="l00351"></a>00351 <span class="preprocessor"></span>  <a class="code" href="classCUploader.html#aec0d7af7fba5b97153166800ab462309">iSnapshotTimerAo</a>.start(atTime);
<a name="l00352"></a>00352 }
<a name="l00353"></a>00353 
<a name="l00354"></a><a class="code" href="up__uploader__qt_8cpp.html#a569a0aef0d2682230dcff8381a8e6d77">00354</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="up__uploader__qt_8cpp.html#a569a0aef0d2682230dcff8381a8e6d77">SecsToMsecs</a>(<span class="keywordtype">int</span> secs)
<a name="l00355"></a>00355 {
<a name="l00356"></a>00356   <span class="keywordtype">long</span> <span class="keywordtype">long</span> ms64 = (<span class="keywordtype">long</span> long)(secs) * 1000LL;
<a name="l00357"></a>00357   <span class="keywordflow">if</span> (ms64 &gt; 0x7fffffffLL) ms64 = 0x7fffffffLL;
<a name="l00358"></a>00358   <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)ms64;
<a name="l00359"></a>00359 }
<a name="l00360"></a>00360 
<a name="l00361"></a><a class="code" href="classCUploader.html#af62d9738ca77007ae37796006d71cc1a">00361</a> <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#af62d9738ca77007ae37796006d71cc1a">CUploader::SetPostTimer</a>()
<a name="l00362"></a>00362 {
<a name="l00363"></a>00363   assert(<a class="code" href="classCUploader.html#a723cc544d0e91ce2d31048341d8bb875">iNumPostFailures</a> &gt; 0);
<a name="l00364"></a>00364 
<a name="l00365"></a>00365   <span class="keywordflow">if</span> (<a class="code" href="classCUploader.html#ad8f5425d22b1ad5240dfa0a5e8df3501">iPostTimerAo</a>.isActive())
<a name="l00366"></a>00366     <a class="code" href="classCUploader.html#ad8f5425d22b1ad5240dfa0a5e8df3501">iPostTimerAo</a>.stop();
<a name="l00367"></a>00367 
<a name="l00368"></a>00368   <span class="comment">// Roughly num_failures * 5 mins.</span>
<a name="l00369"></a>00369   <span class="keywordtype">int</span> secs = 5 * 60 * <a class="code" href="classCUploader.html#a723cc544d0e91ce2d31048341d8bb875">iNumPostFailures</a> + (rand() % 60);
<a name="l00370"></a>00370   <span class="keywordtype">int</span> interval = <a class="code" href="up__uploader__qt_8cpp.html#a569a0aef0d2682230dcff8381a8e6d77">SecsToMsecs</a>(secs);
<a name="l00371"></a>00371   <a class="code" href="er__errors_8h.html#a812dd79a9d8d1eb96710602911653d44">dblogg</a>(<span class="stringliteral">&quot;retrying upload in %d secs / %d msecs&quot;</span>, secs, interval);
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   <a class="code" href="classCUploader.html#ad8f5425d22b1ad5240dfa0a5e8df3501">iPostTimerAo</a>.start(interval);
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 <span class="comment">// Make sure this method does not leave.</span>
<a name="l00377"></a><a class="code" href="classCUploader.html#a2790d34d65cbb89696e9b472b2317ed2">00377</a> <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#a2790d34d65cbb89696e9b472b2317ed2">CUploader::handlePosterTimerEvent</a>()
<a name="l00378"></a>00378 {
<a name="l00379"></a>00379   <a class="code" href="logging__c_8h.html#a919260af80d8c36d20780bd23f20fa5a">logt</a>(<span class="stringliteral">&quot;posting timer event&quot;</span>);
<a name="l00380"></a>00380   <a class="code" href="classCUploader.html#a5ef684506d69ad304799073847d49466">StateChanged</a>();
<a name="l00381"></a>00381 }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383 <span class="comment">// Make sure this method does not leave.</span>
<a name="l00384"></a><a class="code" href="classCUploader.html#a42fd8fcab728607568e02fbbe36f5cd6">00384</a> <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#a42fd8fcab728607568e02fbbe36f5cd6">CUploader::handleSnapshotTimerEvent</a>()
<a name="l00385"></a>00385 {
<a name="l00386"></a>00386   <a class="code" href="logging__c_8h.html#a919260af80d8c36d20780bd23f20fa5a">logt</a>(<span class="stringliteral">&quot;snapshot timer event&quot;</span>);
<a name="l00387"></a>00387   <a class="code" href="classCUploader.html#a5b9c4bcae12126c8aaaa45fc07655cdd">iSnapshotTimePassed</a> = <span class="keyword">true</span>;
<a name="l00388"></a>00388   <a class="code" href="classCUploader.html#a5ef684506d69ad304799073847d49466">StateChanged</a>();
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 <span class="keywordtype">bool</span> <a class="code" href="classCUploader.html#a06f9078e35a9464cdfbc3de748498dfe">CUploader::PosterAoIsActive</a>()
<a name="l00392"></a>00392 {
<a name="l00393"></a>00393   <span class="keywordflow">return</span> <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a> &amp;&amp; 
<a name="l00394"></a>00394     <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#a0a63e8d878d3cd38f667b1029308102d">iNetworkReply</a> &amp;&amp; 
<a name="l00395"></a>00395     <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#a0a63e8d878d3cd38f667b1029308102d">iNetworkReply</a>-&gt;isRunning();
<a name="l00396"></a>00396 }
<a name="l00397"></a>00397 
<a name="l00398"></a><a class="code" href="classCUploader.html#a6984ea57f55f841a48ec8531ef0963a3">00398</a> <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#a6984ea57f55f841a48ec8531ef0963a3">CUploader::postingSslErrors</a>(<span class="keyword">const</span> QList&lt;QSslError&gt; &amp; errors)
<a name="l00399"></a>00399 {
<a name="l00400"></a>00400 <span class="preprocessor">#if 1</span>
<a name="l00401"></a>00401 <span class="preprocessor"></span>  <span class="keywordflow">foreach</span> (<span class="keyword">const</span> QSslError&amp; err, errors) {
<a name="l00402"></a>00402     <span class="keyword">const</span> QSslCertificate&amp; cert = err.certificate();
<a name="l00403"></a>00403     <a class="code" href="logging__qt_8hpp.html#a32ef4624a2b1f90cbf5b7e0c08050f39">qxDebug</a>() &lt;&lt; err.errorString() &lt;&lt; (int)err.error() &lt;&lt; cert.issuerInfo(QSslCertificate::Organization);
<a name="l00404"></a>00404   }
<a name="l00405"></a>00405 <span class="preprocessor">#endif</span>
<a name="l00406"></a>00406 <span class="preprocessor"></span>  <span class="comment">// We do want security, and hence do not make any exceptions here. A</span>
<a name="l00407"></a>00407   <span class="comment">// self-signed CA is only okay if we have a locally registered copy.</span>
<a name="l00408"></a>00408   <span class="comment">// For now we only do a bug workaround here. Essentially, we want</span>
<a name="l00409"></a>00409   <span class="comment">// all CA certificates to be accepted as such, and accept no errors</span>
<a name="l00410"></a>00410   <span class="comment">// regarding any of them. Even this workaround only works if the</span>
<a name="l00411"></a>00411   <span class="comment">// server can give us the CA cert, as only then will the comparison</span>
<a name="l00412"></a>00412   <span class="comment">// succeed.</span>
<a name="l00413"></a>00413 <span class="preprocessor">#if !defined(__SYMBIAN32__) &amp;&amp; (QT_VERSION &lt;= 0x040701)</span>
<a name="l00414"></a>00414 <span class="preprocessor"></span>  {
<a name="l00415"></a>00415     QList&lt;QSslCertificate&gt; caList = <a class="code" href="classCUploader.html#a6b11b4f5b111d5816862ee7d80bf9977">iSslConfiguration</a>.caCertificates();
<a name="l00416"></a>00416     <span class="keywordtype">int</span> trueErrors = 0;
<a name="l00417"></a>00417     <span class="comment">//qxDebug() &lt;&lt; &quot;ca&quot; &lt;&lt; caList.last();</span>
<a name="l00418"></a>00418     <span class="keywordflow">foreach</span> (<span class="keyword">const</span> QSslError&amp; err, errors) {
<a name="l00419"></a>00419       <span class="keyword">const</span> QSslCertificate&amp; cert = err.certificate();
<a name="l00420"></a>00420       <span class="comment">//qxDebug() &lt;&lt; &quot;cert&quot; &lt;&lt; cert;</span>
<a name="l00421"></a>00421       <span class="comment">//qxDebug() &lt;&lt; &quot;equal&quot; &lt;&lt; (caList.last() == cert);</span>
<a name="l00422"></a>00422       <span class="keywordflow">if</span> (!caList.contains(cert)) {
<a name="l00423"></a>00423   trueErrors++;
<a name="l00424"></a>00424       } <span class="keywordflow">else</span> {
<a name="l00425"></a>00425   <a class="code" href="logging__qt_8hpp.html#a32ef4624a2b1f90cbf5b7e0c08050f39">qxDebug</a>() &lt;&lt; <span class="stringliteral">&quot;cert is a CA cert, ignoring errors regarding it:&quot;</span> &lt;&lt; 
<a name="l00426"></a>00426     cert;
<a name="l00427"></a>00427       }
<a name="l00428"></a>00428     }
<a name="l00429"></a>00429     <span class="keywordflow">if</span> (!trueErrors) {
<a name="l00430"></a>00430       <a class="code" href="logging__c_8h.html#a919260af80d8c36d20780bd23f20fa5a">logt</a>(<span class="stringliteral">&quot;ignoring all SSL errors&quot;</span>);
<a name="l00431"></a>00431       <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#a0a63e8d878d3cd38f667b1029308102d">iNetworkReply</a>-&gt;ignoreSslErrors();
<a name="l00432"></a>00432     }
<a name="l00433"></a>00433   }
<a name="l00434"></a>00434 <span class="preprocessor">#endif </span><span class="comment">/* __SYMBIAN32__ */</span>
<a name="l00435"></a>00435 }
<a name="l00436"></a>00436 
<a name="l00437"></a><a class="code" href="classCUploader.html#a582670cecd2888b237ada2af2e5005c9">00437</a> <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#a582670cecd2888b237ada2af2e5005c9">CUploader::postingFinished</a>()
<a name="l00438"></a>00438 {
<a name="l00439"></a>00439   QNetworkReply::NetworkError errCode = <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#a0a63e8d878d3cd38f667b1029308102d">iNetworkReply</a>-&gt;error();
<a name="l00440"></a>00440   <a class="code" href="er__errors_8h.html#a812dd79a9d8d1eb96710602911653d44">dblogg</a>(<span class="stringliteral">&quot;poster finished with %d&quot;</span>, errCode);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442   <span class="comment">// Cannot delete while still open.</span>
<a name="l00443"></a>00443   <a class="code" href="classCUploader.html#a0e16a1cb5b1666917c153c4f42bd2c72">iFileToPost</a>-&gt;close();
<a name="l00444"></a>00444 
<a name="l00445"></a>00445   <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#a7d273697d1090a5889e5ede29f599817">iFileToPost</a> = NULL;
<a name="l00446"></a>00446   <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;deleteLater();
<a name="l00447"></a>00447   <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a> = NULL;
<a name="l00448"></a>00448 
<a name="l00449"></a>00449   <span class="keywordflow">switch</span> (errCode)
<a name="l00450"></a>00450     {<span class="comment"></span>
<a name="l00451"></a>00451 <span class="comment">      //// success</span>
<a name="l00452"></a>00452 <span class="comment"></span>    <span class="keywordflow">case</span> QNetworkReply::NoError:
<a name="l00453"></a>00453       {
<a name="l00454"></a>00454   GError* localError = NULL;
<a name="l00455"></a>00455   QByteArray ba = (<a class="code" href="classCUploader.html#a0e16a1cb5b1666917c153c4f42bd2c72">iFileToPost</a>-&gt;fileName().toLocal8Bit());
<a name="l00456"></a>00456   <span class="keyword">const</span> <span class="keywordtype">char</span>* pathname = ba.data();
<a name="l00457"></a>00457   <span class="keywordflow">if</span> (!<a class="code" href="utils__cl2_8c.html#a5ab92b0bf07bf5f320e3812f53bae37f">rm_file</a>(pathname, &amp;localError)) {
<a name="l00458"></a>00458     <a class="code" href="classCUploader.html#ab7bf872d2485eeac131838d1bcc63b37">FatalError</a>(<a class="code" href="classGException.html">GException</a>(localError));
<a name="l00459"></a>00459   } <span class="keywordflow">else</span> {
<a name="l00460"></a>00460     <a class="code" href="ld__log__db_8c.html#a593a2e358ba9033bbd885a1acd1ab3c2">log_db_log_status</a>(<a class="code" href="classCUploader.html#a728b07158dc2504b67356a3730b9ce96">GetLogDb</a>(), NULL, <span class="stringliteral">&quot;posted log file &apos;%s&apos;&quot;</span>, pathname);
<a name="l00461"></a>00461     <a class="code" href="classCUploader.html#a723cc544d0e91ce2d31048341d8bb875">iNumPostFailures</a> = 0;
<a name="l00462"></a>00462     DELETE_Z(<a class="code" href="classCUploader.html#a0e16a1cb5b1666917c153c4f42bd2c72">iFileToPost</a>);
<a name="l00463"></a>00463 
<a name="l00464"></a>00464     {
<a name="l00465"></a>00465       time_t t = <a class="code" href="up__uploader__qt_8cpp.html#af4021e9f52da176d129c08bae4bff1ee">TimeNow</a>();
<a name="l00466"></a>00466       <a class="code" href="ac__app__context_8h.html#a0b330e17f0a4775bc0f50efe9fa181a9">ac_global_Registry</a>-&gt;last_upload_time = t;
<a name="l00467"></a>00467     }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469     <a class="code" href="classCUploader.html#a5ef684506d69ad304799073847d49466">StateChanged</a>();
<a name="l00470"></a>00470   }
<a name="l00471"></a>00471         <span class="keywordflow">break</span>;
<a name="l00472"></a>00472       }<span class="comment"></span>
<a name="l00473"></a>00473 <span class="comment">      //// aborted (do we ever get these signals)</span>
<a name="l00474"></a>00474 <span class="comment"></span>    <span class="keywordflow">case</span> QNetworkReply::OperationCanceledError:
<a name="l00475"></a>00475       {
<a name="l00476"></a>00476   <a class="code" href="logging__c_8h.html#a919260af80d8c36d20780bd23f20fa5a">logt</a>(<span class="stringliteral">&quot;upload operation cancelled event&quot;</span>);
<a name="l00477"></a>00477   <span class="keywordflow">break</span>;
<a name="l00478"></a>00478       }<span class="comment"></span>
<a name="l00479"></a>00479 <span class="comment">      //// transient failure</span>
<a name="l00480"></a>00480 <span class="comment"></span>    <span class="keywordflow">case</span> QNetworkReply::ConnectionRefusedError:
<a name="l00481"></a>00481     <span class="keywordflow">case</span> QNetworkReply::RemoteHostClosedError:
<a name="l00482"></a>00482     <span class="keywordflow">case</span> QNetworkReply::HostNotFoundError:
<a name="l00483"></a>00483     <span class="keywordflow">case</span> QNetworkReply::TimeoutError:
<a name="l00484"></a>00484     <span class="keywordflow">case</span> QNetworkReply::SslHandshakeFailedError:
<a name="l00485"></a>00485     <span class="keywordflow">case</span> QNetworkReply::TemporaryNetworkFailureError:
<a name="l00486"></a>00486     <span class="keywordflow">case</span> QNetworkReply::ProxyConnectionRefusedError:
<a name="l00487"></a>00487     <span class="keywordflow">case</span> QNetworkReply::ProxyConnectionClosedError:
<a name="l00488"></a>00488     <span class="keywordflow">case</span> QNetworkReply::ProxyNotFoundError:
<a name="l00489"></a>00489     <span class="keywordflow">case</span> QNetworkReply::ProxyTimeoutError:
<a name="l00490"></a>00490     <span class="keywordflow">case</span> QNetworkReply::ProxyAuthenticationRequiredError:
<a name="l00491"></a>00491     <span class="keywordflow">case</span> QNetworkReply::ContentAccessDenied:
<a name="l00492"></a>00492     <span class="keywordflow">case</span> QNetworkReply::ContentOperationNotPermittedError:
<a name="l00493"></a>00493     <span class="keywordflow">case</span> QNetworkReply::ContentNotFoundError:
<a name="l00494"></a>00494     <span class="keywordflow">case</span> QNetworkReply::ContentReSendError:
<a name="l00495"></a>00495     <span class="keywordflow">case</span> QNetworkReply::ProtocolUnknownError:
<a name="l00496"></a>00496     <span class="keywordflow">case</span> QNetworkReply::ProtocolInvalidOperationError:
<a name="l00497"></a>00497     <span class="keywordflow">case</span> QNetworkReply::UnknownNetworkError:
<a name="l00498"></a>00498     <span class="keywordflow">case</span> QNetworkReply::UnknownProxyError:
<a name="l00499"></a>00499     <span class="keywordflow">case</span> QNetworkReply::UnknownContentError:
<a name="l00500"></a>00500     <span class="keywordflow">case</span> QNetworkReply::ProtocolFailure:
<a name="l00501"></a>00501       {
<a name="l00502"></a>00502   <span class="comment">// Retry later.</span>
<a name="l00503"></a>00503   <a class="code" href="logging__c_8h.html#abea298723ad956e744c9efec71512dd0">logg</a>(<span class="stringliteral">&quot;upload failure %d, retrying later&quot;</span>, errCode);
<a name="l00504"></a>00504   <a class="code" href="classCUploader.html#a723cc544d0e91ce2d31048341d8bb875">iNumPostFailures</a>++;
<a name="l00505"></a>00505   <a class="code" href="classCUploader.html#af62d9738ca77007ae37796006d71cc1a">SetPostTimer</a>();
<a name="l00506"></a>00506         <span class="keywordflow">break</span>;
<a name="l00507"></a>00507       }<span class="comment"></span>
<a name="l00508"></a>00508 <span class="comment">      //// permanent failure</span>
<a name="l00509"></a>00509 <span class="comment"></span>    <span class="keywordflow">case</span> QNetworkReply::AuthenticationRequiredError:
<a name="l00510"></a>00510       {
<a name="l00511"></a>00511         <span class="comment">// We must be doing something wrong. Better stop altogether,</span>
<a name="l00512"></a>00512         <span class="comment">// barring external intervention.</span>
<a name="l00513"></a>00513   <a class="code" href="er__errors_8h.html#a38fb855b186279a938f48b0407296a29">er_log_none</a>(0, <span class="stringliteral">&quot;inactivating uploader due to a permanent posting failure (%d)&quot;</span>, errCode);
<a name="l00514"></a>00514   <a class="code" href="classCUploader.html#a5bb59f6cd4340d71a9b6700d795d46f9">Inactivate</a>();
<a name="l00515"></a>00515         <span class="keywordflow">break</span>;
<a name="l00516"></a>00516       }<span class="comment"></span>
<a name="l00517"></a>00517 <span class="comment">      //// unknown failure</span>
<a name="l00518"></a>00518 <span class="comment"></span>    <span class="keywordflow">default</span>:
<a name="l00519"></a>00519       {
<a name="l00520"></a>00520   <a class="code" href="logging__c_8h.html#abea298723ad956e744c9efec71512dd0">logg</a>(<span class="stringliteral">&quot;unknown upload failure %d, retrying later&quot;</span>, errCode);
<a name="l00521"></a>00521   <a class="code" href="classCUploader.html#a723cc544d0e91ce2d31048341d8bb875">iNumPostFailures</a>++;
<a name="l00522"></a>00522   <a class="code" href="classCUploader.html#af62d9738ca77007ae37796006d71cc1a">SetPostTimer</a>();
<a name="l00523"></a>00523         <span class="keywordflow">break</span>;
<a name="l00524"></a>00524       }
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526 }
<a name="l00527"></a>00527 
<a name="l00528"></a><a class="code" href="classPostSession.html#a407787ebc24a3503a9dbe92c75b86e6a">00528</a> <a class="code" href="classPostSession.html#a407787ebc24a3503a9dbe92c75b86e6a">PostSession::PostSession</a>() : 
<a name="l00529"></a>00529   iNetworkReply(NULL), iFileToPost(NULL), 
<a name="l00530"></a>00530   iPrologue(NULL), iEpilogue(NULL), 
<a name="l00531"></a>00531   iPostData(NULL)
<a name="l00532"></a>00532 {
<a name="l00533"></a>00533 }  
<a name="l00534"></a>00534 
<a name="l00535"></a><a class="code" href="classPostSession.html#a1ab463ef6fcb6dd6e31ad11a4475b438">00535</a> <a class="code" href="classPostSession.html#a1ab463ef6fcb6dd6e31ad11a4475b438">PostSession::~PostSession</a>()
<a name="l00536"></a>00536 {
<a name="l00537"></a>00537   <span class="comment">//logh();</span>
<a name="l00538"></a>00538   <span class="keywordflow">if</span> (<a class="code" href="classPostSession.html#a0a63e8d878d3cd38f667b1029308102d">iNetworkReply</a>) {
<a name="l00539"></a>00539     <a class="code" href="classPostSession.html#a0a63e8d878d3cd38f667b1029308102d">iNetworkReply</a>-&gt;abort();
<a name="l00540"></a>00540     DELETE_Z(<a class="code" href="classPostSession.html#a0a63e8d878d3cd38f667b1029308102d">iNetworkReply</a>);
<a name="l00541"></a>00541   }
<a name="l00542"></a>00542   DELETE_Z(<a class="code" href="classPostSession.html#ae372e376a8bc10001a180c65f1bd6e0c">iPostData</a>);
<a name="l00543"></a>00543   <a class="code" href="classPostSession.html#ae8ed9da607f27affad96f97ca604d562">iPostElems</a>.clear();
<a name="l00544"></a>00544   <span class="keywordflow">if</span> (<a class="code" href="classPostSession.html#a7d273697d1090a5889e5ede29f599817">iFileToPost</a>) {
<a name="l00545"></a>00545     <a class="code" href="classPostSession.html#a7d273697d1090a5889e5ede29f599817">iFileToPost</a>-&gt;close();
<a name="l00546"></a>00546   }
<a name="l00547"></a>00547   DELETE_Z(<a class="code" href="classPostSession.html#a14372062aaf2ea1c7dd2c7913a7ae07c">iPrologue</a>);
<a name="l00548"></a>00548   DELETE_Z(<a class="code" href="classPostSession.html#ad24ad5af71d5f4a6c5d90326e740b885">iEpilogue</a>);
<a name="l00549"></a>00549 }
<a name="l00550"></a>00550 
<a name="l00551"></a>00551 <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#a9082efa2cd23dd596fb56cc330a35b5d">CUploader::DestroyPosterAo</a>()
<a name="l00552"></a>00552 {
<a name="l00553"></a>00553   DELETE_Z(<a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>);
<a name="l00554"></a>00554 }
<a name="l00555"></a>00555 
<a name="l00556"></a><a class="code" href="classCUploader.html#a4a245d61cd4509a94520489d3acbfaa7">00556</a> <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#a4a245d61cd4509a94520489d3acbfaa7">CUploader::CreatePosterAoL</a>()
<a name="l00557"></a>00557 {
<a name="l00558"></a>00558   assert(!<a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>);
<a name="l00559"></a>00559   assert(<a class="code" href="classCUploader.html#a0e16a1cb5b1666917c153c4f42bd2c72">iFileToPost</a>);
<a name="l00560"></a>00560 
<a name="l00561"></a>00561   QByteArray ba = (<a class="code" href="classCUploader.html#a0e16a1cb5b1666917c153c4f42bd2c72">iFileToPost</a>-&gt;fileName().toLocal8Bit());
<a name="l00562"></a>00562   <span class="keyword">const</span> <span class="keywordtype">char</span>* pathname = ba.data();
<a name="l00563"></a>00563   <a class="code" href="er__errors_8h.html#a812dd79a9d8d1eb96710602911653d44">dblogg</a>(<span class="stringliteral">&quot;asking poster to post &apos;%s&apos;&quot;</span>, pathname);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565   <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a> = q_check_ptr(<span class="keyword">new</span> <a class="code" href="classPostSession.html">PostSession</a>());
<a name="l00566"></a>00566 
<a name="l00567"></a>00567   <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#a7d273697d1090a5889e5ede29f599817">iFileToPost</a> = <a class="code" href="classCUploader.html#a0e16a1cb5b1666917c153c4f42bd2c72">iFileToPost</a>;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569   <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#a14372062aaf2ea1c7dd2c7913a7ae07c">iPrologue</a> = q_check_ptr(<span class="keyword">new</span> QBuffer());
<a name="l00570"></a>00570   <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#ad24ad5af71d5f4a6c5d90326e740b885">iEpilogue</a> = q_check_ptr(<span class="keyword">new</span> QBuffer());
<a name="l00571"></a>00571 
<a name="l00572"></a>00572   <span class="keyword">const</span> gchar* username = <a class="code" href="cf__query_8c.html#aa6804e9cceb0d18ab254133aa76891c6">get_config_username</a>();
<a name="l00573"></a>00573   <a class="code" href="logging__c_8h.html#abea298723ad956e744c9efec71512dd0">logg</a>(<span class="stringliteral">&quot;uploader using username &apos;%s&apos;&quot;</span>, username);
<a name="l00574"></a>00574 
<a name="l00575"></a>00575   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* KSep = <span class="stringliteral">&quot;--&quot;</span>;
<a name="l00576"></a>00576   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* KCrLf = <span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l00577"></a>00577 
<a name="l00578"></a>00578   QByteArray&amp; prologue = <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#a14372062aaf2ea1c7dd2c7913a7ae07c">iPrologue</a>-&gt;buffer();
<a name="l00579"></a>00579   prologue.append(KSep);
<a name="l00580"></a>00580   prologue.append(KBoundary);
<a name="l00581"></a>00581   prologue.append(KCrLf);
<a name="l00582"></a>00582   prologue.append(<span class="stringliteral">&quot;Content-Disposition: form-data; name=\&quot;logdata\&quot;; filename=\&quot;&quot;</span>);
<a name="l00583"></a>00583   prologue.append(username);
<a name="l00584"></a>00584   prologue.append(<span class="stringliteral">&quot;.db\&quot;\r\nContent-Type: application/octet-stream\r\nContent-Transfer-Encoding: binary\r\n\r\n&quot;</span>);
<a name="l00585"></a>00585 
<a name="l00586"></a>00586   QByteArray&amp; epilogue = <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#ad24ad5af71d5f4a6c5d90326e740b885">iEpilogue</a>-&gt;buffer();
<a name="l00587"></a>00587   epilogue.append(KCrLf);
<a name="l00588"></a>00588   epilogue.append(KSep);
<a name="l00589"></a>00589   epilogue.append(KBoundary);
<a name="l00590"></a>00590   epilogue.append(KCrLf);
<a name="l00591"></a>00591   epilogue.append(<span class="stringliteral">&quot;Content-Disposition: form-data; name=\&quot;logdata_submit\&quot;\r\n\r\nUpload\r\n&quot;</span>);
<a name="l00592"></a>00592   epilogue.append(KSep);
<a name="l00593"></a>00593   epilogue.append(KBoundary);
<a name="l00594"></a>00594   epilogue.append(KSep);
<a name="l00595"></a>00595   epilogue.append(KCrLf);
<a name="l00596"></a>00596 
<a name="l00597"></a>00597   <span class="keywordflow">if</span> (!<a class="code" href="classCUploader.html#a0e16a1cb5b1666917c153c4f42bd2c72">iFileToPost</a>-&gt;open(QIODevice::ReadOnly)) {
<a name="l00598"></a>00598     <span class="keywordtype">int</span> errCode = (<a class="code" href="classCUploader.html#a0e16a1cb5b1666917c153c4f42bd2c72">iFileToPost</a>-&gt;error());
<a name="l00599"></a>00599     <a class="code" href="gx__exception_8hpp.html#ad3c99cd0dd7070aa681e8bf411ba03e9">gx_throw</a>(<a class="code" href="gxerror_8c.html#a75e3ca4bc4d268c9470ec2c141fa4d47">gx_error_new</a>(<a class="code" href="error__list_8h.html#afd39a5cc65997ba2f508017b8c1dde68">domain_qt</a>, errCode, 
<a name="l00600"></a>00600         <span class="stringliteral">&quot;failed to open file &apos;%s&apos;: QFile::FileError %d&quot;</span>, 
<a name="l00601"></a>00601         pathname, errCode));
<a name="l00602"></a>00602   }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604 <span class="preprocessor">#define CHECKBUFOPEN(x) throw_cstr_unless(x, &quot;QBuffer open failed&quot;)</span>
<a name="l00605"></a>00605 <span class="preprocessor"></span>  <a class="code" href="up__uploader__qt_8cpp.html#aedb3a7033b96a8b5e10109764e821ea5">CHECKBUFOPEN</a>(<a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#a14372062aaf2ea1c7dd2c7913a7ae07c">iPrologue</a>-&gt;open(QIODevice::ReadOnly));
<a name="l00606"></a>00606   <a class="code" href="up__uploader__qt_8cpp.html#aedb3a7033b96a8b5e10109764e821ea5">CHECKBUFOPEN</a>(<a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#ad24ad5af71d5f4a6c5d90326e740b885">iEpilogue</a>-&gt;open(QIODevice::ReadOnly));
<a name="l00607"></a>00607 
<a name="l00608"></a>00608   <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#ae8ed9da607f27affad96f97ca604d562">iPostElems</a>.append(<a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#a14372062aaf2ea1c7dd2c7913a7ae07c">iPrologue</a>);
<a name="l00609"></a>00609   <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#ae8ed9da607f27affad96f97ca604d562">iPostElems</a>.append(<a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#a7d273697d1090a5889e5ede29f599817">iFileToPost</a>);
<a name="l00610"></a>00610   <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#ae8ed9da607f27affad96f97ca604d562">iPostElems</a>.append(<a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#ad24ad5af71d5f4a6c5d90326e740b885">iEpilogue</a>);
<a name="l00611"></a>00611 
<a name="l00612"></a>00612   <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#ae372e376a8bc10001a180c65f1bd6e0c">iPostData</a> = q_check_ptr(<span class="keyword">new</span> <a class="code" href="classQIODeviceSeq.html">QIODeviceSeq</a>(<a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#ae8ed9da607f27affad96f97ca604d562">iPostElems</a>));
<a name="l00613"></a>00613 
<a name="l00614"></a>00614   <span class="comment">// Note that the file object (or the file) may not be deleted until</span>
<a name="l00615"></a>00615   <span class="comment">// we get the finished() signal for this reply.</span>
<a name="l00616"></a>00616   <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#a0a63e8d878d3cd38f667b1029308102d">iNetworkReply</a> = 
<a name="l00617"></a>00617     <a class="code" href="classCUploader.html#a5ecaa6598458996a6f71a6093ed8ce3a">iNetworkAccessManager</a>.post(<a class="code" href="classCUploader.html#a0f7c390d2e45965508103bca64249a48">iNetworkRequest</a>, <a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#ae372e376a8bc10001a180c65f1bd6e0c">iPostData</a>);
<a name="l00618"></a>00618 
<a name="l00619"></a>00619   connect(<a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#a0a63e8d878d3cd38f667b1029308102d">iNetworkReply</a>, SIGNAL(sslErrors(<span class="keyword">const</span> QList&lt;QSslError&gt; &amp;)),
<a name="l00620"></a>00620     <span class="keyword">this</span>, SLOT(<a class="code" href="classCUploader.html#a6984ea57f55f841a48ec8531ef0963a3">postingSslErrors</a>(<span class="keyword">const</span> QList&lt;QSslError&gt; &amp;)));
<a name="l00621"></a>00621   connect(<a class="code" href="classCUploader.html#a17a9ae20eae2d2346122b90cabfb82a5">iPostSession</a>-&gt;<a class="code" href="classPostSession.html#a0a63e8d878d3cd38f667b1029308102d">iNetworkReply</a>, SIGNAL(finished()),
<a name="l00622"></a>00622     <span class="keyword">this</span>, SLOT(<a class="code" href="classCUploader.html#a582670cecd2888b237ada2af2e5005c9">postingFinished</a>()));
<a name="l00623"></a>00623 }
<a name="l00624"></a>00624 
<a name="l00625"></a>00625 <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#ac793a729f5305eee74d4b4ceee652008">CUploader::PostNowL</a>()
<a name="l00626"></a>00626 {
<a name="l00627"></a>00627   <a class="code" href="classCUploader.html#a4a245d61cd4509a94520489d3acbfaa7">CreatePosterAoL</a>();
<a name="l00628"></a>00628 }
<a name="l00629"></a>00629 
<a name="l00630"></a>00630 <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#afada293f4d7790b54b96a3ad51f4dbdd">CUploader::TakeSnapshotNowL</a>()
<a name="l00631"></a>00631 {
<a name="l00632"></a>00632   <a class="code" href="er__errors_8h.html#ab339605c1c09843b74ed9beabd5bd8f9">dblogt</a>(<span class="stringliteral">&quot;taking snapshot now&quot;</span>);
<a name="l00633"></a>00633 
<a name="l00634"></a>00634   <span class="comment">// LOG_UPLOADS_DIR and LOGDB_DIR must be on the same device to allow</span>
<a name="l00635"></a>00635   <span class="comment">// for renaming rather than copying.</span>
<a name="l00636"></a>00636   <span class="keywordtype">char</span>* pathname = tempnam(<a class="code" href="ac__app__context_8h.html#a0fd2cfda764ade87d6a5ada79eca4987">LOG_UPLOADS_DIR</a>, <span class="stringliteral">&quot;log_&quot;</span>); <span class="comment">// caller must free &apos;pathname&apos;</span>
<a name="l00637"></a>00637   <span class="keywordflow">if</span> (!pathname) {
<a name="l00638"></a>00638     <a class="code" href="er__errors_8h.html#a5f74b6eea0be228404efd4a23c25f406">er_log_errno</a>(<a class="code" href="er__errors_8h.html#a74b7465a12d63ad80bc10d1ebaf900d8">er_FATAL</a>, <span class="stringliteral">&quot;failure in tempnam&quot;</span>);
<a name="l00639"></a>00639   }
<a name="l00640"></a>00640   
<a name="l00641"></a>00641   gboolean wasRenamed = FALSE;
<a name="l00642"></a>00642   GError* snapError = NULL;
<a name="l00643"></a>00643   <span class="keywordflow">if</span> (!<a class="code" href="ld__log__db_8c.html#a55563ed5bc2ecfcb239f001fcc4baaf3">log_db_take_snapshot</a>(<a class="code" href="classCUploader.html#a728b07158dc2504b67356a3730b9ce96">GetLogDb</a>(), pathname, &amp;wasRenamed, &amp;snapError)) {
<a name="l00644"></a>00644     <a class="code" href="logging__c_8h.html#abea298723ad956e744c9efec71512dd0">logg</a>(<span class="stringliteral">&quot;failure taking snapshot to file &apos;%s&apos;&quot;</span>, pathname);
<a name="l00645"></a>00645     free(pathname);
<a name="l00646"></a>00646     <a class="code" href="logging__c_8h.html#abea298723ad956e744c9efec71512dd0">logg</a>(<span class="stringliteral">&quot;snapshot file was%s created&quot;</span>, wasRenamed ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot; not&quot;</span>);
<a name="l00647"></a>00647     <a class="code" href="er__errors_8h.html#a0f3362e469d9427660e2f1fd290b5eb2">er_log_gerror</a>(<a class="code" href="er__errors_8h.html#a74b7465a12d63ad80bc10d1ebaf900d8">er_FATAL</a>|<a class="code" href="er__errors_8h.html#a586203382212832772429f0a9cbb3774">er_FREE</a>, snapError, <span class="stringliteral">&quot;taking snapshot&quot;</span>);
<a name="l00648"></a>00648   }
<a name="l00649"></a>00649 
<a name="l00650"></a>00650   <a class="code" href="ld__log__db_8c.html#a593a2e358ba9033bbd885a1acd1ab3c2">log_db_log_status</a>(<a class="code" href="classCUploader.html#a728b07158dc2504b67356a3730b9ce96">GetLogDb</a>(), NULL, <span class="stringliteral">&quot;snapshot taken as &apos;%s&apos;&quot;</span>, pathname);
<a name="l00651"></a>00651 
<a name="l00652"></a>00652   assert(!<a class="code" href="classCUploader.html#a0e16a1cb5b1666917c153c4f42bd2c72">iFileToPost</a>);
<a name="l00653"></a>00653   <a class="code" href="classCUploader.html#a0e16a1cb5b1666917c153c4f42bd2c72">iFileToPost</a> = q_check_ptr(<span class="keyword">new</span> QFile(QString::fromUtf8(pathname)));
<a name="l00654"></a>00654   <a class="code" href="classCUploader.html#a5b9c4bcae12126c8aaaa45fc07655cdd">iSnapshotTimePassed</a> = <span class="keyword">false</span>;
<a name="l00655"></a>00655   <a class="code" href="classCUploader.html#aaf851c238e691609ec2a2b1e17845013">StateChangedL</a>();
<a name="l00656"></a>00656 }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 <span class="comment">// Better by careful not to run out of stack calling this recursively.</span>
<a name="l00659"></a>00659 <span class="comment">// Can always use an &quot;ImmediateAo&quot; if necessary to avoid such a risk.</span>
<a name="l00660"></a>00660 <span class="keywordtype">void</span> <a class="code" href="classCUploader.html#aaf851c238e691609ec2a2b1e17845013">CUploader::StateChangedL</a>()
<a name="l00661"></a>00661 {
<a name="l00662"></a>00662   <span class="keywordflow">if</span> (<a class="code" href="classCUploader.html#a53862c92a4820d4f291bb0289ad72ce8">iNoConfig</a>)
<a name="l00663"></a>00663     <span class="keywordflow">return</span>;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665   <span class="keywordflow">if</span> (!<a class="code" href="classCUploader.html#a5b9c4bcae12126c8aaaa45fc07655cdd">iSnapshotTimePassed</a> &amp;&amp;
<a name="l00666"></a>00666       !<a class="code" href="classCUploader.html#ab45a1c61ed10cfac50fe97d8c8bfa8b7">iNoNextSnapshotTime</a> &amp;&amp;
<a name="l00667"></a>00667       !<a class="code" href="classCUploader.html#aec0d7af7fba5b97153166800ab462309">iSnapshotTimerAo</a>.isActive()) {
<a name="l00668"></a>00668     <a class="code" href="classCUploader.html#af1fc7f25fd6a84a14e219b54b26fea38">SetSnapshotTimerL</a>();
<a name="l00669"></a>00669   }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671   <span class="keywordflow">if</span> (!<a class="code" href="classCUploader.html#a06f9078e35a9464cdfbc3de748498dfe">PosterAoIsActive</a>())
<a name="l00672"></a>00672     <a class="code" href="classCUploader.html#a9082efa2cd23dd596fb56cc330a35b5d">DestroyPosterAo</a>(); <span class="comment">// make sure no connection remains</span>
<a name="l00673"></a>00673 
<a name="l00674"></a>00674  again:
<a name="l00675"></a>00675   <span class="keywordflow">if</span> (<a class="code" href="classCUploader.html#a0e16a1cb5b1666917c153c4f42bd2c72">iFileToPost</a>) {
<a name="l00676"></a>00676     <span class="keywordflow">if</span> (<a class="code" href="classCUploader.html#a06f9078e35a9464cdfbc3de748498dfe">PosterAoIsActive</a>() || <a class="code" href="classCUploader.html#ad8f5425d22b1ad5240dfa0a5e8df3501">iPostTimerAo</a>.isActive())
<a name="l00677"></a>00677       <span class="keywordflow">return</span>;
<a name="l00678"></a>00678     <span class="keywordflow">if</span> (<a class="code" href="classCUploader.html#afd82e74323ae66d14e5ecde74816346e">i_uploads_allowed</a>) {
<a name="l00679"></a>00679       <a class="code" href="classCUploader.html#ac793a729f5305eee74d4b4ceee652008">PostNowL</a>(); <span class="comment">// not called elsewhere</span>
<a name="l00680"></a>00680     }
<a name="l00681"></a>00681   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="classCUploader.html#a218321e8998867affb63121ad4e2fbea">iNoOldFiles</a>) {
<a name="l00682"></a>00682     <a class="code" href="classCUploader.html#afdaacaad9a951e2dffb3fbbe56264d16">NextOldFileL</a>();
<a name="l00683"></a>00683     <span class="keywordflow">goto</span> again;
<a name="l00684"></a>00684   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classCUploader.html#a5b9c4bcae12126c8aaaa45fc07655cdd">iSnapshotTimePassed</a>) {
<a name="l00685"></a>00685     <a class="code" href="classCUploader.html#afada293f4d7790b54b96a3ad51f4dbdd">TakeSnapshotNowL</a>(); <span class="comment">// not called elsewhere</span>
<a name="l00686"></a>00686   }
<a name="l00687"></a>00687 }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689 <span class="comment">// --------------------------------------------------</span>
<a name="l00690"></a>00690 <span class="comment">// global system state</span>
<a name="l00691"></a>00691 <span class="comment">// --------------------------------------------------</span>
<a name="l00692"></a>00692 
<a name="l00693"></a><a class="code" href="up__uploader__qt_8cpp.html#aac88a2355d08f9a88c66a311d6822e3b">00693</a> <a class="code" href="sh__utils_8h.html#abbaccfbed35b945162c27ef6d3748e77">EXTERN_C</a> gboolean <a class="code" href="up__uploader_8h.html#a121efd3ec7afd52277fc0fabf8d5ba4f">up_global_init</a>(GError** error)
<a name="l00694"></a>00694 {
<a name="l00695"></a>00695   <span class="comment">// Nothing to do.</span>
<a name="l00696"></a>00696   <span class="keywordflow">return</span> TRUE;
<a name="l00697"></a>00697 }
<a name="l00698"></a>00698 
<a name="l00699"></a><a class="code" href="up__uploader__qt_8cpp.html#af63b1c9c77ce7edd9b6b21041614258b">00699</a> <a class="code" href="sh__utils_8h.html#abbaccfbed35b945162c27ef6d3748e77">EXTERN_C</a> <span class="keywordtype">void</span> <a class="code" href="up__uploader_8h.html#a21d8f167d3bdd44aa74cde1923e8d538">up_global_cleanup</a>()
<a name="l00700"></a>00700 {
<a name="l00701"></a>00701   <span class="comment">// Nothing to do.</span>
<a name="l00702"></a>00702 }
<a name="l00703"></a>00703 
<a name="l00704"></a>00704 <span class="comment">// --------------------------------------------------</span>
<a name="l00705"></a>00705 <span class="comment">// API</span>
<a name="l00706"></a>00706 <span class="comment">// --------------------------------------------------</span>
<a name="l00707"></a>00707 
<a name="l00708"></a><a class="code" href="up__uploader__qt_8cpp.html#a4e50189537aa61beb282d36f5058ed40">00708</a> <a class="code" href="sh__utils_8h.html#abbaccfbed35b945162c27ef6d3748e77">EXTERN_C</a> gboolean <a class="code" href="up__uploader_8h.html#a00c7ece5919b83882d7fb3607d7dc970">up_Uploader_upload_now</a>(<a class="code" href="up__uploader_8h.html#a53415b00752398eec70f361e5833d708">up_Uploader</a>* <span class="keywordtype">object</span>, GError** error)
<a name="l00709"></a>00709 {
<a name="l00710"></a>00710   ((<a class="code" href="classCUploader.html">CUploader</a>*)<span class="keywordtype">object</span>)-&gt;RequestSnapshot();
<a name="l00711"></a>00711   <span class="keywordflow">return</span> TRUE;
<a name="l00712"></a>00712 }
<a name="l00713"></a>00713 
<a name="l00714"></a><a class="code" href="up__uploader__qt_8cpp.html#aa5622c66cfd228bc5c02b7dedcda0190">00714</a> <a class="code" href="sh__utils_8h.html#abbaccfbed35b945162c27ef6d3748e77">EXTERN_C</a> gboolean <a class="code" href="up__uploader_8h.html#a6cefcbe34a192d777513aa60088b8e51">up_Uploader_reconfigure</a>(<a class="code" href="up__uploader_8h.html#a53415b00752398eec70f361e5833d708">up_Uploader</a>* <span class="keywordtype">object</span>,
<a name="l00715"></a>00715             <span class="keyword">const</span> gchar* key,
<a name="l00716"></a>00716             <span class="keyword">const</span> gchar* value, 
<a name="l00717"></a>00717             GError** error)
<a name="l00718"></a>00718 {
<a name="l00719"></a>00719   <span class="keywordflow">if</span> (strcmp(key, <span class="stringliteral">&quot;iap&quot;</span>) == 0) {
<a name="l00720"></a>00720     ((<a class="code" href="classCUploader.html">CUploader</a>*)<span class="keywordtype">object</span>)-&gt;RefreshIap(<span class="keyword">true</span>);
<a name="l00721"></a>00721   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(key, <span class="stringliteral">&quot;uploader.time_expr&quot;</span>) == 0) {
<a name="l00722"></a>00722     ((<a class="code" href="classCUploader.html">CUploader</a>*)<span class="keywordtype">object</span>)-&gt;RefreshSnapshotTimeExpr(<span class="keyword">true</span>);
<a name="l00723"></a>00723   }
<a name="l00724"></a>00724   <span class="keywordflow">return</span> TRUE;
<a name="l00725"></a>00725 }
<a name="l00726"></a>00726 
<a name="l00727"></a><a class="code" href="up__uploader__qt_8cpp.html#ad8129cc5670628b69b11e7f1dd943279">00727</a> <a class="code" href="sh__utils_8h.html#abbaccfbed35b945162c27ef6d3748e77">EXTERN_C</a> <a class="code" href="up__uploader_8h.html#a53415b00752398eec70f361e5833d708">up_Uploader</a>* <a class="code" href="up__uploader_8h.html#a1fe68e57760b09074de5dd04a8ee2a40">up_Uploader_new</a>(<a class="code" href="struct__ac__AppContext.html">ac_AppContext</a>* aAppContext, GError** error)
<a name="l00728"></a>00728 {
<a name="l00729"></a>00729   <a class="code" href="classCUploader.html">CUploader</a>* <span class="keywordtype">object</span> = NULL;
<a name="l00730"></a>00730   <span class="keywordflow">try</span> {
<a name="l00731"></a>00731     <span class="keywordtype">object</span> = q_check_ptr(<span class="keyword">new</span> <a class="code" href="classCUploader.html">CUploader</a>(aAppContext));
<a name="l00732"></a>00732   } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;ex) {
<a name="l00733"></a>00733     <span class="keywordflow">if</span> (error)
<a name="l00734"></a>00734       *error = <a class="code" href="gxerror_8c.html#a75e3ca4bc4d268c9470ec2c141fa4d47">gx_error_new</a>(<a class="code" href="error__list_8h.html#afd39a5cc65997ba2f508017b8c1dde68">domain_qt</a>, -1, <span class="stringliteral">&quot;Uploader init failure: %s&quot;</span>, ex.what());
<a name="l00735"></a>00735     <span class="keywordflow">return</span> NULL;
<a name="l00736"></a>00736   }
<a name="l00737"></a>00737   <span class="keywordflow">return</span> (<a class="code" href="up__uploader_8h.html#a53415b00752398eec70f361e5833d708">up_Uploader</a>*)object;
<a name="l00738"></a>00738 }
<a name="l00739"></a>00739 
<a name="l00740"></a><a class="code" href="up__uploader__qt_8cpp.html#abf8ce0412d4a856a64f4776906faef17">00740</a> <a class="code" href="sh__utils_8h.html#abbaccfbed35b945162c27ef6d3748e77">EXTERN_C</a> <span class="keywordtype">void</span> <a class="code" href="up__uploader_8h.html#ac282a7b11fcb8b806a6d705f6aa01009">up_Uploader_destroy</a>(<a class="code" href="up__uploader_8h.html#a53415b00752398eec70f361e5833d708">up_Uploader</a>* <span class="keywordtype">object</span>)
<a name="l00741"></a>00741 {
<a name="l00742"></a>00742   <span class="keyword">delete</span> ((<a class="code" href="classCUploader.html">CUploader</a>*)<span class="keywordtype">object</span>);
<a name="l00743"></a>00743 }
<a name="l00744"></a>00744 <span class="comment"></span>
<a name="l00745"></a>00745 <span class="comment">/**</span>
<a name="l00746"></a>00746 <span class="comment"></span>
<a name="l00747"></a>00747 <span class="comment">Copyright 2009 Helsinki Institute for Information Technology (HIIT)</span>
<a name="l00748"></a>00748 <span class="comment">and the authors. All rights reserved.</span>
<a name="l00749"></a>00749 <span class="comment"></span>
<a name="l00750"></a>00750 <span class="comment">Authors: Tero Hasu &lt;tero.hasu@hut.fi&gt;</span>
<a name="l00751"></a>00751 <span class="comment"></span>
<a name="l00752"></a>00752 <span class="comment">Permission is hereby granted, free of charge, to any person</span>
<a name="l00753"></a>00753 <span class="comment">obtaining a copy of this software and associated documentation files</span>
<a name="l00754"></a>00754 <span class="comment">(the &quot;Software&quot;), to deal in the Software without restriction,</span>
<a name="l00755"></a>00755 <span class="comment">including without limitation the rights to use, copy, modify, merge,</span>
<a name="l00756"></a>00756 <span class="comment">publish, distribute, sublicense, and/or sell copies of the Software,</span>
<a name="l00757"></a>00757 <span class="comment">and to permit persons to whom the Software is furnished to do so,</span>
<a name="l00758"></a>00758 <span class="comment">subject to the following conditions:</span>
<a name="l00759"></a>00759 <span class="comment"></span>
<a name="l00760"></a>00760 <span class="comment">The above copyright notice and this permission notice shall be</span>
<a name="l00761"></a>00761 <span class="comment">included in all copies or substantial portions of the Software.</span>
<a name="l00762"></a>00762 <span class="comment"></span>
<a name="l00763"></a>00763 <span class="comment">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<a name="l00764"></a>00764 <span class="comment">EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<a name="l00765"></a>00765 <span class="comment">MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<a name="l00766"></a>00766 <span class="comment">NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<a name="l00767"></a>00767 <span class="comment">BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<a name="l00768"></a>00768 <span class="comment">ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<a name="l00769"></a>00769 <span class="comment">CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<a name="l00770"></a>00770 <span class="comment">SOFTWARE.</span>
<a name="l00771"></a>00771 <span class="comment"></span>
<a name="l00772"></a>00772 <span class="comment"> **/</span>
</pre></div></div>
<hr size="1">

<p style="text-align: right;">
  <a href="http://www.contextlogger.org/">ContextLogger2</a>&#8212;ContextLogger2 Logger Daemon Internals&#8212;<small>Generated on Mon May 2 13:49:57 2011 by&nbsp;<a href="http://www.doxygen.org/">Doxygen</a> 1.6.1</small>
</p>

</body>
</html>
