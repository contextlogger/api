<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ContextLogger2 Logger Daemon Internals: prepare.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_53e7feede50ae4cb655a635f658a2b4e.html">sqlite3h</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_a0c08fff43b69094a2511677d8587129.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_05c6b5177aad09a72e8ee1adc608dac0.html">sqlite3</a>
  </div>
</div>
<div class="contents">
<h1>prepare.c</h1><a href="prepare_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">** 2005 May 25</span>
<a name="l00003"></a>00003 <span class="comment">**</span>
<a name="l00004"></a>00004 <span class="comment">** The author disclaims copyright to this source code.  In place of</span>
<a name="l00005"></a>00005 <span class="comment">** a legal notice, here is a blessing:</span>
<a name="l00006"></a>00006 <span class="comment">**</span>
<a name="l00007"></a>00007 <span class="comment">**    May you do good and not evil.</span>
<a name="l00008"></a>00008 <span class="comment">**    May you find forgiveness for yourself and forgive others.</span>
<a name="l00009"></a>00009 <span class="comment">**    May you share freely, never taking more than you give.</span>
<a name="l00010"></a>00010 <span class="comment">**</span>
<a name="l00011"></a>00011 <span class="comment">*************************************************************************</span>
<a name="l00012"></a>00012 <span class="comment">** This file contains the implementation of the sqlite3_prepare()</span>
<a name="l00013"></a>00013 <span class="comment">** interface, and routines that contribute to loading the database schema</span>
<a name="l00014"></a>00014 <span class="comment">** from disk.</span>
<a name="l00015"></a>00015 <span class="comment">**</span>
<a name="l00016"></a>00016 <span class="comment">** $Id: prepare.c,v 1.98 2008/10/31 10:53:23 danielk1977 Exp $</span>
<a name="l00017"></a>00017 <span class="comment">*/</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="sqliteInt_8h.html">sqliteInt.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="comment">/*</span>
<a name="l00022"></a>00022 <span class="comment">** Fill the InitData structure with an error message that indicates</span>
<a name="l00023"></a>00023 <span class="comment">** that the database is corrupt.</span>
<a name="l00024"></a>00024 <span class="comment">*/</span>
<a name="l00025"></a><a class="code" href="prepare_8c.html#a9fba70569e9a18d95220854f44ea28c5">00025</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="prepare_8c.html#a9fba70569e9a18d95220854f44ea28c5">corruptSchema</a>(
<a name="l00026"></a>00026   <a class="code" href="structInitData.html">InitData</a> *pData,     <span class="comment">/* Initialization context */</span>
<a name="l00027"></a>00027   <span class="keyword">const</span> <span class="keywordtype">char</span> *zObj,    <span class="comment">/* Object being parsed at the point of error */</span>
<a name="l00028"></a>00028   <span class="keyword">const</span> <span class="keywordtype">char</span> *zExtra   <span class="comment">/* Error information */</span>
<a name="l00029"></a>00029 ){
<a name="l00030"></a>00030   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a> = pData-&gt;<a class="code" href="structInitData.html#adc9e29c56e0392076e92d7f4b29fa272">db</a>;
<a name="l00031"></a>00031   <span class="keywordflow">if</span>( !db-&gt;<a class="code" href="structsqlite3.html#a79beb0036337ba7fc2de5ccbb9225935">mallocFailed</a> &amp;&amp; (db-&gt;<a class="code" href="structsqlite3.html#a8dac784e669d6b8a9f936d3193c1aaec">flags</a> &amp; <a class="code" href="sqliteInt_8h.html#aa6554fca0be084740ad54c8120a5c457">SQLITE_RecoveryMode</a>)==0 ){
<a name="l00032"></a>00032     <span class="keywordflow">if</span>( zObj==0 ) zObj = <span class="stringliteral">&quot;?&quot;</span>;
<a name="l00033"></a>00033     <a class="code" href="malloc_8c.html#af1c1714a3fa3d522e9909a10b3e69cfb">sqlite3SetString</a>(pData-&gt;<a class="code" href="structInitData.html#aa8aef34241ec214f038b38932ffe1357">pzErrMsg</a>, pData-&gt;<a class="code" href="structInitData.html#adc9e29c56e0392076e92d7f4b29fa272">db</a>,
<a name="l00034"></a>00034        <span class="stringliteral">&quot;malformed database schema (%s)&quot;</span>, zObj);
<a name="l00035"></a>00035     <span class="keywordflow">if</span>( zExtra &amp;&amp; zExtra[0] ){
<a name="l00036"></a>00036       *pData-&gt;<a class="code" href="structInitData.html#aa8aef34241ec214f038b38932ffe1357">pzErrMsg</a> = <a class="code" href="printf_8c.html#a8c13cea9062e442b7163031ab6429681">sqlite3MAppendf</a>(pData-&gt;<a class="code" href="structInitData.html#adc9e29c56e0392076e92d7f4b29fa272">db</a>, *pData-&gt;<a class="code" href="structInitData.html#aa8aef34241ec214f038b38932ffe1357">pzErrMsg</a>, <span class="stringliteral">&quot;%s - %s&quot;</span>,
<a name="l00037"></a>00037                                   *pData-&gt;<a class="code" href="structInitData.html#aa8aef34241ec214f038b38932ffe1357">pzErrMsg</a>, zExtra);
<a name="l00038"></a>00038     }
<a name="l00039"></a>00039   }
<a name="l00040"></a>00040   pData-&gt;<a class="code" href="structInitData.html#a627153a3de2c4d159ae44ebc03961592">rc</a> = <a class="code" href="sqlite3_8h.html#a4b7e972bd61cc8f5fb639011d1807935">SQLITE_CORRUPT</a>;
<a name="l00041"></a>00041 }
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="comment">/*</span>
<a name="l00044"></a>00044 <span class="comment">** This is the callback routine for the code that initializes the</span>
<a name="l00045"></a>00045 <span class="comment">** database.  See sqlite3Init() below for additional information.</span>
<a name="l00046"></a>00046 <span class="comment">** This routine is also called from the OP_ParseSchema opcode of the VDBE.</span>
<a name="l00047"></a>00047 <span class="comment">**</span>
<a name="l00048"></a>00048 <span class="comment">** Each callback contains the following information:</span>
<a name="l00049"></a>00049 <span class="comment">**</span>
<a name="l00050"></a>00050 <span class="comment">**     argv[0] = name of thing being created</span>
<a name="l00051"></a>00051 <span class="comment">**     argv[1] = root page number for table or index. 0 for trigger or view.</span>
<a name="l00052"></a>00052 <span class="comment">**     argv[2] = SQL text for the CREATE statement.</span>
<a name="l00053"></a>00053 <span class="comment">**</span>
<a name="l00054"></a>00054 <span class="comment">*/</span>
<a name="l00055"></a><a class="code" href="sqliteInt_8h.html#a2e68f3f0521ee71ac5f4fcf2da63ab9e">00055</a> <span class="keywordtype">int</span> <a class="code" href="prepare_8c.html#ad97a9053636c29ea602f2211d5c53314">sqlite3InitCallback</a>(<span class="keywordtype">void</span> *pInit, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv, <span class="keywordtype">char</span> **azColName){
<a name="l00056"></a>00056   <a class="code" href="structInitData.html">InitData</a> *pData = (<a class="code" href="structInitData.html">InitData</a>*)pInit;
<a name="l00057"></a>00057   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a> = pData-&gt;<a class="code" href="structInitData.html#adc9e29c56e0392076e92d7f4b29fa272">db</a>;
<a name="l00058"></a>00058   <span class="keywordtype">int</span> iDb = pData-&gt;<a class="code" href="structInitData.html#ad6c7953b49d351cd9fb14e3394010689">iDb</a>;
<a name="l00059"></a>00059 
<a name="l00060"></a>00060   assert( <a class="code" href="mutex_8h.html#ab92b5e853fc83d5aaa9a5d25e1883d3d">sqlite3_mutex_held</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>) );
<a name="l00061"></a>00061   <a class="code" href="sqliteInt_8h.html#a7df9fb731dfaaa2bdcfa01ad3db1c4c6">DbClearProperty</a>(db, iDb, <a class="code" href="sqliteInt_8h.html#a71d4defda4c02eb7f153a2a50a85f54e">DB_Empty</a>);
<a name="l00062"></a>00062   <span class="keywordflow">if</span>( db-&gt;<a class="code" href="structsqlite3.html#a79beb0036337ba7fc2de5ccbb9225935">mallocFailed</a> ){
<a name="l00063"></a>00063     <a class="code" href="prepare_8c.html#a9fba70569e9a18d95220854f44ea28c5">corruptSchema</a>(pData, argv[0], 0);
<a name="l00064"></a>00064     <span class="keywordflow">return</span> <a class="code" href="sqlite3_8h.html#a9e34c7a5186dc9095e108e517eaac9f6">SQLITE_NOMEM</a>;
<a name="l00065"></a>00065   }
<a name="l00066"></a>00066 
<a name="l00067"></a>00067   assert( argc==3 );
<a name="l00068"></a>00068   assert( iDb&gt;=0 &amp;&amp; iDb&lt;db-&gt;nDb );
<a name="l00069"></a>00069   <span class="keywordflow">if</span>( argv==0 ) <span class="keywordflow">return</span> 0;   <span class="comment">/* Might happen if EMPTY_RESULT_CALLBACKS are on */</span>
<a name="l00070"></a>00070   <span class="keywordflow">if</span>( argv[1]==0 ){
<a name="l00071"></a>00071     <a class="code" href="prepare_8c.html#a9fba70569e9a18d95220854f44ea28c5">corruptSchema</a>(pData, argv[0], 0);
<a name="l00072"></a>00072   }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( argv[2] &amp;&amp; argv[2][0] ){
<a name="l00073"></a>00073     <span class="comment">/* Call the parser to process a CREATE TABLE, INDEX or VIEW.</span>
<a name="l00074"></a>00074 <span class="comment">    ** But because db-&gt;init.busy is set to 1, no VDBE code is generated</span>
<a name="l00075"></a>00075 <span class="comment">    ** or executed.  All the parser does is build the internal data</span>
<a name="l00076"></a>00076 <span class="comment">    ** structures that describe the table, index, or view.</span>
<a name="l00077"></a>00077 <span class="comment">    */</span>
<a name="l00078"></a>00078     <span class="keywordtype">char</span> *zErr;
<a name="l00079"></a>00079     <span class="keywordtype">int</span> rc;
<a name="l00080"></a>00080     <a class="code" href="sqliteInt_8h.html#a74a0f6424ae628af25f23f0a35f6ead3">u8</a> lookasideEnabled;
<a name="l00081"></a>00081     assert( db-&gt;<a class="code" href="structsqlite3.html#a14bb7fbfa6b662021069fcdf6b334d70">init</a>.<a class="code" href="structsqlite3_1_1sqlite3InitInfo.html#a6ac01842e0ae68023cb60fea93bd8688">busy</a> );
<a name="l00082"></a>00082     db-&gt;<a class="code" href="structsqlite3.html#a14bb7fbfa6b662021069fcdf6b334d70">init</a>.<a class="code" href="structsqlite3_1_1sqlite3InitInfo.html#a1dd98d805ac1ba2c0fe4d911d0639927">iDb</a> = iDb;
<a name="l00083"></a>00083     db-&gt;<a class="code" href="structsqlite3.html#a14bb7fbfa6b662021069fcdf6b334d70">init</a>.<a class="code" href="structsqlite3_1_1sqlite3InitInfo.html#a65250c8c5f215989e64294ede6c1c268">newTnum</a> = atoi(argv[1]);
<a name="l00084"></a>00084     lookasideEnabled = db-&gt;<a class="code" href="structsqlite3.html#a8a42788add62e1a59d0c930ecc190e87">lookaside</a>.<a class="code" href="structLookaside.html#adbe2c3486f893c30525e19388f35eb21">bEnabled</a>;
<a name="l00085"></a>00085     db-&gt;<a class="code" href="structsqlite3.html#a8a42788add62e1a59d0c930ecc190e87">lookaside</a>.<a class="code" href="structLookaside.html#adbe2c3486f893c30525e19388f35eb21">bEnabled</a> = 0;
<a name="l00086"></a>00086     rc = <a class="code" href="legacy_8c.html#ada787486cf95a994521cfd0c64e853e4">sqlite3_exec</a>(db, argv[2], 0, 0, &amp;zErr);
<a name="l00087"></a>00087     db-&gt;<a class="code" href="structsqlite3.html#a14bb7fbfa6b662021069fcdf6b334d70">init</a>.<a class="code" href="structsqlite3_1_1sqlite3InitInfo.html#a1dd98d805ac1ba2c0fe4d911d0639927">iDb</a> = 0;
<a name="l00088"></a>00088     db-&gt;<a class="code" href="structsqlite3.html#a8a42788add62e1a59d0c930ecc190e87">lookaside</a>.<a class="code" href="structLookaside.html#adbe2c3486f893c30525e19388f35eb21">bEnabled</a> = lookasideEnabled;
<a name="l00089"></a>00089     assert( rc!=<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> || zErr==0 );
<a name="l00090"></a>00090     <span class="keywordflow">if</span>( <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>!=rc ){
<a name="l00091"></a>00091       pData-&gt;<a class="code" href="structInitData.html#a627153a3de2c4d159ae44ebc03961592">rc</a> = rc;
<a name="l00092"></a>00092       <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#a9e34c7a5186dc9095e108e517eaac9f6">SQLITE_NOMEM</a> ){
<a name="l00093"></a>00093         db-&gt;<a class="code" href="structsqlite3.html#a79beb0036337ba7fc2de5ccbb9225935">mallocFailed</a> = 1;
<a name="l00094"></a>00094       }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( rc!=<a class="code" href="sqlite3_8h.html#a03c9b25faf07d0e47ce7a1b1e46b2adc">SQLITE_INTERRUPT</a> ){
<a name="l00095"></a>00095         <a class="code" href="prepare_8c.html#a9fba70569e9a18d95220854f44ea28c5">corruptSchema</a>(pData, argv[0], zErr);
<a name="l00096"></a>00096       }
<a name="l00097"></a>00097       <a class="code" href="malloc_8c.html#a8ca215f2395ca90fd180460afb2eba9d">sqlite3DbFree</a>(db, zErr);
<a name="l00098"></a>00098     }
<a name="l00099"></a>00099   }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( argv[0]==0 ){
<a name="l00100"></a>00100     <a class="code" href="prepare_8c.html#a9fba70569e9a18d95220854f44ea28c5">corruptSchema</a>(pData, 0, 0);
<a name="l00101"></a>00101   }<span class="keywordflow">else</span>{
<a name="l00102"></a>00102     <span class="comment">/* If the SQL column is blank it means this is an index that</span>
<a name="l00103"></a>00103 <span class="comment">    ** was created to be the PRIMARY KEY or to fulfill a UNIQUE</span>
<a name="l00104"></a>00104 <span class="comment">    ** constraint for a CREATE TABLE.  The index should have already</span>
<a name="l00105"></a>00105 <span class="comment">    ** been created when we processed the CREATE TABLE.  All we have</span>
<a name="l00106"></a>00106 <span class="comment">    ** to do here is record the root page number for that index.</span>
<a name="l00107"></a>00107 <span class="comment">    */</span>
<a name="l00108"></a>00108     <a class="code" href="structIndex.html">Index</a> *pIndex;
<a name="l00109"></a>00109     pIndex = <a class="code" href="build_8c.html#a041e9d78febefb3f9542595fcbd34549">sqlite3FindIndex</a>(db, argv[0], db-&gt;<a class="code" href="structsqlite3.html#a0abe1dccdea5f43e6c49360b42749697">aDb</a>[iDb].<a class="code" href="structDb.html#a6df2b5d7c8fd68e92cea961d9e3b279b">zName</a>);
<a name="l00110"></a>00110     <span class="keywordflow">if</span>( pIndex==0 || pIndex-&gt;<a class="code" href="structIndex.html#af895a09c01701021c3e36362c04a1ae6">tnum</a>!=0 ){
<a name="l00111"></a>00111       <span class="comment">/* This can occur if there exists an index on a TEMP table which</span>
<a name="l00112"></a>00112 <span class="comment">      ** has the same name as another index on a permanent index.  Since</span>
<a name="l00113"></a>00113 <span class="comment">      ** the permanent table is hidden by the TEMP table, we can also</span>
<a name="l00114"></a>00114 <span class="comment">      ** safely ignore the index on the permanent table.</span>
<a name="l00115"></a>00115 <span class="comment">      */</span>
<a name="l00116"></a>00116       <span class="comment">/* Do Nothing */</span>;
<a name="l00117"></a>00117     }<span class="keywordflow">else</span>{
<a name="l00118"></a>00118       pIndex-&gt;<a class="code" href="structIndex.html#af895a09c01701021c3e36362c04a1ae6">tnum</a> = atoi(argv[1]);
<a name="l00119"></a>00119     }
<a name="l00120"></a>00120   }
<a name="l00121"></a>00121   <span class="keywordflow">return</span> 0;
<a name="l00122"></a>00122 }
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 <span class="comment">/*</span>
<a name="l00125"></a>00125 <span class="comment">** Attempt to read the database schema and initialize internal</span>
<a name="l00126"></a>00126 <span class="comment">** data structures for a single database file.  The index of the</span>
<a name="l00127"></a>00127 <span class="comment">** database file is given by iDb.  iDb==0 is used for the main</span>
<a name="l00128"></a>00128 <span class="comment">** database.  iDb==1 should never be used.  iDb&gt;=2 is used for</span>
<a name="l00129"></a>00129 <span class="comment">** auxiliary databases.  Return one of the SQLITE_ error codes to</span>
<a name="l00130"></a>00130 <span class="comment">** indicate success or failure.</span>
<a name="l00131"></a>00131 <span class="comment">*/</span>
<a name="l00132"></a><a class="code" href="prepare_8c.html#ac4318b25df65269906b0379251fe9b85">00132</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="prepare_8c.html#ac4318b25df65269906b0379251fe9b85">sqlite3InitOne</a>(<a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a>, <span class="keywordtype">int</span> iDb, <span class="keywordtype">char</span> **pzErrMsg){
<a name="l00133"></a>00133   <span class="keywordtype">int</span> rc;
<a name="l00134"></a>00134   <a class="code" href="structBtCursor.html">BtCursor</a> *curMain;
<a name="l00135"></a>00135   <span class="keywordtype">int</span> size;
<a name="l00136"></a>00136   <a class="code" href="structTable.html">Table</a> *pTab;
<a name="l00137"></a>00137   <a class="code" href="structDb.html">Db</a> *pDb;
<a name="l00138"></a>00138   <span class="keywordtype">char</span> <span class="keyword">const</span> *azArg[4];
<a name="l00139"></a>00139   <span class="keywordtype">int</span> meta[10];
<a name="l00140"></a>00140   <a class="code" href="structInitData.html">InitData</a> initData;
<a name="l00141"></a>00141   <span class="keywordtype">char</span> <span class="keyword">const</span> *zMasterSchema;
<a name="l00142"></a>00142   <span class="keywordtype">char</span> <span class="keyword">const</span> *zMasterName = <a class="code" href="sqliteInt_8h.html#a0393ad099b2c180c4c26c32c251baf37">SCHEMA_TABLE</a>(iDb);
<a name="l00143"></a>00143 
<a name="l00144"></a>00144   <span class="comment">/*</span>
<a name="l00145"></a>00145 <span class="comment">  ** The master database table has a structure like this</span>
<a name="l00146"></a>00146 <span class="comment">  */</span>
<a name="l00147"></a>00147   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> master_schema[] = 
<a name="l00148"></a>00148      <span class="stringliteral">&quot;CREATE TABLE sqlite_master(\n&quot;</span>
<a name="l00149"></a>00149      <span class="stringliteral">&quot;  type text,\n&quot;</span>
<a name="l00150"></a>00150      <span class="stringliteral">&quot;  name text,\n&quot;</span>
<a name="l00151"></a>00151      <span class="stringliteral">&quot;  tbl_name text,\n&quot;</span>
<a name="l00152"></a>00152      <span class="stringliteral">&quot;  rootpage integer,\n&quot;</span>
<a name="l00153"></a>00153      <span class="stringliteral">&quot;  sql text\n&quot;</span>
<a name="l00154"></a>00154      <span class="stringliteral">&quot;)&quot;</span>
<a name="l00155"></a>00155   ;
<a name="l00156"></a>00156 <span class="preprocessor">#ifndef SQLITE_OMIT_TEMPDB</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span>  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> temp_master_schema[] = 
<a name="l00158"></a>00158      <span class="stringliteral">&quot;CREATE TEMP TABLE sqlite_temp_master(\n&quot;</span>
<a name="l00159"></a>00159      <span class="stringliteral">&quot;  type text,\n&quot;</span>
<a name="l00160"></a>00160      <span class="stringliteral">&quot;  name text,\n&quot;</span>
<a name="l00161"></a>00161      <span class="stringliteral">&quot;  tbl_name text,\n&quot;</span>
<a name="l00162"></a>00162      <span class="stringliteral">&quot;  rootpage integer,\n&quot;</span>
<a name="l00163"></a>00163      <span class="stringliteral">&quot;  sql text\n&quot;</span>
<a name="l00164"></a>00164      <span class="stringliteral">&quot;)&quot;</span>
<a name="l00165"></a>00165   ;
<a name="l00166"></a>00166 <span class="preprocessor">#else</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span><span class="preprocessor">  #define temp_master_schema 0</span>
<a name="l00168"></a>00168 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00169"></a>00169 <span class="preprocessor"></span>
<a name="l00170"></a>00170   assert( iDb&gt;=0 &amp;&amp; iDb&lt;db-&gt;nDb );
<a name="l00171"></a>00171   assert( db-&gt;<a class="code" href="structsqlite3.html#a0abe1dccdea5f43e6c49360b42749697">aDb</a>[iDb].<a class="code" href="structDb.html#afd8647a83a4a7053231b92814520d6d4">pSchema</a> );
<a name="l00172"></a>00172   assert( <a class="code" href="mutex_8h.html#ab92b5e853fc83d5aaa9a5d25e1883d3d">sqlite3_mutex_held</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>) );
<a name="l00173"></a>00173   assert( iDb==1 || sqlite3BtreeHoldsMutex(db-&gt;<a class="code" href="structsqlite3.html#a0abe1dccdea5f43e6c49360b42749697">aDb</a>[iDb].<a class="code" href="structDb.html#a0633e5a6abfc39246d07cc6a417a5852">pBt</a>) );
<a name="l00174"></a>00174 
<a name="l00175"></a>00175   <span class="comment">/* zMasterSchema and zInitScript are set to point at the master schema</span>
<a name="l00176"></a>00176 <span class="comment">  ** and initialisation script appropriate for the database being</span>
<a name="l00177"></a>00177 <span class="comment">  ** initialised. zMasterName is the name of the master table.</span>
<a name="l00178"></a>00178 <span class="comment">  */</span>
<a name="l00179"></a>00179   <span class="keywordflow">if</span>( !<a class="code" href="sqliteInt_8h.html#a66e48cdcd6a4b9d9ae001c2e9d81311a">OMIT_TEMPDB</a> &amp;&amp; iDb==1 ){
<a name="l00180"></a>00180     zMasterSchema = temp_master_schema;
<a name="l00181"></a>00181   }<span class="keywordflow">else</span>{
<a name="l00182"></a>00182     zMasterSchema = master_schema;
<a name="l00183"></a>00183   }
<a name="l00184"></a>00184   zMasterName = <a class="code" href="sqliteInt_8h.html#a0393ad099b2c180c4c26c32c251baf37">SCHEMA_TABLE</a>(iDb);
<a name="l00185"></a>00185 
<a name="l00186"></a>00186   <span class="comment">/* Construct the schema tables.  */</span>
<a name="l00187"></a>00187   azArg[0] = zMasterName;
<a name="l00188"></a>00188   azArg[1] = <span class="stringliteral">&quot;1&quot;</span>;
<a name="l00189"></a>00189   azArg[2] = zMasterSchema;
<a name="l00190"></a>00190   azArg[3] = 0;
<a name="l00191"></a>00191   initData.<a class="code" href="structInitData.html#adc9e29c56e0392076e92d7f4b29fa272">db</a> = db;
<a name="l00192"></a>00192   initData.<a class="code" href="structInitData.html#ad6c7953b49d351cd9fb14e3394010689">iDb</a> = iDb;
<a name="l00193"></a>00193   initData.<a class="code" href="structInitData.html#a627153a3de2c4d159ae44ebc03961592">rc</a> = <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00194"></a>00194   initData.<a class="code" href="structInitData.html#aa8aef34241ec214f038b38932ffe1357">pzErrMsg</a> = pzErrMsg;
<a name="l00195"></a>00195   (void)<a class="code" href="sqliteInt_8h.html#afd5afdeac4ae868c2bcb8a2246eefaf0">sqlite3SafetyOff</a>(db);
<a name="l00196"></a>00196   <a class="code" href="prepare_8c.html#ad97a9053636c29ea602f2211d5c53314">sqlite3InitCallback</a>(&amp;initData, 3, (<span class="keywordtype">char</span> **)azArg, 0);
<a name="l00197"></a>00197   (void)<a class="code" href="sqliteInt_8h.html#a5478b816780572bc0098dd1e2076ded2">sqlite3SafetyOn</a>(db);
<a name="l00198"></a>00198   <span class="keywordflow">if</span>( initData.<a class="code" href="structInitData.html#a627153a3de2c4d159ae44ebc03961592">rc</a> ){
<a name="l00199"></a>00199     rc = initData.<a class="code" href="structInitData.html#a627153a3de2c4d159ae44ebc03961592">rc</a>;
<a name="l00200"></a>00200     <span class="keywordflow">goto</span> error_out;
<a name="l00201"></a>00201   }
<a name="l00202"></a>00202   pTab = <a class="code" href="build_8c.html#ad5aa86dccbdb717fa67a89732c05207a">sqlite3FindTable</a>(db, zMasterName, db-&gt;<a class="code" href="structsqlite3.html#a0abe1dccdea5f43e6c49360b42749697">aDb</a>[iDb].<a class="code" href="structDb.html#a6df2b5d7c8fd68e92cea961d9e3b279b">zName</a>);
<a name="l00203"></a>00203   <span class="keywordflow">if</span>( pTab ){
<a name="l00204"></a>00204     pTab-&gt;<a class="code" href="structTable.html#ab0aeb112ae7e1b81e2a18bc493f7992c">tabFlags</a> |= <a class="code" href="sqliteInt_8h.html#a63c8aa835c05034c45dc1e0cc1e4bd0b">TF_Readonly</a>;
<a name="l00205"></a>00205   }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207   <span class="comment">/* Create a cursor to hold the database open</span>
<a name="l00208"></a>00208 <span class="comment">  */</span>
<a name="l00209"></a>00209   pDb = &amp;db-&gt;<a class="code" href="structsqlite3.html#a0abe1dccdea5f43e6c49360b42749697">aDb</a>[iDb];
<a name="l00210"></a>00210   <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structDb.html#a0633e5a6abfc39246d07cc6a417a5852">pBt</a>==0 ){
<a name="l00211"></a>00211     <span class="keywordflow">if</span>( !<a class="code" href="sqliteInt_8h.html#a66e48cdcd6a4b9d9ae001c2e9d81311a">OMIT_TEMPDB</a> &amp;&amp; iDb==1 ){
<a name="l00212"></a>00212       <a class="code" href="sqliteInt_8h.html#a72f3c29fdc9f66763158091ecbbc224f">DbSetProperty</a>(db, 1, <a class="code" href="sqliteInt_8h.html#a72c3d0884e544aa67cea3d4751dced73">DB_SchemaLoaded</a>);
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214     <span class="keywordflow">return</span> <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00215"></a>00215   }
<a name="l00216"></a>00216   curMain = <a class="code" href="malloc_8c.html#aa88ccfc5604fb4bd9b60b3ca4f9f58d4">sqlite3MallocZero</a>(<a class="code" href="btree_8c.html#a96338636fbb297e190ebbe528d065cbe">sqlite3BtreeCursorSize</a>());
<a name="l00217"></a>00217   <span class="keywordflow">if</span>( !curMain ){
<a name="l00218"></a>00218     rc = <a class="code" href="sqlite3_8h.html#a9e34c7a5186dc9095e108e517eaac9f6">SQLITE_NOMEM</a>;
<a name="l00219"></a>00219     <span class="keywordflow">goto</span> error_out;
<a name="l00220"></a>00220   }
<a name="l00221"></a>00221   <a class="code" href="btree_8h.html#a56a39b11f155ee99c00f24e119d6d78a">sqlite3BtreeEnter</a>(pDb-&gt;<a class="code" href="structDb.html#a0633e5a6abfc39246d07cc6a417a5852">pBt</a>);
<a name="l00222"></a>00222   rc = <a class="code" href="btree_8c.html#a4b7ea579f2a4d5e2ac49e7ad5b5f47b7">sqlite3BtreeCursor</a>(pDb-&gt;<a class="code" href="structDb.html#a0633e5a6abfc39246d07cc6a417a5852">pBt</a>, <a class="code" href="sqliteInt_8h.html#a55c81f26551028f4d36e84190993eaed">MASTER_ROOT</a>, 0, 0, curMain);
<a name="l00223"></a>00223   <span class="keywordflow">if</span>( rc!=<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> &amp;&amp; rc!=<a class="code" href="sqlite3_8h.html#adb3ccb6413bc81a990cab25356ab092f">SQLITE_EMPTY</a> ){
<a name="l00224"></a>00224     <a class="code" href="malloc_8c.html#af1c1714a3fa3d522e9909a10b3e69cfb">sqlite3SetString</a>(pzErrMsg, db, <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="main_8c.html#a02d1b390ceb669b8e689f27ea7134cad">sqlite3ErrStr</a>(rc));
<a name="l00225"></a>00225     <span class="keywordflow">goto</span> initone_error_out;
<a name="l00226"></a>00226   }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228   <span class="comment">/* Get the database meta information.</span>
<a name="l00229"></a>00229 <span class="comment">  **</span>
<a name="l00230"></a>00230 <span class="comment">  ** Meta values are as follows:</span>
<a name="l00231"></a>00231 <span class="comment">  **    meta[0]   Schema cookie.  Changes with each schema change.</span>
<a name="l00232"></a>00232 <span class="comment">  **    meta[1]   File format of schema layer.</span>
<a name="l00233"></a>00233 <span class="comment">  **    meta[2]   Size of the page cache.</span>
<a name="l00234"></a>00234 <span class="comment">  **    meta[3]   Use freelist if 0.  Autovacuum if greater than zero.</span>
<a name="l00235"></a>00235 <span class="comment">  **    meta[4]   Db text encoding. 1:UTF-8 2:UTF-16LE 3:UTF-16BE</span>
<a name="l00236"></a>00236 <span class="comment">  **    meta[5]   The user cookie. Used by the application.</span>
<a name="l00237"></a>00237 <span class="comment">  **    meta[6]   Incremental-vacuum flag.</span>
<a name="l00238"></a>00238 <span class="comment">  **    meta[7]</span>
<a name="l00239"></a>00239 <span class="comment">  **    meta[8]</span>
<a name="l00240"></a>00240 <span class="comment">  **    meta[9]</span>
<a name="l00241"></a>00241 <span class="comment">  **</span>
<a name="l00242"></a>00242 <span class="comment">  ** Note: The #defined SQLITE_UTF* symbols in sqliteInt.h correspond to</span>
<a name="l00243"></a>00243 <span class="comment">  ** the possible values of meta[4].</span>
<a name="l00244"></a>00244 <span class="comment">  */</span>
<a name="l00245"></a>00245   <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> ){
<a name="l00246"></a>00246     <span class="keywordtype">int</span> i;
<a name="l00247"></a>00247     <span class="keywordflow">for</span>(i=0; i&lt;<span class="keyword">sizeof</span>(meta)/<span class="keyword">sizeof</span>(meta[0]); i++){
<a name="l00248"></a>00248       rc = <a class="code" href="btree_8c.html#a927b663f431cd2f4edfac55d7018cbb6">sqlite3BtreeGetMeta</a>(pDb-&gt;<a class="code" href="structDb.html#a0633e5a6abfc39246d07cc6a417a5852">pBt</a>, i+1, (<a class="code" href="sqliteInt_8h.html#a03ad5adfaeb9b7640dde78a0cc390319">u32</a> *)&amp;meta[i]);
<a name="l00249"></a>00249       <span class="keywordflow">if</span>( rc ){
<a name="l00250"></a>00250         <a class="code" href="malloc_8c.html#af1c1714a3fa3d522e9909a10b3e69cfb">sqlite3SetString</a>(pzErrMsg, db, <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="main_8c.html#a02d1b390ceb669b8e689f27ea7134cad">sqlite3ErrStr</a>(rc));
<a name="l00251"></a>00251         <span class="keywordflow">goto</span> initone_error_out;
<a name="l00252"></a>00252       }
<a name="l00253"></a>00253     }
<a name="l00254"></a>00254   }<span class="keywordflow">else</span>{
<a name="l00255"></a>00255     memset(meta, 0, <span class="keyword">sizeof</span>(meta));
<a name="l00256"></a>00256   }
<a name="l00257"></a>00257   pDb-&gt;<a class="code" href="structDb.html#afd8647a83a4a7053231b92814520d6d4">pSchema</a>-&gt;<a class="code" href="structSchema.html#a3eef54a64f4f962d64577646bd34a47c">schema_cookie</a> = meta[0];
<a name="l00258"></a>00258 
<a name="l00259"></a>00259   <span class="comment">/* If opening a non-empty database, check the text encoding. For the</span>
<a name="l00260"></a>00260 <span class="comment">  ** main database, set sqlite3.enc to the encoding of the main database.</span>
<a name="l00261"></a>00261 <span class="comment">  ** For an attached db, it is an error if the encoding is not the same</span>
<a name="l00262"></a>00262 <span class="comment">  ** as sqlite3.enc.</span>
<a name="l00263"></a>00263 <span class="comment">  */</span>
<a name="l00264"></a>00264   <span class="keywordflow">if</span>( meta[4] ){  <span class="comment">/* text encoding */</span>
<a name="l00265"></a>00265     <span class="keywordflow">if</span>( iDb==0 ){
<a name="l00266"></a>00266       <span class="comment">/* If opening the main database, set ENC(db). */</span>
<a name="l00267"></a>00267       <a class="code" href="sqliteInt_8h.html#a8d01c7bc7577fdd8cae2d7f9e13ae88d">ENC</a>(db) = (<a class="code" href="sqliteInt_8h.html#a74a0f6424ae628af25f23f0a35f6ead3">u8</a>)meta[4];
<a name="l00268"></a>00268       db-&gt;<a class="code" href="structsqlite3.html#a2e5d7e7ac07c33b11c936b181d07789a">pDfltColl</a> = <a class="code" href="callback_8c.html#a10cedac1d42ec0882125e830ea930ed3">sqlite3FindCollSeq</a>(db, <a class="code" href="sqlite3_8h.html#a7a65f15cad0da22be8ebc0c70f526d32">SQLITE_UTF8</a>, <span class="stringliteral">&quot;BINARY&quot;</span>, 6, 0);
<a name="l00269"></a>00269     }<span class="keywordflow">else</span>{
<a name="l00270"></a>00270       <span class="comment">/* If opening an attached database, the encoding much match ENC(db) */</span>
<a name="l00271"></a>00271       <span class="keywordflow">if</span>( meta[4]!=<a class="code" href="sqliteInt_8h.html#a8d01c7bc7577fdd8cae2d7f9e13ae88d">ENC</a>(db) ){
<a name="l00272"></a>00272         <a class="code" href="malloc_8c.html#af1c1714a3fa3d522e9909a10b3e69cfb">sqlite3SetString</a>(pzErrMsg, db, <span class="stringliteral">&quot;attached databases must use the same&quot;</span>
<a name="l00273"></a>00273             <span class="stringliteral">&quot; text encoding as main database&quot;</span>);
<a name="l00274"></a>00274         rc = <a class="code" href="sqlite3_8h.html#afda25cd6575e87558d2b7cd4a6585f2f">SQLITE_ERROR</a>;
<a name="l00275"></a>00275         <span class="keywordflow">goto</span> initone_error_out;
<a name="l00276"></a>00276       }
<a name="l00277"></a>00277     }
<a name="l00278"></a>00278   }<span class="keywordflow">else</span>{
<a name="l00279"></a>00279     <a class="code" href="sqliteInt_8h.html#a72f3c29fdc9f66763158091ecbbc224f">DbSetProperty</a>(db, iDb, <a class="code" href="sqliteInt_8h.html#a71d4defda4c02eb7f153a2a50a85f54e">DB_Empty</a>);
<a name="l00280"></a>00280   }
<a name="l00281"></a>00281   pDb-&gt;<a class="code" href="structDb.html#afd8647a83a4a7053231b92814520d6d4">pSchema</a>-&gt;<a class="code" href="structSchema.html#a1338d09fe9cbb5a8162929202cb73cae">enc</a> = <a class="code" href="sqliteInt_8h.html#a8d01c7bc7577fdd8cae2d7f9e13ae88d">ENC</a>(db);
<a name="l00282"></a>00282 
<a name="l00283"></a>00283   <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structDb.html#afd8647a83a4a7053231b92814520d6d4">pSchema</a>-&gt;<a class="code" href="structSchema.html#a0a66691be95a30c099ca4840da7110dd">cache_size</a>==0 ){
<a name="l00284"></a>00284     size = meta[2];
<a name="l00285"></a>00285     <span class="keywordflow">if</span>( size==0 ){ size = <a class="code" href="sqliteLimit_8h.html#a57d623fa2eb3dad332a5d3f1af8979e2">SQLITE_DEFAULT_CACHE_SIZE</a>; }
<a name="l00286"></a>00286     <span class="keywordflow">if</span>( size&lt;0 ) size = -size;
<a name="l00287"></a>00287     pDb-&gt;<a class="code" href="structDb.html#afd8647a83a4a7053231b92814520d6d4">pSchema</a>-&gt;<a class="code" href="structSchema.html#a0a66691be95a30c099ca4840da7110dd">cache_size</a> = size;
<a name="l00288"></a>00288     <a class="code" href="btree_8c.html#a0b9a94952a1db07c9e97555d1de1df7b">sqlite3BtreeSetCacheSize</a>(pDb-&gt;<a class="code" href="structDb.html#a0633e5a6abfc39246d07cc6a417a5852">pBt</a>, pDb-&gt;<a class="code" href="structDb.html#afd8647a83a4a7053231b92814520d6d4">pSchema</a>-&gt;<a class="code" href="structSchema.html#a0a66691be95a30c099ca4840da7110dd">cache_size</a>);
<a name="l00289"></a>00289   }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291   <span class="comment">/*</span>
<a name="l00292"></a>00292 <span class="comment">  ** file_format==1    Version 3.0.0.</span>
<a name="l00293"></a>00293 <span class="comment">  ** file_format==2    Version 3.1.3.  // ALTER TABLE ADD COLUMN</span>
<a name="l00294"></a>00294 <span class="comment">  ** file_format==3    Version 3.1.4.  // ditto but with non-NULL defaults</span>
<a name="l00295"></a>00295 <span class="comment">  ** file_format==4    Version 3.3.0.  // DESC indices.  Boolean constants</span>
<a name="l00296"></a>00296 <span class="comment">  */</span>
<a name="l00297"></a>00297   pDb-&gt;<a class="code" href="structDb.html#afd8647a83a4a7053231b92814520d6d4">pSchema</a>-&gt;<a class="code" href="structSchema.html#ab9f0371436e41b3080772995407a4cca">file_format</a> = meta[1];
<a name="l00298"></a>00298   <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structDb.html#afd8647a83a4a7053231b92814520d6d4">pSchema</a>-&gt;<a class="code" href="structSchema.html#ab9f0371436e41b3080772995407a4cca">file_format</a>==0 ){
<a name="l00299"></a>00299     pDb-&gt;<a class="code" href="structDb.html#afd8647a83a4a7053231b92814520d6d4">pSchema</a>-&gt;<a class="code" href="structSchema.html#ab9f0371436e41b3080772995407a4cca">file_format</a> = 1;
<a name="l00300"></a>00300   }
<a name="l00301"></a>00301   <span class="keywordflow">if</span>( pDb-&gt;<a class="code" href="structDb.html#afd8647a83a4a7053231b92814520d6d4">pSchema</a>-&gt;<a class="code" href="structSchema.html#ab9f0371436e41b3080772995407a4cca">file_format</a>&gt;<a class="code" href="sqliteInt_8h.html#a151e7bdeeae926cd9e17c182da900217">SQLITE_MAX_FILE_FORMAT</a> ){
<a name="l00302"></a>00302     <a class="code" href="malloc_8c.html#af1c1714a3fa3d522e9909a10b3e69cfb">sqlite3SetString</a>(pzErrMsg, db, <span class="stringliteral">&quot;unsupported file format&quot;</span>);
<a name="l00303"></a>00303     rc = <a class="code" href="sqlite3_8h.html#afda25cd6575e87558d2b7cd4a6585f2f">SQLITE_ERROR</a>;
<a name="l00304"></a>00304     <span class="keywordflow">goto</span> initone_error_out;
<a name="l00305"></a>00305   }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307   <span class="comment">/* Ticket #2804:  When we open a database in the newer file format,</span>
<a name="l00308"></a>00308 <span class="comment">  ** clear the legacy_file_format pragma flag so that a VACUUM will</span>
<a name="l00309"></a>00309 <span class="comment">  ** not downgrade the database and thus invalidate any descending</span>
<a name="l00310"></a>00310 <span class="comment">  ** indices that the user might have created.</span>
<a name="l00311"></a>00311 <span class="comment">  */</span>
<a name="l00312"></a>00312   <span class="keywordflow">if</span>( iDb==0 &amp;&amp; meta[1]&gt;=4 ){
<a name="l00313"></a>00313     db-&gt;<a class="code" href="structsqlite3.html#a8dac784e669d6b8a9f936d3193c1aaec">flags</a> &amp;= ~<a class="code" href="sqliteInt_8h.html#acdc64fc34147e793809849c20c01b623">SQLITE_LegacyFileFmt</a>;
<a name="l00314"></a>00314   }
<a name="l00315"></a>00315 
<a name="l00316"></a>00316   <span class="comment">/* Read the schema information out of the schema tables</span>
<a name="l00317"></a>00317 <span class="comment">  */</span>
<a name="l00318"></a>00318   assert( db-&gt;<a class="code" href="structsqlite3.html#a14bb7fbfa6b662021069fcdf6b334d70">init</a>.<a class="code" href="structsqlite3_1_1sqlite3InitInfo.html#a6ac01842e0ae68023cb60fea93bd8688">busy</a> );
<a name="l00319"></a>00319   <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#adb3ccb6413bc81a990cab25356ab092f">SQLITE_EMPTY</a> ){
<a name="l00320"></a>00320     <span class="comment">/* For an empty database, there is nothing to read */</span>
<a name="l00321"></a>00321     rc = <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00322"></a>00322   }<span class="keywordflow">else</span>{
<a name="l00323"></a>00323     <span class="keywordtype">char</span> *zSql;
<a name="l00324"></a>00324     zSql = <a class="code" href="printf_8c.html#a565f1e5e7ec859ec4e815ed15d42a415">sqlite3MPrintf</a>(db, 
<a name="l00325"></a>00325         <span class="stringliteral">&quot;SELECT name, rootpage, sql FROM &apos;%q&apos;.%s&quot;</span>,
<a name="l00326"></a>00326         db-&gt;<a class="code" href="structsqlite3.html#a0abe1dccdea5f43e6c49360b42749697">aDb</a>[iDb].<a class="code" href="structDb.html#a6df2b5d7c8fd68e92cea961d9e3b279b">zName</a>, zMasterName);
<a name="l00327"></a>00327     (void)<a class="code" href="sqliteInt_8h.html#afd5afdeac4ae868c2bcb8a2246eefaf0">sqlite3SafetyOff</a>(db);
<a name="l00328"></a>00328 <span class="preprocessor">#ifndef SQLITE_OMIT_AUTHORIZATION</span>
<a name="l00329"></a>00329 <span class="preprocessor"></span>    {
<a name="l00330"></a>00330       int (*xAuth)(<span class="keywordtype">void</span>*,int,<span class="keyword">const</span> <span class="keywordtype">char</span>*,<span class="keyword">const</span> <span class="keywordtype">char</span>*,<span class="keyword">const</span> <span class="keywordtype">char</span>*,<span class="keyword">const</span> <span class="keywordtype">char</span>*);
<a name="l00331"></a>00331       xAuth = db-&gt;<a class="code" href="structsqlite3.html#a7eb4472cad41b37417fcc6d2cc0561fa">xAuth</a>;
<a name="l00332"></a>00332       db-&gt;<a class="code" href="structsqlite3.html#a7eb4472cad41b37417fcc6d2cc0561fa">xAuth</a> = 0;
<a name="l00333"></a>00333 <span class="preprocessor">#endif</span>
<a name="l00334"></a>00334 <span class="preprocessor"></span>      rc = <a class="code" href="legacy_8c.html#ada787486cf95a994521cfd0c64e853e4">sqlite3_exec</a>(db, zSql, <a class="code" href="prepare_8c.html#ad97a9053636c29ea602f2211d5c53314">sqlite3InitCallback</a>, &amp;initData, 0);
<a name="l00335"></a>00335 <span class="preprocessor">#ifndef SQLITE_OMIT_AUTHORIZATION</span>
<a name="l00336"></a>00336 <span class="preprocessor"></span>      db-&gt;<a class="code" href="structsqlite3.html#a7eb4472cad41b37417fcc6d2cc0561fa">xAuth</a> = xAuth;
<a name="l00337"></a>00337     }
<a name="l00338"></a>00338 <span class="preprocessor">#endif</span>
<a name="l00339"></a>00339 <span class="preprocessor"></span>    <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> ) rc = initData.<a class="code" href="structInitData.html#a627153a3de2c4d159ae44ebc03961592">rc</a>;
<a name="l00340"></a>00340     (void)<a class="code" href="sqliteInt_8h.html#a5478b816780572bc0098dd1e2076ded2">sqlite3SafetyOn</a>(db);
<a name="l00341"></a>00341     <a class="code" href="malloc_8c.html#a8ca215f2395ca90fd180460afb2eba9d">sqlite3DbFree</a>(db, zSql);
<a name="l00342"></a>00342 <span class="preprocessor">#ifndef SQLITE_OMIT_ANALYZE</span>
<a name="l00343"></a>00343 <span class="preprocessor"></span>    <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> ){
<a name="l00344"></a>00344       <a class="code" href="analyze_8c.html#a33e56439dd87d2f769188eee389f15ee">sqlite3AnalysisLoad</a>(db, iDb);
<a name="l00345"></a>00345     }
<a name="l00346"></a>00346 <span class="preprocessor">#endif</span>
<a name="l00347"></a>00347 <span class="preprocessor"></span>  }
<a name="l00348"></a>00348   <span class="keywordflow">if</span>( db-&gt;<a class="code" href="structsqlite3.html#a79beb0036337ba7fc2de5ccbb9225935">mallocFailed</a> ){
<a name="l00349"></a>00349     rc = <a class="code" href="sqlite3_8h.html#a9e34c7a5186dc9095e108e517eaac9f6">SQLITE_NOMEM</a>;
<a name="l00350"></a>00350     <a class="code" href="build_8c.html#a67e7c0c4f9880fb86514ef03643b1cd2">sqlite3ResetInternalSchema</a>(db, 0);
<a name="l00351"></a>00351   }
<a name="l00352"></a>00352   <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> || (db-&gt;<a class="code" href="structsqlite3.html#a8dac784e669d6b8a9f936d3193c1aaec">flags</a>&amp;<a class="code" href="sqliteInt_8h.html#aa6554fca0be084740ad54c8120a5c457">SQLITE_RecoveryMode</a>)){
<a name="l00353"></a>00353     <span class="comment">/* Black magic: If the SQLITE_RecoveryMode flag is set, then consider</span>
<a name="l00354"></a>00354 <span class="comment">    ** the schema loaded, even if errors occured. In this situation the </span>
<a name="l00355"></a>00355 <span class="comment">    ** current sqlite3_prepare() operation will fail, but the following one</span>
<a name="l00356"></a>00356 <span class="comment">    ** will attempt to compile the supplied statement against whatever subset</span>
<a name="l00357"></a>00357 <span class="comment">    ** of the schema was loaded before the error occured. The primary</span>
<a name="l00358"></a>00358 <span class="comment">    ** purpose of this is to allow access to the sqlite_master table</span>
<a name="l00359"></a>00359 <span class="comment">    ** even when its contents have been corrupted.</span>
<a name="l00360"></a>00360 <span class="comment">    */</span>
<a name="l00361"></a>00361     <a class="code" href="sqliteInt_8h.html#a72f3c29fdc9f66763158091ecbbc224f">DbSetProperty</a>(db, iDb, <a class="code" href="sqliteInt_8h.html#a72c3d0884e544aa67cea3d4751dced73">DB_SchemaLoaded</a>);
<a name="l00362"></a>00362     rc = <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00363"></a>00363   }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365   <span class="comment">/* Jump here for an error that occurs after successfully allocating</span>
<a name="l00366"></a>00366 <span class="comment">  ** curMain and calling sqlite3BtreeEnter(). For an error that occurs</span>
<a name="l00367"></a>00367 <span class="comment">  ** before that point, jump to error_out.</span>
<a name="l00368"></a>00368 <span class="comment">  */</span>
<a name="l00369"></a>00369 initone_error_out:
<a name="l00370"></a>00370   <a class="code" href="btree_8c.html#aceb051a90ea80c52fc1513ed5de5087d">sqlite3BtreeCloseCursor</a>(curMain);
<a name="l00371"></a>00371   <a class="code" href="malloc_8c.html#a89d4380358f918be2a8e2171d95bbb04">sqlite3_free</a>(curMain);
<a name="l00372"></a>00372   <a class="code" href="btree_8h.html#a9fe50dc54d10997ed95d1999ec173236">sqlite3BtreeLeave</a>(pDb-&gt;<a class="code" href="structDb.html#a0633e5a6abfc39246d07cc6a417a5852">pBt</a>);
<a name="l00373"></a>00373 
<a name="l00374"></a>00374 error_out:
<a name="l00375"></a>00375   <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#a9e34c7a5186dc9095e108e517eaac9f6">SQLITE_NOMEM</a> || rc==<a class="code" href="sqlite3_8h.html#a51c0d3d9c66efa031416bc47ca5a2431">SQLITE_IOERR_NOMEM</a> ){
<a name="l00376"></a>00376     db-&gt;<a class="code" href="structsqlite3.html#a79beb0036337ba7fc2de5ccbb9225935">mallocFailed</a> = 1;
<a name="l00377"></a>00377   }
<a name="l00378"></a>00378   <span class="keywordflow">return</span> rc;
<a name="l00379"></a>00379 }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381 <span class="comment">/*</span>
<a name="l00382"></a>00382 <span class="comment">** Initialize all database files - the main database file, the file</span>
<a name="l00383"></a>00383 <span class="comment">** used to store temporary tables, and any additional database files</span>
<a name="l00384"></a>00384 <span class="comment">** created using ATTACH statements.  Return a success code.  If an</span>
<a name="l00385"></a>00385 <span class="comment">** error occurs, write an error message into *pzErrMsg.</span>
<a name="l00386"></a>00386 <span class="comment">**</span>
<a name="l00387"></a>00387 <span class="comment">** After a database is initialized, the DB_SchemaLoaded bit is set</span>
<a name="l00388"></a>00388 <span class="comment">** bit is set in the flags field of the Db structure. If the database</span>
<a name="l00389"></a>00389 <span class="comment">** file was of zero-length, then the DB_Empty flag is also set.</span>
<a name="l00390"></a>00390 <span class="comment">*/</span>
<a name="l00391"></a><a class="code" href="sqliteInt_8h.html#a56c3e2e48bc93b87d8a7290eac6f6de4">00391</a> <span class="keywordtype">int</span> <a class="code" href="prepare_8c.html#a8bf7657a963bc06184e09704d8822541">sqlite3Init</a>(<a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a>, <span class="keywordtype">char</span> **pzErrMsg){
<a name="l00392"></a>00392   <span class="keywordtype">int</span> i, rc;
<a name="l00393"></a>00393   <span class="keywordtype">int</span> commit_internal = !(db-&gt;<a class="code" href="structsqlite3.html#a8dac784e669d6b8a9f936d3193c1aaec">flags</a>&amp;<a class="code" href="sqliteInt_8h.html#ac4ee799ffccd81c7967fde25523c6c6a">SQLITE_InternChanges</a>);
<a name="l00394"></a>00394   
<a name="l00395"></a>00395   assert( <a class="code" href="mutex_8h.html#ab92b5e853fc83d5aaa9a5d25e1883d3d">sqlite3_mutex_held</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>) );
<a name="l00396"></a>00396   <span class="keywordflow">if</span>( db-&gt;<a class="code" href="structsqlite3.html#a14bb7fbfa6b662021069fcdf6b334d70">init</a>.<a class="code" href="structsqlite3_1_1sqlite3InitInfo.html#a6ac01842e0ae68023cb60fea93bd8688">busy</a> ) <span class="keywordflow">return</span> <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00397"></a>00397   rc = <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00398"></a>00398   db-&gt;<a class="code" href="structsqlite3.html#a14bb7fbfa6b662021069fcdf6b334d70">init</a>.<a class="code" href="structsqlite3_1_1sqlite3InitInfo.html#a6ac01842e0ae68023cb60fea93bd8688">busy</a> = 1;
<a name="l00399"></a>00399   <span class="keywordflow">for</span>(i=0; rc==<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> &amp;&amp; i&lt;db-&gt;<a class="code" href="structsqlite3.html#a03d047bc289999b0e39d8637f0762489">nDb</a>; i++){
<a name="l00400"></a>00400     <span class="keywordflow">if</span>( <a class="code" href="sqliteInt_8h.html#a7a2fa1b984bf800e8ba8c9accf449834">DbHasProperty</a>(db, i, <a class="code" href="sqliteInt_8h.html#a72c3d0884e544aa67cea3d4751dced73">DB_SchemaLoaded</a>) || i==1 ) <span class="keywordflow">continue</span>;
<a name="l00401"></a>00401     rc = <a class="code" href="prepare_8c.html#ac4318b25df65269906b0379251fe9b85">sqlite3InitOne</a>(db, i, pzErrMsg);
<a name="l00402"></a>00402     <span class="keywordflow">if</span>( rc ){
<a name="l00403"></a>00403       <a class="code" href="build_8c.html#a67e7c0c4f9880fb86514ef03643b1cd2">sqlite3ResetInternalSchema</a>(db, i);
<a name="l00404"></a>00404     }
<a name="l00405"></a>00405   }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407   <span class="comment">/* Once all the other databases have been initialised, load the schema</span>
<a name="l00408"></a>00408 <span class="comment">  ** for the TEMP database. This is loaded last, as the TEMP database</span>
<a name="l00409"></a>00409 <span class="comment">  ** schema may contain references to objects in other databases.</span>
<a name="l00410"></a>00410 <span class="comment">  */</span>
<a name="l00411"></a>00411 <span class="preprocessor">#ifndef SQLITE_OMIT_TEMPDB</span>
<a name="l00412"></a>00412 <span class="preprocessor"></span>  <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> &amp;&amp; db-&gt;<a class="code" href="structsqlite3.html#a03d047bc289999b0e39d8637f0762489">nDb</a>&gt;1 &amp;&amp; !<a class="code" href="sqliteInt_8h.html#a7a2fa1b984bf800e8ba8c9accf449834">DbHasProperty</a>(db, 1, <a class="code" href="sqliteInt_8h.html#a72c3d0884e544aa67cea3d4751dced73">DB_SchemaLoaded</a>) ){
<a name="l00413"></a>00413     rc = <a class="code" href="prepare_8c.html#ac4318b25df65269906b0379251fe9b85">sqlite3InitOne</a>(db, 1, pzErrMsg);
<a name="l00414"></a>00414     <span class="keywordflow">if</span>( rc ){
<a name="l00415"></a>00415       <a class="code" href="build_8c.html#a67e7c0c4f9880fb86514ef03643b1cd2">sqlite3ResetInternalSchema</a>(db, 1);
<a name="l00416"></a>00416     }
<a name="l00417"></a>00417   }
<a name="l00418"></a>00418 <span class="preprocessor">#endif</span>
<a name="l00419"></a>00419 <span class="preprocessor"></span>
<a name="l00420"></a>00420   db-&gt;<a class="code" href="structsqlite3.html#a14bb7fbfa6b662021069fcdf6b334d70">init</a>.<a class="code" href="structsqlite3_1_1sqlite3InitInfo.html#a6ac01842e0ae68023cb60fea93bd8688">busy</a> = 0;
<a name="l00421"></a>00421   <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> &amp;&amp; commit_internal ){
<a name="l00422"></a>00422     <a class="code" href="build_8c.html#a062d37e1dd1b785e13695ad1900e4a60">sqlite3CommitInternalChanges</a>(db);
<a name="l00423"></a>00423   }
<a name="l00424"></a>00424 
<a name="l00425"></a>00425   <span class="keywordflow">return</span> rc; 
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 <span class="comment">/*</span>
<a name="l00429"></a>00429 <span class="comment">** This routine is a no-op if the database schema is already initialised.</span>
<a name="l00430"></a>00430 <span class="comment">** Otherwise, the schema is loaded. An error code is returned.</span>
<a name="l00431"></a>00431 <span class="comment">*/</span>
<a name="l00432"></a><a class="code" href="sqliteInt_8h.html#a703165390f347ccf1855e04db050384d">00432</a> <span class="keywordtype">int</span> <a class="code" href="prepare_8c.html#a703165390f347ccf1855e04db050384d">sqlite3ReadSchema</a>(<a class="code" href="structParse.html">Parse</a> *pParse){
<a name="l00433"></a>00433   <span class="keywordtype">int</span> rc = <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00434"></a>00434   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a> = pParse-&gt;<a class="code" href="structParse.html#a44364e5e1197927f89864ec345bc5491">db</a>;
<a name="l00435"></a>00435   assert( <a class="code" href="mutex_8h.html#ab92b5e853fc83d5aaa9a5d25e1883d3d">sqlite3_mutex_held</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>) );
<a name="l00436"></a>00436   <span class="keywordflow">if</span>( !db-&gt;<a class="code" href="structsqlite3.html#a14bb7fbfa6b662021069fcdf6b334d70">init</a>.<a class="code" href="structsqlite3_1_1sqlite3InitInfo.html#a6ac01842e0ae68023cb60fea93bd8688">busy</a> ){
<a name="l00437"></a>00437     rc = <a class="code" href="prepare_8c.html#a8bf7657a963bc06184e09704d8822541">sqlite3Init</a>(db, &amp;pParse-&gt;<a class="code" href="structParse.html#a04146757986ff4654c7b321654896e81">zErrMsg</a>);
<a name="l00438"></a>00438   }
<a name="l00439"></a>00439   <span class="keywordflow">if</span>( rc!=<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> ){
<a name="l00440"></a>00440     pParse-&gt;<a class="code" href="structParse.html#a897c2ea40a1065d49a134f18ca251637">rc</a> = rc;
<a name="l00441"></a>00441     pParse-&gt;<a class="code" href="structParse.html#ac7206f0c7e580ab32b7dfb20950bb1c9">nErr</a>++;
<a name="l00442"></a>00442   }
<a name="l00443"></a>00443   <span class="keywordflow">return</span> rc;
<a name="l00444"></a>00444 }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446 
<a name="l00447"></a>00447 <span class="comment">/*</span>
<a name="l00448"></a>00448 <span class="comment">** Check schema cookies in all databases.  If any cookie is out</span>
<a name="l00449"></a>00449 <span class="comment">** of date, return 0.  If all schema cookies are current, return 1.</span>
<a name="l00450"></a>00450 <span class="comment">*/</span>
<a name="l00451"></a><a class="code" href="prepare_8c.html#a13f2d9601d2ba6c5e02817cdee73ce12">00451</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="prepare_8c.html#a13f2d9601d2ba6c5e02817cdee73ce12">schemaIsValid</a>(<a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a>){
<a name="l00452"></a>00452   <span class="keywordtype">int</span> iDb;
<a name="l00453"></a>00453   <span class="keywordtype">int</span> rc;
<a name="l00454"></a>00454   <a class="code" href="structBtCursor.html">BtCursor</a> *curTemp;
<a name="l00455"></a>00455   <span class="keywordtype">int</span> cookie;
<a name="l00456"></a>00456   <span class="keywordtype">int</span> allOk = 1;
<a name="l00457"></a>00457 
<a name="l00458"></a>00458   curTemp = (<a class="code" href="structBtCursor.html">BtCursor</a> *)<a class="code" href="malloc_8c.html#a8c1a33577a57524c7c6eef3d9e64e742">sqlite3Malloc</a>(<a class="code" href="btree_8c.html#a96338636fbb297e190ebbe528d065cbe">sqlite3BtreeCursorSize</a>());
<a name="l00459"></a>00459   <span class="keywordflow">if</span>( curTemp ){
<a name="l00460"></a>00460     assert( <a class="code" href="mutex_8h.html#ab92b5e853fc83d5aaa9a5d25e1883d3d">sqlite3_mutex_held</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>) );
<a name="l00461"></a>00461     <span class="keywordflow">for</span>(iDb=0; allOk &amp;&amp; iDb&lt;db-&gt;<a class="code" href="structsqlite3.html#a03d047bc289999b0e39d8637f0762489">nDb</a>; iDb++){
<a name="l00462"></a>00462       <a class="code" href="structBtree.html">Btree</a> *pBt;
<a name="l00463"></a>00463       pBt = db-&gt;<a class="code" href="structsqlite3.html#a0abe1dccdea5f43e6c49360b42749697">aDb</a>[iDb].<a class="code" href="structDb.html#a0633e5a6abfc39246d07cc6a417a5852">pBt</a>;
<a name="l00464"></a>00464       <span class="keywordflow">if</span>( pBt==0 ) <span class="keywordflow">continue</span>;
<a name="l00465"></a>00465       memset(curTemp, 0, <a class="code" href="btree_8c.html#a96338636fbb297e190ebbe528d065cbe">sqlite3BtreeCursorSize</a>());
<a name="l00466"></a>00466       rc = <a class="code" href="btree_8c.html#a4b7ea579f2a4d5e2ac49e7ad5b5f47b7">sqlite3BtreeCursor</a>(pBt, <a class="code" href="sqliteInt_8h.html#a55c81f26551028f4d36e84190993eaed">MASTER_ROOT</a>, 0, 0, curTemp);
<a name="l00467"></a>00467       <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> ){
<a name="l00468"></a>00468         rc = <a class="code" href="btree_8c.html#a927b663f431cd2f4edfac55d7018cbb6">sqlite3BtreeGetMeta</a>(pBt, 1, (<a class="code" href="sqliteInt_8h.html#a03ad5adfaeb9b7640dde78a0cc390319">u32</a> *)&amp;cookie);
<a name="l00469"></a>00469         <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> &amp;&amp; cookie!=db-&gt;<a class="code" href="structsqlite3.html#a0abe1dccdea5f43e6c49360b42749697">aDb</a>[iDb].<a class="code" href="structDb.html#afd8647a83a4a7053231b92814520d6d4">pSchema</a>-&gt;<a class="code" href="structSchema.html#a3eef54a64f4f962d64577646bd34a47c">schema_cookie</a> ){
<a name="l00470"></a>00470           allOk = 0;
<a name="l00471"></a>00471         }
<a name="l00472"></a>00472         <a class="code" href="btree_8c.html#aceb051a90ea80c52fc1513ed5de5087d">sqlite3BtreeCloseCursor</a>(curTemp);
<a name="l00473"></a>00473       }
<a name="l00474"></a>00474       <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#a9e34c7a5186dc9095e108e517eaac9f6">SQLITE_NOMEM</a> || rc==<a class="code" href="sqlite3_8h.html#a51c0d3d9c66efa031416bc47ca5a2431">SQLITE_IOERR_NOMEM</a> ){
<a name="l00475"></a>00475         db-&gt;<a class="code" href="structsqlite3.html#a79beb0036337ba7fc2de5ccbb9225935">mallocFailed</a> = 1;
<a name="l00476"></a>00476       }
<a name="l00477"></a>00477     }
<a name="l00478"></a>00478     <a class="code" href="malloc_8c.html#a89d4380358f918be2a8e2171d95bbb04">sqlite3_free</a>(curTemp);
<a name="l00479"></a>00479   }<span class="keywordflow">else</span>{
<a name="l00480"></a>00480     allOk = 0;
<a name="l00481"></a>00481     db-&gt;<a class="code" href="structsqlite3.html#a79beb0036337ba7fc2de5ccbb9225935">mallocFailed</a> = 1;
<a name="l00482"></a>00482   }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484   <span class="keywordflow">return</span> allOk;
<a name="l00485"></a>00485 }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487 <span class="comment">/*</span>
<a name="l00488"></a>00488 <span class="comment">** Convert a schema pointer into the iDb index that indicates</span>
<a name="l00489"></a>00489 <span class="comment">** which database file in db-&gt;aDb[] the schema refers to.</span>
<a name="l00490"></a>00490 <span class="comment">**</span>
<a name="l00491"></a>00491 <span class="comment">** If the same database is attached more than once, the first</span>
<a name="l00492"></a>00492 <span class="comment">** attached database is returned.</span>
<a name="l00493"></a>00493 <span class="comment">*/</span>
<a name="l00494"></a><a class="code" href="sqliteInt_8h.html#ad8490bb538848316cdd0cf7a9bd45385">00494</a> <span class="keywordtype">int</span> <a class="code" href="prepare_8c.html#aecd8922611e561d76d5e9f16655e8a7c">sqlite3SchemaToIndex</a>(<a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a>, <a class="code" href="structSchema.html">Schema</a> *pSchema){
<a name="l00495"></a>00495   <span class="keywordtype">int</span> i = -1000000;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497   <span class="comment">/* If pSchema is NULL, then return -1000000. This happens when code in </span>
<a name="l00498"></a>00498 <span class="comment">  ** expr.c is trying to resolve a reference to a transient table (i.e. one</span>
<a name="l00499"></a>00499 <span class="comment">  ** created by a sub-select). In this case the return value of this </span>
<a name="l00500"></a>00500 <span class="comment">  ** function should never be used.</span>
<a name="l00501"></a>00501 <span class="comment">  **</span>
<a name="l00502"></a>00502 <span class="comment">  ** We return -1000000 instead of the more usual -1 simply because using</span>
<a name="l00503"></a>00503 <span class="comment">  ** -1000000 as incorrectly using -1000000 index into db-&gt;aDb[] is much </span>
<a name="l00504"></a>00504 <span class="comment">  ** more likely to cause a segfault than -1 (of course there are assert()</span>
<a name="l00505"></a>00505 <span class="comment">  ** statements too, but it never hurts to play the odds).</span>
<a name="l00506"></a>00506 <span class="comment">  */</span>
<a name="l00507"></a>00507   assert( <a class="code" href="mutex_8h.html#ab92b5e853fc83d5aaa9a5d25e1883d3d">sqlite3_mutex_held</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>) );
<a name="l00508"></a>00508   <span class="keywordflow">if</span>( pSchema ){
<a name="l00509"></a>00509     <span class="keywordflow">for</span>(i=0; i&lt;db-&gt;<a class="code" href="structsqlite3.html#a03d047bc289999b0e39d8637f0762489">nDb</a>; i++){
<a name="l00510"></a>00510       <span class="keywordflow">if</span>( db-&gt;<a class="code" href="structsqlite3.html#a0abe1dccdea5f43e6c49360b42749697">aDb</a>[i].<a class="code" href="structDb.html#afd8647a83a4a7053231b92814520d6d4">pSchema</a>==pSchema ){
<a name="l00511"></a>00511         <span class="keywordflow">break</span>;
<a name="l00512"></a>00512       }
<a name="l00513"></a>00513     }
<a name="l00514"></a>00514     assert( i&gt;=0 &amp;&amp;i&gt;=0 &amp;&amp;  i&lt;db-&gt;nDb );
<a name="l00515"></a>00515   }
<a name="l00516"></a>00516   <span class="keywordflow">return</span> i;
<a name="l00517"></a>00517 }
<a name="l00518"></a>00518 
<a name="l00519"></a>00519 <span class="comment">/*</span>
<a name="l00520"></a>00520 <span class="comment">** Compile the UTF-8 encoded SQL statement zSql into a statement handle.</span>
<a name="l00521"></a>00521 <span class="comment">*/</span>
<a name="l00522"></a><a class="code" href="prepare_8c.html#aa3e7ff81525b91f8de8ecb0357b0b0cb">00522</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="prepare_8c.html#aa3e7ff81525b91f8de8ecb0357b0b0cb">sqlite3Prepare</a>(
<a name="l00523"></a>00523   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a>,              <span class="comment">/* Database handle. */</span>
<a name="l00524"></a>00524   <span class="keyword">const</span> <span class="keywordtype">char</span> *zSql,         <span class="comment">/* UTF-8 encoded SQL statement. */</span>
<a name="l00525"></a>00525   <span class="keywordtype">int</span> nBytes,               <span class="comment">/* Length of zSql in bytes. */</span>
<a name="l00526"></a>00526   <span class="keywordtype">int</span> saveSqlFlag,          <span class="comment">/* True to copy SQL text into the sqlite3_stmt */</span>
<a name="l00527"></a>00527   <a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> **ppStmt,    <span class="comment">/* OUT: A pointer to the prepared statement */</span>
<a name="l00528"></a>00528   <span class="keyword">const</span> <span class="keywordtype">char</span> **pzTail       <span class="comment">/* OUT: End of parsed string */</span>
<a name="l00529"></a>00529 ){
<a name="l00530"></a>00530   <a class="code" href="structParse.html">Parse</a> sParse;
<a name="l00531"></a>00531   <span class="keywordtype">char</span> *zErrMsg = 0;
<a name="l00532"></a>00532   <span class="keywordtype">int</span> rc = <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00533"></a>00533   <span class="keywordtype">int</span> i;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535   assert( ppStmt );
<a name="l00536"></a>00536   *ppStmt = 0;
<a name="l00537"></a>00537   <span class="keywordflow">if</span>( <a class="code" href="sqliteInt_8h.html#a5478b816780572bc0098dd1e2076ded2">sqlite3SafetyOn</a>(db) ){
<a name="l00538"></a>00538     <span class="keywordflow">return</span> <a class="code" href="sqlite3_8h.html#a34f01e4ee909e6b68be040868f7503bc">SQLITE_MISUSE</a>;
<a name="l00539"></a>00539   }
<a name="l00540"></a>00540   assert( !db-&gt;<a class="code" href="structsqlite3.html#a79beb0036337ba7fc2de5ccbb9225935">mallocFailed</a> );
<a name="l00541"></a>00541   assert( <a class="code" href="mutex_8h.html#ab92b5e853fc83d5aaa9a5d25e1883d3d">sqlite3_mutex_held</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>) );
<a name="l00542"></a>00542 
<a name="l00543"></a>00543   <span class="comment">/* If any attached database schemas are locked, do not proceed with</span>
<a name="l00544"></a>00544 <span class="comment">  ** compilation. Instead return SQLITE_LOCKED immediately.</span>
<a name="l00545"></a>00545 <span class="comment">  */</span>
<a name="l00546"></a>00546   <span class="keywordflow">for</span>(i=0; i&lt;db-&gt;<a class="code" href="structsqlite3.html#a03d047bc289999b0e39d8637f0762489">nDb</a>; i++) {
<a name="l00547"></a>00547     <a class="code" href="structBtree.html">Btree</a> *pBt = db-&gt;<a class="code" href="structsqlite3.html#a0abe1dccdea5f43e6c49360b42749697">aDb</a>[i].<a class="code" href="structDb.html#a0633e5a6abfc39246d07cc6a417a5852">pBt</a>;
<a name="l00548"></a>00548     <span class="keywordflow">if</span>( pBt ){
<a name="l00549"></a>00549       <span class="keywordtype">int</span> rc;
<a name="l00550"></a>00550       rc = <a class="code" href="btree_8c.html#a2b2573d96fb0f726092bdffef068f44d">sqlite3BtreeSchemaLocked</a>(pBt);
<a name="l00551"></a>00551       <span class="keywordflow">if</span>( rc ){
<a name="l00552"></a>00552         <span class="keyword">const</span> <span class="keywordtype">char</span> *zDb = db-&gt;<a class="code" href="structsqlite3.html#a0abe1dccdea5f43e6c49360b42749697">aDb</a>[i].<a class="code" href="structDb.html#a6df2b5d7c8fd68e92cea961d9e3b279b">zName</a>;
<a name="l00553"></a>00553         <a class="code" href="sqliteInt_8h.html#adf4434e94ac41a2abedd476047d49983">sqlite3Error</a>(db, <a class="code" href="sqlite3_8h.html#ab1a65dcef7ac3d761c7f0a07e3428a58">SQLITE_LOCKED</a>, <span class="stringliteral">&quot;database schema is locked: %s&quot;</span>, zDb);
<a name="l00554"></a>00554         (void)<a class="code" href="sqliteInt_8h.html#afd5afdeac4ae868c2bcb8a2246eefaf0">sqlite3SafetyOff</a>(db);
<a name="l00555"></a>00555         <span class="keywordflow">return</span> <a class="code" href="malloc_8c.html#a5ace6847fdf42079e5ec21f3d54d601b">sqlite3ApiExit</a>(db, <a class="code" href="sqlite3_8h.html#ab1a65dcef7ac3d761c7f0a07e3428a58">SQLITE_LOCKED</a>);
<a name="l00556"></a>00556       }
<a name="l00557"></a>00557     }
<a name="l00558"></a>00558   }
<a name="l00559"></a>00559   
<a name="l00560"></a>00560   memset(&amp;sParse, 0, <span class="keyword">sizeof</span>(sParse));
<a name="l00561"></a>00561   sParse.<a class="code" href="structParse.html#a44364e5e1197927f89864ec345bc5491">db</a> = db;
<a name="l00562"></a>00562   <span class="keywordflow">if</span>( nBytes&gt;=0 &amp;&amp; (nBytes==0 || zSql[nBytes-1]!=0) ){
<a name="l00563"></a>00563     <span class="keywordtype">char</span> *zSqlCopy;
<a name="l00564"></a>00564     <span class="keywordtype">int</span> mxLen = db-&gt;<a class="code" href="structsqlite3.html#ad8acf663e1619905094c9dfe4125157b">aLimit</a>[<a class="code" href="sqlite3_8h.html#a6498a9b0e2a19d61612a3f51d458fb15">SQLITE_LIMIT_SQL_LENGTH</a>];
<a name="l00565"></a>00565     <span class="keywordflow">if</span>( nBytes&gt;mxLen ){
<a name="l00566"></a>00566       <a class="code" href="sqliteInt_8h.html#adf4434e94ac41a2abedd476047d49983">sqlite3Error</a>(db, <a class="code" href="sqlite3_8h.html#a88e41cbe09fb26a267081d59316ef126">SQLITE_TOOBIG</a>, <span class="stringliteral">&quot;statement too long&quot;</span>);
<a name="l00567"></a>00567       (void)<a class="code" href="sqliteInt_8h.html#afd5afdeac4ae868c2bcb8a2246eefaf0">sqlite3SafetyOff</a>(db);
<a name="l00568"></a>00568       <span class="keywordflow">return</span> <a class="code" href="malloc_8c.html#a5ace6847fdf42079e5ec21f3d54d601b">sqlite3ApiExit</a>(db, <a class="code" href="sqlite3_8h.html#a88e41cbe09fb26a267081d59316ef126">SQLITE_TOOBIG</a>);
<a name="l00569"></a>00569     }
<a name="l00570"></a>00570     zSqlCopy = <a class="code" href="malloc_8c.html#a17fab011bf22c10e5f74813f08404f63">sqlite3DbStrNDup</a>(db, zSql, nBytes);
<a name="l00571"></a>00571     <span class="keywordflow">if</span>( zSqlCopy ){
<a name="l00572"></a>00572       <a class="code" href="sqliteInt_8h.html#a012b875619bdd3e411e20471e044fc47">sqlite3RunParser</a>(&amp;sParse, zSqlCopy, &amp;zErrMsg);
<a name="l00573"></a>00573       <a class="code" href="malloc_8c.html#a8ca215f2395ca90fd180460afb2eba9d">sqlite3DbFree</a>(db, zSqlCopy);
<a name="l00574"></a>00574       sParse.<a class="code" href="structParse.html#a14f58728b3ae2a297272510ae4bd9a89">zTail</a> = &amp;zSql[sParse.<a class="code" href="structParse.html#a14f58728b3ae2a297272510ae4bd9a89">zTail</a>-zSqlCopy];
<a name="l00575"></a>00575     }<span class="keywordflow">else</span>{
<a name="l00576"></a>00576       sParse.<a class="code" href="structParse.html#a14f58728b3ae2a297272510ae4bd9a89">zTail</a> = &amp;zSql[nBytes];
<a name="l00577"></a>00577     }
<a name="l00578"></a>00578   }<span class="keywordflow">else</span>{
<a name="l00579"></a>00579     <a class="code" href="sqliteInt_8h.html#a012b875619bdd3e411e20471e044fc47">sqlite3RunParser</a>(&amp;sParse, zSql, &amp;zErrMsg);
<a name="l00580"></a>00580   }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582   <span class="keywordflow">if</span>( db-&gt;<a class="code" href="structsqlite3.html#a79beb0036337ba7fc2de5ccbb9225935">mallocFailed</a> ){
<a name="l00583"></a>00583     sParse.<a class="code" href="structParse.html#a897c2ea40a1065d49a134f18ca251637">rc</a> = <a class="code" href="sqlite3_8h.html#a9e34c7a5186dc9095e108e517eaac9f6">SQLITE_NOMEM</a>;
<a name="l00584"></a>00584   }
<a name="l00585"></a>00585   <span class="keywordflow">if</span>( sParse.<a class="code" href="structParse.html#a897c2ea40a1065d49a134f18ca251637">rc</a>==<a class="code" href="sqlite3_8h.html#afd1d7cc5f2e803af5e944f548e28f141">SQLITE_DONE</a> ) sParse.<a class="code" href="structParse.html#a897c2ea40a1065d49a134f18ca251637">rc</a> = <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00586"></a>00586   <span class="keywordflow">if</span>( sParse.<a class="code" href="structParse.html#a13b660ed90fc83565aa542a10549ec9f">checkSchema</a> &amp;&amp; !<a class="code" href="prepare_8c.html#a13f2d9601d2ba6c5e02817cdee73ce12">schemaIsValid</a>(db) ){
<a name="l00587"></a>00587     sParse.<a class="code" href="structParse.html#a897c2ea40a1065d49a134f18ca251637">rc</a> = <a class="code" href="sqlite3_8h.html#a1671ab645a3331d997b4422dc334476a">SQLITE_SCHEMA</a>;
<a name="l00588"></a>00588   }
<a name="l00589"></a>00589   <span class="keywordflow">if</span>( sParse.<a class="code" href="structParse.html#a897c2ea40a1065d49a134f18ca251637">rc</a>==<a class="code" href="sqlite3_8h.html#a1671ab645a3331d997b4422dc334476a">SQLITE_SCHEMA</a> ){
<a name="l00590"></a>00590     <a class="code" href="build_8c.html#a67e7c0c4f9880fb86514ef03643b1cd2">sqlite3ResetInternalSchema</a>(db, 0);
<a name="l00591"></a>00591   }
<a name="l00592"></a>00592   <span class="keywordflow">if</span>( db-&gt;<a class="code" href="structsqlite3.html#a79beb0036337ba7fc2de5ccbb9225935">mallocFailed</a> ){
<a name="l00593"></a>00593     sParse.<a class="code" href="structParse.html#a897c2ea40a1065d49a134f18ca251637">rc</a> = <a class="code" href="sqlite3_8h.html#a9e34c7a5186dc9095e108e517eaac9f6">SQLITE_NOMEM</a>;
<a name="l00594"></a>00594   }
<a name="l00595"></a>00595   <span class="keywordflow">if</span>( pzTail ){
<a name="l00596"></a>00596     *pzTail = sParse.<a class="code" href="structParse.html#a14f58728b3ae2a297272510ae4bd9a89">zTail</a>;
<a name="l00597"></a>00597   }
<a name="l00598"></a>00598   rc = sParse.<a class="code" href="structParse.html#a897c2ea40a1065d49a134f18ca251637">rc</a>;
<a name="l00599"></a>00599 
<a name="l00600"></a>00600 <span class="preprocessor">#ifndef SQLITE_OMIT_EXPLAIN</span>
<a name="l00601"></a>00601 <span class="preprocessor"></span>  <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> &amp;&amp; sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a> &amp;&amp; sParse.<a class="code" href="structParse.html#a41f7ea55f0d6523295a5d958e25a2787">explain</a> ){
<a name="l00602"></a>00602     <span class="keywordflow">if</span>( sParse.<a class="code" href="structParse.html#a41f7ea55f0d6523295a5d958e25a2787">explain</a>==2 ){
<a name="l00603"></a>00603       <a class="code" href="vdbe_8h.html#adbf4be46f9152eb8e9be03ad52453b3e">sqlite3VdbeSetNumCols</a>(sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a>, 3);
<a name="l00604"></a>00604       <a class="code" href="vdbe_8h.html#a3501a072f6a015567c0ce5ed683bf31f">sqlite3VdbeSetColName</a>(sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a>, 0, <a class="code" href="vdbe_8h.html#af2998f82dd52035cb28538e1ecde4e7b">COLNAME_NAME</a>, <span class="stringliteral">&quot;order&quot;</span>, <a class="code" href="sqlite3_8h.html#a98b49797a7a15e2a570532fc2b5537c8">SQLITE_STATIC</a>);
<a name="l00605"></a>00605       <a class="code" href="vdbe_8h.html#a3501a072f6a015567c0ce5ed683bf31f">sqlite3VdbeSetColName</a>(sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a>, 1, <a class="code" href="vdbe_8h.html#af2998f82dd52035cb28538e1ecde4e7b">COLNAME_NAME</a>, <span class="stringliteral">&quot;from&quot;</span>, <a class="code" href="sqlite3_8h.html#a98b49797a7a15e2a570532fc2b5537c8">SQLITE_STATIC</a>);
<a name="l00606"></a>00606       <a class="code" href="vdbe_8h.html#a3501a072f6a015567c0ce5ed683bf31f">sqlite3VdbeSetColName</a>(sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a>, 2, <a class="code" href="vdbe_8h.html#af2998f82dd52035cb28538e1ecde4e7b">COLNAME_NAME</a>, <span class="stringliteral">&quot;detail&quot;</span>, <a class="code" href="sqlite3_8h.html#a98b49797a7a15e2a570532fc2b5537c8">SQLITE_STATIC</a>);
<a name="l00607"></a>00607     }<span class="keywordflow">else</span>{
<a name="l00608"></a>00608       <a class="code" href="vdbe_8h.html#adbf4be46f9152eb8e9be03ad52453b3e">sqlite3VdbeSetNumCols</a>(sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a>, 8);
<a name="l00609"></a>00609       <a class="code" href="vdbe_8h.html#a3501a072f6a015567c0ce5ed683bf31f">sqlite3VdbeSetColName</a>(sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a>, 0, <a class="code" href="vdbe_8h.html#af2998f82dd52035cb28538e1ecde4e7b">COLNAME_NAME</a>, <span class="stringliteral">&quot;addr&quot;</span>, <a class="code" href="sqlite3_8h.html#a98b49797a7a15e2a570532fc2b5537c8">SQLITE_STATIC</a>);
<a name="l00610"></a>00610       <a class="code" href="vdbe_8h.html#a3501a072f6a015567c0ce5ed683bf31f">sqlite3VdbeSetColName</a>(sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a>, 1, <a class="code" href="vdbe_8h.html#af2998f82dd52035cb28538e1ecde4e7b">COLNAME_NAME</a>, <span class="stringliteral">&quot;opcode&quot;</span>, <a class="code" href="sqlite3_8h.html#a98b49797a7a15e2a570532fc2b5537c8">SQLITE_STATIC</a>);
<a name="l00611"></a>00611       <a class="code" href="vdbe_8h.html#a3501a072f6a015567c0ce5ed683bf31f">sqlite3VdbeSetColName</a>(sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a>, 2, <a class="code" href="vdbe_8h.html#af2998f82dd52035cb28538e1ecde4e7b">COLNAME_NAME</a>, <span class="stringliteral">&quot;p1&quot;</span>, <a class="code" href="sqlite3_8h.html#a98b49797a7a15e2a570532fc2b5537c8">SQLITE_STATIC</a>);
<a name="l00612"></a>00612       <a class="code" href="vdbe_8h.html#a3501a072f6a015567c0ce5ed683bf31f">sqlite3VdbeSetColName</a>(sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a>, 3, <a class="code" href="vdbe_8h.html#af2998f82dd52035cb28538e1ecde4e7b">COLNAME_NAME</a>, <span class="stringliteral">&quot;p2&quot;</span>, <a class="code" href="sqlite3_8h.html#a98b49797a7a15e2a570532fc2b5537c8">SQLITE_STATIC</a>);
<a name="l00613"></a>00613       <a class="code" href="vdbe_8h.html#a3501a072f6a015567c0ce5ed683bf31f">sqlite3VdbeSetColName</a>(sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a>, 4, <a class="code" href="vdbe_8h.html#af2998f82dd52035cb28538e1ecde4e7b">COLNAME_NAME</a>, <span class="stringliteral">&quot;p3&quot;</span>, <a class="code" href="sqlite3_8h.html#a98b49797a7a15e2a570532fc2b5537c8">SQLITE_STATIC</a>);
<a name="l00614"></a>00614       <a class="code" href="vdbe_8h.html#a3501a072f6a015567c0ce5ed683bf31f">sqlite3VdbeSetColName</a>(sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a>, 5, <a class="code" href="vdbe_8h.html#af2998f82dd52035cb28538e1ecde4e7b">COLNAME_NAME</a>, <span class="stringliteral">&quot;p4&quot;</span>, <a class="code" href="sqlite3_8h.html#a98b49797a7a15e2a570532fc2b5537c8">SQLITE_STATIC</a>);
<a name="l00615"></a>00615       <a class="code" href="vdbe_8h.html#a3501a072f6a015567c0ce5ed683bf31f">sqlite3VdbeSetColName</a>(sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a>, 6, <a class="code" href="vdbe_8h.html#af2998f82dd52035cb28538e1ecde4e7b">COLNAME_NAME</a>, <span class="stringliteral">&quot;p5&quot;</span>, <a class="code" href="sqlite3_8h.html#a98b49797a7a15e2a570532fc2b5537c8">SQLITE_STATIC</a>);
<a name="l00616"></a>00616       <a class="code" href="vdbe_8h.html#a3501a072f6a015567c0ce5ed683bf31f">sqlite3VdbeSetColName</a>(sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a>, 7, <a class="code" href="vdbe_8h.html#af2998f82dd52035cb28538e1ecde4e7b">COLNAME_NAME</a>, <span class="stringliteral">&quot;comment&quot;</span>, <a class="code" href="sqlite3_8h.html#a98b49797a7a15e2a570532fc2b5537c8">SQLITE_STATIC</a>);
<a name="l00617"></a>00617     }
<a name="l00618"></a>00618   }
<a name="l00619"></a>00619 <span class="preprocessor">#endif</span>
<a name="l00620"></a>00620 <span class="preprocessor"></span>
<a name="l00621"></a>00621   <span class="keywordflow">if</span>( <a class="code" href="sqliteInt_8h.html#afd5afdeac4ae868c2bcb8a2246eefaf0">sqlite3SafetyOff</a>(db) ){
<a name="l00622"></a>00622     rc = <a class="code" href="sqlite3_8h.html#a34f01e4ee909e6b68be040868f7503bc">SQLITE_MISUSE</a>;
<a name="l00623"></a>00623   }
<a name="l00624"></a>00624 
<a name="l00625"></a>00625   <span class="keywordflow">if</span>( saveSqlFlag ){
<a name="l00626"></a>00626     <a class="code" href="vdbe_8h.html#a91ef9ee10a88caaa650cd178958c8dcf">sqlite3VdbeSetSql</a>(sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a>, zSql, sParse.<a class="code" href="structParse.html#a14f58728b3ae2a297272510ae4bd9a89">zTail</a> - zSql);
<a name="l00627"></a>00627   }
<a name="l00628"></a>00628   <span class="keywordflow">if</span>( rc!=<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> || db-&gt;<a class="code" href="structsqlite3.html#a79beb0036337ba7fc2de5ccbb9225935">mallocFailed</a> ){
<a name="l00629"></a>00629     <a class="code" href="sqlite3_8h.html#aaf6c3dbc23f33c0752588425c7e9d498">sqlite3_finalize</a>((<a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a>*)sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a>);
<a name="l00630"></a>00630     assert(!(*ppStmt));
<a name="l00631"></a>00631   }<span class="keywordflow">else</span>{
<a name="l00632"></a>00632     *ppStmt = (<a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a>*)sParse.<a class="code" href="structParse.html#a81774053fd5063046f532c07e3daa98b">pVdbe</a>;
<a name="l00633"></a>00633   }
<a name="l00634"></a>00634 
<a name="l00635"></a>00635   <span class="keywordflow">if</span>( zErrMsg ){
<a name="l00636"></a>00636     <a class="code" href="sqliteInt_8h.html#adf4434e94ac41a2abedd476047d49983">sqlite3Error</a>(db, rc, <span class="stringliteral">&quot;%s&quot;</span>, zErrMsg);
<a name="l00637"></a>00637     <a class="code" href="malloc_8c.html#a8ca215f2395ca90fd180460afb2eba9d">sqlite3DbFree</a>(db, zErrMsg);
<a name="l00638"></a>00638   }<span class="keywordflow">else</span>{
<a name="l00639"></a>00639     <a class="code" href="sqliteInt_8h.html#adf4434e94ac41a2abedd476047d49983">sqlite3Error</a>(db, rc, 0);
<a name="l00640"></a>00640   }
<a name="l00641"></a>00641 
<a name="l00642"></a>00642   rc = <a class="code" href="malloc_8c.html#a5ace6847fdf42079e5ec21f3d54d601b">sqlite3ApiExit</a>(db, rc);
<a name="l00643"></a>00643   assert( (rc&amp;db-&gt;<a class="code" href="structsqlite3.html#a12541dafcf60cfce52fb60f84e42f152">errMask</a>)==rc );
<a name="l00644"></a>00644   <span class="keywordflow">return</span> rc;
<a name="l00645"></a>00645 }
<a name="l00646"></a><a class="code" href="prepare_8c.html#a6e737d5fdc7fedf58b7dd3db92ad18c9">00646</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="prepare_8c.html#a6e737d5fdc7fedf58b7dd3db92ad18c9">sqlite3LockAndPrepare</a>(
<a name="l00647"></a>00647   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a>,              <span class="comment">/* Database handle. */</span>
<a name="l00648"></a>00648   <span class="keyword">const</span> <span class="keywordtype">char</span> *zSql,         <span class="comment">/* UTF-8 encoded SQL statement. */</span>
<a name="l00649"></a>00649   <span class="keywordtype">int</span> nBytes,               <span class="comment">/* Length of zSql in bytes. */</span>
<a name="l00650"></a>00650   <span class="keywordtype">int</span> saveSqlFlag,          <span class="comment">/* True to copy SQL text into the sqlite3_stmt */</span>
<a name="l00651"></a>00651   <a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> **ppStmt,    <span class="comment">/* OUT: A pointer to the prepared statement */</span>
<a name="l00652"></a>00652   <span class="keyword">const</span> <span class="keywordtype">char</span> **pzTail       <span class="comment">/* OUT: End of parsed string */</span>
<a name="l00653"></a>00653 ){
<a name="l00654"></a>00654   <span class="keywordtype">int</span> rc;
<a name="l00655"></a>00655   <span class="keywordflow">if</span>( !<a class="code" href="sqliteInt_8h.html#aab020605a0d83080a5db8fae5e51db2e">sqlite3SafetyCheckOk</a>(db) ){
<a name="l00656"></a>00656     <span class="keywordflow">return</span> <a class="code" href="sqlite3_8h.html#a34f01e4ee909e6b68be040868f7503bc">SQLITE_MISUSE</a>;
<a name="l00657"></a>00657   }
<a name="l00658"></a>00658   <a class="code" href="mutex_8h.html#afbab5dc0108b65678f2fa579473041ac">sqlite3_mutex_enter</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>);
<a name="l00659"></a>00659   <a class="code" href="btree_8h.html#a4fc9b040d1c7ac6b711febf3e71eeefe">sqlite3BtreeEnterAll</a>(db);
<a name="l00660"></a>00660   rc = <a class="code" href="prepare_8c.html#aa3e7ff81525b91f8de8ecb0357b0b0cb">sqlite3Prepare</a>(db, zSql, nBytes, saveSqlFlag, ppStmt, pzTail);
<a name="l00661"></a>00661   <a class="code" href="btree_8h.html#ad6d7e5bd01a11b45825ef54eda66fee4">sqlite3BtreeLeaveAll</a>(db);
<a name="l00662"></a>00662   <a class="code" href="mutex_8h.html#aba06556afc1a17868af4675ba856701c">sqlite3_mutex_leave</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>);
<a name="l00663"></a>00663   <span class="keywordflow">return</span> rc;
<a name="l00664"></a>00664 }
<a name="l00665"></a>00665 
<a name="l00666"></a>00666 <span class="comment">/*</span>
<a name="l00667"></a>00667 <span class="comment">** Rerun the compilation of a statement after a schema change.</span>
<a name="l00668"></a>00668 <span class="comment">** Return true if the statement was recompiled successfully.</span>
<a name="l00669"></a>00669 <span class="comment">** Return false if there is an error of some kind.</span>
<a name="l00670"></a>00670 <span class="comment">*/</span>
<a name="l00671"></a><a class="code" href="sqliteInt_8h.html#a2fc907e58282d2e880f2aa78fc596adf">00671</a> <span class="keywordtype">int</span> <a class="code" href="prepare_8c.html#a910dc34b228355761dd5957391dc4686">sqlite3Reprepare</a>(<a class="code" href="structVdbe.html">Vdbe</a> *p){
<a name="l00672"></a>00672   <span class="keywordtype">int</span> rc;
<a name="l00673"></a>00673   <a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> *pNew;
<a name="l00674"></a>00674   <span class="keyword">const</span> <span class="keywordtype">char</span> *zSql;
<a name="l00675"></a>00675   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a>;
<a name="l00676"></a>00676 
<a name="l00677"></a>00677   assert( <a class="code" href="mutex_8h.html#ab92b5e853fc83d5aaa9a5d25e1883d3d">sqlite3_mutex_held</a>(<a class="code" href="vdbe_8h.html#af0e1e3c12dca9f250170460e88bccdad">sqlite3VdbeDb</a>(p)-&gt;mutex) );
<a name="l00678"></a>00678   zSql = <a class="code" href="sqlite3_8h.html#a08e26e378f63456743e0a39d13eb193e">sqlite3_sql</a>((<a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> *)p);
<a name="l00679"></a>00679   assert( zSql!=0 );  <span class="comment">/* Reprepare only called for prepare_v2() statements */</span>
<a name="l00680"></a>00680   db = <a class="code" href="vdbe_8h.html#af0e1e3c12dca9f250170460e88bccdad">sqlite3VdbeDb</a>(p);
<a name="l00681"></a>00681   assert( <a class="code" href="mutex_8h.html#ab92b5e853fc83d5aaa9a5d25e1883d3d">sqlite3_mutex_held</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>) );
<a name="l00682"></a>00682   rc = <a class="code" href="prepare_8c.html#a6e737d5fdc7fedf58b7dd3db92ad18c9">sqlite3LockAndPrepare</a>(db, zSql, -1, 0, &amp;pNew, 0);
<a name="l00683"></a>00683   <span class="keywordflow">if</span>( rc ){
<a name="l00684"></a>00684     <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#a9e34c7a5186dc9095e108e517eaac9f6">SQLITE_NOMEM</a> ){
<a name="l00685"></a>00685       db-&gt;<a class="code" href="structsqlite3.html#a79beb0036337ba7fc2de5ccbb9225935">mallocFailed</a> = 1;
<a name="l00686"></a>00686     }
<a name="l00687"></a>00687     assert( pNew==0 );
<a name="l00688"></a>00688     <span class="keywordflow">return</span> 0;
<a name="l00689"></a>00689   }<span class="keywordflow">else</span>{
<a name="l00690"></a>00690     assert( pNew!=0 );
<a name="l00691"></a>00691   }
<a name="l00692"></a>00692   <a class="code" href="vdbe_8h.html#ae5dc11f3d31e8c0b9b0e793185bff637">sqlite3VdbeSwap</a>((<a class="code" href="structVdbe.html">Vdbe</a>*)pNew, p);
<a name="l00693"></a>00693   <a class="code" href="sqliteInt_8h.html#a1d5aecef937a435bb7eac5a8dcac1d47">sqlite3TransferBindings</a>(pNew, (<a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a>*)p);
<a name="l00694"></a>00694   <a class="code" href="vdbe_8h.html#aebcf31493be1e7a7c4d88c67876ced9f">sqlite3VdbeResetStepResult</a>((<a class="code" href="structVdbe.html">Vdbe</a>*)pNew);
<a name="l00695"></a>00695   <a class="code" href="vdbe_8h.html#a65395771ab2499f7e467c7edb809b670">sqlite3VdbeFinalize</a>((<a class="code" href="structVdbe.html">Vdbe</a>*)pNew);
<a name="l00696"></a>00696   <span class="keywordflow">return</span> 1;
<a name="l00697"></a>00697 }
<a name="l00698"></a>00698 
<a name="l00699"></a>00699 
<a name="l00700"></a>00700 <span class="comment">/*</span>
<a name="l00701"></a>00701 <span class="comment">** Two versions of the official API.  Legacy and new use.  In the legacy</span>
<a name="l00702"></a>00702 <span class="comment">** version, the original SQL text is not saved in the prepared statement</span>
<a name="l00703"></a>00703 <span class="comment">** and so if a schema change occurs, SQLITE_SCHEMA is returned by</span>
<a name="l00704"></a>00704 <span class="comment">** sqlite3_step().  In the new version, the original SQL text is retained</span>
<a name="l00705"></a>00705 <span class="comment">** and the statement is automatically recompiled if an schema change</span>
<a name="l00706"></a>00706 <span class="comment">** occurs.</span>
<a name="l00707"></a>00707 <span class="comment">*/</span>
<a name="l00708"></a><a class="code" href="sqlite3_8h.html#ae616087af47470c9eeb7e82d2edd7e98">00708</a> <span class="keywordtype">int</span> <a class="code" href="prepare_8c.html#a2322405eadeb95539ec7c96e2cfdf38b">sqlite3_prepare</a>(
<a name="l00709"></a>00709   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a>,              <span class="comment">/* Database handle. */</span>
<a name="l00710"></a>00710   <span class="keyword">const</span> <span class="keywordtype">char</span> *zSql,         <span class="comment">/* UTF-8 encoded SQL statement. */</span>
<a name="l00711"></a>00711   <span class="keywordtype">int</span> nBytes,               <span class="comment">/* Length of zSql in bytes. */</span>
<a name="l00712"></a>00712   <a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> **ppStmt,    <span class="comment">/* OUT: A pointer to the prepared statement */</span>
<a name="l00713"></a>00713   <span class="keyword">const</span> <span class="keywordtype">char</span> **pzTail       <span class="comment">/* OUT: End of parsed string */</span>
<a name="l00714"></a>00714 ){
<a name="l00715"></a>00715   <span class="keywordtype">int</span> rc;
<a name="l00716"></a>00716   rc = <a class="code" href="prepare_8c.html#a6e737d5fdc7fedf58b7dd3db92ad18c9">sqlite3LockAndPrepare</a>(db,zSql,nBytes,0,ppStmt,pzTail);
<a name="l00717"></a>00717   assert( rc==<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> || ppStmt==0 || *ppStmt==0 );  <span class="comment">/* VERIFY: F13021 */</span>
<a name="l00718"></a>00718   <span class="keywordflow">return</span> rc;
<a name="l00719"></a>00719 }
<a name="l00720"></a><a class="code" href="sqlite3_8h.html#a941862e7610ebb0703f55829c729967f">00720</a> <span class="keywordtype">int</span> <a class="code" href="prepare_8c.html#a2798d2a1d90446bee6e9fa880fc659c1">sqlite3_prepare_v2</a>(
<a name="l00721"></a>00721   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a>,              <span class="comment">/* Database handle. */</span>
<a name="l00722"></a>00722   <span class="keyword">const</span> <span class="keywordtype">char</span> *zSql,         <span class="comment">/* UTF-8 encoded SQL statement. */</span>
<a name="l00723"></a>00723   <span class="keywordtype">int</span> nBytes,               <span class="comment">/* Length of zSql in bytes. */</span>
<a name="l00724"></a>00724   <a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> **ppStmt,    <span class="comment">/* OUT: A pointer to the prepared statement */</span>
<a name="l00725"></a>00725   <span class="keyword">const</span> <span class="keywordtype">char</span> **pzTail       <span class="comment">/* OUT: End of parsed string */</span>
<a name="l00726"></a>00726 ){
<a name="l00727"></a>00727   <span class="keywordtype">int</span> rc;
<a name="l00728"></a>00728   rc = <a class="code" href="prepare_8c.html#a6e737d5fdc7fedf58b7dd3db92ad18c9">sqlite3LockAndPrepare</a>(db,zSql,nBytes,1,ppStmt,pzTail);
<a name="l00729"></a>00729   assert( rc==<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> || ppStmt==0 || *ppStmt==0 );  <span class="comment">/* VERIFY: F13021 */</span>
<a name="l00730"></a>00730   <span class="keywordflow">return</span> rc;
<a name="l00731"></a>00731 }
<a name="l00732"></a>00732 
<a name="l00733"></a>00733 
<a name="l00734"></a>00734 <span class="preprocessor">#ifndef SQLITE_OMIT_UTF16</span>
<a name="l00735"></a>00735 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l00736"></a>00736 <span class="comment">** Compile the UTF-16 encoded SQL statement zSql into a statement handle.</span>
<a name="l00737"></a>00737 <span class="comment">*/</span>
<a name="l00738"></a><a class="code" href="prepare_8c.html#a5842e6724b91885125f83c438da1f15b">00738</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="prepare_8c.html#a5842e6724b91885125f83c438da1f15b">sqlite3Prepare16</a>(
<a name="l00739"></a>00739   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a>,              <span class="comment">/* Database handle. */</span> 
<a name="l00740"></a>00740   <span class="keyword">const</span> <span class="keywordtype">void</span> *zSql,         <span class="comment">/* UTF-8 encoded SQL statement. */</span>
<a name="l00741"></a>00741   <span class="keywordtype">int</span> nBytes,               <span class="comment">/* Length of zSql in bytes. */</span>
<a name="l00742"></a>00742   <span class="keywordtype">int</span> saveSqlFlag,          <span class="comment">/* True to save SQL text into the sqlite3_stmt */</span>
<a name="l00743"></a>00743   <a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> **ppStmt,    <span class="comment">/* OUT: A pointer to the prepared statement */</span>
<a name="l00744"></a>00744   <span class="keyword">const</span> <span class="keywordtype">void</span> **pzTail       <span class="comment">/* OUT: End of parsed string */</span>
<a name="l00745"></a>00745 ){
<a name="l00746"></a>00746   <span class="comment">/* This function currently works by first transforming the UTF-16</span>
<a name="l00747"></a>00747 <span class="comment">  ** encoded string to UTF-8, then invoking sqlite3_prepare(). The</span>
<a name="l00748"></a>00748 <span class="comment">  ** tricky bit is figuring out the pointer to return in *pzTail.</span>
<a name="l00749"></a>00749 <span class="comment">  */</span>
<a name="l00750"></a>00750   <span class="keywordtype">char</span> *zSql8;
<a name="l00751"></a>00751   <span class="keyword">const</span> <span class="keywordtype">char</span> *zTail8 = 0;
<a name="l00752"></a>00752   <span class="keywordtype">int</span> rc = <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00753"></a>00753 
<a name="l00754"></a>00754   <span class="keywordflow">if</span>( !<a class="code" href="sqliteInt_8h.html#aab020605a0d83080a5db8fae5e51db2e">sqlite3SafetyCheckOk</a>(db) ){
<a name="l00755"></a>00755     <span class="keywordflow">return</span> <a class="code" href="sqlite3_8h.html#a34f01e4ee909e6b68be040868f7503bc">SQLITE_MISUSE</a>;
<a name="l00756"></a>00756   }
<a name="l00757"></a>00757   <a class="code" href="mutex_8h.html#afbab5dc0108b65678f2fa579473041ac">sqlite3_mutex_enter</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>);
<a name="l00758"></a>00758   zSql8 = <a class="code" href="sqliteInt_8h.html#ab5e02fbadd50652b4dc831e8a44dba34">sqlite3Utf16to8</a>(db, zSql, nBytes);
<a name="l00759"></a>00759   <span class="keywordflow">if</span>( zSql8 ){
<a name="l00760"></a>00760     rc = <a class="code" href="prepare_8c.html#a6e737d5fdc7fedf58b7dd3db92ad18c9">sqlite3LockAndPrepare</a>(db, zSql8, -1, saveSqlFlag, ppStmt, &amp;zTail8);
<a name="l00761"></a>00761   }
<a name="l00762"></a>00762 
<a name="l00763"></a>00763   <span class="keywordflow">if</span>( zTail8 &amp;&amp; pzTail ){
<a name="l00764"></a>00764     <span class="comment">/* If sqlite3_prepare returns a tail pointer, we calculate the</span>
<a name="l00765"></a>00765 <span class="comment">    ** equivalent pointer into the UTF-16 string by counting the unicode</span>
<a name="l00766"></a>00766 <span class="comment">    ** characters between zSql8 and zTail8, and then returning a pointer</span>
<a name="l00767"></a>00767 <span class="comment">    ** the same number of characters into the UTF-16 string.</span>
<a name="l00768"></a>00768 <span class="comment">    */</span>
<a name="l00769"></a>00769     <span class="keywordtype">int</span> chars_parsed = <a class="code" href="sqliteInt_8h.html#a2fc6093c14c97b5eecc449831127d23c">sqlite3Utf8CharLen</a>(zSql8, zTail8-zSql8);
<a name="l00770"></a>00770     *pzTail = (<a class="code" href="sqliteInt_8h.html#a74a0f6424ae628af25f23f0a35f6ead3">u8</a> *)zSql + <a class="code" href="sqliteInt_8h.html#a5595879ab4890373b7e238b12ee4382c">sqlite3Utf16ByteLen</a>(zSql, chars_parsed);
<a name="l00771"></a>00771   }
<a name="l00772"></a>00772   <a class="code" href="malloc_8c.html#a8ca215f2395ca90fd180460afb2eba9d">sqlite3DbFree</a>(db, zSql8); 
<a name="l00773"></a>00773   rc = <a class="code" href="malloc_8c.html#a5ace6847fdf42079e5ec21f3d54d601b">sqlite3ApiExit</a>(db, rc);
<a name="l00774"></a>00774   <a class="code" href="mutex_8h.html#aba06556afc1a17868af4675ba856701c">sqlite3_mutex_leave</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>);
<a name="l00775"></a>00775   <span class="keywordflow">return</span> rc;
<a name="l00776"></a>00776 }
<a name="l00777"></a>00777 
<a name="l00778"></a>00778 <span class="comment">/*</span>
<a name="l00779"></a>00779 <span class="comment">** Two versions of the official API.  Legacy and new use.  In the legacy</span>
<a name="l00780"></a>00780 <span class="comment">** version, the original SQL text is not saved in the prepared statement</span>
<a name="l00781"></a>00781 <span class="comment">** and so if a schema change occurs, SQLITE_SCHEMA is returned by</span>
<a name="l00782"></a>00782 <span class="comment">** sqlite3_step().  In the new version, the original SQL text is retained</span>
<a name="l00783"></a>00783 <span class="comment">** and the statement is automatically recompiled if an schema change</span>
<a name="l00784"></a>00784 <span class="comment">** occurs.</span>
<a name="l00785"></a>00785 <span class="comment">*/</span>
<a name="l00786"></a><a class="code" href="sqlite3_8h.html#a8d1e6fcf1c4d664e0d113d739403ff82">00786</a> <span class="keywordtype">int</span> <a class="code" href="prepare_8c.html#a91cc492d3829f1674d9ecd19458421ed">sqlite3_prepare16</a>(
<a name="l00787"></a>00787   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a>,              <span class="comment">/* Database handle. */</span> 
<a name="l00788"></a>00788   <span class="keyword">const</span> <span class="keywordtype">void</span> *zSql,         <span class="comment">/* UTF-8 encoded SQL statement. */</span>
<a name="l00789"></a>00789   <span class="keywordtype">int</span> nBytes,               <span class="comment">/* Length of zSql in bytes. */</span>
<a name="l00790"></a>00790   <a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> **ppStmt,    <span class="comment">/* OUT: A pointer to the prepared statement */</span>
<a name="l00791"></a>00791   <span class="keyword">const</span> <span class="keywordtype">void</span> **pzTail       <span class="comment">/* OUT: End of parsed string */</span>
<a name="l00792"></a>00792 ){
<a name="l00793"></a>00793   <span class="keywordtype">int</span> rc;
<a name="l00794"></a>00794   rc = <a class="code" href="prepare_8c.html#a5842e6724b91885125f83c438da1f15b">sqlite3Prepare16</a>(db,zSql,nBytes,0,ppStmt,pzTail);
<a name="l00795"></a>00795   assert( rc==<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> || ppStmt==0 || *ppStmt==0 );  <span class="comment">/* VERIFY: F13021 */</span>
<a name="l00796"></a>00796   <span class="keywordflow">return</span> rc;
<a name="l00797"></a>00797 }
<a name="l00798"></a><a class="code" href="sqlite3_8h.html#acf65a65810f993ac19ca1a83cf17c53d">00798</a> <span class="keywordtype">int</span> <a class="code" href="prepare_8c.html#a175fd7ddbf1b8986a8ba2c164b8634fd">sqlite3_prepare16_v2</a>(
<a name="l00799"></a>00799   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a>,              <span class="comment">/* Database handle. */</span> 
<a name="l00800"></a>00800   <span class="keyword">const</span> <span class="keywordtype">void</span> *zSql,         <span class="comment">/* UTF-8 encoded SQL statement. */</span>
<a name="l00801"></a>00801   <span class="keywordtype">int</span> nBytes,               <span class="comment">/* Length of zSql in bytes. */</span>
<a name="l00802"></a>00802   <a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> **ppStmt,    <span class="comment">/* OUT: A pointer to the prepared statement */</span>
<a name="l00803"></a>00803   <span class="keyword">const</span> <span class="keywordtype">void</span> **pzTail       <span class="comment">/* OUT: End of parsed string */</span>
<a name="l00804"></a>00804 ){
<a name="l00805"></a>00805   <span class="keywordtype">int</span> rc;
<a name="l00806"></a>00806   rc = <a class="code" href="prepare_8c.html#a5842e6724b91885125f83c438da1f15b">sqlite3Prepare16</a>(db,zSql,nBytes,1,ppStmt,pzTail);
<a name="l00807"></a>00807   assert( rc==<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> || ppStmt==0 || *ppStmt==0 );  <span class="comment">/* VERIFY: F13021 */</span>
<a name="l00808"></a>00808   <span class="keywordflow">return</span> rc;
<a name="l00809"></a>00809 }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811 <span class="preprocessor">#endif </span><span class="comment">/* SQLITE_OMIT_UTF16 */</span>
</pre></div></div>
<hr size="1">

<p style="text-align: right;">
  <a href="http://www.contextlogger.org/">ContextLogger2</a>&#8212;ContextLogger2 Logger Daemon Internals&#8212;<small>Generated on Mon May 2 13:49:55 2011 by&nbsp;<a href="http://www.doxygen.org/">Doxygen</a> 1.6.1</small>
</p>

</body>
</html>
