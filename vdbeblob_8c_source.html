<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ContextLogger2 Logger Daemon Internals: vdbeblob.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_53e7feede50ae4cb655a635f658a2b4e.html">sqlite3h</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_a0c08fff43b69094a2511677d8587129.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_05c6b5177aad09a72e8ee1adc608dac0.html">sqlite3</a>
  </div>
</div>
<div class="contents">
<h1>vdbeblob.c</h1><a href="vdbeblob_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">** 2007 May 1</span>
<a name="l00003"></a>00003 <span class="comment">**</span>
<a name="l00004"></a>00004 <span class="comment">** The author disclaims copyright to this source code.  In place of</span>
<a name="l00005"></a>00005 <span class="comment">** a legal notice, here is a blessing:</span>
<a name="l00006"></a>00006 <span class="comment">**</span>
<a name="l00007"></a>00007 <span class="comment">**    May you do good and not evil.</span>
<a name="l00008"></a>00008 <span class="comment">**    May you find forgiveness for yourself and forgive others.</span>
<a name="l00009"></a>00009 <span class="comment">**    May you share freely, never taking more than you give.</span>
<a name="l00010"></a>00010 <span class="comment">**</span>
<a name="l00011"></a>00011 <span class="comment">*************************************************************************</span>
<a name="l00012"></a>00012 <span class="comment">**</span>
<a name="l00013"></a>00013 <span class="comment">** This file contains code used to implement incremental BLOB I/O.</span>
<a name="l00014"></a>00014 <span class="comment">**</span>
<a name="l00015"></a>00015 <span class="comment">** $Id: vdbeblob.c,v 1.26 2008/10/02 14:49:02 danielk1977 Exp $</span>
<a name="l00016"></a>00016 <span class="comment">*/</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="sqliteInt_8h.html">sqliteInt.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="vdbeInt_8h.html">vdbeInt.h</a>&quot;</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="preprocessor">#ifndef SQLITE_OMIT_INCRBLOB</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span>
<a name="l00023"></a>00023 <span class="comment">/*</span>
<a name="l00024"></a>00024 <span class="comment">** Valid sqlite3_blob* handles point to Incrblob structures.</span>
<a name="l00025"></a>00025 <span class="comment">*/</span>
<a name="l00026"></a><a class="code" href="vdbeblob_8c.html#a7a8bb03d7cc185a0ab274966c3695c8f">00026</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structIncrblob.html">Incrblob</a> <a class="code" href="structIncrblob.html">Incrblob</a>;
<a name="l00027"></a><a class="code" href="structIncrblob.html">00027</a> <span class="keyword">struct </span><a class="code" href="structIncrblob.html">Incrblob</a> {
<a name="l00028"></a><a class="code" href="structIncrblob.html#a46fa093e5241305f28d02926f8d0846f">00028</a>   <span class="keywordtype">int</span> <a class="code" href="structIncrblob.html#a46fa093e5241305f28d02926f8d0846f">flags</a>;              <span class="comment">/* Copy of &quot;flags&quot; passed to sqlite3_blob_open() */</span>
<a name="l00029"></a><a class="code" href="structIncrblob.html#ab1e1439df086208173fa97003f0ee02b">00029</a>   <span class="keywordtype">int</span> <a class="code" href="structIncrblob.html#ab1e1439df086208173fa97003f0ee02b">nByte</a>;              <span class="comment">/* Size of open blob, in bytes */</span>
<a name="l00030"></a><a class="code" href="structIncrblob.html#af8e71744f43178967460b9f402e7fafd">00030</a>   <span class="keywordtype">int</span> <a class="code" href="structIncrblob.html#af8e71744f43178967460b9f402e7fafd">iOffset</a>;            <span class="comment">/* Byte offset of blob in cursor data */</span>
<a name="l00031"></a><a class="code" href="structIncrblob.html#af5a24b18473d1449c8c3fe7d826de59a">00031</a>   <a class="code" href="structBtCursor.html">BtCursor</a> *<a class="code" href="structIncrblob.html#af5a24b18473d1449c8c3fe7d826de59a">pCsr</a>;         <span class="comment">/* Cursor pointing at blob row */</span>
<a name="l00032"></a><a class="code" href="structIncrblob.html#a8b7b39c9372db552add74c69f14a61a3">00032</a>   <a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> *<a class="code" href="structIncrblob.html#a8b7b39c9372db552add74c69f14a61a3">pStmt</a>;    <span class="comment">/* Statement holding cursor open */</span>
<a name="l00033"></a><a class="code" href="structIncrblob.html#a9d3fe0b0229b75b9d0f9ee8e6545b5bc">00033</a>   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="structIncrblob.html#a9d3fe0b0229b75b9d0f9ee8e6545b5bc">db</a>;            <span class="comment">/* The associated database */</span>
<a name="l00034"></a>00034 };
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="comment">/*</span>
<a name="l00037"></a>00037 <span class="comment">** Open a blob handle.</span>
<a name="l00038"></a>00038 <span class="comment">*/</span>
<a name="l00039"></a><a class="code" href="vdbeblob_8c.html#a64e37df714cdde16c94e3f50dbcbbc7d">00039</a> <span class="keywordtype">int</span> <a class="code" href="sqlite3_8h.html#ae1f10d350ddc4b4ec97bb9c7efc51102">sqlite3_blob_open</a>(
<a name="l00040"></a>00040   <a class="code" href="structsqlite3.html">sqlite3</a>* <a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a>,            <span class="comment">/* The database connection */</span>
<a name="l00041"></a>00041   <span class="keyword">const</span> <span class="keywordtype">char</span> *zDb,        <span class="comment">/* The attached database containing the blob */</span>
<a name="l00042"></a>00042   <span class="keyword">const</span> <span class="keywordtype">char</span> *zTable,     <span class="comment">/* The table containing the blob */</span>
<a name="l00043"></a>00043   <span class="keyword">const</span> <span class="keywordtype">char</span> *zColumn,    <span class="comment">/* The column containing the blob */</span>
<a name="l00044"></a>00044   <a class="code" href="sqlite3_8h.html#a520a95f9080c018b2fade39885bd2e2a">sqlite_int64</a> iRow,      <span class="comment">/* The row containing the glob */</span>
<a name="l00045"></a>00045   <span class="keywordtype">int</span> flags,              <span class="comment">/* True -&gt; read/write access, false -&gt; read-only */</span>
<a name="l00046"></a>00046   <a class="code" href="sqlite3_8h.html#a3eb4857c157c542bb3fb7d8cbf38a662">sqlite3_blob</a> **ppBlob   <span class="comment">/* Handle for accessing the blob returned here */</span>
<a name="l00047"></a>00047 ){
<a name="l00048"></a>00048   <span class="keywordtype">int</span> nAttempt = 0;
<a name="l00049"></a>00049   <span class="keywordtype">int</span> iCol;               <span class="comment">/* Index of zColumn in row-record */</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051   <span class="comment">/* This VDBE program seeks a btree cursor to the identified </span>
<a name="l00052"></a>00052 <span class="comment">  ** db/table/row entry. The reason for using a vdbe program instead</span>
<a name="l00053"></a>00053 <span class="comment">  ** of writing code to use the b-tree layer directly is that the</span>
<a name="l00054"></a>00054 <span class="comment">  ** vdbe program will take advantage of the various transaction,</span>
<a name="l00055"></a>00055 <span class="comment">  ** locking and error handling infrastructure built into the vdbe.</span>
<a name="l00056"></a>00056 <span class="comment">  **</span>
<a name="l00057"></a>00057 <span class="comment">  ** After seeking the cursor, the vdbe executes an OP_ResultRow.</span>
<a name="l00058"></a>00058 <span class="comment">  ** Code external to the Vdbe then &quot;borrows&quot; the b-tree cursor and</span>
<a name="l00059"></a>00059 <span class="comment">  ** uses it to implement the blob_read(), blob_write() and </span>
<a name="l00060"></a>00060 <span class="comment">  ** blob_bytes() functions.</span>
<a name="l00061"></a>00061 <span class="comment">  **</span>
<a name="l00062"></a>00062 <span class="comment">  ** The sqlite3_blob_close() function finalizes the vdbe program,</span>
<a name="l00063"></a>00063 <span class="comment">  ** which closes the b-tree cursor and (possibly) commits the </span>
<a name="l00064"></a>00064 <span class="comment">  ** transaction.</span>
<a name="l00065"></a>00065 <span class="comment">  */</span>
<a name="l00066"></a>00066   <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structVdbeOpList.html">VdbeOpList</a> openBlob[] = {
<a name="l00067"></a>00067     {<a class="code" href="opcodes_8h.html#a4b94e42b258f79e67949e9af065cbcc0">OP_Transaction</a>, 0, 0, 0},     <span class="comment">/* 0: Start a transaction */</span>
<a name="l00068"></a>00068     {<a class="code" href="opcodes_8h.html#af6461f533fb8e4b5c60d510b64566440">OP_VerifyCookie</a>, 0, 0, 0},    <span class="comment">/* 1: Check the schema cookie */</span>
<a name="l00069"></a>00069 
<a name="l00070"></a>00070     <span class="comment">/* One of the following two instructions is replaced by an</span>
<a name="l00071"></a>00071 <span class="comment">    ** OP_Noop before exection.</span>
<a name="l00072"></a>00072 <span class="comment">    */</span>
<a name="l00073"></a>00073     {<a class="code" href="opcodes_8h.html#a573b06e057d808cf609dd66f29e0d998">OP_SetNumColumns</a>, 0, 0, 0},   <span class="comment">/* 2: Num cols for cursor */</span>
<a name="l00074"></a>00074     {<a class="code" href="opcodes_8h.html#a0c72fbe4989449cdc9a69e1bbb2e91c2">OP_OpenRead</a>, 0, 0, 0},        <span class="comment">/* 3: Open cursor 0 for reading */</span>
<a name="l00075"></a>00075     {<a class="code" href="opcodes_8h.html#a573b06e057d808cf609dd66f29e0d998">OP_SetNumColumns</a>, 0, 0, 0},   <span class="comment">/* 4: Num cols for cursor */</span>
<a name="l00076"></a>00076     {<a class="code" href="opcodes_8h.html#a98af8f9fca78ddf04bbc472cf2761f10">OP_OpenWrite</a>, 0, 0, 0},       <span class="comment">/* 5: Open cursor 0 for read/write */</span>
<a name="l00077"></a>00077 
<a name="l00078"></a>00078     {<a class="code" href="opcodes_8h.html#a2ebfabd08425c365befd3c0eca08634b">OP_Variable</a>, 1, 1, 0},        <span class="comment">/* 6: Push the rowid to the stack */</span>
<a name="l00079"></a>00079     {<a class="code" href="opcodes_8h.html#a52cd591f2f66a915ef7549c215806357">OP_NotExists</a>, 0, 10, 1},      <span class="comment">/* 7: Seek the cursor */</span>
<a name="l00080"></a>00080     {<a class="code" href="opcodes_8h.html#a38d4675eacb229ecb7fbf9062c880773">OP_Column</a>, 0, 0, 1},          <span class="comment">/* 8  */</span>
<a name="l00081"></a>00081     {<a class="code" href="opcodes_8h.html#a4a151d57c367806cd9e8a75f4865fd1b">OP_ResultRow</a>, 1, 0, 0},       <span class="comment">/* 9  */</span>
<a name="l00082"></a>00082     {<a class="code" href="opcodes_8h.html#a0aa97845ae3b449f1745a6713f20f3a6">OP_Close</a>, 0, 0, 0},           <span class="comment">/* 10  */</span>
<a name="l00083"></a>00083     {<a class="code" href="opcodes_8h.html#af1020441d30e76aa4d065ac2ec56c23d">OP_Halt</a>, 0, 0, 0},            <span class="comment">/* 11 */</span>
<a name="l00084"></a>00084   };
<a name="l00085"></a>00085 
<a name="l00086"></a>00086   <a class="code" href="structVdbe.html">Vdbe</a> *v = 0;
<a name="l00087"></a>00087   <span class="keywordtype">int</span> rc = <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00088"></a>00088   <span class="keywordtype">char</span> zErr[128];
<a name="l00089"></a>00089 
<a name="l00090"></a>00090   zErr[0] = 0;
<a name="l00091"></a>00091   <a class="code" href="mutex_8h.html#afbab5dc0108b65678f2fa579473041ac">sqlite3_mutex_enter</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>);
<a name="l00092"></a>00092   <span class="keywordflow">do</span> {
<a name="l00093"></a>00093     <a class="code" href="structParse.html">Parse</a> sParse;
<a name="l00094"></a>00094     <a class="code" href="structTable.html">Table</a> *pTab;
<a name="l00095"></a>00095 
<a name="l00096"></a>00096     memset(&amp;sParse, 0, <span class="keyword">sizeof</span>(<a class="code" href="structParse.html">Parse</a>));
<a name="l00097"></a>00097     sParse.<a class="code" href="structParse.html#a44364e5e1197927f89864ec345bc5491">db</a> = db;
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     <span class="keywordflow">if</span>( <a class="code" href="sqliteInt_8h.html#a5478b816780572bc0098dd1e2076ded2">sqlite3SafetyOn</a>(db) ){
<a name="l00100"></a>00100       <a class="code" href="mutex_8h.html#aba06556afc1a17868af4675ba856701c">sqlite3_mutex_leave</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>);
<a name="l00101"></a>00101       <span class="keywordflow">return</span> <a class="code" href="sqlite3_8h.html#a34f01e4ee909e6b68be040868f7503bc">SQLITE_MISUSE</a>;
<a name="l00102"></a>00102     }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104     <a class="code" href="btree_8h.html#a4fc9b040d1c7ac6b711febf3e71eeefe">sqlite3BtreeEnterAll</a>(db);
<a name="l00105"></a>00105     pTab = <a class="code" href="build_8c.html#a6368fd982cd0827e830b850ec74f6ac8">sqlite3LocateTable</a>(&amp;sParse, 0, zTable, zDb);
<a name="l00106"></a>00106     <span class="keywordflow">if</span>( pTab &amp;&amp; <a class="code" href="sqliteInt_8h.html#a3a32526e289387307e17cfee27f7243e">IsVirtual</a>(pTab) ){
<a name="l00107"></a>00107       pTab = 0;
<a name="l00108"></a>00108       <a class="code" href="sqliteInt_8h.html#af5069bb768199c3dab949999e7e6e19c">sqlite3ErrorMsg</a>(&amp;sParse, <span class="stringliteral">&quot;cannot open virtual table: %s&quot;</span>, zTable);
<a name="l00109"></a>00109     }
<a name="l00110"></a>00110 <span class="preprocessor">#ifndef SQLITE_OMIT_VIEW</span>
<a name="l00111"></a>00111 <span class="preprocessor"></span>    <span class="keywordflow">if</span>( pTab &amp;&amp; pTab-&gt;<a class="code" href="structTable.html#a39d620182fe2174fc97d04094421fa60">pSelect</a> ){
<a name="l00112"></a>00112       pTab = 0;
<a name="l00113"></a>00113       <a class="code" href="sqliteInt_8h.html#af5069bb768199c3dab949999e7e6e19c">sqlite3ErrorMsg</a>(&amp;sParse, <span class="stringliteral">&quot;cannot open view: %s&quot;</span>, zTable);
<a name="l00114"></a>00114     }
<a name="l00115"></a>00115 <span class="preprocessor">#endif</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span>    <span class="keywordflow">if</span>( !pTab ){
<a name="l00117"></a>00117       <span class="keywordflow">if</span>( sParse.<a class="code" href="structParse.html#a04146757986ff4654c7b321654896e81">zErrMsg</a> ){
<a name="l00118"></a>00118         <a class="code" href="printf_8c.html#aa62e83e27ab0a63e15f9f844c17c595f">sqlite3_snprintf</a>(<span class="keyword">sizeof</span>(zErr), zErr, <span class="stringliteral">&quot;%s&quot;</span>, sParse.<a class="code" href="structParse.html#a04146757986ff4654c7b321654896e81">zErrMsg</a>);
<a name="l00119"></a>00119       }
<a name="l00120"></a>00120       <a class="code" href="malloc_8c.html#a8ca215f2395ca90fd180460afb2eba9d">sqlite3DbFree</a>(db, sParse.<a class="code" href="structParse.html#a04146757986ff4654c7b321654896e81">zErrMsg</a>);
<a name="l00121"></a>00121       rc = <a class="code" href="sqlite3_8h.html#afda25cd6575e87558d2b7cd4a6585f2f">SQLITE_ERROR</a>;
<a name="l00122"></a>00122       (void)<a class="code" href="sqliteInt_8h.html#afd5afdeac4ae868c2bcb8a2246eefaf0">sqlite3SafetyOff</a>(db);
<a name="l00123"></a>00123       <a class="code" href="btree_8h.html#ad6d7e5bd01a11b45825ef54eda66fee4">sqlite3BtreeLeaveAll</a>(db);
<a name="l00124"></a>00124       <span class="keywordflow">goto</span> blob_open_out;
<a name="l00125"></a>00125     }
<a name="l00126"></a>00126 
<a name="l00127"></a>00127     <span class="comment">/* Now search pTab for the exact column. */</span>
<a name="l00128"></a>00128     <span class="keywordflow">for</span>(iCol=0; iCol &lt; pTab-&gt;<a class="code" href="structTable.html#a2b3925b85368f0367322ab66bf289163">nCol</a>; iCol++) {
<a name="l00129"></a>00129       <span class="keywordflow">if</span>( <a class="code" href="sqliteInt_8h.html#ae3fd8e3be3ee260b4be7afe7b9d23406">sqlite3StrICmp</a>(pTab-&gt;<a class="code" href="structTable.html#a87ec3b706ecf9545bd9ed582a12ce3e7">aCol</a>[iCol].<a class="code" href="structColumn.html#a6450a4e9fde68b3a2d79425d826eccc3">zName</a>, zColumn)==0 ){
<a name="l00130"></a>00130         <span class="keywordflow">break</span>;
<a name="l00131"></a>00131       }
<a name="l00132"></a>00132     }
<a name="l00133"></a>00133     <span class="keywordflow">if</span>( iCol==pTab-&gt;<a class="code" href="structTable.html#a2b3925b85368f0367322ab66bf289163">nCol</a> ){
<a name="l00134"></a>00134       <a class="code" href="printf_8c.html#aa62e83e27ab0a63e15f9f844c17c595f">sqlite3_snprintf</a>(<span class="keyword">sizeof</span>(zErr), zErr, <span class="stringliteral">&quot;no such column: \&quot;%s\&quot;&quot;</span>, zColumn);
<a name="l00135"></a>00135       rc = <a class="code" href="sqlite3_8h.html#afda25cd6575e87558d2b7cd4a6585f2f">SQLITE_ERROR</a>;
<a name="l00136"></a>00136       (void)<a class="code" href="sqliteInt_8h.html#afd5afdeac4ae868c2bcb8a2246eefaf0">sqlite3SafetyOff</a>(db);
<a name="l00137"></a>00137       <a class="code" href="btree_8h.html#ad6d7e5bd01a11b45825ef54eda66fee4">sqlite3BtreeLeaveAll</a>(db);
<a name="l00138"></a>00138       <span class="keywordflow">goto</span> blob_open_out;
<a name="l00139"></a>00139     }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     <span class="comment">/* If the value is being opened for writing, check that the</span>
<a name="l00142"></a>00142 <span class="comment">    ** column is not indexed. It is against the rules to open an</span>
<a name="l00143"></a>00143 <span class="comment">    ** indexed column for writing.</span>
<a name="l00144"></a>00144 <span class="comment">    */</span>
<a name="l00145"></a>00145     <span class="keywordflow">if</span>( flags ){
<a name="l00146"></a>00146       <a class="code" href="structIndex.html">Index</a> *pIdx;
<a name="l00147"></a>00147       <span class="keywordflow">for</span>(pIdx=pTab-&gt;<a class="code" href="structTable.html#a5dffd0c9e8f0265d6a47b32bd0e6d59f">pIndex</a>; pIdx; pIdx=pIdx-&gt;<a class="code" href="structIndex.html#a115a17d236bd277d59dd5ea030954c3e">pNext</a>){
<a name="l00148"></a>00148         <span class="keywordtype">int</span> j;
<a name="l00149"></a>00149         <span class="keywordflow">for</span>(j=0; j&lt;pIdx-&gt;<a class="code" href="structIndex.html#ac583449830c285a52d1fd10b8c890162">nColumn</a>; j++){
<a name="l00150"></a>00150           <span class="keywordflow">if</span>( pIdx-&gt;<a class="code" href="structIndex.html#acbb125339b02ca6819dd2e382de2d639">aiColumn</a>[j]==iCol ){
<a name="l00151"></a>00151             <a class="code" href="printf_8c.html#aa62e83e27ab0a63e15f9f844c17c595f">sqlite3_snprintf</a>(<span class="keyword">sizeof</span>(zErr), zErr,
<a name="l00152"></a>00152                              <span class="stringliteral">&quot;cannot open indexed column for writing&quot;</span>);
<a name="l00153"></a>00153             rc = <a class="code" href="sqlite3_8h.html#afda25cd6575e87558d2b7cd4a6585f2f">SQLITE_ERROR</a>;
<a name="l00154"></a>00154             (void)<a class="code" href="sqliteInt_8h.html#afd5afdeac4ae868c2bcb8a2246eefaf0">sqlite3SafetyOff</a>(db);
<a name="l00155"></a>00155             <a class="code" href="btree_8h.html#ad6d7e5bd01a11b45825ef54eda66fee4">sqlite3BtreeLeaveAll</a>(db);
<a name="l00156"></a>00156             <span class="keywordflow">goto</span> blob_open_out;
<a name="l00157"></a>00157           }
<a name="l00158"></a>00158         }
<a name="l00159"></a>00159       }
<a name="l00160"></a>00160     }
<a name="l00161"></a>00161 
<a name="l00162"></a>00162     v = <a class="code" href="vdbe_8h.html#a19fd8bfb709ddb7bc11030ebbf5ff301">sqlite3VdbeCreate</a>(db);
<a name="l00163"></a>00163     <span class="keywordflow">if</span>( v ){
<a name="l00164"></a>00164       <span class="keywordtype">int</span> iDb = <a class="code" href="prepare_8c.html#aecd8922611e561d76d5e9f16655e8a7c">sqlite3SchemaToIndex</a>(db, pTab-&gt;<a class="code" href="structTable.html#a1d6ce038a061722cebaeba0f3ffceacf">pSchema</a>);
<a name="l00165"></a>00165       <a class="code" href="vdbe_8h.html#a4105d7944fb904f78d6da14f8933bdd2">sqlite3VdbeAddOpList</a>(v, <span class="keyword">sizeof</span>(openBlob)/<span class="keyword">sizeof</span>(<a class="code" href="structVdbeOpList.html">VdbeOpList</a>), openBlob);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167       <span class="comment">/* Configure the OP_Transaction */</span>
<a name="l00168"></a>00168       <a class="code" href="vdbe_8h.html#a5b024078b85f7acc25e746fa9fc9136c">sqlite3VdbeChangeP1</a>(v, 0, iDb);
<a name="l00169"></a>00169       <a class="code" href="vdbe_8h.html#ad80ae0e25107f1e56fad9d6eee8f010d">sqlite3VdbeChangeP2</a>(v, 0, (flags ? 1 : 0));
<a name="l00170"></a>00170 
<a name="l00171"></a>00171       <span class="comment">/* Configure the OP_VerifyCookie */</span>
<a name="l00172"></a>00172       <a class="code" href="vdbe_8h.html#a5b024078b85f7acc25e746fa9fc9136c">sqlite3VdbeChangeP1</a>(v, 1, iDb);
<a name="l00173"></a>00173       <a class="code" href="vdbe_8h.html#ad80ae0e25107f1e56fad9d6eee8f010d">sqlite3VdbeChangeP2</a>(v, 1, pTab-&gt;<a class="code" href="structTable.html#a1d6ce038a061722cebaeba0f3ffceacf">pSchema</a>-&gt;<a class="code" href="structSchema.html#a3eef54a64f4f962d64577646bd34a47c">schema_cookie</a>);
<a name="l00174"></a>00174 
<a name="l00175"></a>00175       <span class="comment">/* Make sure a mutex is held on the table to be accessed */</span>
<a name="l00176"></a>00176       <a class="code" href="vdbe_8h.html#a44ca3a39c7bc260ba1358a4ad14f39d4">sqlite3VdbeUsesBtree</a>(v, iDb); 
<a name="l00177"></a>00177 
<a name="l00178"></a>00178       <span class="comment">/* Remove either the OP_OpenWrite or OpenRead. Set the P2 </span>
<a name="l00179"></a>00179 <span class="comment">      ** parameter of the other to pTab-&gt;tnum. </span>
<a name="l00180"></a>00180 <span class="comment">      */</span>
<a name="l00181"></a>00181       <a class="code" href="vdbe_8h.html#ac38d185582ae5f72f6d8b39424eef847">sqlite3VdbeChangeToNoop</a>(v, (flags ? 3 : 5), 1);
<a name="l00182"></a>00182       <a class="code" href="vdbe_8h.html#ad80ae0e25107f1e56fad9d6eee8f010d">sqlite3VdbeChangeP2</a>(v, (flags ? 5 : 3), pTab-&gt;<a class="code" href="structTable.html#aebe1abbfb2fd4b5e5dff8e74a4f3c890">tnum</a>);
<a name="l00183"></a>00183       <a class="code" href="vdbe_8h.html#ac7aa977bac471cb643aff9c6c51079be">sqlite3VdbeChangeP3</a>(v, (flags ? 5 : 3), iDb);
<a name="l00184"></a>00184 
<a name="l00185"></a>00185       <span class="comment">/* Configure the OP_SetNumColumns. Configure the cursor to</span>
<a name="l00186"></a>00186 <span class="comment">      ** think that the table has one more column than it really</span>
<a name="l00187"></a>00187 <span class="comment">      ** does. An OP_Column to retrieve this imaginary column will</span>
<a name="l00188"></a>00188 <span class="comment">      ** always return an SQL NULL. This is useful because it means</span>
<a name="l00189"></a>00189 <span class="comment">      ** we can invoke OP_Column to fill in the vdbe cursors type </span>
<a name="l00190"></a>00190 <span class="comment">      ** and offset cache without causing any IO.</span>
<a name="l00191"></a>00191 <span class="comment">      */</span>
<a name="l00192"></a>00192       <a class="code" href="vdbe_8h.html#ad80ae0e25107f1e56fad9d6eee8f010d">sqlite3VdbeChangeP2</a>(v, flags ? 4 : 2, pTab-&gt;<a class="code" href="structTable.html#a2b3925b85368f0367322ab66bf289163">nCol</a>+1);
<a name="l00193"></a>00193       <a class="code" href="vdbe_8h.html#ad80ae0e25107f1e56fad9d6eee8f010d">sqlite3VdbeChangeP2</a>(v, 8, pTab-&gt;<a class="code" href="structTable.html#a2b3925b85368f0367322ab66bf289163">nCol</a>);
<a name="l00194"></a>00194       <span class="keywordflow">if</span>( !db-&gt;<a class="code" href="structsqlite3.html#a79beb0036337ba7fc2de5ccbb9225935">mallocFailed</a> ){
<a name="l00195"></a>00195         <a class="code" href="vdbe_8h.html#ace51a1495db9070228c5fddb7a156ffe">sqlite3VdbeMakeReady</a>(v, 1, 1, 1, 0);
<a name="l00196"></a>00196       }
<a name="l00197"></a>00197     }
<a name="l00198"></a>00198    
<a name="l00199"></a>00199     <a class="code" href="btree_8h.html#ad6d7e5bd01a11b45825ef54eda66fee4">sqlite3BtreeLeaveAll</a>(db);
<a name="l00200"></a>00200     rc = <a class="code" href="sqliteInt_8h.html#afd5afdeac4ae868c2bcb8a2246eefaf0">sqlite3SafetyOff</a>(db);
<a name="l00201"></a>00201     <span class="keywordflow">if</span>( rc!=<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> || db-&gt;<a class="code" href="structsqlite3.html#a79beb0036337ba7fc2de5ccbb9225935">mallocFailed</a> ){
<a name="l00202"></a>00202       <span class="keywordflow">goto</span> blob_open_out;
<a name="l00203"></a>00203     }
<a name="l00204"></a>00204 
<a name="l00205"></a>00205     <a class="code" href="sqlite3_8h.html#aefd78e20f41e9d96f27b755e8ef54578">sqlite3_bind_int64</a>((<a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> *)v, 1, iRow);
<a name="l00206"></a>00206     rc = <a class="code" href="sqlite3_8h.html#ae04a3cf3ae391dabf1161cc0e040e9e8">sqlite3_step</a>((<a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> *)v);
<a name="l00207"></a>00207     <span class="keywordflow">if</span>( rc!=<a class="code" href="sqlite3_8h.html#a624365823d0b11a99ccb49e9bb5f8fcf">SQLITE_ROW</a> ){
<a name="l00208"></a>00208       nAttempt++;
<a name="l00209"></a>00209       rc = <a class="code" href="sqlite3_8h.html#aaf6c3dbc23f33c0752588425c7e9d498">sqlite3_finalize</a>((<a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> *)v);
<a name="l00210"></a>00210       <a class="code" href="printf_8c.html#aa62e83e27ab0a63e15f9f844c17c595f">sqlite3_snprintf</a>(<span class="keyword">sizeof</span>(zErr), zErr, <a class="code" href="main_8c.html#ad2a9feca40ee5a7c629c2af6d0ae1d27">sqlite3_errmsg</a>(db));
<a name="l00211"></a>00211       v = 0;
<a name="l00212"></a>00212     }
<a name="l00213"></a>00213   } <span class="keywordflow">while</span>( nAttempt&lt;5 &amp;&amp; rc==<a class="code" href="sqlite3_8h.html#a1671ab645a3331d997b4422dc334476a">SQLITE_SCHEMA</a> );
<a name="l00214"></a>00214 
<a name="l00215"></a>00215   <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#a624365823d0b11a99ccb49e9bb5f8fcf">SQLITE_ROW</a> ){
<a name="l00216"></a>00216     <span class="comment">/* The row-record has been opened successfully. Check that the</span>
<a name="l00217"></a>00217 <span class="comment">    ** column in question contains text or a blob. If it contains</span>
<a name="l00218"></a>00218 <span class="comment">    ** text, it is up to the caller to get the encoding right.</span>
<a name="l00219"></a>00219 <span class="comment">    */</span>
<a name="l00220"></a>00220     <a class="code" href="structIncrblob.html">Incrblob</a> *pBlob;
<a name="l00221"></a>00221     <a class="code" href="sqliteInt_8h.html#a03ad5adfaeb9b7640dde78a0cc390319">u32</a> type = v-&gt;<a class="code" href="structVdbe.html#a8bd1b6ecdc16918e10ee1ae90b4e19ef">apCsr</a>[0]-&gt;<a class="code" href="structVdbeCursor.html#a6992d2bf9eb8480985aec47dae58f1ab">aType</a>[iCol];
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     <span class="keywordflow">if</span>( type&lt;12 ){
<a name="l00224"></a>00224       <a class="code" href="printf_8c.html#aa62e83e27ab0a63e15f9f844c17c595f">sqlite3_snprintf</a>(<span class="keyword">sizeof</span>(zErr), zErr, <span class="stringliteral">&quot;cannot open value of type %s&quot;</span>,
<a name="l00225"></a>00225           type==0?<span class="stringliteral">&quot;null&quot;</span>: type==7?<span class="stringliteral">&quot;real&quot;</span>: <span class="stringliteral">&quot;integer&quot;</span>
<a name="l00226"></a>00226       );
<a name="l00227"></a>00227       rc = <a class="code" href="sqlite3_8h.html#afda25cd6575e87558d2b7cd4a6585f2f">SQLITE_ERROR</a>;
<a name="l00228"></a>00228       <span class="keywordflow">goto</span> blob_open_out;
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230     pBlob = (<a class="code" href="structIncrblob.html">Incrblob</a> *)<a class="code" href="malloc_8c.html#a9cdef45d3f06c28e71d728e8b15ebc0f">sqlite3DbMallocZero</a>(db, <span class="keyword">sizeof</span>(<a class="code" href="structIncrblob.html">Incrblob</a>));
<a name="l00231"></a>00231     <span class="keywordflow">if</span>( db-&gt;<a class="code" href="structsqlite3.html#a79beb0036337ba7fc2de5ccbb9225935">mallocFailed</a> ){
<a name="l00232"></a>00232       <a class="code" href="malloc_8c.html#a8ca215f2395ca90fd180460afb2eba9d">sqlite3DbFree</a>(db, pBlob);
<a name="l00233"></a>00233       <span class="keywordflow">goto</span> blob_open_out;
<a name="l00234"></a>00234     }
<a name="l00235"></a>00235     pBlob-&gt;<a class="code" href="structIncrblob.html#a46fa093e5241305f28d02926f8d0846f">flags</a> = flags;
<a name="l00236"></a>00236     pBlob-&gt;<a class="code" href="structIncrblob.html#af5a24b18473d1449c8c3fe7d826de59a">pCsr</a> =  v-&gt;<a class="code" href="structVdbe.html#a8bd1b6ecdc16918e10ee1ae90b4e19ef">apCsr</a>[0]-&gt;<a class="code" href="structVdbeCursor.html#a9ecb4ab9f7374f92da69f03fc336c293">pCursor</a>;
<a name="l00237"></a>00237     <a class="code" href="btree_8h.html#a93d663ae673eae8888df40f05b7572e9">sqlite3BtreeEnterCursor</a>(pBlob-&gt;<a class="code" href="structIncrblob.html#af5a24b18473d1449c8c3fe7d826de59a">pCsr</a>);
<a name="l00238"></a>00238     <a class="code" href="btree_8c.html#a05efe0da93ae407220fd202dd6480520">sqlite3BtreeCacheOverflow</a>(pBlob-&gt;<a class="code" href="structIncrblob.html#af5a24b18473d1449c8c3fe7d826de59a">pCsr</a>);
<a name="l00239"></a>00239     <a class="code" href="btree_8h.html#a47ac74ebeb333b65c0af802995529740">sqlite3BtreeLeaveCursor</a>(pBlob-&gt;<a class="code" href="structIncrblob.html#af5a24b18473d1449c8c3fe7d826de59a">pCsr</a>);
<a name="l00240"></a>00240     pBlob-&gt;<a class="code" href="structIncrblob.html#a8b7b39c9372db552add74c69f14a61a3">pStmt</a> = (<a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> *)v;
<a name="l00241"></a>00241     pBlob-&gt;<a class="code" href="structIncrblob.html#af8e71744f43178967460b9f402e7fafd">iOffset</a> = v-&gt;<a class="code" href="structVdbe.html#a8bd1b6ecdc16918e10ee1ae90b4e19ef">apCsr</a>[0]-&gt;<a class="code" href="structVdbeCursor.html#a17431e67b341282aeb6c026cd01ec1e9">aOffset</a>[iCol];
<a name="l00242"></a>00242     pBlob-&gt;<a class="code" href="structIncrblob.html#ab1e1439df086208173fa97003f0ee02b">nByte</a> = <a class="code" href="vdbeaux_8c.html#a002b233ebea0d972e5bc2964f5fe5de6">sqlite3VdbeSerialTypeLen</a>(type);
<a name="l00243"></a>00243     pBlob-&gt;<a class="code" href="structIncrblob.html#a9d3fe0b0229b75b9d0f9ee8e6545b5bc">db</a> = db;
<a name="l00244"></a>00244     *ppBlob = (<a class="code" href="sqlite3_8h.html#a3eb4857c157c542bb3fb7d8cbf38a662">sqlite3_blob</a> *)pBlob;
<a name="l00245"></a>00245     rc = <a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>;
<a name="l00246"></a>00246   }<span class="keywordflow">else</span> <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> ){
<a name="l00247"></a>00247     <a class="code" href="printf_8c.html#aa62e83e27ab0a63e15f9f844c17c595f">sqlite3_snprintf</a>(<span class="keyword">sizeof</span>(zErr), zErr, <span class="stringliteral">&quot;no such rowid: %lld&quot;</span>, iRow);
<a name="l00248"></a>00248     rc = <a class="code" href="sqlite3_8h.html#afda25cd6575e87558d2b7cd4a6585f2f">SQLITE_ERROR</a>;
<a name="l00249"></a>00249   }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251 blob_open_out:
<a name="l00252"></a>00252   zErr[<span class="keyword">sizeof</span>(zErr)-1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00253"></a>00253   <span class="keywordflow">if</span>( rc!=<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a> || db-&gt;<a class="code" href="structsqlite3.html#a79beb0036337ba7fc2de5ccbb9225935">mallocFailed</a> ){
<a name="l00254"></a>00254     <a class="code" href="sqlite3_8h.html#aaf6c3dbc23f33c0752588425c7e9d498">sqlite3_finalize</a>((<a class="code" href="sqlite3_8h.html#af2a033da1327cdd77f0a174a09aedd0c">sqlite3_stmt</a> *)v);
<a name="l00255"></a>00255   }
<a name="l00256"></a>00256   <a class="code" href="sqliteInt_8h.html#adf4434e94ac41a2abedd476047d49983">sqlite3Error</a>(db, rc, (rc==<a class="code" href="sqlite3_8h.html#a650d09c7bec7ddadb7c8aa3519dc842c">SQLITE_OK</a>?0:zErr));
<a name="l00257"></a>00257   rc = <a class="code" href="malloc_8c.html#a5ace6847fdf42079e5ec21f3d54d601b">sqlite3ApiExit</a>(db, rc);
<a name="l00258"></a>00258   <a class="code" href="mutex_8h.html#aba06556afc1a17868af4675ba856701c">sqlite3_mutex_leave</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>);
<a name="l00259"></a>00259   <span class="keywordflow">return</span> rc;
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 <span class="comment">/*</span>
<a name="l00263"></a>00263 <span class="comment">** Close a blob handle that was previously created using</span>
<a name="l00264"></a>00264 <span class="comment">** sqlite3_blob_open().</span>
<a name="l00265"></a>00265 <span class="comment">*/</span>
<a name="l00266"></a><a class="code" href="vdbeblob_8c.html#a7fb489604108fe8b765b547f85fd445f">00266</a> <span class="keywordtype">int</span> <a class="code" href="sqlite3_8h.html#a4fa30f77f307bf27544138a6a88b45cf">sqlite3_blob_close</a>(<a class="code" href="sqlite3_8h.html#a3eb4857c157c542bb3fb7d8cbf38a662">sqlite3_blob</a> *pBlob){
<a name="l00267"></a>00267   <a class="code" href="structIncrblob.html">Incrblob</a> *p = (<a class="code" href="structIncrblob.html">Incrblob</a> *)pBlob;
<a name="l00268"></a>00268   <span class="keywordtype">int</span> rc;
<a name="l00269"></a>00269 
<a name="l00270"></a>00270   rc = <a class="code" href="sqlite3_8h.html#aaf6c3dbc23f33c0752588425c7e9d498">sqlite3_finalize</a>(p-&gt;<a class="code" href="structIncrblob.html#a8b7b39c9372db552add74c69f14a61a3">pStmt</a>);
<a name="l00271"></a>00271   <a class="code" href="malloc_8c.html#a8ca215f2395ca90fd180460afb2eba9d">sqlite3DbFree</a>(p-&gt;<a class="code" href="structIncrblob.html#a9d3fe0b0229b75b9d0f9ee8e6545b5bc">db</a>, p);
<a name="l00272"></a>00272   <span class="keywordflow">return</span> rc;
<a name="l00273"></a>00273 }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275 <span class="comment">/*</span>
<a name="l00276"></a>00276 <span class="comment">** Perform a read or write operation on a blob</span>
<a name="l00277"></a>00277 <span class="comment">*/</span>
<a name="l00278"></a><a class="code" href="vdbeblob_8c.html#a6c1d57e4337ee1b8655215c06dea4046">00278</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="vdbeblob_8c.html#a6c1d57e4337ee1b8655215c06dea4046">blobReadWrite</a>(
<a name="l00279"></a>00279   <a class="code" href="sqlite3_8h.html#a3eb4857c157c542bb3fb7d8cbf38a662">sqlite3_blob</a> *pBlob, 
<a name="l00280"></a>00280   <span class="keywordtype">void</span> *z, 
<a name="l00281"></a>00281   <span class="keywordtype">int</span> n, 
<a name="l00282"></a>00282   <span class="keywordtype">int</span> iOffset, 
<a name="l00283"></a>00283   <span class="keywordtype">int</span> (*xCall)(<a class="code" href="structBtCursor.html">BtCursor</a>*, <a class="code" href="sqliteInt_8h.html#a03ad5adfaeb9b7640dde78a0cc390319">u32</a>, <a class="code" href="sqliteInt_8h.html#a03ad5adfaeb9b7640dde78a0cc390319">u32</a>, <span class="keywordtype">void</span>*)
<a name="l00284"></a>00284 ){
<a name="l00285"></a>00285   <span class="keywordtype">int</span> rc;
<a name="l00286"></a>00286   <a class="code" href="structIncrblob.html">Incrblob</a> *p = (<a class="code" href="structIncrblob.html">Incrblob</a> *)pBlob;
<a name="l00287"></a>00287   <a class="code" href="structVdbe.html">Vdbe</a> *v;
<a name="l00288"></a>00288   <a class="code" href="structsqlite3.html">sqlite3</a> *<a class="code" href="shell_8c.html#ad6e663497d2c934364b3bcf07496b30b">db</a> = p-&gt;<a class="code" href="structIncrblob.html#a9d3fe0b0229b75b9d0f9ee8e6545b5bc">db</a>;  
<a name="l00289"></a>00289 
<a name="l00290"></a>00290   <a class="code" href="mutex_8h.html#afbab5dc0108b65678f2fa579473041ac">sqlite3_mutex_enter</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>);
<a name="l00291"></a>00291   v = (<a class="code" href="structVdbe.html">Vdbe</a>*)p-&gt;<a class="code" href="structIncrblob.html#a8b7b39c9372db552add74c69f14a61a3">pStmt</a>;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293   <span class="keywordflow">if</span>( n&lt;0 || iOffset&lt;0 || (iOffset+n)&gt;p-&gt;<a class="code" href="structIncrblob.html#ab1e1439df086208173fa97003f0ee02b">nByte</a> ){
<a name="l00294"></a>00294     <span class="comment">/* Request is out of range. Return a transient error. */</span>
<a name="l00295"></a>00295     rc = <a class="code" href="sqlite3_8h.html#afda25cd6575e87558d2b7cd4a6585f2f">SQLITE_ERROR</a>;
<a name="l00296"></a>00296     <a class="code" href="sqliteInt_8h.html#adf4434e94ac41a2abedd476047d49983">sqlite3Error</a>(db, <a class="code" href="sqlite3_8h.html#afda25cd6575e87558d2b7cd4a6585f2f">SQLITE_ERROR</a>, 0);
<a name="l00297"></a>00297   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( v==0 ){
<a name="l00298"></a>00298     <span class="comment">/* If there is no statement handle, then the blob-handle has</span>
<a name="l00299"></a>00299 <span class="comment">    ** already been invalidated. Return SQLITE_ABORT in this case.</span>
<a name="l00300"></a>00300 <span class="comment">    */</span>
<a name="l00301"></a>00301     rc = <a class="code" href="sqlite3_8h.html#ab0c18279e950b695575a4667c7bb38b7">SQLITE_ABORT</a>;
<a name="l00302"></a>00302   }<span class="keywordflow">else</span>{
<a name="l00303"></a>00303     <span class="comment">/* Call either BtreeData() or BtreePutData(). If SQLITE_ABORT is</span>
<a name="l00304"></a>00304 <span class="comment">    ** returned, clean-up the statement handle.</span>
<a name="l00305"></a>00305 <span class="comment">    */</span>
<a name="l00306"></a>00306     assert( db == v-&gt;<a class="code" href="structVdbe.html#a495366101a593999f4d2ed905e839029">db</a> );
<a name="l00307"></a>00307     <a class="code" href="btree_8h.html#a93d663ae673eae8888df40f05b7572e9">sqlite3BtreeEnterCursor</a>(p-&gt;<a class="code" href="structIncrblob.html#af5a24b18473d1449c8c3fe7d826de59a">pCsr</a>);
<a name="l00308"></a>00308     rc = xCall(p-&gt;<a class="code" href="structIncrblob.html#af5a24b18473d1449c8c3fe7d826de59a">pCsr</a>, iOffset+p-&gt;<a class="code" href="structIncrblob.html#af8e71744f43178967460b9f402e7fafd">iOffset</a>, n, z);
<a name="l00309"></a>00309     <a class="code" href="btree_8h.html#a47ac74ebeb333b65c0af802995529740">sqlite3BtreeLeaveCursor</a>(p-&gt;<a class="code" href="structIncrblob.html#af5a24b18473d1449c8c3fe7d826de59a">pCsr</a>);
<a name="l00310"></a>00310     <span class="keywordflow">if</span>( rc==<a class="code" href="sqlite3_8h.html#ab0c18279e950b695575a4667c7bb38b7">SQLITE_ABORT</a> ){
<a name="l00311"></a>00311       <a class="code" href="vdbe_8h.html#a65395771ab2499f7e467c7edb809b670">sqlite3VdbeFinalize</a>(v);
<a name="l00312"></a>00312       p-&gt;<a class="code" href="structIncrblob.html#a8b7b39c9372db552add74c69f14a61a3">pStmt</a> = 0;
<a name="l00313"></a>00313     }<span class="keywordflow">else</span>{
<a name="l00314"></a>00314       db-&gt;<a class="code" href="structsqlite3.html#a73adbb5395118bcbd9e4d705712966a2">errCode</a> = rc;
<a name="l00315"></a>00315       v-&gt;<a class="code" href="structVdbe.html#af82fb0227a5b8db9d3b9bdb03964a4a0">rc</a> = rc;
<a name="l00316"></a>00316     }
<a name="l00317"></a>00317   }
<a name="l00318"></a>00318   rc = <a class="code" href="malloc_8c.html#a5ace6847fdf42079e5ec21f3d54d601b">sqlite3ApiExit</a>(db, rc);
<a name="l00319"></a>00319   <a class="code" href="mutex_8h.html#aba06556afc1a17868af4675ba856701c">sqlite3_mutex_leave</a>(db-&gt;<a class="code" href="structsqlite3.html#a6328497ac0393204ab5f5083f05731c9">mutex</a>);
<a name="l00320"></a>00320   <span class="keywordflow">return</span> rc;
<a name="l00321"></a>00321 }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 <span class="comment">/*</span>
<a name="l00324"></a>00324 <span class="comment">** Read data from a blob handle.</span>
<a name="l00325"></a>00325 <span class="comment">*/</span>
<a name="l00326"></a><a class="code" href="vdbeblob_8c.html#a8833bcf81900c01f2b03d32fc1ca4628">00326</a> <span class="keywordtype">int</span> <a class="code" href="sqlite3_8h.html#aca280a1aad5b2e4597f2f15b00e91465">sqlite3_blob_read</a>(<a class="code" href="sqlite3_8h.html#a3eb4857c157c542bb3fb7d8cbf38a662">sqlite3_blob</a> *pBlob, <span class="keywordtype">void</span> *z, <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> iOffset){
<a name="l00327"></a>00327   <span class="keywordflow">return</span> <a class="code" href="vdbeblob_8c.html#a6c1d57e4337ee1b8655215c06dea4046">blobReadWrite</a>(pBlob, z, n, iOffset, <a class="code" href="btree_8c.html#a173bbb37f94d673235e12e2ae3ba8d41">sqlite3BtreeData</a>);
<a name="l00328"></a>00328 }
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 <span class="comment">/*</span>
<a name="l00331"></a>00331 <span class="comment">** Write data to a blob handle.</span>
<a name="l00332"></a>00332 <span class="comment">*/</span>
<a name="l00333"></a><a class="code" href="vdbeblob_8c.html#a2bac80c0d1b7e4f3325c040cd2ed5a48">00333</a> <span class="keywordtype">int</span> <a class="code" href="sqlite3_8h.html#ac994103512f70b80b4978824ef008071">sqlite3_blob_write</a>(<a class="code" href="sqlite3_8h.html#a3eb4857c157c542bb3fb7d8cbf38a662">sqlite3_blob</a> *pBlob, <span class="keyword">const</span> <span class="keywordtype">void</span> *z, <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> iOffset){
<a name="l00334"></a>00334   <span class="keywordflow">return</span> <a class="code" href="vdbeblob_8c.html#a6c1d57e4337ee1b8655215c06dea4046">blobReadWrite</a>(pBlob, (<span class="keywordtype">void</span> *)z, n, iOffset, <a class="code" href="btree_8c.html#aaa41f4fd4d084006d21f5637ae93901c">sqlite3BtreePutData</a>);
<a name="l00335"></a>00335 }
<a name="l00336"></a>00336 
<a name="l00337"></a>00337 <span class="comment">/*</span>
<a name="l00338"></a>00338 <span class="comment">** Query a blob handle for the size of the data.</span>
<a name="l00339"></a>00339 <span class="comment">**</span>
<a name="l00340"></a>00340 <span class="comment">** The Incrblob.nByte field is fixed for the lifetime of the Incrblob</span>
<a name="l00341"></a>00341 <span class="comment">** so no mutex is required for access.</span>
<a name="l00342"></a>00342 <span class="comment">*/</span>
<a name="l00343"></a><a class="code" href="vdbeblob_8c.html#a6e7a1a49acf8be028a224519392ced05">00343</a> <span class="keywordtype">int</span> <a class="code" href="sqlite3_8h.html#a3c5a730e8f7bb89384994f42341e2081">sqlite3_blob_bytes</a>(<a class="code" href="sqlite3_8h.html#a3eb4857c157c542bb3fb7d8cbf38a662">sqlite3_blob</a> *pBlob){
<a name="l00344"></a>00344   <a class="code" href="structIncrblob.html">Incrblob</a> *p = (<a class="code" href="structIncrblob.html">Incrblob</a> *)pBlob;
<a name="l00345"></a>00345   <span class="keywordflow">return</span> p-&gt;<a class="code" href="structIncrblob.html#ab1e1439df086208173fa97003f0ee02b">nByte</a>;
<a name="l00346"></a>00346 }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348 <span class="preprocessor">#endif </span><span class="comment">/* #ifndef SQLITE_OMIT_INCRBLOB */</span>
</pre></div></div>
<hr size="1">

<p style="text-align: right;">
  <a href="http://www.contextlogger.org/">ContextLogger2</a>&#8212;ContextLogger2 Logger Daemon Internals&#8212;<small>Generated on Mon May 2 13:49:57 2011 by&nbsp;<a href="http://www.doxygen.org/">Doxygen</a> 1.6.1</small>
</p>

</body>
</html>
